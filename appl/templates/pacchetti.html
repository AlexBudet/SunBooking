<!-- appl/templates/pacchetti.html -->
{% extends "base.html" %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>  
.offcanvas-footer {
    position: sticky;
    bottom: 0;
    z-index: 1020;
}

#seduteOmaggioContainer {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 10px;
}

/* Badge pagato per pacchetti con rate completamente pagate */
.badge-pagato {
    font-size: 0.7rem;
    background-color: #9e9e9e;
    color: white;
    float: right;
}

#clientDropdown, #serviceDropdown, #searchClienteDropdown, #searchProgrammaDropdown {
  display: none;
  max-height: 200px;
  overflow-y: auto;
}

.offcanvas-footer {
    position: sticky;
    bottom: 0;
    z-index: 1020;
}

#seduteOmaggioContainer {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 10px;
}

#clientDropdown, #serviceDropdown, #searchClienteDropdown, #searchProgrammaDropdown {
  display: none;
  max-height: 200px;
  overflow-y: auto;
}

#pacchettoModal .modal-dialog {
  margin: 5vh auto;
  padding: 5px;
  max-height: 90vh; /* Limita l'altezza totale */
  display: flex;
  flex-direction: column;
}

#pacchettoModal .modal-content {
  padding: 5px;
  display: flex;
  flex-direction: column;
  max-height: 100%;
  overflow: hidden; /* Importante per contenere il body */
}

#pacchettoModal .modal-body {
  padding: 10px;
  overflow-y: auto; /* Scroll SOLO sul body */
  flex: 1 1 auto;
  min-height: 0; /* Fix per Firefox */
}

#pacchettoModal .modal-header,
#pacchettoModal .modal-footer {
  flex-shrink: 0; /* Non si comprimono mai */
  background: #fff;
  z-index: 1;
}

/* Centra verticalmente header e celle (sovrascrive Bootstrap) */
.table thead th,
.table tbody td { vertical-align: middle !important; }

/* Centra orizzontalmente le colonne: Creato il, Da Listino, Scontato */
.table thead th:nth-child(3),
.table thead th:nth-child(4),
.table thead th:nth-child(5),
.table tbody td:nth-child(3),
.table tbody td:nth-child(4),
.table tbody td:nth-child(5) { text-align: center !important; }

.table tbody tr { margin: 3px 0; padding: 1px; }

/* Colonna Pacchetto: larghezza massima con ellipsis */
.table tbody td:nth-child(2) {
  max-width: 320px;
  position: relative;
}

/* Nome completo visibile di default */
.table tbody td:nth-child(2) .nome-completo {
  display: inline;
}
.table tbody td:nth-child(2) .nome-tag {
  display: none;
}

/* Su schermi medi: mostra tag invece di nome completo */
@media (max-width: 1200px) {
  .table tbody td:nth-child(2) { max-width: 220px; }
  .table tbody td:nth-child(2) .nome-completo { display: none; }
  .table tbody td:nth-child(2) .nome-tag { display: inline; }
}

/* Su schermi piccoli: ancora pi√π compatto */
@media (max-width: 1200px) {
  .table tbody td:nth-child(2) { max-width: 150px; }
}

/* Badge PAGATO responsive */
.badge-pagato {
    font-size: 0.7rem;
    background-color: #9e9e9e;
    color: white;
    margin-left: 6px;
    white-space: nowrap;
}
.badge-pagato .badge-text {
    display: inline;
}
@media (max-width: 1200px) {
    .table tbody td:nth-child(2) { max-width: 200px; }
    .badge-pagato .badge-text { display: none; }
}
@media (max-width: 1200px) {
    .table tbody td:nth-child(2) { max-width: 150px; }
}

/* Colore bordo riga per status (usa variabili Bootstrap) */
.table tbody tr.status-preventivo { --bs-table-border-color: #ffdb10; --bs-border-width: 2px; }
.table tbody tr.status-attivo { --bs-table-border-color: #81e1ff; --bs-border-width: 2px; }
.table tbody tr.status-completato { 
  --bs-table-border-color: #7e7e7e; 
  --bs-border-width: 2px; 
  --bs-table-bg: #b1b1b1;      /* sfondo grigio permanente */
  --bs-table-color: #ffffff;   /* testo bianco permanente */
}
.table tbody tr.status-abbandonato { --bs-table-border-color: #ffb4b4; --bs-border-width: 2px; }

/* Hover: colore di sfondo per cella/righe per status */
.table tbody tr.status-preventivo:hover { --bs-table-bg: #fff7cc; }
.table tbody tr.status-attivo:hover { --bs-table-bg: #e8f8ff; }
.table tbody tr.status-completato:hover { --bs-table-bg: #525252; --bs-table-color: #ffffff; }
.table tbody tr.status-abbandonato:hover { --bs-table-bg: #ffe5e5; }

/* Transizione morbida su colore di sfondo/testo */
.table tbody tr[class*="status-"] > td,
.table tbody tr[class*="status-"] > th {
  transition: background-color .15s ease, color .15s ease;
}

/* Necessario per vedere i corner sui <td> */
.table { border-collapse: separate; border-spacing: 0 10px; background-color: transparent; width: 90%; margin-left: 5%;}

/* Bordi orizzontali su tutte le celle tranne azioni */
.table tbody tr[class*="status-"] > td:not(.actions) {
  border-top: var(--bs-border-width) solid var(--bs-table-border-color);
  border-bottom: var(--bs-border-width) solid var(--bs-table-border-color);
  border-left: 0;
  border-right: 0;
  background-clip: padding-box;
}

/* Prima cella: solo bordo sinistro + corner arrotondati */
.table tbody tr[class*="status-"] > td:first-child {
  border-left: var(--bs-border-width) solid var(--bs-table-border-color);
  border-top-left-radius: 8px;
  border-bottom-left-radius: 8px;
  overflow: hidden;
}

/* Penultima cella CON bordo destro: solo quando ESISTE la cella .actions dopo */
.table tbody tr[class*="status-"] > td:nth-last-child(2):has(+ td.actions) {
  border-right: var(--bs-border-width) solid var(--bs-table-border-color);
  border-top-right-radius: 8px;
  border-bottom-right-radius: 8px;
  overflow: hidden;
}

/* Ultima cella CON bordo destro: quando NON √® .actions */
.table tbody tr[class*="status-"] > td:last-child:not(.actions) {
  border-right: var(--bs-border-width) solid var(--bs-table-border-color);
  border-top-right-radius: 8px;
  border-bottom-right-radius: 8px;
  overflow: hidden;
}

/* Cella azioni: nessun bordo, nessun corner; appare "esterna" */
.table tbody tr[class*="status-"] > td.actions {
  border: 0 !important;
  border-radius: 0 !important;
  background-color: transparent;
}

/* Tooltip stile nero come in calendar */
.tooltip {
  background-color: #242424 !important;
  color: #fff !important;
  text-align: center;
  padding: 2px 4px;
  opacity: 1 !important;
  border-radius: 6px;
}
.tooltip.bs-tooltip-top .tooltip-arrow::before { border-top-color: #212529 !important; }
.tooltip.bs-tooltip-bottom .tooltip-arrow::before { border-bottom-color: #212529 !important; }
.tooltip.bs-tooltip-start .tooltip-arrow::before { border-left-color: #212529 !important; }
.tooltip.bs-tooltip-end .tooltip-arrow::before { border-right-color: #212529 !important; }

/* Colonne sortabili */
.table thead th.sortable {
  cursor: pointer;
  user-select: none;
}
.table thead th.sortable:hover {
  background-color: #e9ecef;
}
.table thead th.sortable i {
  font-size: 0.75rem;
  opacity: 0.5;
  margin-left: 4px;
}
.table thead th.sortable.asc i::before {
  content: "\F128"; /* bi-arrow-up */
}
.table thead th.sortable.desc i::before {
  content: "\F129"; /* bi-arrow-down */
}
.table thead th.sortable.asc i,
.table thead th.sortable.desc i {
  opacity: 1;
}

/* Bottone aggiungi cliente quadrato verde */
.btn-add-client-square {
    width: 38px;
    height: 38px;
    padding: 0;
    font-size: 1.5rem;
    line-height: 1;
    border-radius: 4px;
    flex-shrink: 0;
}
/* Nascondi colonne sotto 1200px */
@media (max-width: 1200px) {
  .hide-mobile {
    display: none !important;
  }
  /* Su mobile, la colonna "Creato il" (terza colonna) deve avere border destro e radius */
  .table tbody tr[class*="status-"] > td:nth-child(3) {
    border-right: var(--bs-border-width) solid var(--bs-table-border-color);
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
    overflow: hidden;
  }

  .tooltip {
    display: none;
  }

  /* Disabilita tooltip nativi del browser su mobile */
  [title] {
    pointer-events: none;
  }
}
</style>
<br><br><br>
<div class="page-wide-90">
    <h2>Pacchetti</h2>
    
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-3" id="pacchettiTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-servizi" data-bs-toggle="tab" data-bs-target="#panel-servizi" 
                    type="button" role="tab" aria-controls="panel-servizi" aria-selected="true">
                <i class="bi bi-box-seam me-1"></i> Pacchetti Servizi
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-prepagate" data-bs-toggle="tab" data-bs-target="#panel-prepagate" 
                    type="button" role="tab" aria-controls="panel-prepagate" aria-selected="false">
                <i class="bi bi-credit-card me-1"></i> Carte Prepagate
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="pacchettiTabsContent">
        
        <!-- ========== TAB PACCHETTI SERVIZI ========== -->
        <div class="tab-pane fade show active" id="panel-servizi" role="tabpanel" aria-labelledby="tab-servizi">
            <!-- Campo di ricerca Pacchetti -->
            <div class="mb-3">
              <div class="row">
                <div class="col-md-3">
                  <input type="text" class="form-control" id="searchCliente" placeholder="Cerca per cliente" autocomplete="off"
                         data-bs-toggle="tooltip" data-bs-placement="top" title="Cerca un cliente per nome, cognome o cellulare">
                  <div id="searchClienteDropdown" class="dropdown-menu"></div>
                </div>
                <div class="col-md-3">
                  <input type="text" class="form-control" id="searchProgramma" placeholder="Cerca per programma" autocomplete="off"
                         data-bs-toggle="tooltip" data-bs-placement="top" title="Il nome del programma √® composto dai servizi inclusi (es: '10 Massaggio + 5 Pressoterapia')">
                  <div id="searchProgrammaDropdown" class="dropdown-menu"></div>
                </div>
                <div class="col-md-2">
                       <select class="form-control" id="searchStatus"
                          data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" 
                          title="Filtra i pacchetti per stato:<br><br>üü° <b>Preventivo</b><br>Pacchetto creato ma non iniziato<br><br>üîµ <b>Attivo</b><br>Pacchetto con almeno una seduta effettuata o una rata pagata<br><br>‚ö´ <b>Completato</b><br>Pacchetto completato e pagato<br><br>üî¥ <b>Abbandonato</b><br>Pacchetto non aggiornato da almeno {{ giorni_abbandono }} giorni<br>">
                    <option value="">Tutti gli status</option>
                    <option value="Preventivo">Preventivo</option>
                    <option value="Attivo">Attivo</option>
                    <option value="Completato">Completato</option>
                    <option value="Abbandonato">Abbandonato</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button class="btn btn-secondary" onclick="searchPacchetti()">Cerca</button>
                </div>
                <div class="col-md-2">
                  <button class="btn btn-primary" onclick="openAddModal('servizi')"
                          data-bs-toggle="tooltip" data-bs-placement="top" title="Crea un nuovo pacchetto/programma per un cliente">+ Nuovo Pacchetto</button>
                </div>
              </div>
            </div>
            
            <!-- Tabella Pacchetti Servizi -->
            <table class="table" id="tabellaServizi">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="client_nome">Cliente <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable" data-sort="nome">Pacchetto <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable" data-sort="data_sottoscrizione">Creato il <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable hide-mobile" data-sort="costo_totale_lordo">Da Listino <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable hide-mobile" data-sort="costo_totale_scontato">Scontato <i class="bi bi-arrow-down-up"></i></th>
                        {% if current_user and current_user.ruolo.value != 'user' %}
                        <th class="hide-mobile">Azioni</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="pacchettiTable">
                    <!-- Popolato via JS -->
                </tbody>
            </table>
        </div>

        <!-- ========== TAB CARTE PREPAGATE ========== -->
        <div class="tab-pane fade" id="panel-prepagate" role="tabpanel" aria-labelledby="tab-prepagate">
            <!-- Campo di ricerca Prepagate -->
            <div class="mb-3">
              <div class="row">
                <div class="col-md-4">
                  <input type="text" class="form-control" id="searchClientePrepagata" placeholder="Cerca per cliente" autocomplete="off"
                         data-bs-toggle="tooltip" data-bs-placement="top" title="Cerca un cliente per nome, cognome o cellulare">
                  <div id="searchClientePrepagataDropdown" class="dropdown-menu"></div>
                </div>
                <div class="col-md-2">
                       <select class="form-control" id="searchStatusPrepagata">
                    <option value="">Tutti gli status</option>
                    <option value="Preventivo">Preventivo</option>
                    <option value="Attivo">Attivo</option>
                    <option value="Completato">Completato</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button class="btn btn-secondary" onclick="searchPrepagate()">Cerca</button>
                </div>
                <div class="col-md-4 text-end">
                  <button class="btn btn-success" onclick="openAddModal('prepagata')"
                          data-bs-toggle="tooltip" data-bs-placement="top" title="Crea una nuova carta prepagata / gift card">
                      <i class="bi bi-plus-lg me-1"></i> Nuova Carta Prepagata
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Tabella Carte Prepagate -->
            <table class="table" id="tabellaPrepagate">
                <thead>
                    <tr>
                        <th class="sortable-prep" data-sort="client_nome">Cliente <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable-prep" data-sort="beneficiario_nome">Beneficiario <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable-prep" data-sort="data_sottoscrizione">Creata il <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable-prep hide-mobile" data-sort="credito_iniziale">Credito Iniziale <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable-prep" data-sort="credito_residuo">Saldo <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable-prep hide-mobile" data-sort="data_scadenza">Scadenza <i class="bi bi-arrow-down-up"></i></th>
                        {% if current_user and current_user.ruolo.value != 'user' %}
                        <th class="hide-mobile">Azioni</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="prepagateTable">
                    <!-- Popolato via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal per aggiungere/modificare pacchetto -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="pacchettoOffcanvas" aria-labelledby="offcanvasTitle" style="width: 50vw;">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasTitle">Crea Nuovo Pacchetto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
                <form id="pacchettoForm">
                    <input type="hidden" id="pacchettoId">
                    
                    <!-- Tipo Pacchetto -->
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="tipoPacchetto" id="tipoServizi" value="servizi" checked>
                            <label class="btn btn-outline-primary" for="tipoServizi">Pacchetto Servizi</label>
                            <input type="radio" class="btn-check" name="tipoPacchetto" id="tipoPrepagata" value="prepagata">
                            <label class="btn btn-outline-success" for="tipoPrepagata">Carta Prepagata</label>
                        </div>
                    </div>

                    <!-- Cliente (ricerca come in calendar.js) -->
                    <div class="mb-3">
                        <label for="clientSearch" class="form-label">Cliente</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="text" class="form-control" id="clientSearch" placeholder="Cerca cliente..." autocomplete="off" style="flex: 1;">
                            <button type="button" 
                                    class="btn btn-outline-success btn-add-client-square" 
                                    data-bs-toggle="tooltip" 
                                    data-bs-placement="top" 
                                    title="Aggiungi nuovo cliente"
                                    onclick="openAddClientModalPacchetti()">
                                +
                            </button>
                        </div>
                        <div id="clientDropdown" class="dropdown-menu"></div>
                        <input type="hidden" id="client_id" required>
                    </div>

                    <!-- SEZIONE CARTA PREPAGATA (nascosta di default) -->
                    <div id="sezionePrepagataCampi" style="display: none;">
                        <!-- Importo che il cliente paga -->
                        <div class="mb-3">
                            <label for="importoPagamento" class="form-label">Importo da Pagare (‚Ç¨)</label>
                            <input type="number" class="form-control" id="importoPagamento" step="0.01" min="0" placeholder="es. 100.00" onchange="calcolaCreditoTotale()">
                            <small class="text-muted">L'importo che andr√† in cassa</small>
                        </div>
                        
                        <!-- Tipo bonus -->
                        <div class="mb-3">
                            <label class="form-label">Bonus / Sconto</label>
                            <div class="input-group">
                                <select class="form-select" id="tipoBonusPrepagata" style="max-width: 140px;" onchange="calcolaCreditoTotale()">
                                    <option value="nessuno">Nessun bonus</option>
                                    <option value="euro">Bonus in ‚Ç¨</option>
                                    <option value="percentuale">Bonus in %</option>
                                </select>
                                <input type="number" class="form-control" id="valoreBonusPrepagata" step="0.01" min="0" placeholder="0" onchange="calcolaCreditoTotale()" style="display: none;">
                                <select class="form-select" id="arrotondamentoBonusPrepagata" style="max-width: 120px; display: none;" onchange="calcolaCreditoTotale()">
                                    <option value="nessuno">Nessuno</option>
                                    <option value="difetto">Difetto</option>
                                    <option value="eccesso">Eccesso</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Credito totale (calcolato) -->
                        <div class="mb-3">
                            <label for="creditoTotaleCalcolato" class="form-label">Credito Totale (‚Ç¨)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="creditoTotaleCalcolato" step="0.01" min="0" readonly style="background-color: #e9ecef; font-weight: bold;">
                                <button type="button" class="btn btn-outline-secondary" onclick="sbloccaCreditoManuale()" title="Modifica manualmente">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>
                            <small class="text-muted" id="creditoCalcoloInfo">Importo + Bonus = Credito disponibile per il cliente</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="beneficiarioNome" class="form-label">Beneficiario (opzionale)</label>
                            <input type="text" class="form-control" id="beneficiarioNome" placeholder="Se diverso dal cliente">
                            <small class="text-muted">Lascia vuoto se il beneficiario √® il cliente stesso</small>
                        </div>
                        <div class="mb-3">
                            <label for="dataScadenzaPrepagata" class="form-label">Data Scadenza (opzionale)</label>
                            <input type="date" class="form-control" id="dataScadenzaPrepagata">
                        </div>
                        
                        <!-- Vincoli utilizzo prepagata -->
                        <div class="mb-3">
                            <label class="form-label">Utilizzo consentito</label>
                            <select class="form-select" id="vincoloTipo" onchange="toggleVincoliFields()">
                                <option value="tutti">Tutti i servizi</option>
                                <option value="categoria">Solo una categoria</option>
                                <option value="sottocategoria">Solo una sottocategoria</option>
                                <option value="servizi">Solo servizi specifici</option>
                            </select>
                        </div>
                        
                        <!-- Campo categoria -->
                        <div class="mb-3" id="vincoloCategoriaField" style="display: none;">
                            <label for="vincoloCategoria" class="form-label">Categoria</label>
                            <select class="form-select" id="vincoloCategoria">
                                <option value="Solarium">Solarium</option>
                                <option value="Estetica">Estetica</option>
                            </select>
                        </div>
                        
                        <!-- Campo sottocategoria -->
                        <div class="mb-3" id="vincoloSottocategoriaField" style="display: none;">
                            <label for="vincoloSottocategoria" class="form-label">Sottocategoria</label>
                            <select class="form-select" id="vincoloSottocategoria">
                                <option value="">-- Seleziona --</option>
                                {% for sc in sottocategorie %}
                                <option value="{{ sc.id }}">{{ sc.nome }} ({{ sc.categoria.value }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Campo servizi multipli -->
                        <div class="mb-3" id="vincoloServiziField" style="display: none;">
                            <label class="form-label">Servizi consentiti</label>
                            <input type="text" class="form-control mb-2" id="vincoloServizioSearch" placeholder="Cerca servizio..." autocomplete="off">
                            <div id="vincoloServizioDropdown" class="dropdown-menu" style="position: relative; width: 100%;"></div>
                            <ul id="vincoloServiziList" class="list-group mt-2"></ul>
                        </div>
                    </div>

                    <!-- SEZIONE SERVIZI (visibile di default) -->
                    <div id="sezioneServiziCampi">
                    <!-- Servizi (ricerca come in calendar.js) -->
                    <div class="mb-3">
                        <label class="form-label">Servizi</label>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="serviceSearch" placeholder="Cerca servizio..." autocomplete="off">
                                <div id="serviceDropdown" class="dropdown-menu"></div>
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control" id="serviceQuantita" placeholder="Quantit√†" min="1">
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-sm btn-success" onclick="addService()">Aggiungi</button>
                            </div>
                        </div>
                        <ul id="serviziList" class="list-group"></ul>
                    </div>
                    
                    <!-- Costo totale -->
                    <div class="mb-3">
                        <label for="costoTotale" class="form-label">Costo Totale Lordo</label>
                        <input type="number" class="form-control" id="costoTotale" step="0.01" readonly>
                    </div>
                    
                    <!-- Sconto -->
                    <div class="mb-3">
                    <label for="scontoTipo" class="form-label">Tipo Sconto</label>
                    <select class="form-select" id="scontoTipo" onchange="toggleScontoFields()" disabled>
                        <option value="">Nessuno sconto</option>
                        <option value="Percentuale">Sconto Percentuale</option>
                        <option value="Ogni_N_Omaggio">Sedute Omaggio</option>
                        <!-- Promo salvate caricate dinamicamente -->
                    </select>
                    <small class="text-muted" id="scontoHint">Aggiungi almeno un servizio per attivare gli sconti</small>
                    </div>
                        
                        <!-- Campi per Percentuale -->
                        <div id="scontoPercentualeFields" class="mt-2" style="display: none;">
                            <input type="number" class="form-control" id="scontoPercentuale" placeholder="Valore sconto (%)" step="0.01" min="0" max="100">
                        </div>
                        
                        <!-- Campi per Sedute Omaggio -->
                        <div id="scontoOmaggioFields" class="mt-2" style="display: none;">
                            <input type="number" class="form-control" id="numeroSeduteOmaggio" placeholder="N¬∞ Sedute Omaggio" min="1">
                            <div id="seduteOmaggioContainer" class="mt-2">
                                <!-- Righe sedute omaggio generate dinamicamente -->
                            </div>
                        </div>

                    <!-- Costo totale scontato (auto-calcolato) -->
                    <div class="mb-3">
                        <label for="costoTotaleScontato" class="form-label">Costo Totale Scontato</label>
                        <div class="d-flex align-items-center">
                            <input type="number" class="form-control" id="costoTotaleScontato" step="0.01" readonly style="flex: 1;">
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="prezzoRoundDownModal"
                                    data-bs-toggle="tooltip" data-bs-placement="top" title="Arrotonda il prezzo per difetto"
                                    style="display: none;">‚Üì</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="prezzoRoundUpModal"
                                    data-bs-toggle="tooltip" data-bs-placement="top" title="Arrotonda il prezzo per eccesso"
                                    style="display: none;">‚Üë</button>
                        </div>
                    </div>

                    <!-- Riepilogo sedute (visibile solo con Sedute Omaggio) -->
                    <div class="mb-3" id="riepilogoSeduteDiv" style="display: none;">
                        <div class="alert alert-success py-2 mb-0">
                            <strong>Riepilogo Pacchetto:</strong><br>
                            <span id="riepilogoSeduteText"></span>
                        </div>
                    </div>

                    <!-- Mostra numero totale di sedute -->
                    <div class="mb-3" id="seduteOmaggioDiv" style="display: none;">
                        <label class="form-label">Sedute Omaggio da Aggiungere</label>
                        <div id="seduteOmaggioList" class="border rounded p-2 mb-2" style="max-height: 150px; overflow-y: auto;">
                            <!-- Popolato dinamicamente -->
                        </div>
                        <div class="alert alert-info mb-0 py-2">
                            <small>
                                <strong>Sedute pagate:</strong> <span id="sedutePagate">0</span> |
                                <strong>Sedute omaggio:</strong> <span id="seduteOmaggioCount">0</span> |
                                <strong>Totale sedute:</strong> <span id="seduteTotali">0</span>
                            </small>
                        </div>
                    </div>
                    
                    <!-- Operatori preferiti -->
                    <div class="mb-3">
                        <label class="form-label">Operatore Preferito</label>
                        <div class="d-flex gap-2 align-items-center">
                            <select class="form-select" id="operatoriSelect" multiple style="flex:1">
                            </select>
                            <button type="button"
                                    class="btn btn-outline-secondary btn-sm"
                                    id="btnDeselezionaOperatori"
                                    title="Deseleziona tutti gli operatori"
                                    onclick="deselezionaOperatori()">Deseleziona</button>
                        </div>
                    </div>
                    </div><!-- fine sezioneServiziCampi -->
                    
                    <!-- Status (solo per edit) -->
                    <div class="mb-3" id="statusDiv">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status">
                            <option value="Preventivo">Preventivo</option>
                            <option value="Attivo">Attivo</option>
                            <option value="Completato">Completato</option>
                            <option value="Abbandonato">Abbandonato</option>
                        </select>
                    </div>
                    
        <!-- Footer sticky in fondo -->
        <div class="offcanvas-footer sticky-bottom bg-white border-top p-3 mt-3">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Annulla</button>
            <button type="button" class="btn btn-primary" onclick="savePacchetto()">Salva</button>
        </div>
    </div>
</div>

<!-- Modal per aggiungere nuovo cliente -->
<div class="modal fade" id="AddClientModalPacchetti" tabindex="-1" aria-labelledby="AddClientModalPacchettiLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="AddClientModalPacchettiLabel">Aggiungi Nuovo Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="AddClientFormPacchetti">
          <div class="mb-3">
            <input type="text" class="form-control" id="cliente_nome_pacchetti" name="cliente_nome" required placeholder="Nome">
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" id="cliente_cognome_pacchetti" name="cliente_cognome" required placeholder="Cognome">
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" id="cliente_cellulare_pacchetti" name="cliente_cellulare" required placeholder="Cellulare">
          </div>
          <button type="submit" class="btn btn-primary">Salva Cliente</button>
        </form>        
      </div>
    </div>
  </div>
</div>

<script>
    let serviziSelezionati = [];
    let seduteOmaggio = []; // Array di {serviceId, nome, prezzo}
    let operatoriSelezionati = [];
    let nomePacchetto = '';
    let promoSalvate = []; // Array delle promo caricate da settings
    let arrotondamentoManuale = null; // 'floor', 'ceil', o null
    let tipoPacchettoCorrente = 'servizi'; // 'servizi' o 'prepagata'

    // Variabili per ordinamento
    let currentSort = { field: 'data_sottoscrizione', direction: 'desc' };
    let pacchettiData = []; // Cache dei dati per ordinamento client-side
    
    // Variabili per tab Carte Prepagate
    let currentSortPrepagate = { field: 'data_sottoscrizione', direction: 'desc' };
    let prepagateData = []; // Cache dei dati prepagate

    const userRuolo = '{{ current_user.ruolo.value if current_user else "user" }}';

    // Toggle tra Pacchetto Servizi e Carta Prepagata
    function toggleTipoPacchetto(tipo) {
        tipoPacchettoCorrente = tipo;
        const sezioneServizi = document.getElementById('sezioneServiziCampi');
        const sezionePrepagata = document.getElementById('sezionePrepagataCampi');
        
        if (tipo === 'prepagata') {
            sezioneServizi.style.display = 'none';
            sezionePrepagata.style.display = 'block';
            document.getElementById('offcanvasTitle').textContent = 'Crea Carta Prepagata';
        } else {
            sezioneServizi.style.display = 'block';
            sezionePrepagata.style.display = 'none';
            document.getElementById('offcanvasTitle').textContent = 'Crea Nuovo Pacchetto';
        }
    }

    // Event listener per i radio button tipo pacchetto
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('input[name="tipoPacchetto"]').forEach(radio => {
            radio.addEventListener('change', function() {
                toggleTipoPacchetto(this.value);
            });
        });
    });

    // ============ VINCOLI UTILIZZO PREPAGATA ============
    let vincoloServiziSelezionati = [];
    
    function toggleVincoliFields() {
        const tipo = document.getElementById('vincoloTipo').value;
        document.getElementById('vincoloCategoriaField').style.display = tipo === 'categoria' ? 'block' : 'none';
        document.getElementById('vincoloSottocategoriaField').style.display = tipo === 'sottocategoria' ? 'block' : 'none';
        document.getElementById('vincoloServiziField').style.display = tipo === 'servizi' ? 'block' : 'none';
    }
    
    function aggiungiVincoloServizio(service) {
        if (vincoloServiziSelezionati.some(s => s.id === service.id)) return;
        vincoloServiziSelezionati.push({ id: service.id, nome: service.nome });
        aggiornaListaVincoloServizi();
    }
    
    function rimuoviVincoloServizio(serviceId) {
        vincoloServiziSelezionati = vincoloServiziSelezionati.filter(s => s.id !== serviceId);
        aggiornaListaVincoloServizi();
    }
    
    function aggiornaListaVincoloServizi() {
        const list = document.getElementById('vincoloServiziList');
        list.innerHTML = '';
        vincoloServiziSelezionati.forEach(service => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `${service.nome} <button type="button" class="btn btn-sm btn-outline-danger" onclick="rimuoviVincoloServizio(${service.id})"><i class="bi bi-x"></i></button>`;
            list.appendChild(li);
        });
    }
    
    function getVincoliUtilizzo() {
        const tipo = document.getElementById('vincoloTipo').value;
        if (tipo === 'tutti') return null;
        const vincoli = { tipo: tipo };
        if (tipo === 'categoria') {
            vincoli.categoria = document.getElementById('vincoloCategoria').value;
        } else if (tipo === 'sottocategoria') {
            vincoli.sottocategoria_id = parseInt(document.getElementById('vincoloSottocategoria').value);
        } else if (tipo === 'servizi') {
            vincoli.servizi_ids = vincoloServiziSelezionati.map(s => s.id);
        }
        return vincoli;
    }
    
    // Ricerca servizi per vincoli
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('vincoloServizioSearch');
        const dropdown = document.getElementById('vincoloServizioDropdown');
        if (searchInput) {
            searchInput.addEventListener('input', async function() {
                const query = this.value.trim();
                if (query.length < 2) { dropdown.style.display = 'none'; return; }
                try {
                    const response = await fetch(`/cassa/api/services?q=${encodeURIComponent(query)}`);
                    const services = await response.json();
                    dropdown.innerHTML = '';
                    services.forEach(service => {
                        if (vincoloServiziSelezionati.some(s => s.id === service.id)) return;
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'dropdown-item';
                        item.textContent = `${service.nome} (‚Ç¨${service.prezzo.toFixed(2)})`;
                        item.onclick = function() {
                            aggiungiVincoloServizio(service);
                            dropdown.style.display = 'none';
                            searchInput.value = '';
                        };
                        dropdown.appendChild(item);
                    });
                    dropdown.style.display = services.length ? 'block' : 'none';
                } catch (error) { console.error('Errore ricerca servizi:', error); }
            });
        }
    });

    // ============ CALCOLO BONUS PREPAGATA ============
    let creditoManualeSbloccato = false;
    
    function calcolaCreditoTotale() {
        if (creditoManualeSbloccato) return; // Non ricalcolare se sbloccato manualmente
        
        const importoPagamento = parseFloat(document.getElementById('importoPagamento').value) || 0;
        const tipoBonus = document.getElementById('tipoBonusPrepagata').value;
        const valoreBonus = parseFloat(document.getElementById('valoreBonusPrepagata').value) || 0;
        const arrotondamento = document.getElementById('arrotondamentoBonusPrepagata').value;
        
        let creditoTotale = importoPagamento;
        let bonusCalcolato = 0;
        
        if (tipoBonus === 'euro') {
            bonusCalcolato = valoreBonus;
            creditoTotale = importoPagamento + bonusCalcolato;
        } else if (tipoBonus === 'percentuale' && valoreBonus > 0) {
            bonusCalcolato = importoPagamento * (valoreBonus / 100);
            
            // Arrotondamento
            if (arrotondamento === 'difetto') {
                bonusCalcolato = Math.floor(bonusCalcolato);
            } else if (arrotondamento === 'eccesso') {
                bonusCalcolato = Math.ceil(bonusCalcolato);
            }
            
            creditoTotale = importoPagamento + bonusCalcolato;
        }
        
        document.getElementById('creditoTotaleCalcolato').value = creditoTotale.toFixed(2);
        
        // Aggiorna info
        if (bonusCalcolato > 0) {
            document.getElementById('creditoCalcoloInfo').textContent = 
                `‚Ç¨${importoPagamento.toFixed(2)} + ‚Ç¨${bonusCalcolato.toFixed(2)} bonus = ‚Ç¨${creditoTotale.toFixed(2)} credito`;
        } else {
            document.getElementById('creditoCalcoloInfo').textContent = 
                'Importo + Bonus = Credito disponibile per il cliente';
        }
        
        // Mostra/nascondi campi bonus
        const valoreBonusInput = document.getElementById('valoreBonusPrepagata');
        const arrotondamentoSelect = document.getElementById('arrotondamentoBonusPrepagata');
        
        if (tipoBonus === 'nessuno') {
            valoreBonusInput.style.display = 'none';
            arrotondamentoSelect.style.display = 'none';
        } else if (tipoBonus === 'euro') {
            valoreBonusInput.style.display = 'block';
            valoreBonusInput.placeholder = 'Bonus ‚Ç¨';
            arrotondamentoSelect.style.display = 'none';
        } else if (tipoBonus === 'percentuale') {
            valoreBonusInput.style.display = 'block';
            valoreBonusInput.placeholder = 'Bonus %';
            arrotondamentoSelect.style.display = 'block';
        }
    }
    
    function sbloccaCreditoManuale() {
        const input = document.getElementById('creditoTotaleCalcolato');
        if (creditoManualeSbloccato) {
            // Riblocca e ricalcola
            creditoManualeSbloccato = false;
            input.readOnly = true;
            input.style.backgroundColor = '#e9ecef';
            calcolaCreditoTotale();
        } else {
            // Sblocca per modifica manuale
            creditoManualeSbloccato = true;
            input.readOnly = false;
            input.style.backgroundColor = '#fff';
        }
    }

    // Carica promo salvate
    async function loadPromoSalvate() {
      try {
        const response = await fetch('/settings/api/pacchetti/promo');
        promoSalvate = await response.json();
        updateScontoDropdown();
      } catch (error) {
        console.error('Errore caricamento promo:', error);
      }
    }

    // Aggiorna il dropdown sconto con le promo salvate
    function updateScontoDropdown() {
      const select = document.getElementById('scontoTipo');

    // Calcola il totale sedute selezionate (escluse omaggio)
    const totaleSedute = serviziSelezionati.reduce((sum, s) => sum + s.quantita, 0)
      
      // Rimuovi le opzioni promo esistenti (mantieni le prime 3)
      while (select.options.length > 3) {
        select.remove(3);
      }
      
  // Aggiungi separatore se ci sono promo attive e sufficienti sedute
  const promoEleggibili = promoSalvate.filter(p => p.attiva && totaleSedute >= (p.soglia || 0));
  
  if (promoEleggibili.length > 0) {
    const separator = document.createElement('option');
    separator.disabled = true;
    separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Promo Salvate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
    select.appendChild(separator);
    
    promoEleggibili.forEach(promo => {
      const option = document.createElement('option');
      option.value = `promo_${promo.id}`;
      
      let descrizione = '';
      if (promo.tipo === 'percentuale') {
        descrizione = `${promo.percentuale}% sconto ogni ${promo.soglia} sedute`;
      } else if (promo.tipo === 'sedute_omaggio') {
        descrizione = `${promo.sedute_omaggio} sedute omaggio ogni ${promo.soglia}`;
      }
      
      option.textContent = `${promo.nome} (${descrizione})`;
      option.dataset.promoId = promo.id;
      option.dataset.promoTipo = promo.tipo;
      option.dataset.promoSoglia = promo.soglia || 0;
      option.dataset.promoPercentuale = promo.percentuale || 0;
      option.dataset.promoOmaggio = promo.sedute_omaggio || 0;
      
      select.appendChild(option);
    });
  }
}

    // Abilita/disabilita il select sconto in base ai servizi
    function updateScontoState() {
        const scontoSelect = document.getElementById('scontoTipo');
        const hint = document.getElementById('scontoHint');
        
        if (serviziSelezionati.length > 0) {
            scontoSelect.disabled = false;
            hint.style.display = 'none';
        } else {
            scontoSelect.disabled = true;
            scontoSelect.value = '';
            hint.style.display = '';
        }
    }

 // Toggle campi sconto in base alla selezione
function toggleScontoFields() {
    const select = document.getElementById('scontoTipo');
    const tipo = select.value;
    const percFields = document.getElementById('scontoPercentualeFields');
    const omaggioFields = document.getElementById('scontoOmaggioFields');
    const riepilogoDiv = document.getElementById('riepilogoSeduteDiv');
    
    // Nascondi tutto
    percFields.style.display = 'none';
    omaggioFields.style.display = 'none';
    riepilogoDiv.style.display = 'none';
    
    // Reset
    seduteOmaggio = [];
    document.getElementById('seduteOmaggioContainer').innerHTML = '';
    
    if (tipo === 'Percentuale') {
        percFields.style.display = '';
    } else if (tipo === 'Ogni_N_Omaggio') {
        omaggioFields.style.display = '';
        generateSeduteOmaggioRows();
    } else if (tipo.startsWith('promo_')) {
        // Promo salvata selezionata - leggi dai dataset individuali
        const selectedOption = select.options[select.selectedIndex];
        
        // Costruisci l'oggetto promo dai dataset
        const promo = {
            id: parseInt(selectedOption.dataset.promoId),
            tipo: selectedOption.dataset.promoTipo,
            soglia: parseInt(selectedOption.dataset.promoSoglia) || 0,
            percentuale: parseFloat(selectedOption.dataset.promoPercentuale) || 0,
            sedute_omaggio: parseInt(selectedOption.dataset.promoOmaggio) || 0
        };
        
        if (promo.tipo === 'percentuale') {
            percFields.style.display = '';
            document.getElementById('scontoPercentuale').value = promo.percentuale;
        } else if (promo.tipo === 'sedute_omaggio') {
            omaggioFields.style.display = '';
            // Calcola sedute omaggio: ogni 'soglia' sedute acquistate, 'sedute_omaggio' in omaggio
            const totaleSeduteAcquistate = serviziSelezionati.reduce((sum, s) => sum + s.quantita, 0);
            const numeroOmaggiSpettanti = Math.floor(totaleSeduteAcquistate / promo.soglia) * promo.sedute_omaggio;
            document.getElementById('numeroSeduteOmaggio').value = numeroOmaggiSpettanti;
            generateSeduteOmaggioRows();
        }
    }
    
    arrotondamentoManuale = null; // Reset arrotondamento quando cambia tipo sconto
    updateCostoScontato();
    updateRiepilogo();
}

    // Init - aggiorna per caricare le promo
    document.addEventListener('DOMContentLoaded', () => {
        loadPacchetti();
        loadPrepagate();
        loadPromoSalvate();
        setupSorting();
        setupSortingPrepagate();

        // Inizializza tutti i tooltip Bootstrap
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            new bootstrap.Tooltip(el);
        });

        // Nascondi il tooltip del searchStatus quando si clicca o si apre il dropdown
        const searchStatusEl = document.getElementById('searchStatus');
        if (searchStatusEl) {
            ['click', 'focus', 'mousedown'].forEach(evt => {
                searchStatusEl.addEventListener(evt, function() {
                    const tooltip = bootstrap.Tooltip.getInstance(searchStatusEl);
                    if (tooltip) {
                        tooltip.hide();
                    }
                });
            });
        }
    })

// Genera le righe per selezionare le sedute omaggio
function generateSeduteOmaggioRows() {
    const container = document.getElementById('seduteOmaggioContainer');
    const numOmaggiInput = document.getElementById('numeroSeduteOmaggio');
    let numOmaggi = parseInt(numOmaggiInput.value) || 0;
    
    // VALIDAZIONE: calcola totale sedute pagate
    const totaleSedutePagate = serviziSelezionati.reduce((sum, s) => sum + s.quantita, 0);
    
    // Le sedute omaggio devono essere SEMPRE < sedute pagate
    const maxOmaggiConsentiti = totaleSedutePagate > 0 ? totaleSedutePagate - 1 : 0;
    
    if (numOmaggi >= totaleSedutePagate) {
        // BLOCCA: troppi omaggi richiesti
        alert(`‚ö†Ô∏è ATTENZIONE: Hai selezionato ${totaleSedutePagate} sedute pagate.\nIl numero di sedute omaggio deve essere INFERIORE a questo numero.\n\nMassimo consentito: ${maxOmaggiConsentiti} sedute omaggio.`);
        numOmaggiInput.value = maxOmaggiConsentiti;
        numOmaggi = maxOmaggiConsentiti;
    }
    
    container.innerHTML = '';
    seduteOmaggio = [];
    
    if (numOmaggi <= 0 || serviziSelezionati.length === 0) {
        updateRiepilogo();
        return;
    }
    
    // Prendi il primo servizio come default
    const defaultService = serviziSelezionati[0];
    
    for (let i = 0; i < numOmaggi; i++) {
        // Aggiungi all'array con il servizio di default
        seduteOmaggio.push({
            serviceId: defaultService.id,
            nome: defaultService.nome,
            prezzo: defaultService.prezzo
        });
        
        const row = document.createElement('div');
        row.className = 'd-flex align-items-center gap-2 mb-2';
        row.dataset.index = i;
        
        const label = document.createElement('span');
        label.className = 'badge bg-success';
        label.textContent = `Omaggio ${i + 1}`;
        
        const select = document.createElement('select');
        select.className = 'form-select form-select-sm';
        select.dataset.index = i;
        
        // Popola con i servizi gi√† selezionati
        serviziSelezionati.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = `${s.nome} (‚Ç¨${s.prezzo.toFixed(2)})`;
            opt.dataset.nome = s.nome;
            opt.dataset.prezzo = s.prezzo;
            select.appendChild(opt);
        });
        
        select.addEventListener('change', function() {
            const idx = parseInt(this.dataset.index);
            const selectedOpt = this.options[this.selectedIndex];
            seduteOmaggio[idx] = {
                serviceId: this.value,
                nome: selectedOpt.dataset.nome,
                prezzo: parseFloat(selectedOpt.dataset.prezzo)
            };
            updateRiepilogo();
            updateNomePacchetto();
        });
        
        row.appendChild(label);
        row.appendChild(select);
        container.appendChild(row);
    }
    
    updateRiepilogo();
    updateNomePacchetto();
}

    // Aggiorna il riepilogo sedute
    function updateRiepilogo() {
        const riepilogoDiv = document.getElementById('riepilogoSeduteDiv');
        const riepilogoText = document.getElementById('riepilogoSeduteText');
        const tipo = document.getElementById('scontoTipo').value;
        
        if (tipo !== 'Ogni_N_Omaggio') {
            riepilogoDiv.style.display = 'none';
            return;
        }
        
        riepilogoDiv.style.display = '';
        
        // Conta tutte le sedute (pagate + omaggio)
        const conteggio = {};
        
        // Sedute pagate
        serviziSelezionati.forEach(s => {
            if (!conteggio[s.nome]) conteggio[s.nome] = { pagate: 0, omaggio: 0, prezzo: s.prezzo };
            conteggio[s.nome].pagate += s.quantita;
        });
        
        // Sedute omaggio
        seduteOmaggio.forEach(s => {
            if (!conteggio[s.nome]) conteggio[s.nome] = { pagate: 0, omaggio: 0, prezzo: s.prezzo };
            conteggio[s.nome].omaggio += 1;
        });
        
        // Genera testo riepilogo
        const righe = Object.entries(conteggio).map(([nome, data]) => {
            const totale = data.pagate + data.omaggio;
            if (data.omaggio > 0) {
                return `<strong>${totale} ${nome}</strong> (${data.pagate} pagate + ${data.omaggio} omaggio)`;
            }
            return `<strong>${totale} ${nome}</strong>`;
        });
        
        const costoLordo = parseFloat(document.getElementById('costoTotale').value) || 0;
        righe.push(`<br><strong>Prezzo finale: ‚Ç¨${costoLordo.toFixed(2)}</strong> (invariato)`);
        
        riepilogoText.innerHTML = righe.join('<br>');
    }

    // Genera nome pacchetto basato sui servizi (incluse sedute omaggio)
    function updateNomePacchetto() {
        const serviziRaggruppati = {};
        
        // Conta servizi pagati
        serviziSelezionati.forEach(s => {
            if (!serviziRaggruppati[s.nome]) serviziRaggruppati[s.nome] = 0;
            serviziRaggruppati[s.nome] += s.quantita;
        });
        
        // Aggiungi sedute omaggio
        seduteOmaggio.forEach(s => {
            if (!serviziRaggruppati[s.nome]) serviziRaggruppati[s.nome] = 0;
            serviziRaggruppati[s.nome] += 1;
        });
        
        nomePacchetto = Object.entries(serviziRaggruppati).map(([nome, qty]) => `${qty} ${nome}`).join(' + ');
    }

    // Calcola costo scontato
    function updateCostoScontato() {
        const totale = parseFloat(document.getElementById('costoTotale').value) || 0;
        const tipo = document.getElementById('scontoTipo').value;
        
        let scontato = totale;
        
        if (tipo === 'Percentuale') {
            const perc = parseFloat(document.getElementById('scontoPercentuale').value) || 0;
            if (perc > 0) {
                const percNorm = Math.min(Math.max(perc, 0), 100);
                scontato = totale * (1 - percNorm / 100);
            }
        } else if (tipo === 'Ogni_N_Omaggio') {
            // Il prezzo resta INVARIATO - le sedute omaggio sono gratis
            scontato = totale;
        }
        
        // Applica arrotondamento manuale se presente
        if (arrotondamentoManuale === 'floor') {
            scontato = Math.floor(scontato);
        } else if (arrotondamentoManuale === 'ceil') {
            scontato = Math.ceil(scontato);
        }
        
        document.getElementById('costoTotaleScontato').value = scontato.toFixed(2);
        
        // Mostra/nascondi bottoni arrotondamento se ci sono decimali diversi da .00
        // (controlla il valore PRIMA dell'arrotondamento manuale)
        const totalePreArrotondamento = tipo === 'Percentuale' 
            ? (parseFloat(document.getElementById('scontoPercentuale').value) > 0 
                ? totale * (1 - Math.min(Math.max(parseFloat(document.getElementById('scontoPercentuale').value) || 0, 0), 100) / 100)
                : totale)
            : totale;
        
        const hasDecimals = (totalePreArrotondamento * 100) % 100 !== 0;
        const btnRoundDown = document.getElementById('prezzoRoundDownModal');
        const btnRoundUp = document.getElementById('prezzoRoundUpModal');
        
        if (btnRoundDown && btnRoundUp) {
            if (hasDecimals && totalePreArrotondamento > 0 && arrotondamentoManuale === null) {
                btnRoundDown.style.display = '';
                btnRoundUp.style.display = '';
            } else {
                btnRoundDown.style.display = 'none';
                btnRoundUp.style.display = 'none';
            }
        }
    }

    // Carica dropdown clienti
    async function loadClienti() {
        const response = await fetch('/pacchetti/api/clienti?q=');
        const clienti = await response.json();
        const select = document.getElementById('client_id');
        select.innerHTML = '<option value="">Seleziona cliente</option>';
        clienti.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = `${c.nome} ${c.cognome} - ${c.cellulare}`;
            select.appendChild(option);
        });
    }

    // Carica dropdown operatori
    async function loadOperatori() {
        const response = await fetch('/pacchetti/api/operatori?q=');
        const operatori = await response.json();
        const select = document.getElementById('operatoriSelect');
        select.innerHTML = '';
        operatori.forEach(o => {
            const option = document.createElement('option');
            option.value = o.id;
            option.textContent = o.nome;
            select.appendChild(option);
        });
    }

    // Carica pacchetti servizi
    async function loadPacchetti(params = {}) {
        params.tipo = 'servizi';
        const query = new URLSearchParams(params).toString();
        const response = await fetch(`/pacchetti/api/pacchetti?${query}`);
        pacchettiData = await response.json();
        renderPacchetti();
    }

    // Carica carte prepagate
    async function loadPrepagate(params = {}) {
        params.tipo = 'prepagata';
        const query = new URLSearchParams(params).toString();
        const response = await fetch(`/pacchetti/api/pacchetti?${query}`);
        prepagateData = await response.json();
        renderPrepagate();
    }

    // Renderizza carte prepagate
    function renderPrepagate() {
        const tbody = document.getElementById('prepagateTable');
        tbody.innerHTML = '';
        
        const sorted = [...prepagateData].sort((a, b) => {
            let valA = a[currentSortPrepagate.field];
            let valB = b[currentSortPrepagate.field];
            
            if (valA == null) valA = '';
            if (valB == null) valB = '';
            
            if (currentSortPrepagate.field === 'saldo_attuale' || currentSortPrepagate.field === 'credito_iniziale') {
                valA = parseFloat(valA) || 0;
                valB = parseFloat(valB) || 0;
            } else if (currentSortPrepagate.field === 'data_sottoscrizione' || currentSortPrepagate.field === 'data_scadenza') {
                valA = valA ? new Date(valA).getTime() : 0;
                valB = valB ? new Date(valB).getTime() : 0;
            } else if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            
            if (valA < valB) return currentSortPrepagate.direction === 'asc' ? -1 : 1;
            if (valA > valB) return currentSortPrepagate.direction === 'asc' ? 1 : -1;
            return 0;
        });
        
        function formatDataIt(iso) {
            if (!iso) return '';
            const [yyyy, mm, dd] = iso.split('T')[0].split('-');
            const mesi = ['GEN','FEB','MAR','APR','MAG','GIU','LUG','AGO','SET','OTT','NOV','DIC'];
            const nomeMese = mesi[parseInt(mm, 10) - 1] || '';
            return `${dd} ${nomeMese} ${yyyy}`;
        }
        
        sorted.forEach(p => {
            const tr = document.createElement('tr');
            // Usa lo status reale dal backend, fallback alla logica saldo
            const statusRaw = (p.status ?? p.status_value ?? '').toLowerCase();
            const statusKey = statusRaw === 'preventivo' ? 'preventivo' 
                            : (p.saldo_attuale > 0) ? 'attivo' 
                            : 'completato';
            tr.classList.add(`status-${statusKey}`);
            tr.style.cursor = 'pointer';
            tr.onclick = () => { window.location.href = '/pacchetti/detail/' + p.id; };
            
            const beneficiario = p.beneficiario_nome || p.client_nome;
            const scadenza = p.data_scadenza ? formatDataIt(p.data_scadenza) : 'Nessuna';
            
            tr.innerHTML = `
                <td><b>${p.client_nome}</b></td>
                <td>${beneficiario}</td>
                <td>${formatDataIt(p.data_sottoscrizione)}</td>
                <td class="hide-mobile">‚Ç¨${(p.credito_iniziale || 0).toFixed(2)}</td>
                <td><strong>‚Ç¨${(p.saldo_attuale || 0).toFixed(2)}</strong></td>
                <td class="hide-mobile">${scadenza}</td>
                ${userRuolo !== 'user' ? `
                <td class="actions hide-mobile">
                    <button type="button" class="btn btn-danger btn-sm btn-xxs"
                            onclick="event.stopPropagation(); deletePacchetto(${p.id})">Elimina</button>
                </td>
                ` : ''}
            `;
            tbody.appendChild(tr);
        });
    }

    // Ordina e renderizza i pacchetti
    function renderPacchetti() {
        const tbody = document.getElementById('pacchettiTable');
        tbody.innerHTML = '';
        
        // Ordina i dati
        const sorted = [...pacchettiData].sort((a, b) => {
            let valA = a[currentSort.field];
            let valB = b[currentSort.field];
            
            // Gestione null/undefined
            if (valA == null) valA = '';
            if (valB == null) valB = '';
            
            // Confronto numerico per prezzi
            if (currentSort.field === 'costo_totale_lordo' || currentSort.field === 'costo_totale_scontato') {
                valA = parseFloat(valA) || 0;
                valB = parseFloat(valB) || 0;
            }
            // Confronto date
            else if (currentSort.field === 'data_sottoscrizione') {
                valA = valA ? new Date(valA).getTime() : 0;
                valB = valB ? new Date(valB).getTime() : 0;
            }
            // Confronto stringhe (case-insensitive)
            else if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            
            if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
        
        function formatDataIt(iso) {
            if (!iso) return '';
            const [yyyy, mm, dd] = iso.split('T')[0].split('-');
            const mesi = ['GEN','FEB','MAR','APR','MAG','GIU','LUG','AGO','SET','OTT','NOV','DIC'];
            const nomeMese = mesi[parseInt(mm, 10) - 1] || '';
            return `${dd} ${nomeMese} ${yyyy}`;
        }
        
sorted.forEach(p => {
    const tr = document.createElement('tr');
    const statusRaw = (p.status ?? p.status_value ?? p.status_name ?? '');
    const statusKey = String(statusRaw).toLowerCase();
    if (statusKey) tr.classList.add(`status-${statusKey}`);
    tr.dataset.status = statusKey;
    tr.style.cursor = 'pointer';
    tr.onclick = () => { window.location.href = '/pacchetti/detail/' + p.id; };

// Mappa tooltip per status
const statusTooltips = {
    'preventivo': 'Pacchetto in fase di proposta, non ancora iniziato',
    'attivo': 'Pacchetto in corso: almeno 1 seduta effettuata o 1 rata pagata',
    'completato': 'Pacchetto terminato: tutte le sedute e rate completate',
    'abbandonato': 'Pacchetto non modificato da oltre 3 settimane'
};
const statusTooltip = statusTooltips[statusKey] || '';

// Badge "PAGATO" se status attivo e tutte rate pagate
const badgePagato = (statusKey === 'attivo' && p.tutte_rate_pagate === true) 
    ? '<span class="badge badge-pagato" data-bs-toggle="tooltip" title="Tutte le rate sono state pagate">üí∞<span class="badge-text"> PAGATO</span></span>' 
    : '';

// Genera nome con tag (abbreviato)
function generaTag(nome) {
    if (!nome) return '';
    return nome.split(' + ').map(parte => {
        const match = parte.match(/^(\d+)\s+(.+)$/);
        if (match) {
            const qty = match[1];
            const servizio = match[2];
            const tag = servizio.substring(0, 3).toUpperCase();
            return `${qty} ${tag}`;
        }
        return parte.substring(0, 6).toUpperCase();
    }).join(' + ');
}

const nomeTag = p.nome_tags || generaTag(p.nome);

tr.innerHTML = `
    <td>
      <b data-bs-toggle="tooltip" data-bs-placement="top" title="Clicca per vedere i dettagli del pacchetto">${p.client_nome}</b>
    </td>
    <td data-bs-toggle="tooltip" data-bs-placement="top" title="${p.nome}">
      <span class="nome-completo">${p.nome}</span>
      <span class="nome-tag">${nomeTag}</span>
      ${badgePagato}
    </td>
    <td>${formatDataIt(p.data_sottoscrizione)}</td>
    <td class="hide-mobile">‚Ç¨${p.costo_totale_lordo.toFixed(2)}</td>
    <td class="hide-mobile">${p.costo_totale_scontato ? '‚Ç¨' + p.costo_totale_scontato.toFixed(2) : ''}</td>
    ${userRuolo !== 'user' ? `
    <td class="actions hide-mobile">
        <button type="button" class="btn btn-danger btn-sm btn-xxs"
                onclick="event.stopPropagation(); deletePacchetto(${p.id})">Elimina</button>
    </td>
    ` : ''}
`;
tbody.appendChild(tr);

// Reinizializza i tooltip per i nuovi elementi
const tooltips = tr.querySelectorAll('[data-bs-toggle="tooltip"]');
tooltips.forEach(el => new bootstrap.Tooltip(el));
});
    }

    // Gestione click su header per ordinamento
    function setupSorting() {
        document.querySelectorAll('.table thead th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                
                // Toggle direzione se stesso campo, altrimenti asc
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                
                // Aggiorna classi CSS
                document.querySelectorAll('.table thead th.sortable').forEach(t => {
                    t.classList.remove('asc', 'desc');
                });
                th.classList.add(currentSort.direction);
                
                // Re-renderizza
                renderPacchetti();
            });
        });
    }

    // Gestione ordinamento per tab Prepagate
    function setupSortingPrepagate() {
        document.querySelectorAll('#tabellaPrepagate thead th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                
                if (currentSortPrepagate.field === field) {
                    currentSortPrepagate.direction = currentSortPrepagate.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortPrepagate.field = field;
                    currentSortPrepagate.direction = 'asc';
                }
                
                document.querySelectorAll('#tabellaPrepagate thead th.sortable').forEach(t => {
                    t.classList.remove('asc', 'desc');
                });
                th.classList.add(currentSortPrepagate.direction);
                
                renderPrepagate();
            });
        });
    }

    // Ricerca prepagate
    function searchPrepagate() {
        const clienteInput = document.getElementById('searchClientePrepagata');
        const statusSelect = document.getElementById('searchStatusPrepagata');
        
        const params = {};
        
        if (statusSelect && statusSelect.value) {
            params.status = statusSelect.value;
        }
        
        if (clienteInput && clienteInput.dataset.clientId) {
            params.cliente_id = clienteInput.dataset.clientId;
        } else if (clienteInput && clienteInput.value.trim()) {
            params.cliente = clienteInput.value.trim();
        }
        
        loadPrepagate(params);
    }

    // Ricerca pacchetti con filtri concatenati
    function searchPacchetti() {
        const clienteInput = document.getElementById('searchCliente');
        const programmaInput = document.getElementById('searchProgramma');
        const statusSelect = document.getElementById('searchStatus');
        
        const params = {};
        
        // Filtro status
        if (statusSelect.value) {
            params.status = statusSelect.value;
        }
        
        // Filtro cliente
        if (clienteInput.dataset.clientId) {
            params.cliente_id = clienteInput.dataset.clientId;
        } else if (clienteInput.value.trim()) {
            params.cliente = clienteInput.value.trim();
        }
        
        // Filtro nome programma
        if (programmaInput.value.trim()) {
            params.nome = programmaInput.value.trim();
        }
        
        loadPacchetti(params);
    }

    // Apri modal aggiunta
    function openAddModal(tipo = 'servizi') {
        document.getElementById('pacchettoId').value = '';
        document.getElementById('statusDiv').style.display = 'none';
        resetForm();
        loadClienti();
        loadOperatori();
        
        // Se tipo √® prepagata, attiva direttamente quel tab
        if (tipo === 'prepagata') {
            document.getElementById('tipoPrepagata').checked = true;
            toggleTipoPacchetto('prepagata');
            document.getElementById('offcanvasTitle').textContent = 'Crea Carta Prepagata';
        } else {
            document.getElementById('tipoServizi').checked = true;
            toggleTipoPacchetto('servizi');
            document.getElementById('offcanvasTitle').textContent = 'Crea Nuovo Pacchetto';
        }
        
        new bootstrap.Offcanvas(document.getElementById('pacchettoOffcanvas')).show();
    }
    // Ricerca cliente nel modal
    document.getElementById('clientSearch').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            document.getElementById('clientDropdown').style.display = 'none';
            return;
        }
        handleClientSearchPacchetti(query);
    });

    async function handleClientSearchPacchetti(query) {
        try {
            const response = await fetch(`/pacchetti/api/clienti?q=${encodeURIComponent(query)}`);
            const clients = await response.json();
            showClientDropdownPacchetti(clients);
        } catch (error) {
            console.error('Errore ricerca clienti:', error);
        }
    }

    function showClientDropdownPacchetti(clients) {
        const dropdown = document.getElementById('clientDropdown');
        dropdown.innerHTML = '';
        clients.forEach(c => {
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.textContent = `${c.nome} ${c.cognome} - ${c.cellulare}`;
            a.onclick = () => selectClientPacchetti(c.id, `${c.nome} ${c.cognome}`);
            dropdown.appendChild(a);
        });
        dropdown.style.display = 'block';
    }

    function selectClientPacchetti(id, name) {
        document.getElementById('clientSearch').value = name;
        document.getElementById('client_id').value = id;
        document.getElementById('clientDropdown').style.display = 'none';
    }

    // Ricerca beneficiario nel modal (per carte prepagate)
    document.addEventListener('DOMContentLoaded', function() {
        const benefInput = document.getElementById('beneficiarioNome');
        if (!benefInput) return;
        
        // Crea dropdown per beneficiario
        let benefDropdown = document.getElementById('beneficiarioDropdown');
        if (!benefDropdown) {
            benefDropdown = document.createElement('div');
            benefDropdown.id = 'beneficiarioDropdown';
            benefDropdown.style.cssText = 'display:none; max-height:200px; overflow-y:auto; position:absolute; background:#fff; border:1px solid #ccc; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.2); z-index:1000; width:100%;';
            benefInput.parentElement.style.position = 'relative';
            benefInput.parentElement.appendChild(benefDropdown);
        }
        
        // Variabile per salvare l'ID del beneficiario selezionato
        window.beneficiarioClientId = null;
        
        benefInput.addEventListener('input', function() {
            const query = this.value.trim();
            window.beneficiarioClientId = null; // Reset quando si digita
            if (query.length < 2) {
                benefDropdown.style.display = 'none';
                return;
            }
            fetch('/pacchetti/api/clienti?q=' + encodeURIComponent(query))
                .then(res => res.json())
                .then(clients => {
                    benefDropdown.innerHTML = '';
                    clients.forEach(c => {
                        const a = document.createElement('a');
                        a.href = '#';
                        a.className = 'dropdown-item';
                        a.textContent = c.nome + ' ' + c.cognome + (c.cellulare ? ' (' + c.cellulare + ')' : '');
                        a.addEventListener('click', function(e) {
                            e.preventDefault();
                            benefInput.value = c.nome + ' ' + c.cognome;
                            window.beneficiarioClientId = c.id;
                            benefDropdown.style.display = 'none';
                        });
                        benefDropdown.appendChild(a);
                    });
                    benefDropdown.style.display = clients.length ? 'block' : 'none';
                });
        });
        
        // Chiudi dropdown beneficiario se clicchi fuori
        document.addEventListener('click', function(e) {
            if (!benefInput.contains(e.target) && !benefDropdown.contains(e.target)) {
                benefDropdown.style.display = 'none';
            }
        });
    });

    // Ricerca cliente nella pagina principale
    document.getElementById('searchCliente').addEventListener('input', function () {
        delete this.dataset.clientId;
        const query = this.value.trim();
        if (query.length < 2) {
            document.getElementById('searchClienteDropdown').style.display = 'none';
            return;
        }
        handleTopClientSearchPacchetti(query);
    });

    async function handleTopClientSearchPacchetti(query) {
        try {
            const response = await fetch(`/pacchetti/api/clienti?q=${encodeURIComponent(query)}`);
            const clients = await response.json();
            showTopClientDropdownPacchetti(clients);
        } catch (error) {
            console.error('Errore ricerca clienti (top):', error);
        }
    }

    function showTopClientDropdownPacchetti(clients) {
        const dropdown = document.getElementById('searchClienteDropdown');
        dropdown.innerHTML = '';
        clients.forEach(c => {
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.textContent = `${c.nome} ${c.cognome} - ${c.cellulare}`;
            a.onclick = (e) => { e.preventDefault(); selectTopClientPacchetti(c.id, `${c.nome} ${c.cognome}`); };
            dropdown.appendChild(a);
        });
        dropdown.style.display = 'block';
    }

    function selectTopClientPacchetti(id, name) {
        const input = document.getElementById('searchCliente');
        input.value = name;
        input.dataset.clientId = String(id);
        document.getElementById('searchClienteDropdown').style.display = 'none';
        searchPacchetti();
    }

    // Ricerca programma nella pagina principale
    document.getElementById('searchProgramma').addEventListener('input', function () {
        const query = this.value.trim();
        if (query.length < 3) {
            document.getElementById('searchProgrammaDropdown').style.display = 'none';
            return;
        }
        handleProgrammaSearch(query);
    });

    async function handleProgrammaSearch(query) {
        try {
            const response = await fetch(`/pacchetti/api/servizi?q=${encodeURIComponent(query)}`);
            const servizi = await response.json();
            showProgrammaDropdown(servizi);
        } catch (error) {
            console.error('Errore ricerca programmi:', error);
        }
    }

    function showProgrammaDropdown(servizi) {
        const dropdown = document.getElementById('searchProgrammaDropdown');
        dropdown.innerHTML = '';
        
        // Estrai nomi unici dei servizi
        const nomiUnici = [...new Set(servizi.map(s => s.nome))];
        
        nomiUnici.forEach(nome => {
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.textContent = nome;
            a.onclick = (e) => { 
                e.preventDefault(); 
                selectProgramma(nome); 
            };
            dropdown.appendChild(a);
        });
        dropdown.style.display = nomiUnici.length > 0 ? 'block' : 'none';
    }

    function selectProgramma(nome) {
        document.getElementById('searchProgramma').value = nome;
        document.getElementById('searchProgrammaDropdown').style.display = 'none';
        searchPacchetti();
    }

    // Chiudi dropdown programma se clicchi fuori
    document.addEventListener('click', function(e) {
        const input = document.getElementById('searchProgramma');
        const dropdown = document.getElementById('searchProgrammaDropdown');
        if (input && dropdown && !input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    // Trigger ricerca automatica quando si cambia status
    document.getElementById('searchStatus').addEventListener('change', function() {
        searchPacchetti();
    });

    // Ricerca servizio
    document.getElementById('serviceSearch').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            document.getElementById('serviceDropdown').style.display = 'none';
            return;
        }
        handleServiceSearchPacchetti(query);
    });

    async function handleServiceSearchPacchetti(query) {
        try {
            const response = await fetch(`/pacchetti/api/servizi?q=${encodeURIComponent(query)}`);
            const servizi = await response.json();
            showServiceDropdownPacchetti(servizi);
        } catch (error) {
            console.error('Errore ricerca servizi:', error);
        }
    }

    function showServiceDropdownPacchetti(servizi) {
        const dropdown = document.getElementById('serviceDropdown');
        dropdown.innerHTML = '';
        servizi.forEach(s => {
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.textContent = `${s.nome} (${s.categoria}) - ‚Ç¨${s.prezzo}`;
            a.onclick = () => selectServicePacchetti(s.id, s.nome, s.prezzo);
            dropdown.appendChild(a);
        });
        dropdown.style.display = 'block';
    }

    function selectServicePacchetti(id, nome, prezzo) {
        document.getElementById('serviceSearch').value = nome;
        document.getElementById('serviceSearch').dataset.serviceId = id;
        document.getElementById('serviceSearch').dataset.prezzo = prezzo;
        document.getElementById('serviceDropdown').style.display = 'none';
    }

    // Aggiungi servizio alla lista
    function addService() {
        const searchInput = document.getElementById('serviceSearch');
        const quantita = parseInt(document.getElementById('serviceQuantita').value);
        if (!searchInput.dataset.serviceId || !quantita) return;
        
        const service = {
            id: searchInput.dataset.serviceId,
            nome: searchInput.value.split(' (')[0], // Prende solo il nome
            prezzo: parseFloat(searchInput.dataset.prezzo),
            quantita: quantita
        };
        serviziSelezionati.push(service);
        
        arrotondamentoManuale = null; // Reset arrotondamento quando si aggiunge servizio
        updateServiziList();
        updateCostoTotale();
        updateNomePacchetto();
        updateScontoState();

    // AGGIORNA MAX OMAGGI CONSENTITI
    const totaleSedutePagate = serviziSelezionati.reduce((sum, s) => sum + s.quantita, 0);
    const maxOmaggi = totaleSedutePagate > 0 ? totaleSedutePagate - 1 : 0;
    document.getElementById('numeroSeduteOmaggio').setAttribute('max', maxOmaggi);
        
        // Rigenera le righe omaggio se necessario
        if (document.getElementById('scontoTipo').value === 'Ogni_N_Omaggio') {
            generateSeduteOmaggioRows();
        }
        
        searchInput.value = '';
        delete searchInput.dataset.serviceId;
        delete searchInput.dataset.prezzo;
        document.getElementById('serviceQuantita').value = '';
    }

// Aggiorna lista servizi
function updateServiziList() {
    const list = document.getElementById('serviziList');
    list.innerHTML = '';
    serviziSelezionati.forEach((s, i) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = `${s.quantita}x ${s.nome} - ‚Ç¨${(s.prezzo * s.quantita).toFixed(2)}`;
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-sm btn-danger';
        removeBtn.textContent = 'Rimuovi';
        removeBtn.onclick = () => removeService(i);
        li.appendChild(removeBtn);
        list.appendChild(li);
    });
    
    // AGGIORNA IL DROPDOWN SCONTO DOPO OGNI MODIFICA
    updateScontoDropdown();
}

// Rimuovi servizio
function removeService(index) {
    serviziSelezionati.splice(index, 1);
    arrotondamentoManuale = null; // Reset arrotondamento quando si rimuove servizio
    updateServiziList();
    updateCostoTotale();
    updateNomePacchetto();
    updateScontoState();
    
    // AGGIORNA MAX OMAGGI CONSENTITI
    const totaleSedutePagate = serviziSelezionati.reduce((sum, s) => sum + s.quantita, 0);
    const maxOmaggi = totaleSedutePagate > 0 ? totaleSedutePagate - 1 : 0;
    document.getElementById('numeroSeduteOmaggio').setAttribute('max', maxOmaggi);
    
    // Rigenera le righe omaggio
    if (document.getElementById('scontoTipo').value === 'Ogni_N_Omaggio') {
        generateSeduteOmaggioRows();
    }
}

    // Aggiorna costo totale
    function updateCostoTotale() {
        const totale = serviziSelezionati.reduce((sum, s) => sum + (s.prezzo * s.quantita), 0);
        document.getElementById('costoTotale').value = totale.toFixed(2);
        updateCostoScontato();
    }

// Event listener per numero sedute omaggio con validazione
document.getElementById('numeroSeduteOmaggio').addEventListener('input', function() {
    const totaleSedutePagate = serviziSelezionati.reduce((sum, s) => sum + s.quantita, 0);
    const maxOmaggi = totaleSedutePagate > 0 ? totaleSedutePagate - 1 : 0;
    
    // Imposta max dinamico sull'input
    this.setAttribute('max', maxOmaggi);
    
    // Se supera il massimo, correggi automaticamente
    const valore = parseInt(this.value) || 0;
    if (valore > maxOmaggi) {
        this.value = maxOmaggi;
    }
    
    arrotondamentoManuale = null; // Reset arrotondamento quando cambiano le sedute omaggio
    generateSeduteOmaggioRows();
    updateCostoScontato();
});

    // Event listener per percentuale sconto
    document.getElementById('scontoPercentuale').addEventListener('input', function() {
        arrotondamentoManuale = null; // Reset arrotondamento quando cambia la percentuale
        updateCostoScontato();
    });

    // Listener per arrotondamento prezzo scontato nel modal
    const prezzoRoundDownModal = document.getElementById('prezzoRoundDownModal');
    const prezzoRoundUpModal = document.getElementById('prezzoRoundUpModal');

    if (prezzoRoundDownModal) {
        prezzoRoundDownModal.addEventListener('click', function() {
            arrotondamentoManuale = 'floor';
            updateCostoScontato(); // Ricalcola applicando l'arrotondamento per difetto
        });
    }

    if (prezzoRoundUpModal) {
        prezzoRoundUpModal.addEventListener('click', function() {
            arrotondamentoManuale = 'ceil';
            updateCostoScontato(); // Ricalcola applicando l'arrotondamento per eccesso
        });
    }

    // Lock globale per salvare pacchetto
    let savePacchettoLock = false;

    // Salva pacchetto
    async function savePacchetto() {
        // Protezione contro click multipli
        if (savePacchettoLock) {
            console.log('Salvataggio pacchetto gi√† in corso, operazione ignorata');
            return;
        }

        // Determina il tipo di pacchetto
        const tipoPacchetto = document.querySelector('input[name="tipoPacchetto"]:checked').value;
        
        let data;
        
        if (tipoPacchetto === 'prepagata') {
            // CARTA PREPAGATA
            const importoPagamento = parseFloat(document.getElementById('importoPagamento').value);
            const creditoTotale = parseFloat(document.getElementById('creditoTotaleCalcolato').value);
            
            if (!importoPagamento || importoPagamento <= 0) {
                alert('Inserisci un importo da pagare valido');
                return;
            }
            if (!creditoTotale || creditoTotale <= 0) {
                alert('Il credito totale deve essere maggiore di zero');
                return;
            }
            
            data = {
                client_id: document.getElementById('client_id').value,
                tipo: 'prepagata',
                nome: 'Carta Prepagata',
                credito_iniziale: creditoTotale,
                importo_pagamento: importoPagamento,
                beneficiario_nome: document.getElementById('beneficiarioNome').value.trim() || null,
                beneficiario_client_id: window.beneficiarioClientId || null,
                data_scadenza: document.getElementById('dataScadenzaPrepagata').value || null,
                costo_totale: importoPagamento,
                servizi: [],
                sconto_tipo: '',
                pagamento_tipo: 'saldo',
                numero_rate: 1,
                operatori: [],
                vincoli_utilizzo: getVincoliUtilizzo()
            };
        } else {
            // PACCHETTO SERVIZI (logica esistente)
            const tipo = document.getElementById('scontoTipo').value;
            
            // Costruisci array servizi finali
            const serviziFinali = serviziSelezionati.map(s => ({ 
                id: s.id, 
                quantita: s.quantita, 
                omaggio: false 
            }));
            
            // Aggiungi sedute omaggio se applicabile (anche per promo salvate di tipo sedute_omaggio)
            if (tipo === 'Ogni_N_Omaggio' || (tipo.startsWith('promo_') && seduteOmaggio.length > 0)) {
                seduteOmaggio.forEach(s => {
                    serviziFinali.push({ 
                        id: s.serviceId, 
                        quantita: 1, 
                        omaggio: true 
                    });
                });
            }

            data = {
                client_id: document.getElementById('client_id').value,
                tipo: 'servizi',
                nome: nomePacchetto,
                servizi: serviziFinali,
                costo_totale: parseFloat(document.getElementById('costoTotale').value),
                sconto_tipo: tipo,
                sconto_valore: tipo === 'Percentuale' 
                    ? (parseFloat(document.getElementById('scontoPercentuale').value) || null)
                    : (parseInt(document.getElementById('numeroSeduteOmaggio').value) || null),
                pagamento_tipo: 'saldo',
                numero_rate: 1,
                operatori: Array.from(document.getElementById('operatoriSelect').selectedOptions).map(o => parseInt(o.value)),
                costo_scontato: parseFloat(document.getElementById('costoTotaleScontato').value) || null
            };
        }

        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        const id = document.getElementById('pacchettoId').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/pacchetti/api/pacchetti/${id}` : '/pacchetti/api/pacchetti';

        // Attiva il lock
        savePacchettoLock = true;

        // Disabilita visivamente il pulsante Salva
        const btnSalva = document.querySelector('#pacchettoOffcanvas .btn-primary');
        const originalText = btnSalva ? btnSalva.textContent : '';
        if (btnSalva) {
            btnSalva.disabled = true;
            btnSalva.textContent = 'Salvataggio...';
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                const result = await response.json();
                // Chiudi l'offcanvas invece del modal
                const offcanvasElement = document.getElementById('pacchettoOffcanvas');
                const offcanvasInstance = bootstrap.Offcanvas.getInstance(offcanvasElement);
                if (offcanvasInstance) {
                    offcanvasInstance.hide();
                }
                
                // Redirect alla pagina dettaglio del pacchetto
                const pacchettoId = id || result.id;
                window.location.href = `/pacchetti/detail/${pacchettoId}`;
            } else {
                alert('Errore nel salvataggio');
                // Rilascia il lock in caso di errore
                savePacchettoLock = false;
                if (btnSalva) {
                    btnSalva.disabled = false;
                    btnSalva.textContent = originalText;
                }
            }
        } catch (error) {
            console.error('Errore salvataggio pacchetto:', error);
            alert('Errore nel salvataggio');
            // Rilascia il lock in caso di errore
            savePacchettoLock = false;
            if (btnSalva) {
                btnSalva.disabled = false;
                btnSalva.textContent = originalText;
            }
        }
    }

    // Delete pacchetto
    async function deletePacchetto(id) {
        if (confirm('Confermi eliminazione?')) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            await fetch(`/pacchetti/api/pacchetti/${id}`, { method: 'DELETE', headers: { 'X-CSRFToken': csrfToken } });
            loadPacchetti();
            loadPrepagate();
            location.reload();
        }
    }

    // Reset form
    function resetForm() {
        document.getElementById('pacchettoForm').reset();
        serviziSelezionati = [];
        seduteOmaggio = [];
        nomePacchetto = '';
        tipoPacchettoCorrente = 'servizi';
        document.getElementById('clientSearch').value = '';
        document.getElementById('serviceSearch').value = '';
        document.getElementById('clientDropdown').style.display = 'none';
        document.getElementById('serviceDropdown').style.display = 'none';
        document.getElementById('scontoTipo').value = '';
        document.getElementById('scontoTipo').disabled = true;
        document.getElementById('scontoHint').style.display = '';
        document.getElementById('scontoPercentualeFields').style.display = 'none';
        document.getElementById('scontoOmaggioFields').style.display = 'none';
        document.getElementById('riepilogoSeduteDiv').style.display = 'none';
        document.getElementById('seduteOmaggioContainer').innerHTML = '';
        
        // Reset campi prepagata
        document.getElementById('importoPagamento').value = '';
        document.getElementById('tipoBonusPrepagata').value = 'nessuno';
        document.getElementById('valoreBonusPrepagata').value = '';
        document.getElementById('valoreBonusPrepagata').style.display = 'none';
        document.getElementById('arrotondamentoBonusPrepagata').value = 'nessuno';
        document.getElementById('arrotondamentoBonusPrepagata').style.display = 'none';
        document.getElementById('creditoTotaleCalcolato').value = '';
        creditoManualeSbloccato = false;
        document.getElementById('creditoTotaleCalcolato').readOnly = true;
        document.getElementById('creditoTotaleCalcolato').style.backgroundColor = '#e9ecef';
        document.getElementById('beneficiarioNome').value = '';
        window.beneficiarioClientId = null;
        document.getElementById('dataScadenzaPrepagata').value = '';
        document.getElementById('sezioneServiziCampi').style.display = 'block';
        document.getElementById('sezionePrepagataCampi').style.display = 'none';
        document.getElementById('tipoServizi').checked = true;
        
        // Reset vincoli prepagata
        document.getElementById('vincoloTipo').value = 'tutti';
        document.getElementById('vincoloCategoriaField').style.display = 'none';
        document.getElementById('vincoloSottocategoriaField').style.display = 'none';
        document.getElementById('vincoloServiziField').style.display = 'none';
        vincoloServiziSelezionati = [];
        document.getElementById('vincoloServiziList').innerHTML = '';
        
        updateServiziList();
        updateCostoTotale();
    }

function deselezionaOperatori() {
    const select = document.getElementById('operatoriSelect');
    if (!select) return;
    Array.from(select.options).forEach(o => o.selected = false);
}

// Funzione per aprire il modal di aggiunta cliente
function openAddClientModalPacchetti() {
    const modalElement = document.getElementById('AddClientModalPacchetti');
    if (!modalElement) {
        console.error("Elemento '#AddClientModalPacchetti' non trovato nel DOM.");
        return;
    }
    
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Reset del form
    document.getElementById('AddClientFormPacchetti').reset();
}

// Handler per il submit del form di aggiunta cliente
document.addEventListener('DOMContentLoaded', function() {
    const addClientForm = document.getElementById('AddClientFormPacchetti');
    if (addClientForm) {
        addClientForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nome = document.getElementById('cliente_nome_pacchetti').value.trim();
            const cognome = document.getElementById('cliente_cognome_pacchetti').value.trim();
            const cellulare = document.getElementById('cliente_cellulare_pacchetti').value.trim();
            
            if (!nome || !cognome || !cellulare) {
                alert('Tutti i campi sono obbligatori');
                return;
            }
            
            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const response = await fetch('/clients/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        cliente_nome: nome,
                        cliente_cognome: cognome,
                        cliente_cellulare: cellulare
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Chiudi il modal
                    const modalElement = document.getElementById('AddClientModalPacchetti');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();
                    
                    // Popola il campo di ricerca con il nuovo cliente
                    document.getElementById('clientSearch').value = `${nome} ${cognome}`;
                    document.getElementById('client_id').value = data.client_id;
                    
                    alert('Cliente aggiunto con successo!');
                } else {
                    alert('Errore: ' + (data.message || 'Impossibile aggiungere il cliente'));
                }
            } catch (error) {
                console.error('Errore durante l\'aggiunta del cliente:', error);
                alert('Errore durante l\'aggiunta del cliente');
            }
        });
    }
});
</script>

<script>
// Disabilita tooltip su schermi < 1200px
(function() {
    function handleTooltips() {
        const isMobile = window.innerWidth < 1200;
        
        if (isMobile) {
            // Distruggi tutti i tooltip esistenti
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                const tooltip = bootstrap.Tooltip.getInstance(el);
                if (tooltip) {
                    tooltip.dispose();
                }
                // Rimuovi l'attributo per evitare reinizializzazione
                el.removeAttribute('data-bs-toggle');
                el.setAttribute('data-tooltip-disabled', 'true');
            });
        } else {
            // Reinizializza tooltip se tornati a desktop
            document.querySelectorAll('[data-tooltip-disabled="true"]').forEach(el => {
                el.setAttribute('data-bs-toggle', 'tooltip');
                el.removeAttribute('data-tooltip-disabled');
                new bootstrap.Tooltip(el);
            });
        }
    }
    
    // Esegui al caricamento
    document.addEventListener('DOMContentLoaded', handleTooltips);
    
    // Esegui al resize (con debounce)
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(handleTooltips, 250);
    });
})();
</script>
<script src="{{ url_for('static', filename='js/app_tour.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        checkAutoTour('pacchetti');
    });
</script>
{% endblock %}