{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
<!-- NAVIGAZIONE CALENDARIO -->
<div class="calendar-navigation sticky-nav">
    <!-- Freccia sinistra (giorno precedente) -->
    <a href="#" id="reportPrevDay" class="arrow-nav">&lt;</a>
    <!-- Campo data visibile con giorno della settimana -->
    <div class="calendar-date-container">
        <input type="text"
       id="reportDate"
       class="calendar-date-input"
       value="{{ selected_date_str }}">
        <span id="reportDayOfWeek"></span>
    </div>
    <!-- Freccia destra (giorno successivo) -->
    <a href="#" id="reportNextDay" class="arrow-nav">&gt;</a>
    <!-- Pulsante per tornare a oggi: visualizza solo se la data corrente non √® quella odierna -->
    <div class="nav-today">
        <a href="#" id="reportBtnToday" class="btn-today" style="display:none;">Vai a OGGI</a>
    </div>
</div>
</div>

<!-- NUOVA TABELLA MOBILE DATE-NAV (<1200px): visibile solo su mobile -->
<div class="mobile-date-nav" id="mobileDateNavReport" style="display:none; position:fixed; top: var(--mobile-header-height, 56px); left:0; right:0; width:100vw; max-width:100vw; min-width:100vw; padding:0 3px; box-sizing:border-box;">
  <table aria-label="Navigazione data (mobile)" style="width:100%; table-layout:fixed; border-collapse:collapse;">
    <tr>
      <td class="cell-arrow">
        <a href="#" id="mPrevDayReport" class="arrow-nav" aria-label="Giorno precedente">&lt;</a>
      </td>
      <td class="cell-date" style="padding-right:4px;">
        <span id="mobileDateFormattedReport" style="display:inline-block; margin-right:2px;">-- --- ----</span>
      </td>
      <td class="cell-cal" style="padding-left:2px; text-align:center;">
        <a href="#"
           id="mobileCalIconReport"
           aria-label="Apri calendario"
           title="Apri calendario"
           style="display:none;">üìÖ</a>
        <input type="date"
               id="mobileCalDate"
               value="{{ selected_date_str }}"
               aria-label="Seleziona data"
               title="Seleziona data"
               style="margin-left:0; width:34px; height:34px; display:inline-block; background-position:center center !important; background-repeat:no-repeat !important; background-size:18px 18px !important; text-indent:-9999px;"/>
      </td>
      <td class="cell-arrow">
        <a href="#" id="mNextDayReport" class="arrow-nav" aria-label="Giorno successivo">&gt;</a>
      </td>
      <td class="cell-dow">
        <span id="mobileDayOfWeekReport">---</span>
      </td>
      <td class="cell-today">
        <a href="#"
           id="mBtnTodayReport"
           class="btn-today"
           style="display:none;">Vai a OGGI</a>
      </td>
    </tr>
  </table>
</div>

<script>
// Mobile date-nav: replica logica calendar (client-side) senza redirect
document.addEventListener('DOMContentLoaded', function() {
  try {
    const mobileInput = document.getElementById('mobileCalDate');
    const desktopInput = document.getElementById('reportDate');
    const prevBtn = document.getElementById('mPrevDayReport');
    const nextBtn = document.getElementById('mNextDayReport');
    const todayBtn = document.getElementById('mBtnTodayReport');
    const fmtSpan = document.getElementById('mobileDateFormattedReport');
    const dowSpan = document.getElementById('mobileDayOfWeekReport');
    const calAnchor = document.getElementById('mobileCalIconReport');

    const mesiShort = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    const giorni = ['DOM','LUN','MAR','MER','GIO','VEN','SAB'];

    function formatDate(v) {
      const [y,m,d] = (v||'').split('-').map(n => parseInt(n,10));
      if (!y||!m||!d) return '-- --- ----';
      return `${String(d).padStart(2,'0')} ${mesiShort[m-1]||'---'} ${y}`;
    }
    function formatDOW(v) {
      const dt = new Date(v);
      return isNaN(dt) ? '---' : giorni[dt.getDay()];
    }
    function todayYMD() {
      const t = new Date();
      return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
    }
    function updateLabels(val) {
      const v = val || mobileInput.value || todayYMD();
      if (fmtSpan) fmtSpan.textContent = formatDate(v);
      if (dowSpan) dowSpan.textContent = formatDOW(v);
      const isToday = v === todayYMD();
      if (todayBtn) todayBtn.style.display = isToday ? 'none' : '';
    }
    function setDateAll(v) {
      if (!v) return;
      // desktop flatpickr
      if (desktopInput && desktopInput._flatpickr) {
        desktopInput._flatpickr.setDate(v, true);
      } else if (desktopInput) {
        desktopInput.value = v;
        desktopInput.dispatchEvent(new Event('change'));
      }
      if (mobileInput && mobileInput.value !== v) {
        mobileInput.value = v;
      }
      updateLabels(v);
      if (typeof triggerReportReload === 'function') triggerReportReload();
      if (typeof aggiornaBtnOggi === 'function') aggiornaBtnOggi();
      if (typeof aggiornaGiornoSettimana === 'function') aggiornaGiornoSettimana();
    }
    function shiftDays(base, delta) {
      const d = new Date(base);
      d.setDate(d.getDate()+delta);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    // Init labels
    updateLabels(desktopInput ? desktopInput.value : mobileInput.value);

    // Sync desktop -> mobile labels when desktop changes
    if (desktopInput) {
      desktopInput.addEventListener('change', () => {
        const v = desktopInput.value || todayYMD();
        if (mobileInput && mobileInput.value !== v) mobileInput.value = v;
        updateLabels(v);
      });
    }

    // Mobile change
    if (mobileInput) {
      mobileInput.addEventListener('change', function() {
        const v = (this.value||'').trim();
        if (!v) return;
        setDateAll(v);
      });
      mobileInput.addEventListener('click', function() {
        if (typeof mobileInput.showPicker === 'function') {
          try { mobileInput.showPicker(); } catch(_) {}
        }
      });
    }

    // Prev / Next / Today (client-side)
    if (prevBtn) prevBtn.addEventListener('click', e => {
      e.preventDefault();
      const base = (desktopInput && desktopInput.value) || todayYMD();
      setDateAll(shiftDays(base, -1));
    });
    if (nextBtn) nextBtn.addEventListener('click', e => {
      e.preventDefault();
      const base = (desktopInput && desktopInput.value) || todayYMD();
      setDateAll(shiftDays(base, +1));
    });
    if (todayBtn) todayBtn.addEventListener('click', e => {
      e.preventDefault();
      setDateAll(todayYMD());
    });

    // Nascondi anchor icona (coerenza calendar)
    if (calAnchor) calAnchor.style.display = 'none';
  } catch(err) {
    console.warn('mobile nav report error', err);
  }
});
</script>

<div class="page-wide-90 mt-4">
<br><br>
<!-- Barra superiore filtri -->
<div class="d-flex align-items-center mb-3" style="margin-top: +5px;">
  <h3>REPORT</h3>
<div id="report-filtri-avanzati" style="display: none">
  <div class="d-flex align-items-center gap-3 flex-wrap">
    <label for="dateFrom" class="form-label mb-0">&nbsp;&nbsp;&nbsp;Da</label>
    <input type="date" id="dateFrom" class="form-contrl" style="max-width: 130px;">
    <label for="dateTo" class="form-label mb-0 ms-2">A</label>
    <input type="date" id="dateTo" class="form-control" style="max-width: 130px;">
   <button class="btn ms-1" id="btnOggi" style="background-color: #f3f4f7; color: #333; border: 1px solid #ccc;">
  Oggi
</button>
<input
  type="text"
  id="meseSelect"
  class="form-control d-inline-block"
  style="width: 100px; cursor:pointer; margin-right:0; margin-left:0; border-top-right-radius: 0; border-bottom-right-radius: 0;"
  readonly
  placeholder="Mese"
  data-bs-toggle="dropdown">
<ul class="dropdown-menu" id="meseDropdown"></ul>
<input
  type="text"
  id="annoSelect"
  class="form-control d-inline-block"
  style="width: 80px; cursor:pointer; margin-left:-1px; margin-right:0; border-top-left-radius: 0; border-bottom-left-radius: 0;"
  readonly
  placeholder="Anno"
  data-bs-toggle="dropdown">
<ul class="dropdown-menu" id="annoDropdown"></ul>
    <button class="btn btn-primary ms-3" id="btnVaiFiltri">VAI</button>
    <div id="reportLoader" class="ms-3" style="display:none;">
  <div class="spinner-border text-primary" role="status" style="width: 1.8rem; height: 1.8rem;">
    <span class="visually-hidden">Caricamento...</span>
  </div>
</div>
  </div>
</div>
</div>

<!-- Modifica i pulsanti modali per NON aprire pi√π i modali direttamente -->
 
<div class="d-flex gap-1 mb-4 position-relative report-top-buttons">
  <div class="report-actions d-flex gap-1">
    <button class="btn-neumorphic btn-blue" id="btnCorrispettivi">Corrispettivi</button>
    {% if current_user.ruolo|string != 'RuoloUtente.user' %}
    <button class="btn-neumorphic btn-green" id="btnIncassoCategoria">Incasso per categoria</button>
    <button class="btn-neumorphic btn-orange" id="btnPassaggiCassa">Passaggi cassa</button>
    <button class="btn-neumorphic btn-red" id="btnClienti">Clienti</button>
    <button class="btn-neumorphic btn-purple" id="btnOperatori">Operatori</button>
    {% endif %}
  </div>

  <button class="btn-neumorphic btn-settings"
          id="btnSettings"
          title="Settaggi"
          style="position: absolute; top: 0px; right: 20px; z-index: 0;">
    <i class="bi bi-gear" style="font-size: 1.5em;"></i>
  </button>
</div>

<!-- KPI Cards Row -->
<div class="kpi-cards-container">
  <div class="kpi-card success">
    <i class="bi bi-currency-euro kpi-icon"></i>
    <div class="kpi-content">
      <div class="kpi-value" id="kpi-ricavi">‚Ç¨ 0</div>
      <div class="kpi-label">Incasso totale oggi</div>
      <div class="kpi-trend" id="kpi-ricavi-trend">-</div>
    </div>
  </div>
  
<div class="kpi-card">
  <i class="bi bi-people kpi-icon"></i>
  <div class="kpi-content">
    <div class="kpi-value" id="kpi-clienti">0</div>
    <div class="kpi-label">Passaggi in Cassa</div>
    <div class="kpi-trend kpi-trend-azzurro" id="kpi-clienti-trend">-</div>
  </div>
</div>
  
  <div class="kpi-card warning">
    <i class="bi bi-clock kpi-icon"></i>
    <div class="kpi-content">
      <div class="kpi-value" id="kpi-noshow">0</div>
      <div class="kpi-label">No-Show</div>
      <div class="kpi-trend" id="kpi-noshow-trend">-</div>
    </div>
  </div>
  
  <div class="kpi-card primary">
    <i class="bi bi-graph-up kpi-icon"></i>
    <div class="kpi-content">
      <div class="kpi-value" id="kpi-completamento">0%</div>
      <div class="kpi-label">Tasso Completamento</div>
      <div class="kpi-trend" id="kpi-completamento-trend">-</div>
    </div>
  </div>
</div>

<div class="report-tiles-grid" id="report-tiles-grid">
<div class="tile-neumorphic tile-large" id="tile-stats-oggi">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; left:10px; z-index:2;"></button>
  <div class="tile-title">
    INCASSO TOTALE del
    <span id="stat-incasso-data" style="margin-left:2px;"></span>
  </div>
    <span class="stat-euro fs-3 ms-2" id="stat-incasso-oggi">
      ‚Ç¨ {{ "%.2f"|format(totale) }}
    </span>
<div class="mt-1 mb-1" style="font-size:1.1rem; color:#555;">
  di cui <strong>Servizi</strong> (<span id="stat-servizi-oggi">‚Ç¨ {{ "%.2f"|format(totale_servizi) }}</span>) e <strong>Prodotti</strong> (<span id="stat-prodotti-oggi">‚Ç¨ {{ "%.2f"|format(totale_prodotti) }}</span>)
</div>
  <div class="d-flex align-items-center justify-content-center" style="gap: 22px;">
    <div style="text-align:left;">
      <div class="stat-voce"><strong>Contanti: </strong><span id="stat-cash-oggi">‚Ç¨ {{ "%.2f"|format(totale_cash) }}</span></div>
      <div class="stat-voce"><strong>POS: </strong><span id="stat-pos-oggi">‚Ç¨ {{ "%.2f"|format(totale_pos) }}</span></div>
      <div class="stat-voce"><strong>Altro: </strong><span id="stat-altro-oggi">‚Ç¨ {{ "%.2f"|format(totale_altro) }}</span></div>
      <br>
<div class="stat-voce" id="stat-incasso-fiscale">
  FISCALI: (<span class="stat-euro" id="stat-incasso-fiscale-euro"></span>)<br>
</div>
<div class="stat-voce" id="stat-incasso-test"></div>
  TEST: (<span class="stat-euro" id="stat-incasso-test-euro"></span>)
</div>

    <div class="my-3">
      <canvas id="piePagamenti" width="180" height="180"></canvas>
    </div>
  </div>
</div>
<div class="tile-neumorphic tile-large" id="tile-appuntamenti">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:10px; z-index:2;"></button>
  <div class="tile-title">
    APPUNTAMENTI CONCLUSI
  </div>
  <div class="fs-3">
    <span id="stat-app-completati">{{ completati }}</span> su <span id="stat-app-totali">{{ totali }}</span>
  </div>

  <!-- Barra di progresso -->
<div class="progress-container mt-3 mb-3">
  <div class="progress-bar-custom">
    <div class="progress-fill-completati" id="progress-completati"></div>
    <div class="progress-fill-noshow" id="progress-noshow"></div>
  </div>
  <div class="progress-labels mt-2">
    <span class="label-completati">‚úÖ Completati</span>
    <span class="label-noshow">‚ùå No-show</span>
    <span class="label-rimanenti">‚è≥ In attesa</span>
  </div>
</div>

  <div class="stat-voce text-danger">
    <span id="stat-app-noshow">{{ noshow }}</span> no-show
  </div>
  <div id="appuntamenti-presi-titolo" style="font-weight:600; font-size:1.15em; margin-top: 10px;">
  Appuntamenti presi oggi
 </div>
<div class="fs-3">
  <span id="stat-app-presi-totale">-</span>
</div>
  <div class="stat-voce">
    A mano da gestionale: <span id="stat-app-presi-gestionale">-</span>
  </div>
  <div class="stat-voce">
    Via web booking: <span id="stat-app-presi-web">-</span>
  </div>
</div>
  <div class="tile-neumorphic tile-large" id="tile-incasso-stimato">
    <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:10px; z-index:2;"></button>
  <div class="tile-title">
    INCASSO STIMATO
  </div>
  <div class="fs-3">
    <span id="stat-incasso-stimato-totale">-</span>
  </div>
  <div class="stat-voce">
    TOT stimato Solarium: <span id="stat-incasso-stimato-solarium">-</span>
  </div>
  <div class="stat-voce">
    TOT stimato Estetica: <span id="stat-incasso-stimato-estetica">-</span>
  </div>
<div id="meteo-icona-oggi" style="margin-top: 10px;"></div>
</div>

<div class="tile-neumorphic tile-large" id="tile-top-clienti">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:10px; z-index:2;"></button>
  <div class="tile-title" id="top-clienti-title">TOP CLIENTI</div>
  <ul class="list-group list-group-flush" id="top-clienti-list" style="width: 100%; text-align: center;">
    <!-- Popolato via JS -->
  </ul>
</div>

<div class="tile-neumorphic tile-large" id="tile-heatmap-appuntamenti">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:10px; z-index:2;"></button>
  <div class="tile-title">HEATMAP APPUNTAMENTI a 10 giorni</div>
  <div id="heatmapAppuntamenti" style="width:100%;height:260px;"></div>
</div>

<div class="tile-neumorphic tile-large" id="next-appointments-tile">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:10px; z-index:2;"></button>
   <div class="tile-title">PROSSIMI APPUNTAMENTI</div>
  <ul id="next-appointments-list" style="list-style: none; padding-left: 0; text-align: left;"></ul>
 <div id="agenda-title" style="font-weight:600; font-size:1.15em; margin-top:5px;"></div>
 <button class="btn btn-flat" id="btnViewAgenda" style="margin-top: 5px; background-color: #eef0f4;">Scarica</button>
</div>

<div class="tile-neumorphic tile-large" id="tile-heatmap-incassi">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:10px; z-index:2;"></button>
  <div class="tile-title">HEATMAP INCASSI a 10 giorni</div>
  <div id="heatmapIncassi" style="width:100%;height:260px;"></div>
</div>

<div class="tile-neumorphic tile-large" id="tile-oroscopo">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:10px; z-index:2;"></button>
<div class="tile-title" style="margin-bottom: 15px;">
  ‚ôàÔ∏é ‚ôâÔ∏é ‚ôäÔ∏é <span style="letter-spacing:1px;">OROSCOPO DEL CENTRO</span> ‚ôãÔ∏é ‚ôåÔ∏é ‚ôçÔ∏é 
</div>
  <div id="oroscopo-content" style="font-size:0.9em; min-height:120px; padding-top: 15px;">
    <span class="text-muted">Caricamento previsioni...</span>
  </div>
</div>

<div class="tile-neumorphic tile-large" id="tile-palette-stagionale">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:10px; z-index:2;"></button>
<div class="tile-title">PALETTE STAGIONALE</div>
<div class="palette-container" id="palette-container"></div>
</div>

<div class="tile-neumorphic tile-large" id="tile-riassunto-giornaliero">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:16px; z-index:2;"></button>
    <div class="tile-title">
      RIASSUNTO GIORNALIERO <span id="riassunto-data"></span>
    </div>
  <div class="table-responsive mt-2">
    <span>copia i dati principali per inviarli:&nbsp;</span>
    <button id="btnCopiaRiassunto" class="btn btn-light btn-sm" title="Copia riassunto" style="border-radius:8px; align-content: right;">
      <i class="bi bi-clipboard"></i>
    </button>
    <table class="table table-bordered table-sm mb-0" id="tabella-riassunto">
      <thead>
        <tr>
          <th></th>
          <th>FISCALE</th>
          <th>TEST</th>
          <th>TOTALE</th>
        </tr>
      </thead>
      <tbody>
        <tr class="riassunto-pagamento">
          <th>CASH</th>
          <td id="riassunto-cash-fiscale">-</td>
          <td id="riassunto-cash-test">-</td>
          <td id="riassunto-cash-totale">-</td>
        </tr>
        <tr class="riassunto-pagamento">
          <th>POS</th>
          <td id="riassunto-pos-fiscale">-</td>
          <td id="riassunto-pos-test">-</td>
          <td id="riassunto-pos-totale">-</td>
        </tr>
        <tr class="riassunto-pagamento">
          <th>ALTRO</th>
          <td id="riassunto-altro-fiscale">-</td>
          <td id="riassunto-altro-test">-</td>
          <td id="riassunto-altro-totale">-</td>
        </tr>
        <tr class="riassunto-totale">
          <th style="background:#1976d2; color:#fff;">TOTALE</th>
          <td id="riassunto-totale-fiscale" style="background:#1976d2; color:#fff;">-</td>
          <td id="riassunto-totale-test" style="background:#1976d2; color:#fff;">-</td>
          <td id="riassunto-totale-totale" style="background:#1976d2; color:#fff;">-</td>
        </tr>
        <tr class="riassunto-categoria">
          <th>ESTETICA</th>
          <td id="riassunto-estetica-fiscale">-</td>
          <td id="riassunto-estetica-test">-</td>
          <td id="riassunto-estetica-totale">-</td>
        </tr>
        <tr class="riassunto-categoria">
          <th>SOLARIUM</th>
          <td id="riassunto-solarium-fiscale">-</td>
          <td id="riassunto-solarium-test">-</td>
          <td id="riassunto-solarium-totale">-</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="tile-neumorphic tile-large" id="tile-booking-online">
  <button class="btn-close btn-close-tile" type="button" aria-label="Chiudi" style="position:absolute; top:10px; left:10px; z-index:2;"></button>
  <div class="tile-title">
    PRENOTAZIONI ONLINE del <span id="tile-booking-online-data"></span>
  </div>
  <div id="booking-online-list" class="booking-online-list-custom">
    <span class="text-muted">Caricamento...</span>
  </div>
</div>

<!-- Modal corrispettivi -->
<div class="modal fade" id="modalCorrispettivi" tabindex="-1" aria-labelledby="modalCorrispettiviLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable" style="max-width:90vw;">
    <div class="modal-content">
      <div class="modal-header d-flex align-items-center gap-2">
        <h4 class="modal-title" id="modalCorrispettiviLabel">Registro Corrispettivi</h4>
        <button id="btnExportExcelCorrispettivi" class="btn btn-success btn-sm ms-2" title="Esporta in Excel">
          <i class="bi bi-file-earmark-excel"></i>
        </button>
        <button id="btnExportPdfCorrispettivi" class="btn btn-danger btn-sm ms-2" title="Esporta in PDF">
  <i class="bi bi-file-earmark-pdf"></i>
</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body p-3">
        <div id="wrapperTabellaCorrispettivi" style="max-height:80vh; overflow-y:auto; width:100%;">
          <table class="table table-bordered table-sm mb-0 sticky-thead style="width:100%;">
            <thead class="table-dark">
              <tr>
                <th>Data</th>
                <th>Giorno</th>
                <th>Incasso totale</th>
                <th>Incasso servizi</th>
                <th>Incasso prodotti</th>
                <th>Di cui cash</th>
                <th>Di cui digitali</th>
                <th>Di cui altro (bank)</th>
              </tr>
            </thead>
            <tbody id="corpoTabellaCorrispettivi"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal incasso per categoria -->
<div class="modal fade" id="modalIncassoCategoria" tabindex="-1" aria-labelledby="modalIncassoCategoriaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header d-flex align-items-center gap-2">
        <h4 class="modal-title" id="modalIncassoCategoriaLabel">Incasso per Categoria</h4>
<button id="btnEspandiIncassoCategoria" class="btn btn-light btn-sm ms-2" title="Espandi tutto" style="border-radius:8px;">
  <i class="bi bi-arrows-angle-expand"></i>
</button>
<button id="btnCopiaIncassoCategoria" class="btn btn-light btn-sm ms-2" title="Copia tutto" style="border-radius:8px; display:none;">
  <i class="bi bi-clipboard"></i>
</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body p-3">
        <div id="incasso-categorie-totali">
          <div style="font-size:1.1em; font-weight:600; margin-bottom:10px;">
            Incasso dal <span id="incasso-categorie-datefrom"></span> al <span id="incasso-categorie-dateto"></span>
          </div>
          <br>

          <div class="mb-3" style="font-size:1.2em;">
            <span style="font-weight:600;">INCASSO TOTALE:</span>
            <span id="incasso-categorie-totale" style="color:#000000; font-weight:600;">-</span>
          </div>

          <br>

<div class="mb-3" style="font-size:1.3em;">
  <button type="button" class="categoria-btn" id="btnEstetica">
    INCASSO ESTETICA:
  </button>
  <span id="incasso-categorie-estetica" style="color:#2e4683; font-weight:700;">-</span>
  <span id="incasso-categorie-estetica-pct" style="color:#2e4683; font-weight:700;">(%)</span>
  <span id="incasso-categorie-estetica-passaggi" style="color:#2e4683; font-weight:300;">passaggi: 0</span>
  <div id="sottocategorie-estetica" class="sottocategorie-list" style="display:none; margin-top:10px;"></div>
</div>

<div class="mb-3" style="font-size:1.3em;">
  <button type="button" class="categoria-btn" id="btnSolarium">
    INCASSO SOLARIUM:
  </button>
  <span id="incasso-categorie-solarium" style="color: #7f3659; font-weight:700;">-</span>
  <span id="incasso-categorie-solarium-pct" style="color:#7f3659; font-weight:700;">(%)</span>
  <span id="incasso-categorie-solarium-passaggi" style="color:#7f3659; font-weight:300;">passaggi: 0</span>
  <div id="sottocategorie-solarium" class="sottocategorie-list" style="display:none; margin-top:10px;"></div>
</div>

          <br>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal passaggi di cassa -->
<div class="modal fade" id="modalPassaggiCassa" tabindex="-1" aria-labelledby="modalPassaggiCassaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable" style="max-width:90vw;">
    <div class="modal-content">
      <div class="modal-header d-flex align-items-center gap-2">
        <h4 class="modal-title" id="modalPassaggiCassaLabel">Passaggi di Cassa</h4>
        <button id="btnExportExcelPassaggiCassa" class="btn btn-success btn-sm ms-2" title="Esporta in Excel">
          <i class="bi bi-file-earmark-excel"></i>
        </button>
        <button id="btnExportPdfPassaggiCassa" class="btn btn-danger btn-sm ms-2" title="Esporta in PDF">
          <i class="bi bi-file-earmark-pdf"></i>
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body p-3">
        <div id="wrapperTabellaPassaggiCassa" style="max-height:80vh; overflow-y:auto; width:100%;">
          <table class="table table-bordered table-sm mb-0 sticky-thead" style="width:100%;">
            <thead class="table-dark">
              <tr>
                <th>Data</th>
                <th>Giorno</th>
                <th>Passaggi totali</th>
                <th>Passaggi fiscali</th>
                <th>Passaggi uomo</th>
                <th>Passaggi donna</th>
              </tr>
            </thead>
            <tbody id="corpoTabellaPassaggiCassa"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal clienti -->
<div class="modal fade" id="modalClienti" tabindex="-1" aria-labelledby="modalClientiLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable" style="max-width:90vw;">
    <div class="modal-content">
      <div class="modal-header d-flex align-items-center gap-2">
        <h4 class="modal-title" id="modalClientiLabel">Clienti</h4>
        <button id="btnExportExcelClienti" class="btn btn-success btn-sm ms-2" title="Esporta in Excel">
          <i class="bi bi-file-earmark-excel"></i>
        </button>
        <button id="btnExportPdfClienti" class="btn btn-danger btn-sm ms-2" title="Esporta in PDF">
          <i class="bi bi-file-earmark-pdf"></i>
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body p-3">
        <div id="wrapperTabellaClienti" style="max-height:80vh; overflow-y:auto; width:100%;">
          <table class="table table-bordered table-sm mb-0 sticky-thead" style="width:100%;">
    <thead class="table-dark">
      <tr>
        <th colspan="4" id="clienti-stats-range" style="text-align:center; background:#e9ecef; color:#333; font-weight:600;"></th>
      </tr>
      <tr>
        <th class="sortable" data-sort="nome">Nome cliente</th>
        <th class="sortable" data-sort="passaggi">Numero passaggi</th>
        <th class="sortable" data-sort="ultimo">Ultimo passaggio</th>
        <th class="sortable" data-sort="frequenza">Frequenza</th>
      </tr>
    </thead>
            <tbody id="corpoTabellaClienti"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal operatori -->
<div class="modal fade" id="modalOperatori" tabindex="-1" aria-labelledby="modalOperatoriLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable" style="max-width:90vw;">
    <div class="modal-content">
      <div class="modal-header d-flex align-items-center gap-2">
        <h4 class="modal-title" id="modalOperatoriLabel">Incasso per Operatore</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body p-3">
        <div id="wrapperTabellaOperatori" style="max-height:80vh; overflow-y:auto; width:100%;">
          <table class="table table-bordered table-sm mb-0 sticky-thead" id="tabellaOperatori" style="width:100%;">
            <thead class="table-dark" id="theadOperatori"></thead>
            <tbody id="corpoTabellaOperatori"></tbody>
            <tfoot id="tfootOperatori"></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Settings Tiles -->
<div class="modal fade" id="modalSettingsTiles" tabindex="-1" aria-labelledby="modalSettingsTilesLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalSettingsTilesLabel">Impostazioni Tile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered align-middle mb-0">
          <thead>
            <tr>
              <th>Tile</th>
              <th>Visibile</th>
            </tr>
          </thead>
          <tbody id="settingsTilesTableBody">
            <!-- Popolato via JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal per la vista agenda -->
<div class="modal fade" id="modalAgendaView" tabindex="-1" aria-labelledby="modalAgendaViewLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAgendaViewLabel">Vista Agenda Giornaliera</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body d-flex justify-content-center align-items-center" style="min-height:60vh;">
        <div id="agendaViewImageContainer" style="width:100%;text-align:center;">
          <span class="text-muted">Caricamento...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .page-wide-90 {
  max-width: 90vw;
  margin-left: auto;
  margin-right: auto;
}

/* KPI Cards */
.kpi-cards-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
  margin-top: 20px;
}

.kpi-card {
  background: #ffffff;
  border-radius: 6px;
  padding: 24px 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border-left: 4px solid;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: transform 0.2s, box-shadow 0.2s;
  min-height: 100px;
}

.kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
}

.kpi-card.success { border-left-color: #28a745; }
.kpi-card.info { border-left-color: #17a2b8; }
.kpi-card.warning { border-left-color: #ffc107; }
.kpi-card.primary { border-left-color: #007bff; }

.kpi-icon {
  font-size: 2.5em;
  opacity: 0.8;
}

.kpi-card.success .kpi-icon { color: #28a745; }
.kpi-card.info .kpi-icon { color: #17a2b8; }
.kpi-card.warning .kpi-icon { color: #ffc107; }
.kpi-card.primary .kpi-icon { color: #007bff; }

.kpi-content {
  flex: 1;
}

.kpi-value {
  font-size: 2.2em;
  font-weight: 700;
  color: #2c3e50;
  line-height: 1;
  margin-bottom: 4px;
}

.kpi-label {
  font-size: 0.95em;
  color: #6c757d;
  font-weight: 500;
  margin-bottom: 8px;
}

.kpi-trend {
  font-size: 0.85em;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 12px;
  display: inline-block;
}

.kpi-trend.positive {
  background: #d4edda;
  color: #155724;
}

.kpi-trend.negative {
  background: #f8d7da;
  color: #721c24;
}

.kpi-trend.neutral {
  background: #e2e3e5;
  color: #383d41;
}

/* Responsive */
@media (max-width: 1200px) {
  :root {
    --mobile-header-height: 56px;      /* altezza header base.html (mobile) */
    --mobile-date-nav-height: 44px;    /* altezza riga date-nav mobile */
  }
  /* Spingi il contenuto sotto header fisso + date-nav mobile */
  .mobile-date-nav + .page-wide-90,
  .page-wide-90 {
    margin-top: calc(var(--mobile-header-height) + var(--mobile-date-nav-height)) !important;
  }
  /* Il titolo "REPORT" non deve aggiungere altro spazio (override inline +5px) */
  .page-wide-90 .d-flex.align-items-center.mb-3 {
    margin-top: 0 !important;
  }

  .kpi-cards-container {
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }

  .kpi-card {
    padding: 16px;
    min-height: 80px;
  }
  
  .kpi-icon {
    font-size: 2em;
  }
  
  .kpi-value {
    font-size: 1.8em;
  }

  .report-tiles-grid .tile-neumorphic { cursor: default !important; }
  .report-tiles-grid.tiles-draggable .tile-neumorphic { cursor: default !important; }
}

.report-tiles-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  grid-auto-rows: 170px;
  gap: 12px;
  margin-bottom: 2.5rem;
  margin-top: 1.5rem;
  text-align: center;
}

.tile-neumorphic {
  position: relative;
  background: #ffffff;
  border-radius: 2px;
  box-shadow:
    8px 8px 18px #d1d9e6,
    -8px -8px 18px #e5e5e5;
  display: flex;
  flex-direction: column;
  align-items: center;     
  justify-content: flex-start; 
  transition: box-shadow 0.2s;
  min-width: 0;
  min-height: 0;    
  text-align: center;
}

.tile-neumorphic:hover {
  box-shadow:
    4px 4px 12px #d1d9e6,
    -4px -4px 12px #ffffff;
}

/* Tile dimensioni diverse */
.tile-large {
  grid-column: span 2;
  grid-row: span 2;
}

.tile-title {
  background: linear-gradient(#ffffff 0%, #eeeeee 100%);
  color: rgb(52, 52, 52);
  border-top-left-radius: 2px;
  border-top-right-radius: 2px;
  width: 100%;
  margin-top: 0px !important;
  padding-top: 5px !important;
  padding-bottom: 5px !important;
  padding-left: 40px !important;
  font-style: italic;           /* corsivo */
  font-size: 0.8em;
  text-align: left;            /* allineamento a destra */
}

.btn-neumorphic {
  min-width: 120px;
  min-height: 34px;
  font-size: 1.08em;
  padding: 10px 12px;
  border-radius: 18px;
    box-shadow:
    0 -4px 12px 0 #fff,                /* ombra bianca sopra */
    4px 4px 12px #e0e0e0,              /* ombra scura sotto */
    -4px -4px 12px #ffffff;  
  background: #f7f9f9;
  border: none;
  margin: 0;
  transition: box-shadow 0.15s, background 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
}

  .service-bar-btn:hover {
    background: #ffffff
}

.btn-neumorphic:hover {
  background: white;
  box-shadow:
    2px 2px 6px #d1d9e6,
    -2px -2px 6px #ffffff;
}

.service-bar-btn:focus {
    background: #717980;
    color: white;
}

.btn-neumorphic:focus {
  background: #717980;
  color: white;
  box-shadow:
    2px 2px 6px #d1d9e6,
    -2px -2px 6px #ffffff;
}

/* AGGIUNGI: lo stato selezionato non dipende dal focus */
.btn-neumorphic.active,
.btn-neumorphic.btn-selected {
  background: #717980;
  color: white;
  box-shadow:
    2px 2px 6px #d1d9e6,
    -2px -2px 6px #ffffff;
}

/* opzionale: mantieni anche al passaggio mouse sul selezionato */
.btn-neumorphic.active:hover,
.btn-neumorphic.btn-selected:hover {
  background: #717980;
  color: white;
  box-shadow:
    2px 2px 6px #d1d9e6,
    -2px -2px 6px #ffffff;
}

#tile-stats-oggi .stat-euro {
  color: #1976d2;
  font-weight: 700;
  letter-spacing: 1px;
}
#tile-stats-oggi .stat-variazione {
  color: #388e3c;
  font-weight: 600;
}
#tile-stats-oggi .stat-voce {
  font-size: 1.1rem;
  color: #555;
}

.list-group-item.highlight {
  background: #ececec !important; /* giallo molto chiaro */
  font-weight: 600;
  color: #38547d;
}

.btn-close-tile {
  opacity: 0.4;
  transition: opacity 0.2s;
  width: 10px;
  height: 10px;
  min-width: 14px;
  min-height: 14px;
  font-size: 0.4rem;
}
.btn-close-tile:hover {
  opacity: 1;
}

#tile-top-clienti {
  min-height: 170px;
  max-height: 361px;
  height: 361px;
  overflow-y: auto;
  padding-top: 0;
  padding-bottom: 0;
}

#tile-top-clienti ul.list-group li.list-group-item {
  display: flex;
  gap: 12px;
  min-width: 180px;
  white-space: nowrap;
  border: 1px solid #eee;
  border-radius: 10px;
  margin: 0;
  padding: 1.5px 12px;
  background: #fff;
  text-align: center;     
  align-items: center;   
  justify-content: center;
}

  #next-appointments-list li {
    background: #fff;
    padding: 4px 8px;
    border-radius: 8px;
  }
  #next-appointments-list li.alt {
    background: #f3f4f7;
  }

  /* Barra di progresso appuntamenti */
.progress-container {
  width: 100%;
  max-width: 280px;
  margin: 0 auto;
}

.progress-bar-custom {
  width: 100%;
  height: 24px;
  background-color: #e9ecef;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-fill-completati {
  height: 100%;
  background: linear-gradient(90deg, #28a745, #34ce57);
  float: left;
  transition: width 0.8s ease-in-out;
  position: relative;
}

.progress-fill-noshow {
  height: 100%;
  background: linear-gradient(90deg, #dc3545, #e74c3c);
  float: left;
  transition: width 0.8s ease-in-out;
}

.progress-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.85em;
  color: #6c757d;
  font-weight: 500;
}

.label-completati {
  color: #28a745;
}

.label-noshow {
  color: #dc3545;
}

.label-rimanenti {
  color: #6c757d;
}

/* Tooltip per la barra */
.progress-fill-completati::after,
.progress-fill-noshow::after {
  content: attr(data-tooltip);
  position: absolute;
  top: -30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  opacity: 0;
  transition: opacity 0.2s;
  white-space: nowrap;
  z-index: 10;
}

.progress-fill-completati:hover::after,
.progress-fill-noshow:hover::after {
  opacity: 1;
}

.kpi-trend-azzurro {
  background: #d4eeff 100%;
  color: #0f427c;
  font-weight: 600;
  border-radius: 12px;
  padding: 2px 10px;
  margin-top: 4px;
  display: inline-block;
}

#modalIncassoCategoria {
    width: 40%;
    position: absolute;
    left: 30%;
  }

  #modalCorrispettivi .modal-body {
    max-height: 97vh;
    overflow-y: auto;
  }

    #modalOperatori .modal-body {
    max-height: 97vh;
    overflow-y: auto;
  }

  #modalIncassoCategoria .modal-body {
    max-height: 85vh !important;
    overflow-y: auto !important;
  }

  #modalPassaggiCassa .modal-body  {
    max-height: 97vh;
    overflow-y: auto;
  }

.sticky-thead th {
  position: sticky;
  top: 0;
  z-index: 2;
  background: linear-gradient(#616465, #323537);
  color: #fff !important;
  border: 1px solid #dee2e6 !important;
}

#modalCorrispettivi table th,
#modalIncassoCategoria table th,
#modalPassaggiCassa table th,
#modalCorrispettivi table td,
#modalIncassoCategoria table td,
#modalPassaggiCassa table td {
  text-align: center;
  vertical-align: middle;
}

#corpoTabellaCorrispettivi tr.ultima-riga-totale,
#corpoTabellaIncassoCategoria tr.ultima-riga-totale,
#corpoTabellaPassaggiCassa tr.ultima-riga-totale {
  border: 2px solid #ffffff !important;
}

#corpoTabellaCorrispettivi tr.ultima-riga-totale td,
#corpoTabellaCorrispettivi tr.ultima-riga-totale th,
#corpoTabellaIncassoCategoria tr.ultima-riga-totale td,
#corpoTabellaIncassoCategoria tr.ultima-riga-totale th,
#corpoTabellaPassaggiCassa tr.ultima-riga-totale td,
#corpoTabellaPassaggiCassa tr.ultima-riga-totale th {
  background: #f1f2f4;
  color: #424242 !important;
  font-weight: bold !important;
}

#btnExportExcelCorrispettivi,
#btnExportPdfCorrispettivi,
#btnExportExcelIncassoCategoria,
#btnExportPdfIncassoCategoria,
#btnExportExcelPassaggiCassa,
#btnExportPdfPassaggiCassa {
  padding: 3px 7px !important;
  font-size: 0.95rem;
  min-width: 32px;
  min-height: 32px;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

#btnExportExcelCorrispettivi i,
#btnExportPdfCorrispettivi i,
#btnExportExcelIncassoCategoria i,
#btnExportPdfIncassoCategoria i,
#btnExportExcelPassaggiCassa i,
#btnExportPdfPassaggiCassa i {
  font-size: 1.5em !important;
  vertical-align: middle;
}

.sticky-thead th {
  position: sticky;
  top: 0;
  z-index: 2;
  background: linear-gradient(#616465, #323537);
  color: #fff !important;
  border: 1px solid #dee2e6 !important;
  cursor: pointer;
}
#modalClienti th.sortable:hover {
  background: #bfc2c7 !important;
  color: #222 !important;
}

  #tile-top-clienti .badge.bg-primary {
  background: #fdffed !important; /* blu */
  color: #494949 !important;
}
#tile-top-clienti .badge.bg-info {
  background: #ffffff !important; /* azzurro chiaro */
  color: #0c3864 !important;
}

.tile-ghost {
  opacity: 0.4;
}
.tile-chosen {
  box-shadow: 0 0 0 2px #1976d2;
}

.booking-online-list-custom {
  font-size: 1.2em !important;
  line-height: 1.2;
  width: 100%;
  height: 90%;
  max-height: 90%;
  overflow-y: auto;
  margin-top: 6px;
  text-align: left;
  padding: 10px;
}

#clienti-stats-range {
  background: linear-gradient(90deg, #ededed 0%, #ffffff 100%) !important;
  color: #4e4e4e !important;
  font-weight: 700;
  text-align: center;
  letter-spacing: 0.5px;
}

.riassunto-pagamento th, .riassunto-pagamento td {
  background: #e3f2fd !important; /* azzurro pastello */
  color: #1a237e !important;
}
.riassunto-categoria th, .riassunto-categoria td {
  background: #fce4ec !important; /* rosa pastello */
  color: #ad1457 !important;
}
.riassunto-genere th, .riassunto-genere td {
  background: #e8f5e9 !important; /* verde pastello */
  color: #1b5e20 !important;
}

/* Riduci altezza righe tabella */
.table-sm > tbody > tr > td,
.table-sm > tbody > tr > th,
.table-sm > thead > tr > th,
.table-sm > tfoot > tr > th,
.table-sm > thead > tr > td,
.table-sm > tfoot > tr > td {
  padding-top: 3px !important;
  padding-bottom: 3px !important;
}

/* Centra tutto il contenuto delle tabelle */
.table,
.table th,
.table td {
  text-align: center !important;
  vertical-align: middle !important;
}

#tabella-riassunto {
  width: 100%;
  table-layout: fixed;
  min-width: 0 !important;
  max-width: 100% !important;
  overflow-wrap: anywhere;
}

#tabella-riassunto th,
#tabella-riassunto td {
  margin-top: 10px;
  min-width: 0 !important;
  font-size: 1.05em;
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
}

#oroscopo-content {
padding: 15px !important;
}

#tabella-riassunto td:last-child,
#tabella-riassunto th:last-child {
  font-weight: bold !important;
}

#btnEstetica {
  color: #2e4683;
}
#btnSolarium {
  color: #7f3659;
}

.categoria-btn {
  border-radius: 6px;
}
#btnEstetica:hover {
  background: #ffe0b2;
  outline: 2px solid #f57c00;
}
#btnSolarium:hover{
  background: #ffe0b2;
  outline: 2px solid #f57c00;
}

.sottocategorie-list {
  text-align: left;
  margin-left: 10px;
}
.sottocategoria-row {
  justify-content: space-between;
  padding: 3px 0;
  border-bottom: 1px solid #eee;
  font-size: 1em;
  cursor: pointer;
}

.sottocategoria-row:hover {
  background: #f3f4f7;
}

.sottocategoria-info {
  display: flex;
  gap: 18px;
  align-items: center;
  margin-bottom: 2px;
}

.sottocategoria-passaggi {
  color: #888;
  font-size: 0.95em;
}

.servizi-list {
  margin-left: 10px;
  padding-left: 8px;
  margin-top: 2px;
  display: none;
  border-left: 2px solid #e0e0e0;
}
.servizio-row {
  font-size: 0.72em;
  color: #444;
  padding: 1px 0 1px 0;
  margin-bottom: 1px;
  display: block;
}
.servizio-row span {
  display: block;
  width: 100%;
  text-align: left;
}
.servizio-row span:last-child {
  color: #888;
  margin-left: 0;
}
.next-app-date-today { font-weight: bold; }

/* Minimali e mirate: impedire overflow dei tile specifici e della tabella riassunto */
#tile-riassunto-giornaliero,
.riassunto-giornaliero,
.summary-tile,
.daily-summary,
#tile-oroscopo,
#tile-palette-stagionale {
  overflow: hidden !important;
  box-sizing: border-box !important;
  max-width: 100% !important;
}

/* Forza i figli a non eccedere il contenitore e a spezzare le parole se necessario */
#tile-riassunto-giornaliero *,
.riassunto-giornaliero *,
#tile-oroscopo *,
#tile-palette-stagionale * {
  max-width: 100% !important;
  box-sizing: border-box !important;
  white-space: normal !important;
  word-break: break-word !important;
  overflow-wrap: anywhere !important;
}

/* Mirata a #tabella-riassunto dentro modal: nessun min-width, layout fisso e contenuto adattivo */
.modal-body #tabella-riassunto {
  min-width: 0 !important;
  width: 100% !important;
  max-width: 100% !important;
  table-layout: fixed !important;
  box-sizing: border-box !important;
}

/* Celle della tabella devono andare a capo invece di espandere */
.modal-body #tabella-riassunto th,
.modal-body #tabella-riassunto td {
  white-space: normal !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
  box-sizing: border-box !important;
  padding: 6px 8px !important;
}

/* Se necessario, permetti scroll orizzontale interno al tile solo per la tabella */
.modal-body .table-responsive.mt-2 {
  overflow-x: auto !important;
  -webkit-overflow-scrolling: touch !important;
  padding-left: 8px !important;
  padding-right: 8px !important;
}

#oroscopo-content > div {
  display: flex !important;
  flex-direction: row !important;
  align-items: flex-start !important;
  gap: 8px !important;
  white-space: normal !important;
  box-sizing: border-box !important;
}
#oroscopo-content > div > strong {
  min-width: 86px !important;
  flex: 0 0 auto !important;
  display: inline-block !important;
  font-weight: 700 !important;
}
#oroscopo-content > div > span,
#oroscopo-content > div > i,
#oroscopo-content > div > em,
#oroscopo-content > div > b {
  flex: 1 1 auto !important;
  min-width: 0 !important;
  overflow-wrap: anywhere !important;
  word-break: break-word !important;
.report-actions {
  display: flex;
  gap: 0.5rem;
}

  #btnSettings {
    display: block !important;
  }

  @media (min-width:1201px){
  .report-tiles-grid.tiles-draggable .tile-neumorphic { cursor: move; }
}
</style>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  flatpickr("#reportDate", {
    dateFormat: "Y-m-d",  // Valore input resta yyyy-mm-dd (backend)
    altFormat: "d M Y",   // Display: gg MMM yyyy (mesi italiani grazie a locale)
    altInput: true,       // Mostra altFormat nell'input
    defaultDate: document.getElementById('reportDate').value || new Date().toISOString().slice(0, 10),
    locale: "it",         // Mesi italiani (GEN, FEB, ecc.)
    onChange: function(selectedDates, dateStr, instance) {
      triggerReportReload();
      aggiornaBtnOggi();
      aggiornaGiornoSettimana();
      caricaHeatmapAppuntamenti(dateStr);
      caricaHeatmapIncassi(dateStr);
      aggiornaRiassuntoGiornaliero();
    }
  });
});
</script>
<script>
function triggerReportReload() {
  const dateInput = document.getElementById('reportDate');
  const selectedDate = dateInput.value;

    caricaPrenotazioniOnline(selectedDate);

  // Aggiorna titolo top clienti
  const year = selectedDate ? new Date(selectedDate).getFullYear() : new Date().getFullYear();
  document.getElementById('top-clienti-title').innerText = `TOP 10 CLIENTI ${year}`;

  // Aggiorna titolo incasso
  const date = new Date(selectedDate);
  const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
  document.getElementById('stat-incasso-data').textContent = date.toLocaleDateString('it-IT', options);

  // Aggiorna titolo appuntamenti presi
  const oggi = new Date();
  const isOggi = selectedDate === oggi.toISOString().slice(0, 10);
  if (isOggi) {
    document.getElementById('appuntamenti-presi-titolo').innerText = 'Appuntamenti presi oggi';
  } else {
    const dataFormattata = date.toLocaleDateString('it-IT', options);
    document.getElementById('appuntamenti-presi-titolo').innerText = `Appuntamenti presi il ${dataFormattata}`;
  }

  // Aggiorna agenda title
  const agendaTitle = document.getElementById('agenda-title');
  if (agendaTitle) {
    agendaTitle.textContent = `AGENDA in PDF del ${date.toLocaleDateString('it-IT', options)}`;
  }

  // Fetch dati principali
  fetch(`/api/report_day?date=${selectedDate}`)
    .then(r => r.json())
    .then(data => {
      // KPI Cards
      document.getElementById('kpi-ricavi').innerText = `‚Ç¨ ${data.totale.toFixed(2)}`;
      document.getElementById('kpi-clienti').innerText = data.passaggi_cassa ?? 0;
      document.getElementById('kpi-noshow').innerText = data.noshow;
      const tassoCompletamento = data.totali > 0 ? Math.round((data.completati / data.totali) * 100) : 0;
      document.getElementById('kpi-completamento').innerText = `${tassoCompletamento}%`;

      // Trend Ricavi
      if (data.media_giornaliera_riferimento !== undefined) {
        const oraApertura = 9;
        const oraChiusura = 20;
        const oreApertura = oraChiusura - oraApertura;
        let soglia;
        if (selectedDate === oggi.toISOString().slice(0, 10)) {
          const oraAttuale = oggi.getHours() + oggi.getMinutes() / 60;
          const oreLavorate = Math.max(0, Math.min(oraAttuale - oraApertura, oreApertura));
          soglia = (data.media_giornaliera_riferimento / oreApertura) * oreLavorate;
        } else {
          soglia = data.media_giornaliera_riferimento;
        }
        const diff = data.totale - soglia;
        const kpiRicaviTrend = document.getElementById('kpi-ricavi-trend');
        if (diff >= 0) {
          kpiRicaviTrend.innerText = `üëç ${diff.toFixed(0)} ‚Ç¨ sopra al target! bene!`;
          kpiRicaviTrend.className = 'kpi-trend positive';
        } else {
          kpiRicaviTrend.innerText = `‚ö†Ô∏è ${Math.abs(diff).toFixed(0)} ‚Ç¨ sotto al target!`;
          kpiRicaviTrend.className = 'kpi-trend negative';
        }
      } else {
        const trendRicavi = data.totale > 500 ? 'positive' : data.totale > 200 ? 'neutral' : 'negative';
        const kpiRicaviTrend = document.getElementById('kpi-ricavi-trend');
        kpiRicaviTrend.className = `kpi-trend ${trendRicavi}`;
        kpiRicaviTrend.innerText = data.totale > 500 ? 'üìà Ottimo' : data.totale > 200 ? '‚û°Ô∏è Normale' : 'üìâ Basso';
      }

      // Trend Passaggi in cassa
      document.getElementById('kpi-clienti-trend').innerText =
        `di cui da calendario: ${data.passaggi_cassa_calendario ?? 0}`;
      document.getElementById('kpi-clienti-trend').className = 'kpi-trend kpi-trend-azzurro';

      // Trend No-show
      if (data.media_mese_noshow !== undefined) {
        const diff = data.noshow - data.media_mese_noshow;
        const trend = diff < 0 ? 'üìà' : diff > 0 ? 'üìâ' : '‚û°Ô∏è';
        document.getElementById('kpi-noshow-trend').innerText =
          `${trend} Media mese: ${data.media_mese_noshow.toFixed(1)} (${diff >= 0 ? '+' : ''}${diff.toFixed(1)})`;
        document.getElementById('kpi-noshow-trend').className =
          'kpi-trend ' + (diff < 0 ? 'positive' : diff > 0 ? 'negative' : 'neutral');
      } else {
        const trendNoshow = data.noshow === 0 ? 'positive' : data.noshow <= 2 ? 'neutral' : 'negative';
        const kpiNoshowTrend = document.getElementById('kpi-noshow-trend');
        kpiNoshowTrend.className = `kpi-trend ${trendNoshow}`;
        kpiNoshowTrend.innerText = data.noshow === 0 ? '‚úÖ Perfetto' : data.noshow <= 2 ? '‚ö†Ô∏è Accettabile' : '‚ùå Alto';
      }

      // Trend Completamento
      if (data.media_mese_completamento !== undefined) {
        const diff = tassoCompletamento - data.media_mese_completamento;
        const trend = diff > 0 ? 'üìà' : diff < 0 ? 'üìâ' : '‚û°Ô∏è';
        document.getElementById('kpi-completamento-trend').innerText =
          `${trend} Media mese: ${data.media_mese_completamento.toFixed(0)}% (${diff >= 0 ? '+' : ''}${diff.toFixed(0)}%)`;
        document.getElementById('kpi-completamento-trend').className =
          'kpi-trend ' + (diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral');
      } else {
        const trendCompletamento = tassoCompletamento >= 80 ? 'positive' : tassoCompletamento >= 60 ? 'neutral' : 'negative';
        const kpiCompletamentoTrend = document.getElementById('kpi-completamento-trend');
        kpiCompletamentoTrend.className = `kpi-trend ${trendCompletamento}`;
        kpiCompletamentoTrend.innerText = tassoCompletamento >= 80 ? 'üéØ Eccellente' : tassoCompletamento >= 60 ? 'üëç Buono' : '‚¨áÔ∏è Da migliorare';
      }

      // Statistiche incasso tile
      document.getElementById('stat-incasso-oggi').innerText = `‚Ç¨ ${data.totale.toFixed(2)}`;
      document.getElementById('stat-servizi-oggi').innerText = `‚Ç¨ ${data.totale_servizi.toFixed(2)}`;
      document.getElementById('stat-prodotti-oggi').innerText = `‚Ç¨ ${data.totale_prodotti.toFixed(2)}`;
      document.getElementById('stat-incasso-test-euro').innerText = `‚Ç¨ ${(data.totale_test ?? 0).toFixed(2)}`;
      document.getElementById('stat-incasso-fiscale-euro').innerText = `‚Ç¨ ${(data.totale_fiscale ?? 0).toFixed(2)}`;
      document.getElementById('stat-cash-oggi').innerText = `‚Ç¨ ${data.totale_cash.toFixed(2)}`;
      document.getElementById('stat-pos-oggi').innerText = `‚Ç¨ ${data.totale_pos.toFixed(2)}`;
      document.getElementById('stat-altro-oggi').innerText = `‚Ç¨ ${data.totale_altro.toFixed(2)}`;
      document.getElementById('stat-incasso-stimato-totale').innerText = `‚Ç¨ ${(data.incasso_stimato_totale ?? 0).toFixed(2)}`;
      document.getElementById('stat-incasso-stimato-solarium').innerText = `‚Ç¨ ${(data.incasso_stimato_solarium ?? 0).toFixed(2)}`;
      document.getElementById('stat-incasso-stimato-estetica').innerText = `‚Ç¨ ${(data.incasso_stimato_estetica ?? 0).toFixed(2)}`;

      // Pie chart pagamenti
      if(window.piePagamentiChart) window.piePagamentiChart.destroy();
      const ctx = document.getElementById('piePagamenti').getContext('2d');
      window.piePagamentiChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Cash', 'POS', 'Altro'],
          datasets: [{
            data: [
              data.totale_cash,
              data.totale_pos,
              data.totale_altro
            ],
            backgroundColor: [
              '#ffd966',
              '#8fd3fe',
              '#b6b6b6'
            ],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.label || '';
                  let value = context.parsed || 0;
                  return `${label}: ${value.toFixed(2)}‚Ç¨`;
                }
              }
            },
            legend: {
              display: true,
              position: 'top'
            }
          }
        }
      });

      // Statistiche appuntamenti
      document.getElementById('stat-app-completati').innerText = data.completati;
      document.getElementById('stat-app-totali').innerText = data.totali;
      document.getElementById('stat-app-noshow').innerText = data.noshow;

      // Barra di progresso appuntamenti
      const totali = data.totali || 1;
      const percCompletati = Math.round((data.completati / totali) * 100);
      const percNoshow = Math.round((data.noshow / totali) * 100);
      const percRimanenti = 100 - percCompletati - percNoshow;
      const progressCompletati = document.getElementById('progress-completati');
      const progressNoshow = document.getElementById('progress-noshow');
      if (progressCompletati && progressNoshow) {
        setTimeout(() => {
          progressCompletati.style.width = `${percCompletati}%`;
          progressNoshow.style.width = `${percNoshow}%`;
          progressCompletati.setAttribute('data-tooltip', `${data.completati} completati (${percCompletati}%)`);
          progressNoshow.setAttribute('data-tooltip', `${data.noshow} no-show (${percNoshow}%)`);
        }, 100);
        document.querySelector('.label-completati').textContent = `‚úÖ Completati (${percCompletati}%)`;
        document.querySelector('.label-noshow').textContent = `‚ùå No-show (${percNoshow}%)`;
        document.querySelector('.label-rimanenti').textContent = `‚è≥ In attesa (${percRimanenti}%)`;
      }
    });

  // Aggiorna appuntamenti presi tile
  fetch(`/api/appuntamenti_presi_giorno?date=${selectedDate}`)
    .then(r => r.json())
    .then(dataApp => {
      document.getElementById('stat-app-presi-totale').innerText = dataApp.presi_totale;
      document.getElementById('stat-app-presi-gestionale').innerText = dataApp.presi_gestionale;
      document.getElementById('stat-app-presi-web').innerText = dataApp.presi_web;
    });

  // Aggiorna top clienti
  fetch(`/api/top_clienti_anno?year=${year}`)
    .then(r => r.json())
    .then(clienti => {
      const ul = document.getElementById('top-clienti-list');
      ul.innerHTML = ''; // Svuota la lista
      fetch(`/api/appuntamenti_giorno?date=${selectedDate}`)
        .then(r => r.json())
        .then(apps => {
          // Normalizza: "pier francesco" -> "Pier Francesco", "d'agostini" -> "D‚ÄôAgostini"
          const formatPersonName = (s) => {
            if (s == null) return '';
            const base = String(s).trim().replace(/\s+/g, ' ').toLocaleLowerCase('it-IT');
            // Maiuscola a inizio parola e dopo spazio, trattino, apostrofo (‚Äô o ')
            return base.replace(/(^|[ \-‚Äô'])(\p{L})/gu, (_, p1, p2) => p1 + p2.toLocaleUpperCase('it-IT'));
          };
          const clientiConApp = new Set(apps.map(a => a.client_id));
          clienti.slice(0, 10).forEach((c, idx) => {
            const primoApp = apps.find(a => a.client_id === c.id && a.start_time);
            
            // PATCH: Costruzione sicura dell'elemento <li>
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex align-items-center gap-3';

            const nomeSpan = document.createElement('span');
            const displayNome = formatPersonName(c.nome);
            const displayCognome = formatPersonName(c.cognome);

            if (primoApp && primoApp.start_time) {
              // Se c'√® un appuntamento, crea un link
              const link = document.createElement('a');
              link.href = '#'; // O l'URL corretto se ne hai uno
              link.className = 'top-cliente-link';
              link.style.cssText = 'color:inherit;text-decoration:underline;cursor:pointer;';
              
              const boldSpan = document.createElement('span');
              boldSpan.className = 'fw-bold';
              boldSpan.textContent = `${idx + 1}.`;
              
              link.appendChild(boldSpan);
              link.append(` ${displayNome} ${displayCognome}`);
              nomeSpan.appendChild(link);
            } else {
              // Altrimenti, solo testo
              const boldSpan = document.createElement('span');
              boldSpan.className = 'fw-bold';
              boldSpan.textContent = `${idx + 1}.`;
              nomeSpan.appendChild(boldSpan);
              nomeSpan.append(` ${displayNome} ${displayCognome}`);
            }

            const appBadge = document.createElement('span');
            appBadge.className = 'badge bg-primary';
            appBadge.textContent = `${c.num_app} appuntamenti`;

            const spesaBadge = document.createElement('span');
            spesaBadge.className = 'badge bg-info text-dark';
            spesaBadge.textContent = `‚Ç¨ ${(c.totale_speso ?? 0).toFixed(2)}`;

            li.appendChild(nomeSpan);
            li.appendChild(appBadge);
            li.appendChild(spesaBadge);
            ul.appendChild(li);
          });
        });
    });
}

function aggiornaBtnOggi() {
  const dateInput = document.getElementById('reportDate');
  const desktopBtn = document.getElementById('reportBtnToday');
  const mobileBtn  = document.getElementById('mBtnTodayReport');
  if (!dateInput) return;

  // Oggi in locale (yyyy-mm-dd)
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const todayLocal = `${yyyy}-${mm}-${dd}`;

  const current = (dateInput.value || '').trim();
  const isToday = current === todayLocal;

  if (desktopBtn) desktopBtn.style.display = isToday ? 'none' : '';
  if (mobileBtn)  mobileBtn.style.display  = isToday ? 'none' : '';
}

function aggiornaGiornoSettimana() {
  const dateInput = document.getElementById('reportDate');
  const dayOfWeekSpan = document.getElementById('reportDayOfWeek');
  if (!dateInput || !dayOfWeekSpan) return;
  const giorni = ['DOM', 'LUN', 'MAR', 'MER', 'GIO', 'VEN', 'SAB'];
  const data = new Date(dateInput.value);
  if (!isNaN(data)) {
    dayOfWeekSpan.textContent = giorni[data.getDay()];
    dayOfWeekSpan.style.marginLeft = "10px";
    dayOfWeekSpan.style.fontWeight = "600";
    dayOfWeekSpan.style.color = "#1976d2";
  } else {
    dayOfWeekSpan.textContent = '';
  }
}

let modalToShow = null;

document.addEventListener('DOMContentLoaded', function() {
  triggerReportReload();
  aggiornaBtnOggi();
  aggiornaGiornoSettimana();
    document.getElementById('reportDate').addEventListener('change', function () {
    triggerReportReload();
    aggiornaBtnOggi();
  });
  document.getElementById('reportPrevDay').addEventListener('click', function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('reportDate');
    const d = new Date(dateInput.value);
    d.setDate(d.getDate() - 1);
    const fp = dateInput._flatpickr;
    if (fp) {
      fp.setDate(d, true); // aggiorna altInput e trigghera onChange
    } else {
      dateInput.value = d.toISOString().slice(0, 10);
      triggerReportReload();
      aggiornaBtnOggi();
      aggiornaGiornoSettimana();
      caricaHeatmapAppuntamenti(dateInput.value);
      caricaHeatmapIncassi(dateInput.value);
      aggiornaRiassuntoGiornaliero();
    }
  });
  document.getElementById('reportNextDay').addEventListener('click', function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('reportDate');
    const d = new Date(dateInput.value);
    d.setDate(d.getDate() + 1);
    const fp = dateInput._flatpickr;
    if (fp) {
      fp.setDate(d, true);
    } else {
      dateInput.value = d.toISOString().slice(0, 10);
      triggerReportReload();
      aggiornaBtnOggi();
      aggiornaGiornoSettimana();
      caricaHeatmapAppuntamenti(dateInput.value);
      caricaHeatmapIncassi(dateInput.value);
      aggiornaRiassuntoGiornaliero();
    }
  });
  document.getElementById('reportBtnToday').addEventListener('click', function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('reportDate');
    const oggi = new Date();
    const fp = dateInput._flatpickr;
    if (fp) {
      fp.setDate(oggi, true);
    } else {
      dateInput.value = oggi.toISOString().slice(0, 10);
      triggerReportReload();
      aggiornaBtnOggi();
      aggiornaGiornoSettimana();
      caricaHeatmapAppuntamenti(dateInput.value);
      caricaHeatmapIncassi(dateInput.value);
      aggiornaRiassuntoGiornaliero();
    }
  });
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Calcola primo e ultimo giorno del mese corrente
    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  
    // Formatta in yyyy-mm-dd
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const firstDayStr = `${yyyy}-${mm}-01`;
    const lastDayStr = `${yyyy}-${mm}-${String(lastDay.getDate()).padStart(2, '0')}`;
  
    document.getElementById('dateFrom').value = firstDayStr;
    document.getElementById('dateTo').value = lastDayStr;
  });
  </script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const btnExportExcelCorrispettivi = document.getElementById('btnExportExcelCorrispettivi');
  if (btnExportExcelCorrispettivi) {
    btnExportExcelCorrispettivi.addEventListener('click', function() {
      // Prendi la tabella
      const table = document.querySelector('#wrapperTabellaCorrispettivi table');
      if (!table) return;

      // Ottieni mese e anno dal filtro o dalla tabella
      const dateFrom = document.getElementById('dateFrom').value;
      const mese = dateFrom ? dateFrom.slice(5,7) : (new Date().getMonth()+1).toString().padStart(2,'0');
      const anno = dateFrom ? dateFrom.slice(0,4) : new Date().getFullYear();

      // Crea il workbook
      const wb = XLSX.utils.table_to_book(table, {sheet:"Corrispettivi"});
      const nomeFile = `corrispettivi_${mese}_${anno}.xlsx`;

      // Salva il file (apre la finestra di salvataggio)
      XLSX.writeFile(wb, nomeFile);
    });
  }
});
</script>
<script>
    document.getElementById('btnOggi').addEventListener('click', function() {
        const oggi = new Date();
        const yyyy = oggi.getFullYear();
        const mm = String(oggi.getMonth() + 1).padStart(2, '0');
        const dd = String(oggi.getDate()).padStart(2, '0');
        const oggiStr = `${yyyy}-${mm}-${dd}`;
        document.getElementById('dateFrom').value = oggiStr;
        document.getElementById('dateTo').value = oggiStr;
    });
    </script>
    <script>
        const mesi = [
          "Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
          "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"
        ];
        const now = new Date();
        const meseCorrente = now.getMonth();
        const annoCorrente = now.getFullYear();
        
        // Popola dropdown mesi
        const meseDropdown = document.getElementById('meseDropdown');
        mesi.forEach((mese, idx) => {
          const li = document.createElement('li');
          li.innerHTML = `<a class="dropdown-item" href="#" data-value="${idx+1}">${mese}</a>`;
          meseDropdown.appendChild(li);
        });
        
        // Popola dropdown anni
        const annoDropdown = document.getElementById('annoDropdown');
        for(let y=2020; y<=2050; y++) {
          const li = document.createElement('li');
          li.innerHTML = `<a class="dropdown-item" href="#" data-value="${y}">${y}</a>`;
          annoDropdown.appendChild(li);
        }
        
        // Preseleziona mese e anno corrente
        document.getElementById('meseSelect').value = mesi[meseCorrente];
        document.getElementById('meseSelect').dataset.value = meseCorrente+1;
        document.getElementById('annoSelect').value = annoCorrente;
        document.getElementById('annoSelect').dataset.value = annoCorrente;
        
        // Gestione selezione mese
        meseDropdown.addEventListener('click', function(e) {
          if(e.target.matches('.dropdown-item')) {
            document.getElementById('meseSelect').value = e.target.textContent;
            document.getElementById('meseSelect').dataset.value = e.target.dataset.value;
            aggiornaDateDaMeseAnno();
          }
        });
        
        // Gestione selezione anno
        annoDropdown.addEventListener('click', function(e) {
          if(e.target.matches('.dropdown-item')) {
            document.getElementById('annoSelect').value = e.target.textContent;
            document.getElementById('annoSelect').dataset.value = e.target.dataset.value;
            aggiornaDateDaMeseAnno();
          }
        });
        
        // Funzione per aggiornare i campi data
        function aggiornaDateDaMeseAnno() {
          const mese = document.getElementById('meseSelect').dataset.value;
          const anno = document.getElementById('annoSelect').dataset.value;
          if(mese && anno) {
            const from = `${anno}-${String(mese).padStart(2,'0')}-01`;
            const to = new Date(anno, mese, 0); // ultimo giorno del mese
            document.getElementById('dateFrom').value = from;
            document.getElementById('dateTo').value = `${anno}-${String(mese).padStart(2,'0')}-${String(to.getDate()).padStart(2,'0')}`;
          }
        }
        </script>
<script>
document.addEventListener('hidden.bs.modal', function () {
  // Rimuovi eventuali backdrop rimasti
  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
  document.body.classList.remove('modal-open');
  document.body.style = '';
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  let modalToShow = null;

  const btns = [
    document.getElementById('btnCorrispettivi'),
    document.getElementById('btnIncassoCategoria'),
    document.getElementById('btnPassaggiCassa'),
    document.getElementById('btnClienti'),
    document.getElementById('btnOperatori')
  ];
  const btnVaiFiltri = document.getElementById('btnVaiFiltri');
  const filtri = document.getElementById('report-filtri-avanzati');
  const loader = document.getElementById('reportLoader'); // AGGIUNTO

  function selezionaBtn(btn) {
    btns.forEach(b => {
      if (!b) return;
      b.classList.remove('btn-selected', 'active');
      b.setAttribute('aria-pressed', 'false');
    });
    if (btn) {
      btn.classList.add('btn-selected', 'active');
      btn.setAttribute('aria-pressed', 'true');
    }
  }

  if (btns[0])
    btns[0].addEventListener('click', function(e) {
      e.preventDefault();
      filtri && (filtri.style.display = 'block');
      modalToShow = "#modalCorrispettivi";
      selezionaBtn(this);
    });
  if (btns[1])
    btns[1].addEventListener('click', function(e) {
      e.preventDefault();
      filtri && (filtri.style.display = 'block');
      modalToShow = "#modalIncassoCategoria";
      selezionaBtn(this);
    });
  if (btns[2])
    btns[2].addEventListener('click', function(e) {
      e.preventDefault();
      filtri && (filtri.style.display = 'block');
      modalToShow = "#modalPassaggiCassa";
      selezionaBtn(this);
    });
  if (btns[3])
    btns[3].addEventListener('click', function(e) {
      e.preventDefault();
      filtri && (filtri.style.display = 'block');
      modalToShow = "#modalClienti";
      selezionaBtn(this);
    });
  if (btns[4])
    btns[4].addEventListener('click', function(e) {
      e.preventDefault();
      filtri && (filtri.style.display = 'block');
      modalToShow = "#modalOperatori";
      selezionaBtn(this);
    });

  if (btnVaiFiltri) {
    btnVaiFiltri.addEventListener('click', function() {
      loader.style.display = ''; // MOSTRA LOADER
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;

      if (modalToShow === "#modalIncassoCategoria") {
        fetch(`/api/report_incasso_categoria_totali?dateFrom=${dateFrom}&dateTo=${dateTo}`)
          .then(r => r.json())
          .then(data => {
            document.getElementById('incasso-categorie-datefrom').textContent = dateFrom.split('-').reverse().join('/');
            document.getElementById('incasso-categorie-dateto').textContent = dateTo.split('-').reverse().join('/');
            document.getElementById('incasso-categorie-totale').textContent = `‚Ç¨ ${data.totale.toFixed(2)}`;
            document.getElementById('incasso-categorie-estetica').textContent = `‚Ç¨ ${data.estetica.toFixed(2)}`;
            document.getElementById('incasso-categorie-estetica-pct').textContent = `(${data.estetica_pct}%)`;
            document.getElementById('incasso-categorie-solarium').textContent = `‚Ç¨ ${data.solarium.toFixed(2)}`;
            document.getElementById('incasso-categorie-solarium-pct').textContent = `(${data.solarium_pct}%)`;
            document.getElementById('incasso-categorie-estetica-passaggi').textContent = `passaggi: ${data.passaggi_estetica}`;
            document.getElementById('incasso-categorie-solarium-passaggi').textContent = `passaggi: ${data.passaggi_solarium}`;
            // Svuota eventuali selezioni sottocategorie
            const formContainer = document.getElementById('sottocategorie-form-container');
            if (formContainer) formContainer.innerHTML = '';
            const modal = new bootstrap.Modal(document.querySelector('#modalIncassoCategoria'));
            modal.show();
            loader.style.display = 'none'; // NASCONDI LOADER
          });

      } else if (modalToShow === "#modalCorrispettivi") {
        fetch(`/api/registro_corrispettivi?dateFrom=${dateFrom}&dateTo=${dateTo}`)
          .then(r => r.json())
          .then(data => {
            const tbody = document.getElementById('corpoTabellaCorrispettivi');
            tbody.innerHTML = ''; // Svuota la tabella in modo sicuro

            data.rows.forEach(row => {
              const tr = tbody.insertRow();
              tr.insertCell().textContent = row.data;
              tr.insertCell().textContent = row.giorno;
              tr.insertCell().textContent = row.totale.toFixed(2);
              tr.insertCell().textContent = row.servizi.toFixed(2);
              tr.insertCell().textContent = row.prodotti.toFixed(2);
              tr.insertCell().textContent = row.cash.toFixed(2);
              tr.insertCell().textContent = row.digitali.toFixed(2);
              tr.insertCell().textContent = row.altro.toFixed(2);
            });

            // Aggiungi la riga dei totali
            const trTotale = tbody.insertRow();
            trTotale.className = 'ultima-riga-totale';
            const thTotale = document.createElement('th');
            thTotale.colSpan = 2;
            thTotale.textContent = 'Totale';
            trTotale.appendChild(thTotale);
            trTotale.insertCell().textContent = (data.totali.totale||0).toFixed(2);
            trTotale.insertCell().textContent = (data.totali.servizi||0).toFixed(2);
            trTotale.insertCell().textContent = (data.totali.prodotti||0).toFixed(2);
            trTotale.insertCell().textContent = (data.totali.cash||0).toFixed(2);
            trTotale.insertCell().textContent = (data.totali.digitali||0).toFixed(2);
            trTotale.insertCell().textContent = (data.totali.altro||0).toFixed(2);
            
            const modal = new bootstrap.Modal(document.querySelector('#modalCorrispettivi'));
            modal.show();
            loader.style.display = 'none'; // NASCONDI LOADER
          });

      } else if (modalToShow === "#modalPassaggiCassa") {
        fetch(`/api/report_passaggi_cassa?dateFrom=${dateFrom}&dateTo=${dateTo}`)
          .then(r => r.json())
          .then(data => {
            const tbody = document.getElementById('corpoTabellaPassaggiCassa');
            tbody.innerHTML = ''; // Svuota la tabella

            data.rows.forEach(row => {
              const tr = tbody.insertRow();
              tr.insertCell().textContent = row.data;
              tr.insertCell().textContent = row.giorno;
              tr.insertCell().textContent = row.totali;
              tr.insertCell().textContent = row.fiscali;
              tr.insertCell().textContent = row.uomo;
              tr.insertCell().textContent = row.donna;
            });

            // Aggiungi la riga dei totali
            const trTotale = tbody.insertRow();
            trTotale.className = 'ultima-riga-totale';
            const thTotale = document.createElement('th');
            thTotale.colSpan = 2;
            thTotale.textContent = 'Totale';
            trTotale.appendChild(thTotale);
            trTotale.insertCell().textContent = data.totali.totali;
            trTotale.insertCell().textContent = data.totali.fiscali;
            trTotale.insertCell().textContent = data.totali.uomo;
            trTotale.insertCell().textContent = data.totali.donna;

            const modal = new bootstrap.Modal(document.querySelector('#modalPassaggiCassa'));
            modal.show();
            loader.style.display = 'none'; // NASCONDI LOADER
          });

      } else if (modalToShow === "#modalClienti") {
        fetch(`/api/report_clienti?dateFrom=${dateFrom}&dateTo=${dateTo}`)
          .then(r => r.json())
          .then(data => {
            document.getElementById('clienti-stats-range').textContent =
              `Passaggi dal ${dateFrom.split('-').reverse().join('/')} al ${dateTo.split('-').reverse().join('/')}`;
            clientiData = data.rows;
            renderTabellaClienti();
            const modal = new bootstrap.Modal(document.querySelector('#modalClienti'));
            modal.show();
            loader.style.display = 'none'; // NASCONDI LOADER
          });

      } else if (modalToShow === "#modalOperatori") {
        fetch(`/api/report_operatori?dateFrom=${dateFrom}&dateTo=${dateTo}`)
          .then(r => r.json())
          .then(data => {
            // PATCH: Costruzione sicura dell'header
            const thead = document.getElementById('theadOperatori');
            thead.innerHTML = '';
            const headRow = thead.insertRow();
            headRow.insertCell().textContent = 'Data';
            data.operatori.forEach(op => {
              headRow.insertCell().textContent = op.nome;
            });
            headRow.insertCell().textContent = 'Totale giorno';

            // PATCH: Costruzione sicura del corpo
            const tbody = document.getElementById('corpoTabellaOperatori');
            tbody.innerHTML = '';
            data.rows.forEach(row => {
              const tr = tbody.insertRow();
              tr.insertCell().textContent = row.data;
              data.operatori.forEach(op => {
                tr.insertCell().textContent = row[op.id].toFixed(2);
              });
              tr.insertCell().textContent = row.totale.toFixed(2);
            });

            // PATCH: Costruzione sicura del footer
            const tfoot = document.getElementById('tfootOperatori');
            tfoot.innerHTML = '';
            const footRow = tfoot.insertRow();
            footRow.style.fontWeight = 'bold';
            footRow.insertCell().textContent = 'TOTALE';
            data.operatori.forEach(op => {
              footRow.insertCell().textContent = (data.totali_operatori[op.id] || 0).toFixed(2);
            });
            footRow.insertCell().textContent = (data.totale_periodo || 0).toFixed(2);

            const modal = new bootstrap.Modal(document.querySelector('#modalOperatori'));
            modal.show();
            loader.style.display = 'none'; // NASCONDI LOADER
          });

      } else if (modalToShow) {
        const modal = new bootstrap.Modal(document.querySelector(modalToShow));
        modal.show();
        loader.style.display = 'none'; // NASCONDI LOADER
      } else {
        alert("Seleziona prima una tipologia di report.");
        loader.style.display = 'none'; // NASCONDI LOADER
      }
    });
  }
});
</script>
<script>
 document.getElementById('btnExportPdfCorrispettivi').addEventListener('click', function() {
  const table = document.querySelector('#wrapperTabellaCorrispettivi table');
  if (!table) return;

  const dateFrom = document.getElementById('dateFrom').value;
  const mese = dateFrom ? dateFrom.slice(5,7) : (new Date().getMonth()+1).toString().padStart(2,'0');
  const anno = dateFrom ? dateFrom.slice(0,4) : new Date().getFullYear();
  const nomeFile = `corrispettivi_${mese}_${anno}.pdf`;

  // Prendi il nome azienda dalla variabile globale
  const businessName = window.BUSINESS_NAME || '';

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'landscape',
    unit: 'pt',
    format: 'a4'
  });

  doc.autoTable({
  html: table,
  startY: 60,
  styles: {
    halign: 'center',
    valign: 'middle',
    fontSize: 9,
    cellPadding: 2,
    lineWidth: 0.45,
    lineColor: [0,0,0]
  },
  headStyles: {
    fillColor: [220, 220, 220],
    textColor: [0,0,0],
    fontStyle: 'bold',
    halign: 'center'
  },
  bodyStyles: {
    halign: 'center',
    valign: 'middle'
  },
  alternateRowStyles: {
    fillColor: [245, 245, 245]
  },
  tableLineColor: [0,0,0],
  tableLineWidth: 0.45,
  pageBreak: 'auto',
  margin: { top: 10 },
  didDrawPage: function (data) {
    doc.setFontSize(10);
    doc.text(`Registro Corrispettivi - ${mese}/${anno} - ${businessName}`, 40, 40);
  },
  didParseCell: function (data) {
    // Rendi l'ultima riga (totali) in grassetto
    if (data.row.index === data.table.body.length - 1) {
      data.cell.styles.fontStyle = 'bold';
    }
  }
});

  doc.save(nomeFile);
});
</script>
<script>
  window.BUSINESS_NAME = "{{ business_info.business_name|escapejs if business_info else '' }}";
</script>
<script>
function caricaHeatmapAppuntamenti(dataRif) {
  let url = '/api/heatmap_appuntamenti';
  if (dataRif) {
    url += `?data_rif=${encodeURIComponent(dataRif)}`;
  }
  fetch(url)
    .then(r => r.json())
    .then(data => {
      const ore = [...data.ore];
      const ultimaOra = parseInt(data.ore[data.ore.length - 1], 10) + 1;
      ore.push(ultimaOra.toString().padStart(2, '0'));

      const z = [];
      for (let y = 0; y < data.giorni.length; y++) {
        z[y] = [];
        for (let x = 0; x < data.ore.length; x++) {
          const cell = data.valori.find(v => v.x === x && v.y === y);
          z[y][x] = cell ? cell.v : 0;
        }
        z[y].push(0);
      }

      // RIBALTA VERTICALMENTE I RISULTATI: Inverti l'ordine delle righe in z
      z.reverse();

      const trace = {
        z: z,
        x: ore,
        y: data.giorni,
        type: 'heatmap',
        colorscale: [
          [0, '#fff'],
          [0.2, '#f8bbd0'],
          [0.5, '#f06292'],
          [0.8, '#e53935'],
          [1, '#b71c1c']
        ],
        reversescale: false,
        showscale: true,
        zmin: 0,
        zmax: data.max_legend,
        hovertemplate: 'Giorno: %{y}<br>Ora: %{x}<br>Appuntamenti: %{z}<extra></extra>',
        xgap: 0,
        ygap: 0,
        colorbar: {
          outlinewidth: 0 
        }
      };

      const layout = {
        margin: {l: 70, r: 30, t: 50, b: 30},
        xaxis: {
          title: {
            text: 'Ora',
            standoff: 20
          },
          side: 'top',
          type: 'category',
          tickmode: 'array',
          tickvals: ore,
          ticktext: ore
        },
        yaxis: {autorange: 'reversed', type: 'category'},
        height: 260
      };

      Plotly.newPlot('heatmapAppuntamenti', [trace], layout, {displayModeBar: false, responsive: true});

      // CORREZIONE: Salva dataRif per il click handler
      window.currentDataRifAppuntamenti = dataRif;

      // Gestione click sulla heatmap
      document.getElementById('heatmapAppuntamenti').on('plotly_click', function(eventData) {
        if (eventData && eventData.points && eventData.points.length > 0) {
          const punto = eventData.points[0];
          const giorno = punto.y; // es: "23/05"
          let ora = punto.x;  // es: "08"
    // Assicurati che ora sia una stringa valida (es: "08")
    if (typeof ora === 'number') {
      // Se √® indice, mappa all'ora corrispondente
      const oreArray = ["08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20"];
      ora = oreArray[ora] || "08"; // fallback a 08 se fuori range
    } else if (typeof ora === 'string' && ora.length === 2) {
      // Ok, √® gi√† stringa come "08"
    } else {
      ora = "08"; // fallback
    }

    // Usa dataRif come stringa per evitare problemi di serializzazione
    let dataRifStr = window.currentDataRifAppuntamenti;
    if (!dataRifStr || typeof dataRifStr !== 'string') {
      // Fallback a oggi se non disponibile
      const oggi = new Date();
      dataRifStr = oggi.toISOString().slice(0, 10);
    }

    const dataRifDate = new Date(dataRifStr);
    if (isNaN(dataRifDate.getTime())) {
      console.error("Data di riferimento non valida:", dataRifStr);
      return; // Esci senza navigare
    }

    // Trova l'indice del giorno cliccato
    const giornoIdx = data.giorni.indexOf(giorno);
    if (giornoIdx === -1) {
      console.error("Giorno non trovato:", giorno);
      return;
    }

    // Calcola la data effettiva partendo da dataRif - (N giorni)
    const giorniDaSottrarre = data.giorni.length - 1 - giornoIdx;
    const dataClick = new Date(dataRifDate.getFullYear(), dataRifDate.getMonth(), dataRifDate.getDate() - giorniDaSottrarre);
    if (isNaN(dataClick.getTime())) {
      console.error("Data calcolata non valida");
      return;
    }

          const yyyy = dataClick.getFullYear();
          const mm = String(dataClick.getMonth() + 1).padStart(2, '0');
          const dd = String(dataClick.getDate()).padStart(2, '0');
          const dataStr = `${yyyy}-${mm}-${dd}`;

    // Salva i parametri per lo scroll in sessionStorage (meccanismo esistente)
    sessionStorage.setItem('scrollToDate', dataStr);
    sessionStorage.setItem('scrollToHour', ora);
    sessionStorage.setItem('scrollToMinute', '00'); // Default a 00 minuti

          // Vai su calendar.html con parametri data e ora
          window.location.href = `/calendar/?date=${dataStr}&hour=${ora}`;
        }
      });

    });
}

function caricaHeatmapIncassi(dataRif) {
  let url = '/api/heatmap_incassi';
  if (dataRif) {
    url += `?data_rif=${encodeURIComponent(dataRif)}`;
  }
  fetch(url)
    .then(r => r.json())
    .then(data => {
      const ore = [...data.ore];
      const ultimaOra = parseInt(data.ore[data.ore.length - 1], 10) + 1;
      ore.push(ultimaOra.toString().padStart(2, '0'));

      const z = [];
      for (let y = 0; y < data.giorni.length; y++) {
        z[y] = [];
        for (let x = 0; x < data.ore.length; x++) {
          const cell = data.valori.find(v => v.x === x && v.y === y);
          z[y][x] = cell ? cell.v : 0;
        }
        z[y].push(0);
      }

const maxValue = data.max_legend || 0;
const hasData = maxValue > 0;

const trace = {
  z: z,
  x: ore,
  y: data.giorni,
  type: 'heatmap',
  colorscale: [
    [0, '#fff'],
    [0.2, '#b2dfdb'],
    [0.5, '#4dd0e1'],
    [0.8, '#0097a7'],
    [1, '#004d40']
  ],
  reversescale: false,
  showscale: hasData, // **Nascondi la scala se non ci sono dati**
  zmin: 0,
  zmax: hasData ? maxValue : 1, // **Imposta zmax a 1 se tutti i valori sono 0**
  hovertemplate: 'Giorno: %{y}<br>Ora: %{x}<br>Incasso: %{z:.2f}‚Ç¨<extra></extra>',
  xgap: 0,
  ygap: 0,
  colorbar: {
    outlinewidth: 0,
    title: '‚Ç¨'
  }
};

      const layout = {
        margin: {l: 70, r: 30, t: 50, b: 30},
        xaxis: {
          title: {
            text: 'Ora',
            standoff: 20
          },
          side: 'top',
          type: 'category',
          tickmode: 'array',
          tickvals: ore,
          ticktext: ore
        },
        yaxis: {autorange: 'reversed', type: 'category'},
        height: 260
      };

      Plotly.newPlot('heatmapIncassi', [trace], layout, {displayModeBar: false, responsive: true});
    });
}

// Carica le heatmap all'avvio
document.addEventListener('DOMContentLoaded', function() {
  caricaHeatmapIncassi();
});
document.addEventListener('DOMContentLoaded', function() {
  caricaHeatmapAppuntamenti();
});
</script>
<script>
// filepath: c:\Program Files\SunBooking\appl\templates\report.html
document.addEventListener('DOMContentLoaded', function() {
  const grid = document.getElementById('report-tiles-grid');
  const tileSelector = '.tile-neumorphic';
  if (!grid) return;

  function salvaOrdine() {
    const ids = Array.from(grid.querySelectorAll(tileSelector)).map(t => t.id);
    localStorage.setItem('reportTilesOrder', JSON.stringify(ids));
  }
  function ripristinaOrdine() {
    const saved = localStorage.getItem('reportTilesOrder');
    if (!saved) return;
    JSON.parse(saved).forEach(id => {
      const tile = document.getElementById(id);
      if (tile) grid.appendChild(tile);
    });
  }

  ripristinaOrdine();

  let sortableInstance = null;
  function enableDrag() {
    if (sortableInstance) return;
    sortableInstance = Sortable.create(grid, {
      animation: 200,
      ghostClass: 'tile-ghost',
      chosenClass: 'tile-chosen',
      onEnd: salvaOrdine
    });
    grid.classList.add('tiles-draggable');
  }
  function disableDrag() {
    if (sortableInstance) {
      sortableInstance.destroy();
      sortableInstance = null;
    }
    grid.classList.remove('tiles-draggable');
  }
  function applyMode() {
    if (window.matchMedia('(min-width: 1201px)').matches) {
      enableDrag();
    } else {
      disableDrag();
    }
  }

  applyMode();
  window.addEventListener('resize', applyMode);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Apri il modal settings
  document.getElementById('btnSettings').addEventListener('click', function() {
    popolaSettingsTiles();
    const modal = new bootstrap.Modal(document.getElementById('modalSettingsTiles'));
    modal.show();
  });

  // Popola la tabella dei tile
  function popolaSettingsTiles() {
    const tiles = Array.from(document.querySelectorAll('.tile-neumorphic'));
    const tbody = document.getElementById('settingsTilesTableBody');
    tbody.innerHTML = '';
    tiles.forEach(tile => {
    const titolo = tile.querySelector('.tile-title')?.innerText || tile.id;
      const checked = tile.style.display !== 'none' ? 'checked' : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${titolo}</td>
        <td class="text-center">
          <input type="checkbox" class="tile-visibile-checkbox" data-tileid="${tile.id}" ${checked}>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Gestione toggle visibilit√†
    tbody.querySelectorAll('.tile-visibile-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const tile = document.getElementById(this.dataset.tileid);
        if (this.checked) {
          tile.style.display = '';
        } else {
          tile.style.display = 'none';
        }
        salvaVisibilitaTiles();
      });
    });
  }

  // Ripristina la visibilit√† dei tile all'avvio
  function ripristinaVisibilitaTiles() {
    const stato = JSON.parse(localStorage.getItem('reportTilesVisibility') || '{}');
    Object.entries(stato).forEach(([id, visibile]) => {
      const tile = document.getElementById(id);
      if (tile) tile.style.display = visibile ? '' : 'none';
    });
  }
  ripristinaVisibilitaTiles();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {

  // Gestione chiusura tile tramite "X"
  document.querySelectorAll('.btn-close-tile').forEach(btn => {
    btn.addEventListener('click', function() {
      const tile = this.closest('.tile-neumorphic');
      if (tile) {
        tile.style.display = 'none';
        if (typeof salvaVisibilitaTiles === 'function') salvaVisibilitaTiles();
      }
    });
  });
});
</script>
<script>
    function salvaVisibilitaTiles() {
    const tiles = Array.from(document.querySelectorAll('.tile-neumorphic'));
    const stato = {};
    tiles.forEach(tile => {
      stato[tile.id] = tile.style.display !== 'none';
    });
    localStorage.setItem('reportTilesVisibility', JSON.stringify(stato));
  }
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const filtri = document.getElementById('report-filtri-avanzati');
  const btns = [
  document.getElementById('btnCorrispettivi'),
  document.getElementById('btnIncassoCategoria'),
  document.getElementById('btnPassaggiCassa'),
  document.getElementById('btnClienti'),
  document.getElementById('btnOperatori')
];

  document.addEventListener('mousedown', function(e) {
    // Se i filtri sono visibili
    if (filtri && filtri.style.display === 'block') {
      // Se il click NON √® dentro i filtri e NON √® su uno dei pulsanti
      if (!filtri.contains(e.target) && !btns.some(btn => btn && btn.contains(e.target))) {
        filtri.style.display = 'none';
        // Rimuovi evidenziazione dal pulsante selezionato
        btns.forEach(btn => btn && btn.classList.remove('btn-selected', 'active'));
      }
    }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const list = document.getElementById('next-appointments-list');
  if (!list) return;

  // 1) prova a mostrare SUBITO da cache (se c'√®)
  try {
    const cached = JSON.parse(localStorage.getItem('report_next_appointments') || '[]');
    if (Array.isArray(cached) && cached.length) {
      renderNextAppointments(list, cached);
    }
  } catch(_) {}

  // 2) poi aggiorna da server (quando online) e rinfresca cache
  fetch('/api/next_appointments', { cache: 'no-store' })
    .then(r => r.ok ? r.json() : [])
    .then(data => {
      if (!Array.isArray(data)) return;
      try {
        localStorage.setItem('report_next_appointments', JSON.stringify(data));
        localStorage.setItem('report_next_appointments_ts', String(Date.now()));
      } catch(_) {}
      renderNextAppointments(list, data);
    })
    .catch(() => {
      // se offline e senza cache, lascia ci√≤ che c'√®
      if (!list.children.length) {
        list.innerHTML = '<li>(offline) Nessun dato in cache</li>';
      }
    });

  // funzione di rendering (estratta per riuso)
  function renderNextAppointments(listEl, data) {
    // Normalizza: "pier francesco" -> "Pier Francesco", "d'agostini" -> "D‚ÄôAgostini"
    const formatPersonName = (s) => {
      if (s == null) return '';
      const base = String(s).trim().replace(/\s+/g, ' ').toLocaleLowerCase('it-IT');
      return base.replace(/(^|[ \-‚Äô'])(\p{L})/gu, (_, p1, p2) => p1 + p2.toLocaleUpperCase('it-IT'));
    };

    listEl.innerHTML = '';
    if (!data.length) {
      listEl.innerHTML = '<li>Nessun appuntamento imminente</li>';
      return;
    }
    const oggi = new Date();
    const yyyy = oggi.getFullYear();
    const mm = String(oggi.getMonth() + 1).padStart(2, '0');
    const dd = String(oggi.getDate()).padStart(2, '0');
    const oggiStr = `${yyyy}-${mm}-${dd}`;

      data.forEach((appt, idx) => {
    // SALTA appuntamenti OFF
    if (appt.is_off) return;

    const li = document.createElement('li');

      let apptDate = appt.date;
      if (apptDate && apptDate.includes('/')) {
        const [d, m, y] = apptDate.split('/');
        apptDate = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
      }

      li.classList.add('next-app-row');
      li.setAttribute('data-date', apptDate);
      li.setAttribute('data-hour', (appt.start_time||'00:00').split(':')[0]);
      li.setAttribute('data-minute', (appt.start_time||'00:00').split(':')[1]);

       const rawClient = appt.is_off ? (appt.note || 'OFF') : (appt.client ?? '');
       const clientLabel = appt.is_off ? rawClient : formatPersonName(rawClient);

if (apptDate === oggiStr) {
  const tag = document.createElement('span');
  tag.className = 'next-app-date-today';
  tag.textContent = 'OGGI';
  li.appendChild(tag);
  li.appendChild(document.createTextNode(' ore '));
  li.appendChild(document.createTextNode(String(appt.start_time ?? '')));
  li.appendChild(document.createTextNode(' - '));
  li.appendChild(document.createTextNode(clientLabel));
  li.appendChild(document.createTextNode(' - '));
  li.appendChild(document.createTextNode(String(appt.service ?? '')));
} else {
  const parts = [
    String(appt.date ?? ''), ' ore ',
    String(appt.start_time ?? ''), ' - ',
    clientLabel, ' - ',
    String(appt.service ?? '')
  ];
  parts.forEach(p => li.appendChild(document.createTextNode(p)));
}

      if (idx % 2 === 1) li.classList.add('alt');
      listEl.appendChild(li);
    });

    // click per aprire il giorno nel calendario
    listEl.querySelectorAll('.next-app-row').forEach(li => {
      li.style.cursor = 'pointer';
      li.addEventListener('click', function() {
        const date = this.getAttribute('data-date');
        const hour = this.getAttribute('data-hour');
        const minute = this.getAttribute('data-minute');
        if (date && hour && minute) {
          sessionStorage.setItem('scrollToHour', hour);
          sessionStorage.setItem('scrollToMinute', minute);
          window.location.href = `/calendar?date=${date}&ora=${hour}:${minute}`;
        }
      });
    });
  }
});
</script>
<script>
function exportAgendaPDF(rows, dateISO) {
  console.log('exportAgendaPDF chiamata con dateISO:', dateISO);
  const { jsPDF } = window.jspdf;
  // Usa la data passata invece di oggi
  if (!dateISO || !/^\d{4}-\d{2}-\d{2}$/.test(dateISO)) {
    console.log('dateISO non valido, uso oggi');
    alert('Data non valida per export PDF agenda.');
    return;
  }
  const [yyyy, mm, dd] = dateISO.split('-');
  console.log('yyyy:', yyyy, 'mm:', mm, 'dd:', dd);
  const dataIt = `${dd}/${mm}/${yyyy}`;
  const dataFile = `${dd}-${mm}-${yyyy}`;
  console.log('dataIt:', dataIt, 'dataFile:', dataFile);
  const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

  doc.setFontSize(12);
  doc.text(`Agenda del ${dataIt}`, 40, 40);

  // Prepara intestazione e dati tabella
  const head = [["Operatore","Ora","Cliente","Servizio","Nota"]];
  const body = rows.map(r => [
    r.operator,
    r.start_time,
    r.client,
    r.service,
    r.note
  ]);

  doc.autoTable({
    head: head,
    body: body,
    startY: 60,
    styles: { fontSize: 10 }
  });

  doc.save(`agenda_${dataFile}.pdf`);
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const btnViewAgenda = document.getElementById('btnViewAgenda');
  if (!btnViewAgenda) return;

  document.getElementById('btnViewAgenda').addEventListener('click', async function() {
    const el = document.getElementById('reportDate');
    const fp = el && el._flatpickr ? el._flatpickr : null;
    const dateISO = fp && fp.selectedDates.length
      ? fp.formatDate(fp.selectedDates[0], 'Y-m-d')
      : (el.value || '').trim();  // Fallback al valore dell'input se flatpickr non disponibile

    if (!/^\d{4}-\d{2}-\d{2}$/.test(dateISO)) {
      alert('Seleziona una data valida nel navigator.');
      return;
    }

    const resp = await fetch(`/api/agenda_data?date=${encodeURIComponent(dateISO)}`);
    const rows = await resp.json();
    if (!Array.isArray(rows) || !rows.length) {
      alert("Nessun appuntamento per questa data.");
      return;
    }
    console.log('dateISO selezionata per PDF:', dateISO);
    exportAgendaPDF(rows, dateISO);  // Usa la funzione rinominata
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  fetch('/api/business_city')
    .then(res => res.json())
    .then(loc => {
      let city = loc.city || "Milano";
      let province = loc.province || "";
      let query = city + (province ? `, ${province}` : "") + ", Italia";
      // Geocoding con Nominatim
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(geo => {
          let lat = 45.4642, lon = 9.19; // default Milano
          if (geo && geo.length > 0) {
            lat = geo[0].lat;
            lon = geo[0].lon;
          }
          // Ora chiama Open-Meteo
          fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&current_weather=true&timezone=auto`)
            .then(res => res.json())
            .then(data => {
              // ... (qui il tuo codice per mostrare le icone e le temperature, come gi√† fatto sopra)
              // Copia qui il blocco che aggiorna #meteo-icona-oggi
              // ...
              const icons = {
                0: "‚òÄÔ∏è", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "‚òÅÔ∏è", 45: "üå´Ô∏è", 48: "üå´Ô∏è",
                51: "üå¶Ô∏è", 53: "üå¶Ô∏è", 55: "üå¶Ô∏è", 56: "üåßÔ∏è", 57: "üåßÔ∏è",
                61: "üå¶Ô∏è", 63: "üåßÔ∏è", 65: "üåßÔ∏è", 66: "üåßÔ∏è", 67: "üåßÔ∏è",
                71: "‚ùÑÔ∏è", 73: "‚ùÑÔ∏è", 75: "‚ùÑÔ∏è", 77: "‚ùÑÔ∏è", 80: "üå¶Ô∏è",
                81: "üåßÔ∏è", 82: "üåßÔ∏è", 85: "‚ùÑÔ∏è", 86: "‚ùÑÔ∏è", 95: "‚õàÔ∏è",
                96: "‚õàÔ∏è", 99: "‚õàÔ∏è"
              };
              const descrizioni = {
                0: "Soleggiato", 1: "Preval. sereno", 2: "Parz. nuvoloso", 3: "Nuvoloso",
                45: "Nebbia", 48: "Nebbia", 51: "Pioviggine", 53: "Pioviggine", 55: "Pioviggine",
                56: "Pioggia gelata", 57: "Pioggia gelata", 61: "Pioggia leggera", 63: "Pioggia",
                65: "Pioggia forte", 66: "Pioggia gelata", 67: "Pioggia gelata", 71: "Neve leggera",
                73: "Neve", 75: "Neve forte", 77: "Neve", 80: "Rovesci", 81: "Rovesci",
                82: "Rovesci forti", 85: "Neve", 86: "Neve forte", 95: "Temporale",
                96: "Temporale", 99: "Temporale"
              };

              const meteoOggi = data.current_weather;
              const codeOggi = meteoOggi.weathercode;
              const iconOggi = icons[codeOggi] || "‚ùì";
              const descOggi = descrizioni[codeOggi] || "N/D";
              const tempOggi = Math.round(meteoOggi.temperature);

              const daily = data.daily;
              const codeDomani = daily.weathercode[1];
              const iconDomani = icons[codeDomani] || "‚ùì";
              const descDomani = descrizioni[codeDomani] || "N/D";
              const tempDomani = Math.round(daily.temperature_2m_max[1]);
              const tempDomaniMin = Math.round(daily.temperature_2m_min[1]);

              const codeDopo = daily.weathercode[2];
              const iconDopo = icons[codeDopo] || "‚ùì";
              const descDopo = descrizioni[codeDopo] || "N/D";
              const tempDopo = Math.round(daily.temperature_2m_max[2]);
              const tempDopoMin = Math.round(daily.temperature_2m_min[2]);

const root = document.getElementById('meteo-icona-oggi');
root.innerHTML = '';

function makeCol(icon, temp, label, desc, minText) {
  const col = document.createElement('div');

  const iconEl = document.createElement('div');
  iconEl.style.fontSize = '3.2em';
  iconEl.textContent = String(icon ?? '‚ùì');
  col.appendChild(iconEl);

  const tempEl = document.createElement('div');
  tempEl.style.fontSize = '1.4em';
  tempEl.style.fontWeight = '600';
  tempEl.textContent = `${Math.round(temp)}¬∞C`;
  col.appendChild(tempEl);

  const descWrap = document.createElement('div');
  descWrap.style.fontSize = '1.1em';
  descWrap.style.color = '#555';

  const labelEl = document.createElement('span');
  labelEl.style.fontSize = '0.9em';
  labelEl.style.color = '#888';
  labelEl.textContent = label;
  descWrap.appendChild(labelEl);

  descWrap.appendChild(document.createElement('br'));

  const descEl = document.createElement('span');
  descEl.textContent = String(desc ?? 'N/D');
  descWrap.appendChild(descEl);

  col.appendChild(descWrap);

  if (minText) {
    const minEl = document.createElement('div');
    minEl.style.fontSize = '0.9em';
    minEl.style.color = '#888';
    minEl.textContent = minText;
    col.appendChild(minEl);
  }
  return col;
}

const row = document.createElement('div');
row.style.display = 'flex';
row.style.gap = '24px';
row.style.justifyContent = 'center';

row.appendChild(makeCol(iconOggi, tempOggi, 'Oggi', descOggi, null));
row.appendChild(makeCol(iconDomani, tempDomani, 'Domani', descDomani, `min ${tempDomaniMin}¬∞C`));
row.appendChild(makeCol(iconDopo, tempDopo, 'Dopodomani', descDopo, `min ${tempDopoMin}¬∞C`));

root.appendChild(row);

            });
        });
    });
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
  const isUser = {% if current_user.ruolo.value == 'user' %}true{% else %}false{% endif %};
  window.aggiornaRiassuntoGiornaliero = function() {
    const dateStr = document.getElementById('reportDate').value;
    // Aggiorna la data nel titolo
    const date = new Date(dateStr);
    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
    document.getElementById('riassunto-data').textContent = date.toLocaleDateString('it-IT', options);

    // Modifica header tabella in base al ruolo
    const thead = document.querySelector('#tabella-riassunto thead tr');
    thead.innerHTML = `
      <tr>
        <th></th>
        ${isUser ? '<th>SERVIZI</th><th>PRODOTTI</th><th>TOTALE</th>' : '<th>FISCALE</th><th>TEST</th><th>TOTALE</th>'}
      </tr>
    `;

    fetch(`/api/report_day?date=${dateStr}`)
      .then(r => r.json())
      .then(data => {
        if (isUser) {
          // Per user: colonne SERVIZI, PRODOTTI, TOTALE
          document.getElementById('riassunto-cash-fiscale').innerText = `‚Ç¨ ${(data.cash_servizi ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-pos-fiscale').innerText = `‚Ç¨ ${(data.pos_servizi ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-altro-fiscale').innerText = `‚Ç¨ ${(data.altro_servizi ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-cash-test').innerText = `‚Ç¨ ${(data.cash_prodotti ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-pos-test').innerText = `‚Ç¨ ${(data.pos_prodotti ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-altro-test').innerText = `‚Ç¨ ${(data.altro_prodotti ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-cash-totale').innerText = `‚Ç¨ ${((data.cash_servizi ?? 0) + (data.cash_prodotti ?? 0)).toFixed(2)}`;
          document.getElementById('riassunto-pos-totale').innerText = `‚Ç¨ ${((data.pos_servizi ?? 0) + (data.pos_prodotti ?? 0)).toFixed(2)}`;
          document.getElementById('riassunto-altro-totale').innerText = `‚Ç¨ ${((data.altro_servizi ?? 0) + (data.altro_prodotti ?? 0)).toFixed(2)}`;
          const totaleServizi = (data.cash_servizi ?? 0) + (data.pos_servizi ?? 0) + (data.altro_servizi ?? 0);
          const totaleProdotti = (data.cash_prodotti ?? 0) + (data.pos_prodotti ?? 0) + (data.altro_prodotti ?? 0);
          const totaleTotale = totaleServizi + totaleProdotti;
          document.getElementById('riassunto-totale-fiscale').innerText = `‚Ç¨ ${totaleServizi.toFixed(2)}`;
          document.getElementById('riassunto-totale-test').innerText = `‚Ç¨ ${totaleProdotti.toFixed(2)}`;
          document.getElementById('riassunto-totale-totale').innerText = `‚Ç¨ ${totaleTotale.toFixed(2)}`;
          // ESTETICA
          const esteticaServizi = data.estetica_servizi ?? 0;
          const esteticaProdotti = data.estetica_prodotti ?? 0;
          const esteticaTotale = esteticaServizi + esteticaProdotti;
          document.getElementById('riassunto-estetica-fiscale').innerText = `‚Ç¨ ${esteticaServizi.toFixed(2)}`;
          document.getElementById('riassunto-estetica-test').innerText = `‚Ç¨ ${esteticaProdotti.toFixed(2)}`;
          document.getElementById('riassunto-estetica-totale').innerText = `‚Ç¨ ${esteticaTotale.toFixed(2)}`;
          // SOLARIUM
          const solariumServizi = data.solarium_servizi ?? 0;
          const solariumProdotti = data.solarium_prodotti ?? 0;
          const solariumTotale = solariumServizi + solariumProdotti;
          document.getElementById('riassunto-solarium-fiscale').innerText = `‚Ç¨ ${solariumServizi.toFixed(2)}`;
          document.getElementById('riassunto-solarium-test').innerText = `‚Ç¨ ${solariumProdotti.toFixed(2)}`;
          document.getElementById('riassunto-solarium-totale').innerText = `‚Ç¨ ${solariumTotale.toFixed(2)}`;
        } else {
          // Per admin/owner: colonne FISCALE, TEST, TOTALE (logica esistente)
          document.getElementById('riassunto-cash-fiscale').innerText = `‚Ç¨ ${(data.cash_fiscale ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-pos-fiscale').innerText = `‚Ç¨ ${(data.pos_fiscale ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-altro-fiscale').innerText = `‚Ç¨ ${(data.altro_fiscale ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-cash-test').innerText = `‚Ç¨ ${(data.cash_test ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-pos-test').innerText = `‚Ç¨ ${(data.pos_test ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-altro-test').innerText = `‚Ç¨ ${(data.altro_test ?? 0).toFixed(2)}`;
          document.getElementById('riassunto-cash-totale').innerText = `‚Ç¨ ${((data.cash_fiscale ?? 0) + (data.cash_test ?? 0)).toFixed(2)}`;
          document.getElementById('riassunto-pos-totale').innerText = `‚Ç¨ ${((data.pos_fiscale ?? 0) + (data.pos_test ?? 0)).toFixed(2)}`;
          document.getElementById('riassunto-altro-totale').innerText = `‚Ç¨ ${((data.altro_fiscale ?? 0) + (data.altro_test ?? 0)).toFixed(2)}`;
          const totaleFiscale = (data.cash_fiscale ?? 0) + (data.pos_fiscale ?? 0) + (data.altro_fiscale ?? 0);
          const totaleTest = (data.cash_test ?? 0) + (data.pos_test ?? 0) + (data.altro_test ?? 0);
          const totaleTotale = totaleFiscale + totaleTest;
          document.getElementById('riassunto-totale-fiscale').innerText = `‚Ç¨ ${totaleFiscale.toFixed(2)}`;
          document.getElementById('riassunto-totale-test').innerText = `‚Ç¨ ${totaleTest.toFixed(2)}`;
          document.getElementById('riassunto-totale-totale').innerText = `‚Ç¨ ${totaleTotale.toFixed(2)}`;
          // ESTETICA
          const esteticaFiscale = data.estetica_fiscale ?? 0;
          const esteticaTest = data.estetica_test ?? 0;
          const esteticaTotale = esteticaFiscale + esteticaTest;
          document.getElementById('riassunto-estetica-fiscale').innerText = `‚Ç¨ ${esteticaFiscale.toFixed(2)}`;
          document.getElementById('riassunto-estetica-test').innerText = `‚Ç¨ ${esteticaTest.toFixed(2)}`;
          document.getElementById('riassunto-estetica-totale').innerText = `‚Ç¨ ${esteticaTotale.toFixed(2)}`;
          // SOLARIUM
          const solariumFiscale = data.solarium_fiscale ?? 0;
          const solariumTest = data.solarium_test ?? 0;
          const solariumTotale = solariumFiscale + solariumTest;
          document.getElementById('riassunto-solarium-fiscale').innerText = `‚Ç¨ ${solariumFiscale.toFixed(2)}`;
          document.getElementById('riassunto-solarium-test').innerText = `‚Ç¨ ${solariumTest.toFixed(2)}`;
          document.getElementById('riassunto-solarium-totale').innerText = `‚Ç¨ ${solariumTotale.toFixed(2)}`;
        }
      });
  }
  // Aggiorna all'avvio e al cambio data
  aggiornaRiassuntoGiornaliero();
  document.getElementById('reportDate').addEventListener('change', aggiornaRiassuntoGiornaliero);

  // Funzione copia riassunto (adatta per user)
  document.getElementById('btnCopiaRiassunto').addEventListener('click', function() {
    const dateStr = document.getElementById('reportDate').value;
    fetch(`/api/report_day?date=${dateStr}`)
      .then(r => r.json())
      .then(data => {
        let testo;
        if (isUser) {
          const servizi = (data.totale_servizi ?? 0).toFixed(2);
          const prodotti = (data.totale_prodotti ?? 0).toFixed(2);
          const totale = (data.totale ?? 0).toFixed(2);
          testo = `Servizi ‚Ç¨ ${servizi}, Prodotti ‚Ç¨ ${prodotti}, Totale ‚Ç¨ ${totale}`;
        } else {
          const fiscale = (data.totale_fiscale ?? 0).toFixed(2);
          const totale = (data.totale ?? 0).toFixed(2);
          const pos = ((data.pos_fiscale ?? 0) + (data.pos_test ?? 0)).toFixed(2);
          testo = `Incasso fiscale ‚Ç¨ ${fiscale}, Incasso totale ‚Ç¨ ${totale}, totale pagamenti pos ‚Ç¨ ${pos}`;
        }
        navigator.clipboard.writeText(testo);
      });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const content = document.getElementById('oroscopo-content');
  if (!content) return;

  const today = new Date().toISOString().slice(0, 10);
  const storageKey = 'oroscopo_' + today;

  function clear(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }

  // Divide un eventuale simbolo/emoji iniziale dal testo vero e proprio senza generare HTML
  function splitEmojiPrefix(testo) {
    if (testo == null) return { emoji: '', text: '' };
    const s = String(testo);
    const m = s.match(/^([\p{Emoji}\p{So}\p{Sk}\p{Sc}\p{Sm}])\s*(.*)$/u);
    return m ? { emoji: m[1], text: m[2] } : { emoji: '', text: s };
  }

  // Render sicuro (no innerHTML)
  function mostraOroscopo(previsione, citazione, consiglio) {
    clear(content);

    function riga(label, value, italic = false) {
      const wrap = document.createElement('div');
      wrap.style.marginBottom = '20px';
      wrap.style.display = 'flex';

      const strong = document.createElement('strong');
      strong.textContent = label;
      wrap.appendChild(strong);

      const { emoji, text } = splitEmojiPrefix(value);

      if (emoji) {
        const em = document.createElement('span');
        em.style.fontSize = '1.5em';
        em.style.verticalAlign = 'middle';
        em.textContent = emoji;
        wrap.appendChild(em);
        wrap.appendChild(document.createTextNode(' '));
      }

      const nodeText = document.createTextNode(String(text || ''));
      if (italic) {
        const i = document.createElement('i');
        i.appendChild(nodeText);
        wrap.appendChild(i);
      } else {
        wrap.appendChild(nodeText);
      }
      return wrap;
    }

    content.appendChild(riga('OGGI: ', previsione, false));
    content.appendChild(riga('CITAZIONE: ', citazione, true));
    content.appendChild(riga('CONSIGLIO... ', consiglio, false));
  }

  // Mostra subito un placeholder non-HTML
  content.textContent = 'caricamento previsioni...';

  // 1) Leggi da cache giornaliera, se disponibile
  const oroscopoSalvato = localStorage.getItem(storageKey);
  if (oroscopoSalvato) {
    try {
      const obj = JSON.parse(oroscopoSalvato) || {};
      mostraOroscopo(
        obj.previsione || 'Previsione non disponibile al momento.',
        obj.citazione  || 'Nessuna citazione disponibile.',
        obj.consiglio  || 'Nessun consiglio disponibile.'
      );
      return; // abbiamo gi√† renderizzato
    } catch {
      // Cache illeggibile: prosegui con il fetch
    }
  }

  // 2) Fetch con timeout e fallback; nessun innerHTML
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), 8000); // timeout 8s

  fetch('/api/oroscopo_giornaliero', {
    method: 'GET',
    signal: controller.signal,
    headers: { 'Accept': 'application/json' },
    cache: 'no-store'
  })
  .then(r => {
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  })
  .then(data => {
    const prev = data && typeof data.previsione === 'string' ? data.previsione : 'Previsione non disponibile al momento.';
    const cit  = data && typeof data.citazione  === 'string' ? data.citazione  : 'Nessuna citazione disponibile.';
    const cons = data && typeof data.consiglio  === 'string' ? data.consiglio  : 'Nessun consiglio disponibile.';
    mostraOroscopo(prev, cit, cons);

    // Salvo solo i campi attesi
    try {
      localStorage.setItem(storageKey, JSON.stringify({ previsione: prev, citazione: cit, consiglio: cons }));
    } catch {}
  })
  .catch(() => {
    mostraOroscopo('Previsione non disponibile al momento.', '', '');
  })
  .finally(() => clearTimeout(timer));
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  fetch('/static/js/palette-stagionale.json')
    .then(r => r.json())
    .then(palette => {
      const container = document.getElementById('palette-container');
      container.innerHTML = '';

      // Usa solo le prime 4
palette.slice(0, 4).forEach((col, idx) => {
  let desc = col.descrizione || '';
  const el = document.createElement('div');
  el.className = 'palette-color';
  el.style.display = 'flex';
  el.style.flexDirection = 'column';
  el.style.alignItems = 'center';
  el.style.width = '90px';
  el.style.marginLeft = '3px';
  el.style.marginRight = '3px';
el.textContent = '';

const nail = document.createElement('div');
nail.className = 'nail-shape';
nail.style.width = '38px';
nail.style.height = '62px';
nail.style.marginTop = '20px';
nail.style.marginBottom = '20px';
nail.style.borderRadius = '18px 18px 30px 30px / 30px 30px 62px 62px';
if (typeof col.hex === 'string' && /^#?[0-9a-fA-F]{3,8}$/.test(col.hex)) {
  nail.style.background = col.hex.startsWith('#') ? col.hex : `#${col.hex}`;
} else {
  nail.style.background = '#ccc';
}

const descBox = document.createElement('div');
descBox.className = 'palette-desc';
Object.assign(descBox.style, {
  fontSize: '1.1em', color: '#444', textAlign: 'center',
  minHeight: '32px', maxWidth: '90px', lineHeight: '1.15',
  overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'normal'
});

const b = document.createElement('b');
b.textContent = String(col.nome ?? '');
descBox.appendChild(b);
descBox.appendChild(document.createElement('br'));
descBox.appendChild(document.createTextNode(String(desc ?? '')));

el.appendChild(nail);
el.appendChild(descBox);

  container.appendChild(el);
});

      // Disposizione orizzontale
      container.style.display = 'flex';
      container.style.flexDirection = 'row';
      container.style.justifyContent = 'center';
      container.style.alignItems = 'flex-start';
      container.style.gap = '18px';
      container.style.marginTop = '10px';
      container.style.flexWrap = 'nowrap';
    });
});
</script>
<script>
  document.getElementById('btnExportExcelPassaggiCassa').addEventListener('click', function() {
  const table = document.querySelector('#wrapperTabellaPassaggiCassa table');
  if (!table) return;
  const dateFrom = document.getElementById('dateFrom').value;
  const mese = dateFrom ? dateFrom.slice(5,7) : (new Date().getMonth()+1).toString().padStart(2,'0');
  const anno = dateFrom ? dateFrom.slice(0,4) : new Date().getFullYear();
  const wb = XLSX.utils.table_to_book(table, {sheet:"PassaggiCassa"});
  const nomeFile = `passaggi_cassa_${mese}_${anno}.xlsx`;
  XLSX.writeFile(wb, nomeFile);
});

document.getElementById('btnExportPdfPassaggiCassa').addEventListener('click', function() {
  const table = document.querySelector('#wrapperTabellaPassaggiCassa table');
  if (!table) return;
  const dateFrom = document.getElementById('dateFrom').value;
  const mese = dateFrom ? dateFrom.slice(5,7) : (new Date().getMonth()+1).toString().padStart(2,'0');
  const anno = dateFrom ? dateFrom.slice(0,4) : new Date().getFullYear();
  const nomeFile = `passaggi_cassa_${mese}_${anno}.pdf`;
  const businessName = window.BUSINESS_NAME || '';
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'landscape',
    unit: 'pt',
    format: 'a4'
  });
  doc.autoTable({
    html: table,
    startY: 60,
    styles: {
      halign: 'center',
      valign: 'middle',
      fontSize: 9,
      cellPadding: 2,
      lineWidth: 0.45,
      lineColor: [0,0,0]
    },
    headStyles: {
      fillColor: [220, 220, 220],
      textColor: [0,0,0],
      fontStyle: 'bold',
      halign: 'center'
    },
    bodyStyles: {
      halign: 'center',
      valign: 'middle'
    },
    alternateRowStyles: {
      fillColor: [245, 245, 245]
    },
    tableLineColor: [0,0,0],
    tableLineWidth: 0.45,
    pageBreak: 'auto',
    margin: { top: 10 },
    didDrawPage: function (data) {
      doc.setFontSize(10);
      doc.text(`Passaggi di Cassa - ${mese}/${anno} - ${businessName}`, 40, 40);
    },
    didParseCell: function (data) {
      if (data.row.index === data.table.body.length - 1) {
        data.cell.styles.fontStyle = 'bold';
      }
    }
  });
  doc.save(nomeFile);
});
</script>
<script>
  let clientiData = [];
let clientiSortKey = 'passaggi';
let clientiSortDir = -1;

function renderTabellaClienti() {
  let data = [...clientiData];
  data.sort((a, b) => {
    let vA = a[clientiSortKey], vB = b[clientiSortKey];
    if (clientiSortKey === 'passaggi') return clientiSortDir * (vA - vB);
    if (clientiSortKey === 'ultimo')   return clientiSortDir * (vA.localeCompare(vB));
    if (clientiSortKey === 'frequenza') return clientiSortDir * (a.frequenza_idx - b.frequenza_idx);
    return clientiSortDir * vA.localeCompare(vB);
  });

  const tbody = document.getElementById('corpoTabellaClienti');
  tbody.innerHTML = ''; // ok per pulire; in alternativa: tbody.textContent = '';

  data.forEach(row => {
    const tr = document.createElement('tr');

    const tdNome = document.createElement('td');
    tdNome.textContent = String(row.nome ?? '');
    tr.appendChild(tdNome);

    const tdPass = document.createElement('td');
    tdPass.textContent = String(row.passaggi ?? '');
    tr.appendChild(tdPass);

    const tdUltimo = document.createElement('td');
    tdUltimo.textContent = String(row.ultimo ?? '');
    tr.appendChild(tdUltimo);

    const tdFreq = document.createElement('td');
    tdFreq.textContent = String(row.frequenza ?? '');
    tr.appendChild(tdFreq);

    tbody.appendChild(tr);
  });

// Ordinamento header
document.querySelectorAll('#modalClienti th.sortable').forEach(th => {
  th.style.cursor = 'pointer';
  th.addEventListener('click', function() {
    const key = th.dataset.sort;
    if (clientiSortKey === key) clientiSortDir *= -1;
    else { clientiSortKey = key; clientiSortDir = 1; }
    renderTabellaClienti();
  });
});
}
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
  let esteticaOpen = false;
  let solariumOpen = false;
  let lastDateFrom = '';
  let lastDateTo = '';

function caricaSottocategorie(tipo) {
  const dateFrom = lastDateFrom;
  const dateTo = lastDateTo;
  fetch(`/api/report_incasso_sottocategorie?categoria=${tipo}&dateFrom=${dateFrom}&dateTo=${dateTo}`)
    .then(r => r.json())
    .then(data => {
      const container = document.getElementById(`sottocategorie-${tipo}`);
      if (!container) return;
      if (!data.length) {
        container.innerHTML = '<div class="text-muted">Nessuna sottocategoria trovata</div>';
        return;
      }
container.innerHTML = '';
data.forEach(row => {
  const wrapper = document.createElement('div');
  wrapper.className = 'sottocategoria-row';
  wrapper.dataset.sottocategoriaId = String(row.id);

  const info = document.createElement('div');
  info.className = 'sottocategoria-info';

  const spanNome = document.createElement('span');
  spanNome.textContent = String(row.nome ?? '');
  info.appendChild(spanNome);

  const spanTot = document.createElement('span');
  spanTot.className = 'sottocategoria-totale';
  spanTot.textContent = `‚Ç¨ ${(Number(row.totale)||0).toFixed(2)}`;
  info.appendChild(spanTot);

  const spanPass = document.createElement('span');
  spanPass.className = 'sottocategoria-passaggi';
  spanPass.textContent = `passaggi: ${row.passaggi_cassa || 0}`;
  info.appendChild(spanPass);

  const serviziList = document.createElement('div');
  serviziList.className = 'servizi-list';

  wrapper.appendChild(info);
  wrapper.appendChild(serviziList);
  container.appendChild(wrapper);
});
      container.querySelectorAll('.sottocategoria-row').forEach(row => {
        row.addEventListener('click', function(e) {
          const serviziListDiv = this.querySelector('.servizi-list');
          const sottocategoria_id = this.dataset.sottocategoriaId;
          if (serviziListDiv.style.display === 'block') {
            serviziListDiv.style.display = 'none';
            serviziListDiv.innerHTML = '';
          } else {
            serviziListDiv.style.display = 'block';
            caricaServizi(tipo, sottocategoria_id, serviziListDiv, dateFrom, dateTo);
          }
          e.stopPropagation();
        });
      });
    });
}

window.caricaSottocategorie = caricaSottocategorie;

function caricaServizi(categoria, sottocategoria_id, serviziListDiv, dateFrom, dateTo) {
  fetch(`/api/report_incasso_servizi?categoria=${categoria}&sottocategoria_id=${sottocategoria_id}&dateFrom=${dateFrom}&dateTo=${dateTo}`)
    .then(r => r.json())
    .then(data => {
      if (!data.length) {
        serviziListDiv.innerHTML = '<div class="text-muted" style=>-</div>';
        return;
      }
      serviziListDiv.innerHTML = data.map(serv =>
        `<div class="servizio-row">
          <span>${serv.nome}</span>
          <span>‚Ç¨ ${serv.totale.toFixed(2)} | üßæ ${serv.passaggi_cassa || 0}</span>
        </div>`
      ).join('');
    });
}

window.caricaServizi = caricaServizi;

  document.getElementById('btnEstetica').addEventListener('click', function() {
    esteticaOpen = !esteticaOpen;
    this.classList.toggle('active', esteticaOpen);
    const box = document.getElementById('sottocategorie-estetica');
    if (esteticaOpen) {
      box.style.display = 'block';
      caricaSottocategorie('estetica');
    } else {
      box.style.display = 'none';
    }
  });

  document.getElementById('btnSolarium').addEventListener('click', function() {
    solariumOpen = !solariumOpen;
    this.classList.toggle('active', solariumOpen);
    const box = document.getElementById('sottocategorie-solarium');
    if (solariumOpen) {
      box.style.display = 'block';
      caricaSottocategorie('solarium');
    } else {
      box.style.display = 'none';
    }
  });

  // Salva le date selezionate all'apertura del modal
  document.getElementById('btnVaiFiltri').addEventListener('click', function() {
    lastDateFrom = document.getElementById('dateFrom').value;
    lastDateTo = document.getElementById('dateTo').value;
    // Chiudi eventuali sottomen√π aperti
    document.getElementById('sottocategorie-estetica').style.display = 'none';
    document.getElementById('sottocategorie-solarium').style.display = 'none';
    document.getElementById('btnEstetica').classList.remove('active');
    document.getElementById('btnSolarium').classList.remove('active');
    esteticaOpen = false;
    solariumOpen = false;
  });
});

document.addEventListener('DOMContentLoaded', function() {
  const btnEspandi = document.getElementById('btnEspandiIncassoCategoria');
  const btnCopia = document.getElementById('btnCopiaIncassoCategoria');
  if (!btnEspandi) return;

  btnEspandi.addEventListener('click', async function() {
    // Recupera le date correnti dai campi input
    lastDateFrom = document.getElementById('dateFrom').value;
    lastDateTo = document.getElementById('dateTo').value;

    // Espandi Estetica
    const btnEstetica = document.getElementById('btnEstetica');
    const boxEstetica = document.getElementById('sottocategorie-estetica');
    if (boxEstetica && boxEstetica.style.display !== 'block') {
      btnEstetica.classList.add('active');
      boxEstetica.style.display = 'block';
      await new Promise(resolve => {
        caricaSottocategorie('estetica');
        setTimeout(resolve, 500);
      });
    }
    // Espandi tutte le sottocategorie di Estetica
    boxEstetica.querySelectorAll('.sottocategoria-row').forEach(row => {
      const serviziDiv = row.querySelector('.servizi-list');
      if (serviziDiv && serviziDiv.style.display !== 'block') {
        serviziDiv.style.display = 'block';
        caricaServizi('estetica', row.dataset.sottocategoriaId, serviziDiv, lastDateFrom, lastDateTo);
      }
    });

    // Espandi Solarium
    const btnSolarium = document.getElementById('btnSolarium');
    const boxSolarium = document.getElementById('sottocategorie-solarium');
    if (boxSolarium && boxSolarium.style.display !== 'block') {
      btnSolarium.classList.add('active');
      boxSolarium.style.display = 'block';
      await new Promise(resolve => {
        caricaSottocategorie('solarium');
        setTimeout(resolve, 500);
      });
    }
    // Espandi tutte le sottocategorie di Solarium
    boxSolarium.querySelectorAll('.sottocategoria-row').forEach(row => {
      const serviziDiv = row.querySelector('.servizi-list');
      if (serviziDiv && serviziDiv.style.display !== 'block') {
        serviziDiv.style.display = 'block';
        caricaServizi('solarium', row.dataset.sottocategoriaId, serviziDiv, lastDateFrom, lastDateTo);
      }
    });
    if (btnCopia) btnCopia.style.display = '';
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const btnCopia = document.getElementById('btnCopiaIncassoCategoria');
  if (!btnCopia) return;

  btnCopia.addEventListener('click', async function() {
    if (!lastDateFrom || !lastDateTo) {
      lastDateFrom = document.getElementById('dateFrom').value;
      lastDateTo = document.getElementById('dateTo').value;
    }
    // Prendi dati totali
    const totale = document.getElementById('incasso-categorie-totale').textContent.replace('‚Ç¨','').trim();
    const passaggiEstetica = document.getElementById('incasso-categorie-estetica-passaggi').textContent.replace(/\D/g,'');
    const passaggiSolarium = document.getElementById('incasso-categorie-solarium-passaggi').textContent.replace(/\D/g,'');
    const incassoEstetica = document.getElementById('incasso-categorie-estetica').textContent.replace('‚Ç¨','').trim();
    const incassoSolarium = document.getElementById('incasso-categorie-solarium').textContent.replace('‚Ç¨','').trim();

    let testo = `INCASSO TOTALE ‚Ç¨ ${totale} - passaggi tot: ${parseInt(passaggiEstetica)+parseInt(passaggiSolarium)}\n\n`;
    testo += `INCASSO ESTETICA ‚Ç¨ ${incassoEstetica} - passaggi tot: ${passaggiEstetica}\n`;
    testo += `INCASSO SOLARIUM ‚Ç¨ ${incassoSolarium} - passaggi tot: ${passaggiSolarium}\n\n`;

    // --- SOTTOCATEGORIE ---
    async function getSottocategorie(tipo) {
      const sottocatDiv = document.getElementById(`sottocategorie-${tipo}`);
      if (!sottocatDiv) return [];
      if (!sottocatDiv.innerHTML.trim()) {
        await new Promise(resolve => {
          caricaSottocategorie(tipo);
          setTimeout(resolve, 500);
        });
      }
      const sottocatRows = sottocatDiv.querySelectorAll('.sottocategoria-row');
      let lines = [];
      for (const row of sottocatRows) {
        const nome = row.querySelector('span').textContent.trim();
        const totale = row.querySelector('.sottocategoria-totale').textContent.replace('‚Ç¨','').trim();
        const passaggi = row.querySelector('.sottocategoria-passaggi').textContent.replace(/\D/g,'');
        lines.push(`${nome} ‚Ç¨ ${totale} - passaggi: ${passaggi}`);
      }
      return lines;
    }

    // --- SERVIZI ---
    async function getServizi(tipo) {
      const sottocatDiv = document.getElementById(`sottocategorie-${tipo}`);
      if (!sottocatDiv) return [];
      if (!sottocatDiv.innerHTML.trim()) {
        await new Promise(resolve => {
          caricaSottocategorie(tipo);
          setTimeout(resolve, 500);
        });
      }
      const sottocatRows = sottocatDiv.querySelectorAll('.sottocategoria-row');
      let lines = [];
      for (const row of sottocatRows) {
        const serviziDiv = row.querySelector('.servizi-list');
        if (!serviziDiv.innerHTML.trim()) {
          await new Promise(resolve => {
            caricaServizi(tipo, row.dataset.sottocategoriaId, serviziDiv, lastDateFrom, lastDateTo);
            setTimeout(resolve, 400);
          });
        }
        const serviziRows = serviziDiv.querySelectorAll('.servizio-row');
        serviziRows.forEach(serv => {
          const spans = serv.querySelectorAll('span');
          if (spans.length >= 2) {
            const nomeServ = spans[0].textContent.trim();
            const [totaleServ, passaggiServ] = spans[1].textContent.split('|').map(s => s.replace(/[^\d,\.]/g,'').trim());
            lines.push(`${nomeServ} ‚Ç¨ ${totaleServ} - passaggi: ${passaggiServ}`);
          }
        });
      }
      return lines;
    }

    // Sottocategorie
    testo += `INCASSI per SOTTOCATEGORIA\nESTETICA:\n`;
    const esteticaSottocat = await getSottocategorie('estetica');
    testo += esteticaSottocat.join('\n') + '\n';
    testo += `SOLARIUM:\n`;
    const solariumSottocat = await getSottocategorie('solarium');
    testo += solariumSottocat.join('\n') + '\n\n';

    // Servizi
    testo += `INCASSI per SINGOLO SERVIZIO\nESTETICA:\n`;
    const esteticaServizi = await getServizi('estetica');
    testo += esteticaServizi.join('\n') + '\n';
    testo += `SOLARIUM:\n`;
    const solariumServizi = await getServizi('solarium');
    testo += solariumServizi.join('\n');

    // Copia negli appunti
    navigator.clipboard.writeText(testo);
    btnCopia.innerHTML = '<i class="bi bi-clipboard-check"></i>';
    setTimeout(() => btnCopia.innerHTML = '<i class="bi bi-clipboard"></i>', 1200);
  });
});
</script>
<script>
function caricaPrenotazioniOnline(dateStr) {
  const list = document.getElementById('booking-online-list');
  const titoloData = document.getElementById('tile-booking-online-data');
  list.innerHTML = '<span class="text-muted">Caricamento...</span>';
  fetch(`/api/booking_online_giorno?date=${dateStr}`)
    .then(r => r.json())
  .then(data => {
      if (titoloData && data.data) {
        titoloData.textContent = data.data;
      }
      const prenotazioni = data.prenotazioni || [];
      if (!prenotazioni.length) {
        list.innerHTML = '<span class="text-muted">Nessuna prenotazione online per questa data.</span>';
        return;
      }
      list.innerHTML = ''; // Svuota
      prenotazioni.forEach(a => {
        const div = document.createElement('div');
        div.style.cssText = 'border-bottom:1px solid #eee; padding:4px 0;';

        const oraSpan = document.createElement('span');
        oraSpan.style.fontWeight = '600';
        oraSpan.textContent = a.ora;

        const clienteSpan = document.createElement('span');
        clienteSpan.textContent = ` - ${a.nome_cliente} ${a.cognome_cliente} `;

        const servizioSpan = document.createElement('span');
        servizioSpan.style.color = '#1976d2';
        servizioSpan.textContent = a.servizio;

        div.appendChild(oraSpan);
        div.appendChild(clienteSpan);
        div.appendChild(servizioSpan);
        list.appendChild(div);
      });
    });
}

// Richiama la funzione ogni volta che cambia la data
document.addEventListener('DOMContentLoaded', function() {
  const dateInput = document.getElementById('reportDate');
  function aggiornaTileBookingOnline() {
    caricaPrenotazioniOnline(dateInput.value);
  }
  dateInput.addEventListener('change', aggiornaTileBookingOnline);
  aggiornaTileBookingOnline();
});
</script>
{% endblock %}