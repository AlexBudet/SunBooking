{% extends "base.html" %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<br><br><br>
<div class="page-wide-90">
<h3>&nbsp;&nbsp;CASSA</h3>
<div style="float:right; display:flex; flex-direction:column; gap:8px; margin-top: -20px;">
  <a href="{{ url_for('cassa.registro_scontrini') }}" class="btn neumorphic-btn">Registro Scontrini</a>
  <a href="#" id="btnRegistroDGFE" class="btn neumorphic-btn">Registro DGFE</a>
  <a href="#" id="btnChiusuraGiornaliera" class="btn neumorphic-btn">Chiusura Giornaliera</a>
  <a href="#" id="btnAnnullaScontrino" class="btn neumorphic-btn">Annulla Scontrino</a>
  {% if user_role in ['admin', 'owner'] %}
  <a href="#" id="btnConsoleRCH" class="btn neumorphic-btn" style="background: #ff5722; color: white;">üîß Console RCH</a>
  {% endif %}
</div>
<div class="service-bar" style="display: flex; align-items: center; gap: 0.7em; padding-left: 25px !important; padding-right: 25px !important; flex-wrap: wrap; max-width: 96%;">
    <input type="text" id="searchServiceInput" name="searchServiceInput" class="form-control"
    placeholder="Cerca servizio..." autocomplete="off"
    style="min-width: 180px; flex: 1 1 220px; max-width: 350px;">
<div id="serviceDropdown" class="dropdown-menu w-100"></div>
    <button class="service-bar-btn" id="btnFrequenti">Frequenti</button>
    <button class="service-bar-btn" id="btnUltimi">Ultimi</button>
    <button class="service-bar-btn" id="btnSolarium">Solarium</button>
    <button class="service-bar-btn" id="btnEstetica">Estetica</button>
    <button class="service-bar-btn" id="btnProdotti">Prodotti</button>
  </div>
<br>
  <!-- Sezione pulsanti servizi -->
  <div style="margin-top: 1em; padding-left: 25px; padding-right: 25px;">
    <div id="serviceButtonsContainer" style="display: flex; flex-wrap: wrap; gap: 0.5em;"></div>
  </div>
<br>

<div class="d-flex flex-row align-items-start flex-wrap" style="min-height: 400px; gap: 16px; padding: 1em;">
  <!-- Sezione pseudoscontrino -->
  <div style="flex: 1 1 500px; min-width: 450px; max-width: 850px;">
    <div class="card neumorphic-card h-100">
      <div class="card-body">
        <!-- Operatore -->
<div class="mb-2 d-flex gap-2 align-items-center">
  <div class="dropdown-anchor" style="width:230px; max-width:230px; position:relative;">
    <input type="text" id="operatorSelectInput" name="operatorSelectInput"
           class="form-control" placeholder="Salone" readonly
           style="cursor:pointer; width:100%;"
           data-bs-toggle="tooltip" data-bs-placement="top"
           title="Seleziona l'operatore a cui associare il pagamento">
    <div id="operatorDropdown" class="dropdown-menu" style="width:100%;"></div>
  </div>
  <button type="button" id="toggleOperatoriRiga" class="btn btn-sm btn-outline-secondary"
          data-bs-toggle="tooltip" data-bs-placement="top"
          title="Mostra/nasconde operatore per ogni voce"
          style="padding: 4px 8px; font-size: 0.75em;">
    <i class="bi bi-people"></i>
  </button>

  <div class="dropdown-anchor" style="width:230px; max-width:230px; position:relative;">
    <input type="text" id="clientSearchInputCassa" name="clientSearchInputCassa"
           class="form-control" placeholder="Cliente generico" autocomplete="off"
           style="width:100%;"
           data-bs-toggle="tooltip" data-bs-placement="top"
           title="Seleziona il cliente a cui associare il pagamento">
    <div id="clientDropdownCassa" class="dropdown-menu" style="width:100%;"></div>
  </div>
</div>
        <br>
        <!-- Container righe servizi selezionati -->
        <div id="scontrinoRowsContainer"></div>
        <div id="scontrino-container"></div>
        <!-- Icona dischetto per salvare modifiche (visibile solo se pseudoscontrino popolato da blocchi calendar) -->
<div id="saveModificheContainer" style="display: none; margin-top: 10px; text-align: center;">
  <button id="btnSaveModifiche" class="btn btn-outline-primary" title="Salva modifiche pseudoscontrino">
    <i class="bi bi-floppy"></i> Salva Modifiche
  </button>
  <button id="btnResetModifiche" class="btn btn-outline-warning" title="Ripristina valori originali" style="display: none; margin-left: 10px;">
    <i class="bi bi-arrow-counterclockwise"></i> Reset
  </button>
</div>
        <!-- Opzioni pagamento -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <br>
            <button class="btn btn-outline-success me-1" id="payCashBtn"><i class="bi bi-cash"></i> Cash</button>
            <button class="btn btn-outline-primary me-1" id="payPosBtn"><i class="bi bi-calculator"></i> POS</button>
            <button class="btn btn-outline-info" id="payBankBtn"><i class="bi bi-bank"></i> Bank</button>
          </div>
          <br>
          <div>
            <span id="totalAmount" class="fw-bold fs-5">Scontrino: ‚Ç¨ 0.00</span>&nbsp;&nbsp;&nbsp;&nbsp;
            <span id="totalAmountAll" style="color: #444; font-size: 1rem;">Totale: ‚Ç¨ 0.00</span>
            <br><br>
            <button class="btn btn-success ms-2" id="confermaBtn">CONFERMA</button>
            <button id="reset-scontrino" class="btn btn-outline-danger">SVUOTA</button>
            <!-- Subtotali pagamenti, nascosto di default -->
            <div id="subtotaliPagamenti" class="mt-2" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Pulsante stampa scontrino allineato in alto -->
<div class="d-flex flex-column justify-content-start align-items-center" style="flex: 0 0 auto;">
  <div id="btnStampaScontrino" class="neumorphic-card neumorphic-btn-stampa d-flex justify-content-center align-items-center position-relative"
       style="width:60px; height:60px; cursor:pointer; position:relative;">
    <span style="font-size:2em; color:#1976d2; display:block; line-height:1;">
      <i class="bi bi-printer"></i>
    </span>
    <span id="stampaLabel" class="d-none stampa-label-abs">STAMPA</span>
  </div>

  <!-- Pulsante LOTTERIA: nascosto finch√© non si preme ‚ÄúCONFERMA‚Äù -->
  <button type="button" id="btnLotteria"
          class="btn btn-primary mt-2 d-none">
    LOTTERIA
  </button>
</div>

<!-- Lotteria degli scontrini -->
<!-- Modal Lotteria -->
<div class="modal fade" id="modalLotteria" tabindex="-1" aria-labelledby="modalLotteriaLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLotteriaLabel">Lotteria Scontrini</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <label for="lotteria_codice" class="form-label">Inserisci codice</label>
        <input type="text" id="lotteria_codice"
               class="form-control mb-3"
               maxlength="18" minlength="18" pattern="[A-Za-z0-9]{18}">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="lotteria_invia">Stampa scontrino</button>
      </div>
    </div>
  </div>
</div>

  <!-- Container appuntamenti my-spia -->
  <div style="flex: 1 1 510px; min-width: 360px; max-width: 510px;">
    <div id="containerAppuntamentiMySpia" class="card neumorphic-card h-100"
         style="min-height: 220px; margin-left: 5px;">
      <div class="card-body">
        <h6 class="mb-3" id="mySpiaToggle" style="cursor:pointer; user-select:none;">
          Clienti in istituto
          <span id="mySpiaBlink" style="display:none; position:relative; margin-left:10px; vertical-align: top;">
            <span class="myspia-luce"></span>
          </span>
        </h6>
        <div id="mySpiaListContainer">
          <div id="mySpiaList"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modal Registro DGFE -->
<div class="modal fade" id="modalRegistroDGFE" tabindex="-1" aria-labelledby="modalRegistroDGFELabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalRegistroDGFELabel">Registro DGFE (Memoria Fiscale)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="dgfeDate" class="form-label">Data</label>
          <input type="date" id="dgfeDate" class="form-control" value="{{ giorno.strftime('%Y-%m-%d') if giorno is defined else '' }}">
        </div>
        <div class="mb-3">
          <label for="dgfePrinterIp" class="form-label">IP Stampante</label>
          <input type="text" id="dgfePrinterIp" class="form-control" value="{{ businessinfo.printer_ip if businessinfo is defined else '' }}">
        </div>
        <button class="btn btn-primary mb-3" id="btnCaricaDGFE">Carica Registro</button>
        <div id="dgfeResult"></div>
      </div>
    </div>
  </div>
</div>

<!-- Overlay spinner per attesa RCH (stile coerente con Report: spinner-border) -->
<div id="rchSpinnerOverlay" aria-hidden="true" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.65); z-index:12480; align-items:center; justify-content:center;">
  <div style="text-align:center;">
    <div class="spinner-border text-primary" role="status" aria-label="Attendere..."></div>
    <p style="margin-top:15px; font-size:16px; font-weight:500; color:#333;">
      Stampa in corso...<br>
      <small style="color:#666;">Se la stampante √® in attesa (es. cambio carta), risolvere e attendere</small>
    </p>
  </div>
</div>

<!-- Modal Console Sblocco RCH - aggiungi prima della chiusura </body> -->

{% if user_role is defined and user_role in ['admin', 'owner'] %}
<div class="modal fade" id="modalConsoleRCH" tabindex="-1" aria-labelledby="modalConsoleRCHLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header" style="background: #ff5722; color: white;">
        <h5 class="modal-title" id="modalConsoleRCHLabel">üîß Console Sblocco RCH</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
        <div class="row">
          <!-- COLONNA SINISTRA: Controlli -->
          <div class="col-lg-7">
            
            <!-- STATO STAMPANTE -->
            <div class="card mb-2">
              <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <strong>üìä Stato Stampante</strong>
                <button class="btn btn-sm btn-outline-primary" id="btnRchRefreshStatus">
                  <i class="bi bi-arrow-clockwise"></i> Aggiorna
                </button>
              </div>
              <div class="card-body py-2">
                <div id="rchStatusContainer">
                  <p class="text-muted mb-0 small">Clicca "Aggiorna" per verificare lo stato.</p>
                </div>
              </div>
            </div>
            
            <!-- AZIONI RAPIDE -->
            <div class="card mb-2">
              <div class="card-header py-2"><strong>‚ö° Azioni Rapide</strong></div>
              <div class="card-body py-2">
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-warning btn-sm" id="btnRchSendCL" 
                          data-bs-toggle="tooltip" data-bs-placement="top"
                          title="Equivale a premere CL sulla tastiera dell'RCH. Esegue C3 (annulla riga) + C1 (sblocco).">
                    <i class="bi bi-x-circle"></i> Invia CL
                  </button>
                  <button class="btn btn-danger btn-sm" id="btnRchFullReset"
                          data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                          title="<b>Sequenza di sblocco completa:</b><br>‚Ä¢ C99 (annulla documento)<br>‚Ä¢ C10 (annulla transazione)<br>‚Ä¢ C3 (clear)<br>‚Ä¢ T5/$0 (chiusura zero)<br>‚Ä¢ C3+C1 (sblocco finale)<br><br><i>NON stampa nulla, solo sblocca la stampante.</i>">
                    <i class="bi bi-arrow-repeat"></i> Reset Completo
                  </button>
                </div>
                <small class="text-muted d-block mt-1" style="font-size: 11px;">
                  <b>CL:</b> Annulla e sblocca | <b>Reset:</b> Sblocco completo (non stampa nulla)
                </small>
              </div>
            </div>
            
            <!-- CHIUSURA DOCUMENTO -->
            <div class="card mb-2">
              <div class="card-header py-2"><strong>üìÑ Chiudi Documento Aperto</strong></div>
              <div class="card-body py-2">
                <div class="row g-2 align-items-end">
                  <div class="col-auto">
                    <label class="form-label small mb-1">Importo (‚Ç¨)</label>
                    <input type="number" step="0.01" min="0" id="rchCloseImporto" class="form-control form-control-sm" placeholder="0.00" style="width: 100px;">
                  </div>
                  <div class="col-auto">
                    <label class="form-label small mb-1">Metodo</label>
                    <select id="rchCloseMetodo" class="form-select form-select-sm" style="width: 110px;">
                      <option value="contanti">Contanti</option>
                      <option value="pos">POS</option>
                      <option value="bank">Bank</option>
                    </select>
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-success btn-sm" id="btnRchCloseDocument">
                      <i class="bi bi-check-lg"></i> Chiudi
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- COMANDO RAW -->
            <div class="card mb-2">
              <div class="card-header py-2"><strong>üñ•Ô∏è Comando Manuale</strong></div>
              <div class="card-body py-2">
                <div class="input-group input-group-sm">
                  <span class="input-group-text">=</span>
                  <input type="text" id="rchRawCommand" class="form-control" placeholder="C1, C3, T1/$1000...">
                  <button class="btn btn-secondary" id="btnRchSendRaw">Invia</button>
                </div>
                <small class="text-muted d-block mt-1" style="font-size: 11px;">
                  Comandi: C1 (sblocco), C3 (reset), C10, C99, T5/$0
                </small>
              </div>
            </div>
            
          </div>
          
          <!-- COLONNA DESTRA: Log -->
          <div class="col-lg-5">
            <div class="card h-100">
              <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <strong>üìã Log</strong>
                <button class="btn btn-sm btn-outline-secondary py-0 px-2" id="btnRchClearLog">Pulisci</button>
              </div>
              <div class="card-body p-2">
                <pre id="rchLogContainer" style="height: 280px; overflow-y: auto; background: #1e1e1e; color: #0f0; padding: 8px; border-radius: 5px; font-size: 11px; white-space: pre-wrap; margin: 0;">In attesa di comandi...</pre>
              </div>
            </div>
          </div>
          
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<!-- Mini-modal selezione operatore per singola riga -->
<div class="modal fade" id="modalSelezionaOperatoreRiga" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 200px;">
    <div class="modal-content" style="font-size: 0.85em;">
      <div class="modal-header py-1 px-2">
        <span class="modal-title" style="font-size: 0.9em; font-weight: 600;">Operatore</span>
        <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal" style="font-size: 0.6em;"></button>
      </div>
      <div class="modal-body p-1">
        <div id="listaOperatoriRigaModal" style="max-height: 200px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Inizializza tooltip per i campi operatore e cliente
  if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
    const operatorInput = document.getElementById('operatorSelectInput');
    const clientInput = document.getElementById('clientSearchInputCassa');
    if (operatorInput) new bootstrap.Tooltip(operatorInput);
    if (clientInput) new bootstrap.Tooltip(clientInput);
  }
  
  // Verifica che gli elementi esistano (solo per admin/owner)
  if (!document.getElementById('modalConsoleRCH')) return;
  
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  const logContainer = document.getElementById('rchLogContainer');
  
  // Inizializza tooltip Bootstrap (con controllo esistenza)
  if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
    document.querySelectorAll('#modalConsoleRCH [data-bs-toggle="tooltip"]').forEach(el => {
      new bootstrap.Tooltip(el, { html: el.dataset.bsHtml === 'true' });
    });
  }
  
  function rchLog(msg, type = 'info') {
    if (!logContainer) return;
    const ts = new Date().toLocaleTimeString();
    const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
    logContainer.textContent += `\n[${ts}] ${prefix} ${msg}`;
    logContainer.scrollTop = logContainer.scrollHeight;
  }
  
  function rchLogJson(label, data) {
    rchLog(`${label}:\n${JSON.stringify(data, null, 2)}`);
  }

  // Funzione per aggiornare lo stato (riutilizzabile)
  async function refreshStatus(showAlert) {
    const container = document.getElementById('rchStatusContainer');
    if (!container) return null;
    container.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Verifica...';
    rchLog('Query stato stampante...');
    
    try {
      const resp = await fetch('/cassa/rch-console/status', {
        headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {}
      });
      const data = await resp.json();
      rchLogJson('Stato', data);
      
      let statusHtml = '';
      if (data.error) {
        statusHtml = '<div class="alert alert-danger py-1 mb-0 small">' + data.error + '</div>';
      } else {
        const statusColor = data.status === 'ok' ? 'success' : 'warning';
        
        let docAlert = '';
        if (data.document_open) {
          docAlert = '<div class="alert alert-danger py-2 mb-2">' +
            '<strong>‚ö†Ô∏è ATTENZIONE: DOCUMENTO FISCALE APERTO!</strong><br>' +
            '<small>La stampante ha uno scontrino in sospeso. Usa "Chiudi Documento" o "Reset Completo" per risolvere.</small>' +
            '</div>';
        }
        
        let statusText = data.status === 'ok' ? '‚úÖ PRONTA' : '‚ö†Ô∏è ATTENZIONE';
        if (data.error_message) {
          statusText += ' - ' + data.error_message;
        }
        
        statusHtml = docAlert +
          '<div class="alert alert-' + statusColor + ' py-1 mb-0 small">' +
          '<b>IP:</b> ' + data.printer_ip + ' | <b>Stato:</b> ' + statusText +
          (data.last_z !== null ? ' | <b>Z:</b>' + data.last_z : '') +
          (data.last_doc !== null ? ' <b>Doc:</b>' + data.last_doc : '') +
          '</div>';
        
        if (data.document_open && showAlert) {
          setTimeout(function() {
            alert('‚ö†Ô∏è ATTENZIONE!\n\nLa stampante RCH ha un documento fiscale aperto!\n\nUsa "Chiudi Documento" specificando l\'importo visualizzato sul display, oppure "Reset Completo" per annullare.');
          }, 300);
        }
      }
      container.innerHTML = statusHtml;
      return data;
    } catch (err) {
      container.innerHTML = '<div class="alert alert-danger py-1 mb-0 small">Errore: ' + err.message + '</div>';
      rchLog('Errore: ' + err.message, 'error');
      return null;
    }
  }
  
  // Apri modal E fai check automatico
  var btnConsole = document.getElementById('btnConsoleRCH');
  if (btnConsole) {
    btnConsole.addEventListener('click', function(e) {
      e.preventDefault();
      var modalEl = document.getElementById('modalConsoleRCH');
      if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        var modal = new bootstrap.Modal(modalEl);
        modal.show();
        setTimeout(function() { refreshStatus(true); }, 200);
      }
    });
  }
  
  // Aggiorna Stato (manuale)
  var btnRefresh = document.getElementById('btnRchRefreshStatus');
  if (btnRefresh) {
    btnRefresh.addEventListener('click', function() { refreshStatus(false); });
  }
  
  // Invia CL
  var btnCL = document.getElementById('btnRchSendCL');
  if (btnCL) {
    btnCL.addEventListener('click', async function() {
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
      rchLog('Invio CL (C3 + C1)...');
      
      try {
        const resp = await fetch('/cassa/rch-console/send-cl', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}) }
        });
        const data = await resp.json();
        rchLogJson('Risposta CL', data);
        const allSuccess = data.results && data.results.every(function(r) { return r.success; });
        rchLog(allSuccess ? 'CL OK!' : 'CL con errori', allSuccess ? 'success' : 'error');
        setTimeout(function() { refreshStatus(false); }, 500);
      } catch (err) {
        rchLog('Errore: ' + err.message, 'error');
        alert('‚ùå ' + err.message);
      } finally {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-x-circle"></i> Invia CL';
      }
    });
  }
  
  // Reset Completo
  var btnReset = document.getElementById('btnRchFullReset');
  if (btnReset) {
    btnReset.addEventListener('click', async function() {
      if (!confirm('Eseguire sequenza di sblocco completa?\n\nQuesta operazione NON stampa nulla, serve solo a sbloccare la stampante se √® bloccata.')) return;
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
      rchLog('Reset completo (sblocco)...');
      
      try {
        const resp = await fetch('/cassa/rch-console/full-reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}) }
        });
        const data = await resp.json();
        rchLogJson('Reset', data);
        const ok = data.results ? data.results.filter(function(r) { return r.success; }).length : 0;
        const tot = data.results ? data.results.length : 0;
        rchLog('Sblocco: ' + ok + '/' + tot + ' comandi OK', ok === tot ? 'success' : 'error');
        setTimeout(function() { refreshStatus(false); }, 500);
      } catch (err) {
        rchLog('Errore: ' + err.message, 'error');
        alert('‚ùå ' + err.message);
      } finally {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Reset Completo';
      }
    });
  }
  
  // Chiudi Documento
  var btnClose = document.getElementById('btnRchCloseDocument');
  if (btnClose) {
    btnClose.addEventListener('click', async function() {
      const importo = parseFloat(document.getElementById('rchCloseImporto').value) || 0;
      const metodo = document.getElementById('rchCloseMetodo').value;
      if (!confirm('Chiudere documento con ‚Ç¨' + importo.toFixed(2) + ' (' + metodo + ')?\n\nQuesto STAMPER√Ä uno scontrino fiscale.')) return;
      
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
      rchLog('Chiusura: ‚Ç¨' + importo.toFixed(2) + ' (' + metodo + ')...');
      
      try {
        const resp = await fetch('/cassa/rch-console/close-document', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}) },
          body: JSON.stringify({ importo: importo, metodo: metodo })
        });
        const data = await resp.json();
        rchLogJson('Chiusura', data);
        rchLog(data.success ? 'Chiuso!' : 'Fallito', data.success ? 'success' : 'error');
        alert(data.success ? '‚úÖ Documento chiuso e stampato!' : '‚ö†Ô∏è Fallito, vedi log');
        setTimeout(function() { refreshStatus(false); }, 500);
      } catch (err) {
        rchLog('Errore: ' + err.message, 'error');
        alert('‚ùå ' + err.message);
      } finally {
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-check-lg"></i> Chiudi';
      }
    });
  }
  
  // Comando Raw
  var btnRaw = document.getElementById('btnRchSendRaw');
  if (btnRaw) {
    btnRaw.addEventListener('click', async function() {
      const cmd = document.getElementById('rchRawCommand').value.trim();
      if (!cmd) { alert('Inserisci comando'); return; }
      
      this.disabled = true;
      this.textContent = '...';
      rchLog('Raw: =' + cmd + '...');
      
      try {
        const resp = await fetch('/cassa/rch-console/send-raw', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {}) },
          body: JSON.stringify({ command: cmd })
        });
        const data = await resp.json();
        rchLogJson('Raw', data);
        rchLog(data.success ? 'OK!' : 'Fallito (' + data.error_code + ')', data.success ? 'success' : 'error');
        setTimeout(function() { refreshStatus(false); }, 500);
      } catch (err) {
        rchLog('Errore: ' + err.message, 'error');
      } finally {
        this.disabled = false;
        this.textContent = 'Invia';
      }
    });
  }
  
  // Enter per raw
  var rawInput = document.getElementById('rchRawCommand');
  if (rawInput) {
    rawInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') document.getElementById('btnRchSendRaw').click();
    });
  }
  
  // Pulisci log
  var btnClear = document.getElementById('btnRchClearLog');
  if (btnClear) {
    btnClear.addEventListener('click', function() {
      if (logContainer) logContainer.textContent = 'Log pulito...';
    });
  }
});
</script>
{% endif %}
<style>
  .modal-body {
    max-height: 70vh;      /* Limita l'altezza al 70% della viewport */
    overflow-y: auto !important; /* Scroll verticale se il contenuto √® troppo lungo */
}

#modalRegistroDGFE .modal-body {
  max-height: 70vh;
  overflow-y: auto !important;
}

.neumorphic-btn-stampa {
  box-shadow:  8px 8px 24px #d1d9e6, -8px -8px 24px #ffffff;
  border-radius: 14px;
  background: #ffffff;
  transition: box-shadow 0.2s;
  user-select: none;
}
.neumorphic-btn-stampa:active {
  box-shadow:  2px 2px 8px #d1d9e6, -2px -2px 8px #ffffff;
}

.d-flex[style*="gap"] > * {
  margin-left: 0 !important;
  margin-right: 0 !important;
}

#btnStampaScontrino {
  width: 140px !important;
  height: 140px !important;
  min-width: 60px !important;
  min-height: 60px !important;
  max-width: 140px !important;
  max-height: 140px !important;
  display: flex;
  align-items: center;
  justify-content: center;
}

#btnStampaScontrino.attivo {
  opacity: 1;
  pointer-events: auto;
  background-color: hsl(51, 100%, 71%);
}

.neumorphic-btn-stampa:hover,
#btnStampaScontrino:hover {
  box-shadow:  2px 2px 8px #d1d9e6, -2px -2px 8px #ffffff, 0 0 0 2px #ffd60055;
  cursor: pointer;
}

.card.neumorphic-card:hover,
.myspia-blocco:hover {
  box-shadow:  4px 4px 16px #d1d9e6, -4px -4px 16px #ffffff, 0 0 0 2px #ffd60033;
  cursor: pointer;
}

.stampa-label-abs {
  position: absolute;
  left: 50%;
  bottom: 11px;
  transform: translateX(-50%);
  font-size: 1.25em;
  color: #1976d2;
  font-weight: 500;
  pointer-events: none;
  background: transparent;
  line-height: 1;
}

.pseudoscontrino-bloccato {
  pointer-events: none;
  filter: grayscale(0.2);
}

.pseudoscontrino-bloccato .scontrino-row {
  min-height: 44px;
  padding-top: 5px;
}

.pseudoscontrino-bloccato input,
.pseudoscontrino-bloccato select,
.pseudoscontrino-bloccato textarea,
.pseudoscontrino-bloccato .form-control,
.pseudoscontrino-bloccato .form-select,
.pseudoscontrino-bloccato .border {
  border: transparent !important;
  box-shadow: none !important;
}

.dropdown-anchor { position: relative; }

#operatorDropdown {
    border: 1px solid rgba(135, 100, 124, 0.2);
    border-radius: 10px;
    background: linear-gradient(180deg, #ffffff 0%, #f8f5f7 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#clientDropdownCassa {
    position: absolute !important;
    top: 100% !important;
    margin-top: 2px !important;
    border: 1px solid rgba(135, 100, 124, 0.2);
    border-radius: 10px;
    background: linear-gradient(180deg, #ffffff 0%, #f8f5f7 100%);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#operatorDropdown .dropdown-item,
#clientDropdownCassa .dropdown-item {
    border: none;
    border-bottom: 1px solid #f0f0f0;
    border-radius: 0;
    color: #444;
    background: transparent;
    transition: background-color 0.15s ease;
}

#operatorDropdown .dropdown-item:last-child,
#clientDropdownCassa .dropdown-item:last-child {
    border-bottom: none;
}

#operatorDropdown .dropdown-item:hover,
#clientDropdownCassa .dropdown-item:hover {
    background-color: rgba(248, 232, 240, 0.6);
    color: #333;
}

#searchServiceInput {
    border: 1px solid rgba(135, 100, 124, 0.2);
    border-radius: 10px;
    color: #444;
    background: linear-gradient(180deg, #ffffff 0%, #f8f5f7 100%);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
}

#searchServiceInput:focus {
    border-color: #b8809d;
    box-shadow: 0 0 0 3px rgba(184, 128, 157, 0.15);
    outline: none;
    background: #fff;
}
</style>

<script>
/* Spinner RCH: mostra dopo 5s se /cassa/send-to-rch non ha ancora risposto.
   Rimane visibile finch√© non arriva una risposta non-pending, oppure finch√©
   non si apre il popup di pending (showPendingModal). */
(function() {
  function showRchSpinner() {
    const el = document.getElementById('rchSpinnerOverlay');
    if (!el) return;
    el.style.display = 'flex';
    window.__rchSpinnerVisible = true;
  }
  function hideRchSpinner() {
    const el = document.getElementById('rchSpinnerOverlay');
    if (!el) return;
    el.style.display = 'none';
    window.__rchSpinnerVisible = false;
  }
  window.showRchSpinner = showRchSpinner;
  window.hideRchSpinner = hideRchSpinner;

  // Wrap fetch solo per /cassa/send-to-rch
  const origFetch = window.fetch;
  window.fetch = function(input, init) {
    const url = (typeof input === 'string') ? input : (input && input.url) || '';
    const isRch = /\/cassa\/send-to-rch\b/.test(url);
    if (!isRch) {
      return origFetch.apply(this, arguments);
    }

    let timer = setTimeout(() => { showRchSpinner(); }, 5000);

    return origFetch.apply(this, arguments)
      .then(async (resp) => {
        clearTimeout(timer);
        try {
          const clone = resp.clone();
          const data = await clone.json().catch(() => null);
          // Se NON √® pending, nascondi subito lo spinner
          if (!(data && data.pending)) {
            hideRchSpinner();
          }
        } catch (e) {
          // In caso di parsing fallito, togli lo spinner
          hideRchSpinner();
        }
        return resp;
      })
      .catch((err) => {
        clearTimeout(timer);
        hideRchSpinner();
        throw err;
      });
  };

  // Nascondi lo spinner immediatamente prima di mostrare il modal di pending
  function wrapPendingModal() {
    if (window._wrappedShowPendingModal) return;
    if (typeof window.showPendingModal === 'function') {
      const orig = window.showPendingModal;
      window.showPendingModal = function() {
        try { hideRchSpinner(); } catch(_) {}
        return orig.apply(this, arguments);
      };
      window._wrappedShowPendingModal = true;
    }
  }
  // Prova ora e poi al load (cassa.js potrebbe definire la funzione dopo)
  wrapPendingModal();
  window.addEventListener('load', wrapPendingModal);
  setTimeout(wrapPendingModal, 0);
})();
</script>

<script src="{{ url_for('static', filename='js/cassa.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const servizi = {{ servizi | default([]) | tojson | safe }};
    const clientName = {{ client_name | default('', true) | tojson }};
    const operatorName = "{{ operator_name | default('', true) }}";
    const operatorId = "{{ operator_id | default('', true) }}";
    const clientId = "{{ client_id | default('', true) }}";

    window.SERVIZI_PRECOMPILATI = servizi;
    window.RATA_ID_PRECOMPILATA = {{ request.args.get('rata_id') | tojson | safe if request.args.get('rata_id') else 'null' }};

    if (operatorName) {
      const operatorInput = document.getElementById('operatorSelectInput');
      operatorInput.value = operatorName;
      if (operatorId) {
        operatorInput.dataset.selectedOperator = operatorId;
      }
      // Forza trigger evento change per listener modifiche
      operatorInput.dispatchEvent(new Event('change'));
    }

    if (clientName) {
      const input = document.getElementById('clientSearchInputCassa');
      window.settingClientProgrammatically = true;
      input.value = clientName;
      if (clientId) {
        input.dataset.selectedClient = clientId;
      }
      input.dispatchEvent(new Event('input'));

      // Carica prepagate per il cliente che arriva dal calendar
      if (clientId) {
        setTimeout(function() {
          if (typeof window.caricaPrepagateCliente === 'function') {
            window.caricaPrepagateCliente(clientId, clientName);
          }
        }, 600);
      }
    }

    addInitialServizi(servizi);

async function addInitialServizi(list) {
  if (!Array.isArray(list) || !list.length) return;
  const calApptIds = [];
  for (const s0 of list) {
    const s = { ...s0 };
    // Normalizza l'appointment_id per provenienza da calendar o altri alias
    s.appointment_id = s.appointment_id || s.appointmentId || s.appId || s.app_id || null;
    if (s.appointment_id) calApptIds.push(String(s.appointment_id));

    const sid = s?.id ?? s?.servizio_id ?? s?.service_id;
    if (sid && (!s.nome || s.prezzo === undefined || s.prezzo === null)) {
      try {
        const res = await fetch(`/cassa/api/services?id=${encodeURIComponent(sid)}`);
        const data = await res.json();
        const d = Array.isArray(data) ? data[0] : data;
        if (d) {
          aggiungiRigaServizio({
            id: d.id,
            nome: d.nome,
            prezzo: d.prezzo,
            tag: d.tag,
            sottocategoria: d.sottocategoria,
            appointment_id: s.appointment_id,
            // IMPORTANTE: mantieni operator_id e operator_nome dal servizio originale
            operator_id: s.operator_id || '',
            operator_nome: s.operator_nome || ''
          }, false);
          continue;
        }
      } catch(_) {}
    }
    aggiungiRigaServizio(s, false);
  }
  window.lastPseudoscontrinoAppointmentIds = Array.from(new Set(calApptIds)).filter(Boolean);

  // Attiva toggle multi-operatore se ci sono almeno 2 operatori diversi
  setTimeout(function() {
    const allRows = document.querySelectorAll('.scontrino-row');
    const operatorIds = new Set();
    allRows.forEach(r => {
      const opId = r.dataset.operatorId;
      if (opId && opId !== '') operatorIds.add(opId);
    });
    if (operatorIds.size >= 2) {
      const toggleBtn = document.getElementById('toggleOperatoriRiga');
      if (toggleBtn && !toggleBtn.classList.contains('active')) {
        toggleBtn.classList.add('active');
        document.body.classList.add('show-op-per-riga');
      }
      allRows.forEach(r => {
        const opCol = r.querySelector('.op-col');
        if (opCol) {
          const nome = r.dataset.operatorNome || '';
          opCol.textContent = window.capitalizeName ? window.capitalizeName(nome) : nome;
        }
      });
    }
  }, 150);

  setTimeout(() => ripristinaModifichePseudoscontrino(), 200);
}
  });
</script>
<script>
  document.getElementById('btnRegistroDGFE').addEventListener('click', function(e) {
  e.preventDefault();
  const modal = new bootstrap.Modal(document.getElementById('modalRegistroDGFE'));
  modal.show();
});

document.getElementById('btnCaricaDGFE').addEventListener('click', function() {
  const ip = document.getElementById('dgfePrinterIp').value.trim();
  const date = document.getElementById('dgfeDate').value;
  if (!ip || !date) {
    alert('Inserisci IP stampante e data.');
    return;
  }
const dgfeResult = document.getElementById('dgfeResult');
if (dgfeResult) dgfeResult.textContent = 'Caricamento in corso...';
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
fetch('/cassa/api/dgfe', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRFToken': csrfToken
  },
  body: JSON.stringify({ip, date})
})
.then(res => res.json())
.then(data => {
  const dgfeResult = document.getElementById('dgfeResult');
  dgfeResult.innerHTML = '';
  if (data.error) {
    const span = document.createElement('span');
    span.className = 'text-danger';
    span.textContent = `Errore: ${data.error}`;
    dgfeResult.appendChild(span);
  } else {
    const pre = document.createElement('pre');
    pre.style.whiteSpace = 'pre-wrap';
    pre.style.fontSize = '0.95em';
    pre.textContent = data.dgfe_text || '';
    dgfeResult.appendChild(pre);
  }
})
.catch(err => {
  const dgfeResult = document.getElementById('dgfeResult');
  dgfeResult.innerHTML = '';
  const span = document.createElement('span');
  span.className = 'text-danger';
  span.textContent = `Errore: ${err}`;
  dgfeResult.appendChild(span);
});
});
  </script>
  <script>
document.addEventListener('DOMContentLoaded', function() {
    // Stato EDIT per appuntamenti (persistenza locale)
  function getEditedSet() {
    try {
      const arr = JSON.parse(localStorage.getItem('cassa_edited_appt_ids') || '[]');
      return new Set(arr.map(String));
    } catch (_) {
      return new Set();
    }
  }
  function saveEditedSet(set) {
    try {
      localStorage.setItem('cassa_edited_appt_ids', JSON.stringify(Array.from(set)));
    } catch (_) {}
  }
  function markEditedIds(ids) {
    const set = getEditedSet();
    (ids || []).forEach(id => { if (id != null) set.add(String(id)); });
    saveEditedSet(set);
  }
  
 function unmarkEditedIds(ids) {
   const set = getEditedSet();
   (ids || []).forEach(id => { if (id != null) set.delete(String(id)); });
   saveEditedSet(set);
 }
 window.unmarkEditedIds = unmarkEditedIds;

  function isGruppoEdited(gruppo) {
    const set = getEditedSet();
    const ids = (Array.isArray(gruppo?.ids) && gruppo.ids.length)
      ? gruppo.ids
      : ((Array.isArray(gruppo?.appuntamenti) ? gruppo.appuntamenti : [])
          .map(s => s.appointment_id || s.id)
          .filter(Boolean));
    return ids.some(id => set.has(String(id)));
  }
  // Carica appuntamenti my-spia (stato 1) dal backend
  function caricaAppuntamentiMySpia() {
    fetch('/cassa/api/myspia')
      .then(res => res.json())
      .then(data => {
        renderMySpiaList(data);
      });
  }

  // Renderizza i gruppi per cliente
function renderMySpiaList(gruppi) {
  const list = document.getElementById('mySpiaList');
  const blink = document.getElementById('mySpiaBlink');
  const container = document.getElementById('mySpiaListContainer');
  list.innerHTML = '';

  // Luce blink se ci sono appuntamenti
  blink.style.display = (Array.isArray(gruppi) && gruppi.length > 0) ? '' : 'none';

  // Mostra gli appuntamenti solo se il container √® open
  if (!container.classList.contains('open')) return;

  if (!Array.isArray(gruppi) || gruppi.length === 0) {
    const info = document.createElement('div');
    info.className = 'text-muted';
    info.textContent = 'Nessun cliente in istituto';
    list.appendChild(info);
    return;
  }

  gruppi.forEach(gruppo => {
    // Wrapper per blocco + pulsanti esterni (con spazio a destra per i pulsanti)
    const item = document.createElement('div');
    item.className = 'myspia-item';

    // Blocco appuntamento
    const blocco = document.createElement('div');
    blocco.className = 'myspia-blocco';
    blocco.setAttribute('data-client-id', gruppo.cliente_id);

    const firstServizio = (gruppo.appuntamenti || [])[0] || {};
    blocco.style.backgroundColor = firstServizio.bg_color || '#fff';
    blocco.style.color = firstServizio.font_color || '#000';

    const infoDiv = document.createElement('div');
    infoDiv.style.color = 'inherit';

    const spanNome = document.createElement('span');
    spanNome.style.fontWeight = 'bold';
    spanNome.style.textTransform = 'uppercase';
    spanNome.textContent = `${gruppo.cliente_nome} ${gruppo.cliente_cognome}`;
    infoDiv.appendChild(spanNome);

    const oraInizio = firstServizio.start_time ? firstServizio.start_time.slice(0,5) : '';
    if (oraInizio) {
      infoDiv.appendChild(document.createTextNode(' - '));
      const spanOra = document.createElement('span');
      spanOra.style.fontWeight = 'bold';
      spanOra.textContent = oraInizio;
      infoDiv.appendChild(spanOra);
    }

    const ul = document.createElement('ul');
    ul.style.margin = '8px 0 0 0';
    ul.style.paddingLeft = '18px';
    (gruppo.appuntamenti || []).forEach(servizio => {
      const li = document.createElement('li');
      li.textContent = `${servizio.servizio_nome || servizio.tag || ''} (${servizio.start_time ? servizio.start_time.slice(0,5) : ''})`;
      ul.appendChild(li);
    });

    blocco.appendChild(infoDiv);
    blocco.appendChild(ul);

    // Icona 'modificato' se il gruppo √® stato salvato in cassa
    try {
      if (isGruppoEdited(gruppo)) {
        const badge = document.createElement('span');
        badge.className = 'myspia-edited-badge';
        badge.title = 'Modificato in cassa';
        badge.innerHTML = '<i class="bi bi-pencil-fill" aria-hidden="true"></i>';
        blocco.appendChild(badge);
        blocco.classList.add('myspia-blocco-edited');
      }
    } catch(_) {}

    // Pulsanti esterni, assoluti a destra (verticali)
    const actions = document.createElement('div');
    actions.className = 'myspia-actions';

    const btnCassa = document.createElement('button');
    btnCassa.type = 'button';
    btnCassa.className = 'btn-popup porta-in-cassa';
    btnCassa.setAttribute('data-bs-toggle', 'tooltip');
    btnCassa.setAttribute('data-bs-placement', 'right');
    btnCassa.setAttribute('data-bs-custom-class', 'tooltip-dark');
    btnCassa.setAttribute('title', 'porta in cassa');
    btnCassa.innerHTML = '<i class="euro-icon">‚Ç¨</i>';
    btnCassa.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const ids = (Array.isArray(gruppo.ids) && gruppo.ids.length)
        ? gruppo.ids
        : ((gruppo.appuntamenti || []).map(s => s.appointment_id || s.id).filter(Boolean));
      if (ids.length && typeof window.creaPseudoscontrinoMySpia === 'function') {
        window.creaPseudoscontrinoMySpia(ids.join(','));
      } else {
        alert('Nessun appuntamento da inviare in cassa.');
      }
    });

    const btnCal = document.createElement('button');
    btnCal.type = 'button';
    btnCal.className = 'btn-popup vedi-in-calendario';
    btnCal.setAttribute('data-bs-toggle', 'tooltip');
    btnCal.setAttribute('data-bs-placement', 'right');
    btnCal.setAttribute('data-bs-custom-class', 'tooltip-dark');
    btnCal.setAttribute('title', 'vedi in calendario');
    btnCal.innerHTML = '<i class="bi bi-calendar2-week"></i>';
    btnCal.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const first = (gruppo.appuntamenti || [])[0];
      const clientId = gruppo.cliente_id;
      if (clientId && first && first.start_time && first.data) {
        const dateStr = first.data;
        const oraStr = first.start_time.slice(0,5);
        sessionStorage.setItem('scrollFromCassa', '1');
        const [hour, minute] = oraStr.split(':');
        sessionStorage.setItem('scrollToHour', hour);
        sessionStorage.setItem('scrollToMinute', minute);
        sessionStorage.setItem('scrollFromCassa_ts', String(Date.now()));
        window.location.href = `/calendar/?date=${dateStr}&client_id=${clientId}&ora=${oraStr}`;
      }
    });

    actions.appendChild(btnCassa);
    actions.appendChild(btnCal);

    // Tooltips neri a destra
    setTimeout(() => {
      if (window.bootstrap && bootstrap.Tooltip) {
        [btnCassa, btnCal].forEach(el => {
          bootstrap.Tooltip.getOrCreateInstance(el, {
            placement: 'right',
            container: 'body',
            boundary: 'window',
            customClass: 'tooltip-dark',
            trigger: 'hover focus'
          });
        });
      }
    }, 0);

    item.appendChild(blocco);
    item.appendChild(actions);
    list.appendChild(item);
  });
}

// Gestione apertura/collasso
  document.getElementById('mySpiaToggle').addEventListener('click', function() {
    const container = document.getElementById('mySpiaListContainer');
    if (!container.classList.contains('open')) {
      container.classList.add('open');
      caricaAppuntamentiMySpia();
    } else {
      container.classList.remove('open');
    }
  });

  // All'avvio: container chiuso
  document.getElementById('mySpiaListContainer').classList.remove('open');
  caricaAppuntamentiMySpia();

  // Crea pseudoscontrino per i blocchi selezionati
window.creaPseudoscontrinoMySpia = function(ids) {
  fetch('/cassa/api/myspia/dettagli', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content },
    body: JSON.stringify({ ids: ids.split(',') })
  })
  .then(res => res.json())
  .then(async data => {
    if (data.success && data.appuntamenti) {
      window.originalAppointmentIds = new Set();
      document.getElementById('scontrinoRowsContainer').innerHTML = '';
      const apptIds = [];
      data.appuntamenti.forEach(servizio => {
        const apptId =
          servizio.appointment_id ||
          servizio.appointmentId ||
          servizio.app_id ||
          servizio.appId ||
          servizio.appIdStr ||
          servizio.appt_id ||
          null;
        if (apptId) apptIds.push(String(apptId));
        aggiungiRigaServizio({
          id: servizio.id,
          nome: servizio.nome,
          prezzo: servizio.prezzo,
          tag: servizio.tag,
          sottocategoria: servizio.sottocategoria,
          appointment_id: apptId,
          operator_id: servizio.operator_id || null,
          operator_nome: servizio.operator_nome || ''
        }, false);
      });
      window.lastPseudoscontrinoAppointmentIds = apptIds.filter(Boolean);

      // PATCH: attiva toggle se ci sono almeno 2 operatori diversi e popola op-col
      setTimeout(function() {
        const allRows = document.querySelectorAll('.scontrino-row');
        const operatorIds = new Set();
        allRows.forEach(r => {
          const opId = r.dataset.operatorId;
          if (opId && opId !== '') operatorIds.add(opId);
        });
        if (operatorIds.size >= 2) {
          const toggleBtn = document.getElementById('toggleOperatoriRiga');
          if (toggleBtn && !toggleBtn.classList.contains('active')) {
            toggleBtn.classList.add('active');
            document.body.classList.add('show-op-per-riga');
          }
          // Aggiorna la colonna operatore per ogni riga
          allRows.forEach(r => {
            const opCol = r.querySelector('.op-col');
            if (opCol) {
              const nome = r.dataset.operatorNome || '';
              opCol.textContent = window.capitalizeName ? window.capitalizeName(nome) : nome;
            }
          });
        }
      }, 100);

      if (data.cliente_nome) {
        const input = document.getElementById('clientSearchInputCassa');
        window.settingClientProgrammatically = true;
        input.value = data.cliente_nome + ' ' + (data.cliente_cognome || '');
        input.dataset.selectedClient = data.cliente_id;
      }
      if (data.operatore_nome) {
        const op = document.getElementById('operatorSelectInput');
        op.value = data.operatore_nome;
        op.dataset.selectedOperator = data.operatore_id;
      }
      setTimeout(() => {
        if (typeof ripristinaModifichePseudoscontrino === 'function') {
          ripristinaModifichePseudoscontrino();
        }
      }, 50);
    } else {
      alert('Errore nel recupero dati appuntamenti');
    }
  });
};
  
  // Elimina (resetta stato a 0) i blocchi selezionati
  window.eliminaMySpia = function(ids) {
    if (!confirm('Vuoi togliere questi appuntamenti dalla cassa?')) return;
    fetch('/cassa/api/myspia/elimina', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content },
      body: JSON.stringify({ ids: ids.split(',') })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        caricaAppuntamentiMySpia();
      } else {
        alert('Errore: ' + (data.error || 'Impossibile eliminare.'));
      }
    });
  };

  // Al salvataggio pseudoscontrino: marca gli appointment_id e aggiorna i my-spia visibili
  const saveBtn = document.getElementById('btnSaveModifiche');
  if (saveBtn) {
    saveBtn.addEventListener('click', function() {
      try {
        let ids = Array.from(document.querySelectorAll('.scontrino-row'))
          .map(r => r.dataset.appointmentId)
          .filter(Boolean);
        if (!ids.length && Array.isArray(window.lastPseudoscontrinoAppointmentIds)) {
          ids = window.lastPseudoscontrinoAppointmentIds.slice();
        }
        if (ids.length) {
          // dedup
          ids = Array.from(new Set(ids.map(String)));
          markEditedIds(ids);
          const container = document.getElementById('mySpiaListContainer');
          if (container && container.classList.contains('open')) {
            caricaAppuntamentiMySpia();
          }
        }
      } catch(_) {}
    });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('confermaBtn').addEventListener('click', function(e) {
    e.preventDefault();
    const btnLotteria = document.getElementById('btnLotteria');
    // Controlla i metodi di pagamento delle voci dello pseudoscontrino
    const rows = document.querySelectorAll('.scontrino-row');
    const pagamentiDigitali = Array.from(rows).some(row => {
      const select = row.querySelector('select');
      return select && (select.value === 'pos' || select.value === 'bank');
    });
    if (btnLotteria) {
      if (pagamentiDigitali) {
        btnLotteria.classList.remove('d-none');
        btnLotteria.focus();
      } else {
        btnLotteria.classList.add('d-none');
      }
    }
  });

  // handler con priorit√† massima: viene eseguito prima, blocca gli altri e apre la modale
  document.getElementById('btnLotteria').addEventListener('click', function (e) {
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    // mostra la modale (getOrCreate evita doppioni)
    const modalEl = document.getElementById('modalLotteria');
    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  }, true);

  // LOCK per evitare doppi invii dello scontrino lotteria
  let lotteriaInvioLock = false;

  document.getElementById('lotteria_invia').addEventListener('click', function() {
    // Protezione contro click multipli
    if (lotteriaInvioLock) {
      console.log('Invio scontrino lotteria gi√† in corso, click ignorato');
      return;
    }
    
    const lotteria = document.getElementById('lotteria_codice').value.trim();
    
    // Trova le righe dei servizi attuali
    const rows = document.querySelectorAll('.scontrino-row');
    if (rows.length === 0) {
      alert('Aggiungi almeno un servizio prima di generare lo scontrino!');
      return;
    }
    
    const voci = [];
    let hasError = false;
    
    rows.forEach(row => {
      if (hasError) return;
      
      const nome = row.querySelector('.flex-grow-1')?.textContent.trim() || '';
      const prezzo = parseFloat(row.querySelector('.scontrino-row-prezzo')?.value || '0');
      const sconto_riga = parseInt(row.querySelector('.scontrino-row-sconto')?.value || '0');
      const metodo = row.querySelector('select')?.value || 'cash';
      const servizio_id = row.dataset.servizioId || null;
      const appointment_id = row.dataset.appointmentId || null;

      if (!isFinite(prezzo) || isNaN(prezzo)) {
        alert('Prezzo non valido in una riga. Correggi prima di inviare.');
        hasError = true;
        return;
      }
      if (prezzo < 0) {
        alert('Prezzi negativi non sono consentiti. Correggi il prezzo e riprova.');
        hasError = true;
        return;
      }
      
      const voce = {
        servizio_id,
        nome,
        prezzo,
        sconto_riga,
        tipo: 'service',
        metodo_pagamento: metodo,
        is_fiscale: true
      };
      if (appointment_id) voce.appointment_id = appointment_id;
      voci.push(voce);
    });
    
    if (hasError) return;

    // Attiva il lock PRIMA della chiamata fetch
    lotteriaInvioLock = true;

    // Disabilita visivamente il pulsante
    const btnLotteriaInvia = document.getElementById('lotteria_invia');
    const originalText = btnLotteriaInvia.textContent;
    btnLotteriaInvia.disabled = true;
    btnLotteriaInvia.textContent = 'Invio in corso...';
    
    const cliente_id = document.getElementById('clientSearchInputCassa').dataset.selectedClient || null;
    const operatore_id = document.getElementById('operatorSelectInput').dataset.selectedOperator || null;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    const payload = {
      voci,
      cliente_id,
      operatore_id,
      is_fiscale: true,
      lotteria: lotteria
    };

    fetch('/cassa/send-to-rch', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(csrfToken ? { 'X-CSRFToken': csrfToken } : {})
      },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
      // Se c'√® un pacchetto associato, redirect alla pagina dettaglio
      if (data.redirect_to_pacchetto) {
        const url = `/pacchetti/detail/${data.redirect_to_pacchetto}`;
        if (data.rata_importo_modificato) {
          window.location.href = url + '?ricalcola_rate=1';
        } else {
          window.location.href = url;
        }
      } else {
        location.reload();
      }
    })
    .catch(error => {
      console.error('Errore invio scontrino lotteria:', error);
      alert('Errore durante l\'invio dello scontrino. Riprova.');
      // Rilascia il lock in caso di errore
      lotteriaInvioLock = false;
      btnLotteriaInvia.disabled = false;
      btnLotteriaInvia.textContent = originalText;
    });
  }); // chiude lotteria_invia listener

}); // chiude DOMContentLoaded
</script>
<script>
// Lock globale per chiusura giornaliera
let chiusuraGiornalieraLock = false;

document.getElementById('btnChiusuraGiornaliera').addEventListener('click', function(e) {
  e.preventDefault();
  
  // Protezione contro click multipli
  if (chiusuraGiornalieraLock) {
    console.log('Chiusura giornaliera gi√† in corso, operazione ignorata');
    return;
  }
  
  if (!confirm("Vuoi davvero stampare la chiusura giornaliera?")) return;

  // Attiva il lock
  chiusuraGiornalieraLock = true;

  const btn = this;
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Invio...';

  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

  fetch('/cassa/chiusura-giornaliera', {
    method: 'POST',
    headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {}
  })
  .then(async res => {
    let raw = '';
    try { raw = await res.text(); } catch(_) {}

    // Prova a parse JSON ma senza mai bloccare UX
    let data = {};
    try { data = JSON.parse(raw); } catch(_) {}

    console.log('[CHIUSURA GIORNALIERA] HTTP:', res.status, 'RAW:', raw);
    console.log('[CHIUSURA GIORNALIERA] Parsed:', data);

    // Mostra sempre successo (nessun popup errore)
    alert("Chiusura giornaliera inviata! Controlla gli scontrini stampati.");
  })
  .catch(err => {
    console.warn('[CHIUSURA GIORNALIERA] Errore rete (ignorato per policy):', err);
    alert("Chiusura giornaliera inviata! Controlla gli scontrini stampati.");
  })
  .finally(() => {
    // Rilascia il lock dopo un delay di sicurezza (10 secondi)
    setTimeout(() => {
      chiusuraGiornalieraLock = false;
    }, 10000);
    btn.disabled = false;
    btn.textContent = originalText;
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  try {
    if (localStorage.getItem('sun_touch_ui') === '1') {
      document.body.classList.add('touch-ui');
      const bind = (root = document) => {
        (root.querySelectorAll('#mySpiaList .myspia-item') || []).forEach(item => {
          if (item._touchBound) return;
          item._touchBound = true;
          item.addEventListener('click', (e) => {
            if (e.target.closest('.myspia-actions')) return; // lascia i bottoni attivi
            const wasOpen = item.classList.contains('myspia-open');
            document.querySelectorAll('#mySpiaList .myspia-item.myspia-open')
              .forEach(i => i.classList.remove('myspia-open'));
            if (!wasOpen) item.classList.add('myspia-open');
          });
        });
      };
      bind();
      new MutationObserver(muts => {
        muts.forEach(m => (m.addedNodes || []).forEach(n => {
          if (n.nodeType !== 1) return;
          if (n.classList && n.classList.contains('myspia-item')) bind(n.parentNode || n);
          n.querySelectorAll && n.querySelectorAll('.myspia-item').forEach(() => bind(n));
        }));
      }).observe(document.getElementById('mySpiaList') || document.body, { childList: true, subtree: true });
    }
  } catch (_) {}
});
</script>
<script>
// Svuota lo pseudoscontrino quando si esce dalla pagina cassa
// (navigazione verso altre sezioni)
window.addEventListener('beforeunload', function() {
  // Rimuovi i dati dello pseudoscontrino dal localStorage
  localStorage.removeItem('scontrinoServizi');
  localStorage.removeItem('scontrinoCliente');
  localStorage.removeItem('scontrinoOperatore');
});

// Alternativa pi√π robusta: svuota quando si clicca su link esterni a cassa
document.addEventListener('click', function(e) {
  const link = e.target.closest('a');
  if (!link) return;
  
  const href = link.getAttribute('href') || '';
  // Se il link porta fuori da /cassa (ma non √® un anchor o javascript)
  if (href && !href.startsWith('#') && !href.startsWith('javascript:')) {
    const isCassaLink = href.includes('/cassa') || href === '';
    if (!isCassaLink) {
      // Svuota lo pseudoscontrino
      localStorage.removeItem('scontrinoServizi');
      localStorage.removeItem('scontrinoCliente');
      localStorage.removeItem('scontrinoOperatore');
    }
  }
});
</script>
<style>
.myspia-item {
    position: relative;
    margin-bottom: 12px;
    padding-right: 44px;     /* spazio per 2 pulsanti 28px + margini */
  }

.myspia-blocco {
  border: 1px solid #ffd966;
  border-radius: 8px;
  padding: 10px 12px 8px 12px;
  background: #fff;
  position: relative;
}

.myspia-blocco-edited {
  box-shadow: inset 0 0 0 2px #1976d244;
}
.myspia-edited-badge {
  position: absolute;
  top: 6px;
  right: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #1976d2;
  color: #fff;
  font-size: 12px;
  line-height: 1;
  box-shadow: 0 0 0 2px #ffffff;
  pointer-events: none;
}

/* Pulsanti assoluti a destra (verticali) */
.myspia-actions {
  position: absolute;
  right: 5px;
  top: 50%;
  transform: translateY(-50%);
  display: none;
  flex-direction: column;
  gap: 6px;
  z-index: 2000;
}

/* Desktop: mantieni hover; Touch: disabilita hover e usa solo click */
.myspia-item:hover .myspia-actions,
.myspia-item:focus-within .myspia-actions {
  display: inline-flex;
}
body.touch-ui #mySpiaList .myspia-item:hover .myspia-actions,
body.touch-ui #mySpiaList .myspia-item:focus-within .myspia-actions {
  display: none !important;
}
body.touch-ui #mySpiaList .myspia-item.myspia-open .myspia-actions {
  display: inline-flex !important;
}

  /* Pulsanti neri come calendar */
  .btn-popup {
    background: #000;
    color: #fff;
    border: none;
    padding: 5px;
    border-radius: 3px;
    cursor: pointer;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transform-origin: 50% 50% !important;   /* scala dal centro */
    transition: transform 0.12s ease-out, color 0.1s, background-color 0.1s; /* transizione uniforme */
    will-change: transform;
  }
  .btn-popup:hover {
    transform: scale(1.2);
  }

/* Tooltip scuro (testo bianco) a destra: font come calendar */
.tooltip-dark .tooltip-inner {
  background-color: #000 !important;
  color: #fff !important;
  font-weight: 500;
  font-family: Arial, Helvetica, sans-serif;
  font-size: .875rem;
  line-height: 1.2;
  border-radius: .375rem;
}

  /* Luce spia */
  .myspia-luce {
    margin-top: -44px;
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ffbf00;
    box-shadow: 0 0 4px 2px #ffd600;
    animation: myspia-blink 1s infinite alternate;
  }
  @keyframes myspia-blink {
    0% { opacity: 1; }
    100% { opacity: 0.2; }
  }

  /* Container aperto: niente clipping dei pulsanti */
  #mySpiaListContainer {
    max-height: 0;
    overflow: hidden;
    padding: 0;
  }
  #mySpiaListContainer.open {
    max-height: 1000px;
    padding-top: 4px;
    overflow: visible;     /* consente ai pulsanti di stare ‚Äúfuori‚Äù dal blocco */
  }
/* Colonna operatore per riga - nascosta di default */
.scontrino-row .op-col {
  display: none;
  font-size: 0.68em;
  color: #555;
  min-width: 50px;
  max-width: 70px;
  text-align: center;
  cursor: pointer;
  padding: 1px 4px;
  border-radius: 3px;
  background: #e9ecef;
  margin-right: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  text-transform: capitalize;
}
.scontrino-row .op-col:hover {
  background: #e0e0e0;
}

/* Quando toggle attivo */
body.show-op-per-riga .scontrino-row .op-col {
  display: inline-block;
  pointer-events: auto;
  cursor: pointer;
  padding: 4px 8px;
  margin-right: 8px;
  background: #f0f0f0;
  border-radius: 4px;
  font-size: 0.85em;
  min-width: 80px;
  text-align: center;
}

body.show-op-per-riga .scontrino-row .op-col:hover {
  background: #e0e0e0;
}

#toggleOperatoriRiga.active {
  background: #1976d2;
  color: white;
  border-color: #1976d2;
}
</style>
{% endblock %}