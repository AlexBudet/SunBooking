<!-- appl/templates/business_info.html -->
{% extends "settings.html" %}

{% block settings_content %}
<div class="container page-wide-90">
<h3>&nbsp;Informazioni Aziendali</h3>

<!-- Sezione Logo -->
<div class="logo-section" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa;">
    <h4 style="margin-top: 0;">Logo Negozio</h4>
    
    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
        <!-- Anteprima logo corrente -->
        <div class="logo-preview" style="min-width: 150px; text-align: center;">
            {% if business_info and business_info.logo_image %}
                <img src="{{ url_for('settings.get_logo') }}?t={{ range(1000000) | random }}" 
                     alt="Logo negozio" 
                     style="max-height: 100px; max-width: 200px; border: 1px solid #ccc; border-radius: 4px; background: #fff; padding: 5px;">
                <br>
                <small style="color: #666;">{{ business_info.logo_filename or 'logo' }}</small>
            {% else %}
                <div style="width: 150px; height: 80px; border: 2px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999;">
                    Nessun logo
                </div>
            {% endif %}
        </div>
        
        <!-- Form upload -->
        {% if current_user.ruolo.value != 'user' %}
        <div class="logo-upload">
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                <!-- Form upload -->
                <form method="POST" action="{{ url_for('settings.upload_logo') }}" enctype="multipart/form-data" id="logoUploadForm" style="display: inline-flex; align-items: center; gap: 10px;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <label for="logo_file" class="logo-btn logo-btn-primary">
                        Seleziona file...
                    </label>
                    <input type="file" 
                           name="logo" 
                           id="logo_file" 
                           accept="image/png,image/jpeg,image/webp,image/gif,image/svg+xml"
                           style="display: none;">
                    <span id="selectedFileName" style="color: #333; font-style: italic;"></span>
                    <button type="submit" id="uploadLogoBtn" class="logo-btn logo-btn-success" style="display: none;">Carica Logo</button>
                </form>
                
                {% if business_info and business_info.logo_image %}
                <!-- Form elimina -->
                <form method="POST" action="{{ url_for('settings.delete_logo') }}" style="display: inline;" 
                      onsubmit="return confirm('Sei sicuro di voler eliminare il logo?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="logo-btn logo-btn-danger">Elimina Logo</button>
                </form>
                {% endif %}
            </div>
            
            <small style="color: #666; display: block;">
                Formati: PNG, JPEG, WebP, GIF, SVG • Max: 5MB • Verrà ridimensionato a max 200px di altezza
            </small>
            
            <!-- Checkbox visibilità logo in booking -->
            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" 
                           id="logoVisibleInBooking" 
                           {% if business_info and business_info.logo_visible_in_booking_page %}checked{% endif %}>
                    <span>Mostra logo nella pagina di prenotazione online</span>
                </label>
                <span id="logoVisibleStatus" style="margin-left: 28px; font-size: 0.85em; color: #666;"></span>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Messaggi di errore/successo -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<form method="POST" action="{{ url_for('settings.set_business_info') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
<!-- Modulo per impostare le informazioni aziendali -->
<table>
    <tr>
      <td><label for="business_name">Nome Azienda:</label></td>
      <td><input type="text" id="business_name" name="business_name" value="{{ business_info.business_name if business_info else '' }}" required {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="website">Sito internet:</label></td>
      <td><input type="text" id="website" name="website" value="{{ business_info.website if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="address">Indirizzo:</label></td>
      <td><input type="text" id="address" name="address" value="{{ business_info.address if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="cap">CAP:</label></td>
      <td><input type="text" id="cap" name="cap" value="{{ business_info.cap if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="province">Provincia:</label></td>
      <td><input type="text" id="province" name="province" value="{{ business_info.province if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="city">Città:</label></td>
      <td><input type="text" id="city" name="city" value="{{ business_info.city if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="vat_code">P.IVA/Codice Fiscale:</label></td>
      <td><input type="text" id="vat_code" name="vat_code" value="{{ business_info.vat_code if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="pec_code">PEC/Codice Univoco:</label></td>
      <td><input type="text" id="pec_code" name="pec_code" value="{{ business_info.pec_code if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="phone">Telefono:</label></td>
      <td><input type="text" id="phone" name="phone" value="{{ business_info.phone if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="mobile">Cellulare:</label></td>
      <td><input type="text" id="mobile" name="mobile" value="{{ business_info.mobile if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="email">E-mail:</label></td>
      <td><input type="email" id="email" name="email" value="{{ business_info.email if business_info else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
    <tr>
      <td><label for="vat_percentage">IVA (%)</label></td>
      <td><input type="number" step="0.01" min="0" max="100" id="vat_percentage" name="vat_percentage" value="{{ business_info.vat_percentage or 22.0 }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}></td>
    </tr>
{% if not config.get('HIDE_PRINTER_IP') %}
    <tr>
      <td><label for="printer_ip">IP Stampante Fiscale</label></td>
      <td style="display: flex; align-items: center; gap: 8px;">
        <input type="text" class="form-control" id="printer_ip" name="printer_ip"
               value="{{ business_info.printer_ip if business_info and business_info.printer_ip else '' }}" {% if current_user.ruolo.value == 'user' %}readonly{% endif %}>
        <button type="button" id="pingPrinterButton">Test Connessione RCH</button>
        <span id="pingPrinterStatus" style="margin-left:8px; font-size:0.9em; color:#666;"></span>
      </td>
    </tr>
{% endif %}
  </table>
<br>
    <!-- Orari di visualizzazione dell'agenda -->
    <h4>Ore Visualizzate</h4>
    <label for="opening_time">Da:</label>
    <input type="time" id="opening_time" name="opening_time" value="{{ business_info.opening_time.strftime('%H:%M') if business_info else '' }}" required {% if current_user.ruolo.value == 'user' %}readonly{% endif %}>
&nbsp;&nbsp;
    <label for="closing_time">a:</label>
    <input type="time" id="closing_time" name="closing_time" value="{{ business_info.closing_time.strftime('%H:%M') if business_info else '' }}" required {% if current_user.ruolo.value == 'user' %}readonly{% endif %}>
    <br>
<br>
    <!-- Orari di apertura effettiva -->
    <h4>Ore di Apertura</h4>
    <label for="active_opening_time">Da:</label>
    <input type="time" id="active_opening_time" name="active_opening_time" value="{{ business_info.active_opening_time.strftime('%H:%M') if business_info and business_info.active_opening_time else '' }}" required {% if current_user.ruolo.value == 'user' %}readonly{% endif %}>
&nbsp;&nbsp;

    <label for="active_closing_time">a:</label>
    <input type="time" id="active_closing_time" name="active_closing_time" value="{{ business_info.active_closing_time.strftime('%H:%M') if business_info and business_info.active_closing_time else '' }}" required {% if current_user.ruolo.value == 'user' %}readonly{% endif %}>
    <br>
<br>
    <label>Giorni di Chiusura:</label>

    <br>

<input type="checkbox" id="monday" name="closing_days" value="Monday"
    {% if 'Monday' in business_info.closing_days_list %}checked{% endif %}
    {% if current_user.ruolo.value == 'user' %}disabled{% endif %}>
<label for="monday">Lunedì</label>

<input type="checkbox" id="tuesday" name="closing_days" value="Tuesday"
    {% if 'Tuesday' in business_info.closing_days_list %}checked{% endif %}
    {% if current_user.ruolo.value == 'user' %}disabled{% endif %}>
<label for="tuesday">Martedì</label>

    <input type="checkbox" id="wednesday" name="closing_days" value="Wednesday" 
        {% if 'Wednesday' in business_info.closing_days_list %}checked{% endif %} {% if current_user.ruolo.value == 'user' %}disabled{% endif %}>
        <label for="wednesday">Mercoledì</label>

    <input type="checkbox" id="thursday" name="closing_days" value="Thursday" 
        {% if 'Thursday' in business_info.closing_days_list %}checked{% endif %} {% if current_user.ruolo.value == 'user' %}disabled{% endif %}>
  <label for="thursday">Giovedì</label>

    <input type="checkbox" id="friday" name="closing_days" value="Friday" 
        {% if 'Friday' in business_info.closing_days_list %}checked{% endif %} {% if current_user.ruolo.value == 'user' %}disabled{% endif %}>
  <label for="friday">Venerdì</label>

    <input type="checkbox" id="saturday" name="closing_days" value="Saturday" 
        {% if 'Saturday' in business_info.closing_days_list %}checked{% endif %} {% if current_user.ruolo.value == 'user' %}disabled{% endif %}>
  <label for="saturday">Sabato</label>

    <input type="checkbox" id="sunday" name="closing_days" value="Sunday" 
        {% if 'Sunday' in business_info.closing_days_list %}checked{% endif %} {% if current_user.ruolo.value == 'user' %}disabled{% endif %}>
        <label for="sunday">Domenica</label>

    <button type="submit">Salva Impostazioni</button>
</form>
<br>
<div class="desktop-only-setting" style="display: flex; gap: 8px; align-items: center;">
  <label for="touchUiEnabled">Touch-screen:</label>
  <input type="checkbox" id="touchUiEnabled">
  <small style="margin-left:8px; color:#666;">Abilita interfaccia touch per i blocchi agenda (su questo computer)</small>
</div>
<br>
<div class="desktop-only-setting" style="display: flex; gap: 8px; align-items: center;">
  <label for="zoomNavigatorEnabled">Zoom Navigator:</label>
  <input type="checkbox" id="zoomNavigatorEnabled" checked>
  <small style="margin-left:8px; color:#666;">Mostra controlli zoom (+/−) nell'agenda (su questo computer)</small>
</div>
<style>
  @media (max-width: 1200px) {
    .desktop-only-setting { display: none !important; }
  }
</style>
<br>
<tr>
  <td><label for="refreshButtonEnabled">Tasto Refresh:</label></td>
  <td>
    <input type="checkbox" id="refreshButtonEnabled" checked>
    <small style="margin-left:8px; color:#666;">Mostra pulsante aggiorna pagina nella barra di navigazione (su questo computer)</small>
  </td>
</tr>
<br><br><br>
</div>

<!-- Sezione Aggiornamenti -->
<div class="desktop-only-setting" style="margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
  <h5 style="margin-bottom: 15px;">Aggiornamenti App</h5>
  <div id="updateStatus" style="margin-bottom: 15px;">
    <span id="currentVersion">Versione attuale: -</span>
  </div>
  <button type="button" id="btnCheckUpdate" class="btn btn-primary" onclick="checkForUpdates()">
    Controlla aggiornamenti
  </button>
  <button type="button" id="btnDownloadUpdate" class="btn btn-success" style="display:none;" onclick="downloadUpdate()">
    Scarica aggiornamento
  </button>
  <button type="button" id="btnApplyUpdate" class="btn btn-warning" style="display:none;" onclick="applyUpdate()">
    Installa e riavvia
  </button>
  <div id="updateInfo" style="margin-top: 15px; display:none;">
    <strong>Nuova versione: <span id="remoteVersion"></span></strong>
    <div id="releaseNotes" style="margin-top:10px; padding:10px; background:#fff; border:1px solid #ccc; border-radius:4px; max-height:200px; overflow-y:auto;"></div>
  </div>
</div>

<script>
let updateData = null;

function checkForUpdates() {
  const btn = document.getElementById('btnCheckUpdate');
  btn.disabled = true;
  btn.textContent = 'Controllo in corso...';
  
  fetch('/settings/api/check-update')
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      btn.textContent = 'Controlla aggiornamenti';
      
      if (data.error) {
        alert('Errore: ' + data.error);
        return;
      }
      
      document.getElementById('currentVersion').textContent = 'Versione attuale: ' + (data.local_version || 'sconosciuta');
      
      if (data.has_update && data.download_url) {
        updateData = data;
        document.getElementById('updateInfo').style.display = 'block';
        document.getElementById('remoteVersion').textContent = data.remote_version + ' (' + data.release_name + ')';
        document.getElementById('releaseNotes').innerHTML = data.release_notes ? data.release_notes.replace(/\n/g, '<br>') : 'Nessuna nota di rilascio.';
        document.getElementById('btnDownloadUpdate').style.display = 'inline-block';
        document.getElementById('btnApplyUpdate').style.display = 'none';
      } else if (!data.has_update) {
        alert('Nessun aggiornamento disponibile. Sei già alla versione più recente!');
      } else {
        alert('Aggiornamento disponibile ma file non trovato. Contatta il supporto.');
      }
    })
    .catch(err => {
      btn.disabled = false;
      btn.textContent = 'Controlla aggiornamenti';
      alert('Errore di connessione: ' + err);
    });
}

function downloadUpdate() {
  if (!updateData || !updateData.download_url) return;
  
  const btn = document.getElementById('btnDownloadUpdate');
  btn.disabled = true;
  btn.textContent = 'Download in corso...';
  
  fetch('/settings/api/download-update', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      download_url: updateData.download_url,
      remote_version: updateData.remote_version
    })
  })
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      
      if (data.error) {
        btn.textContent = 'Scarica aggiornamento';
        alert('Errore: ' + data.error);
        return;
      }
      
      btn.style.display = 'none';
      document.getElementById('btnApplyUpdate').style.display = 'inline-block';
      alert('Download completato! Backup creato: ' + data.backup_name + '\n\nClicca "Installa e riavvia" per completare.');
    })
    .catch(err => {
      btn.disabled = false;
      btn.textContent = 'Scarica aggiornamento';
      alert('Errore download: ' + err);
    });
}

function applyUpdate() {
  if (!confirm('L\'app verrà chiusa e riavviata con la nuova versione.\n\nContinuare?')) return;
  
  const btn = document.getElementById('btnApplyUpdate');
  btn.disabled = true;
  btn.textContent = 'Installazione...';
  
  fetch('/settings/api/apply-update', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'}
  })
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        btn.disabled = false;
        btn.textContent = 'Installa e riavvia';
        alert('Errore: ' + data.error);
        return;
      }
      
      if (data.shutdown) {
        alert('Aggiornamento in corso. L\'app si chiuderà e si riavvierà automaticamente.');
        window.close();
      }
    })
    .catch(err => {
      btn.disabled = false;
      btn.textContent = 'Installa e riavvia';
      alert('Errore: ' + err);
    });
}
</script>

<script>
  // Inizializza checkbox da localStorage e salva alla modifica
  (function(){
    try {
      // Touch UI
      const key = 'sun_touch_ui';
      const el = document.getElementById('touchUiEnabled');
      if (el) {
        el.checked = (localStorage.getItem(key) === '1');
        el.addEventListener('change', () => {
          localStorage.setItem(key, el.checked ? '1' : '0');
          alert('Impostazione salvata. Ricarica l\'agenda per applicare la modalità touch.');
        });
      }
      
      // Zoom Navigator (default: visibile)
      const zoomKey = 'sun_zoom_navigator';
      const zoomEl = document.getElementById('zoomNavigatorEnabled');
      if (zoomEl) {
        const zoomVal = localStorage.getItem(zoomKey);
        zoomEl.checked = (zoomVal === null || zoomVal === '1');
        zoomEl.addEventListener('change', () => {
          localStorage.setItem(zoomKey, zoomEl.checked ? '1' : '0');
          alert('Impostazione salvata. Ricarica l\'agenda per applicare.');
        });
      }
      
      // Refresh Button (default: visibile)
      const refreshKey = 'sun_refresh_button';
      const refreshEl = document.getElementById('refreshButtonEnabled');
      if (refreshEl) {
        const refreshVal = localStorage.getItem(refreshKey);
        refreshEl.checked = (refreshVal === null || refreshVal === '1');
        refreshEl.addEventListener('change', () => {
          localStorage.setItem(refreshKey, refreshEl.checked ? '1' : '0');
          alert('Impostazione salvata. Ricarica la pagina per applicare.');
        });
      }
    } catch(e) {}
  })();
</script>
{% if not config.get('HIDE_PRINTER_IP') %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('pingPrinterButton');
  const statusEl = document.getElementById('pingPrinterStatus');
  const ipEl = document.getElementById('printer_ip');
  if (!btn || !statusEl || !ipEl) return;

  btn.addEventListener('click', function() {
    const ip = (ipEl.value || '').trim();
    statusEl.style.color = '#666';
    if (!ip) {
      statusEl.textContent = 'Inserisci un IP prima di eseguire il test.';
      return;
    }

    statusEl.textContent = 'Verifica in corso...';

    const token = (document.querySelector('input[name="csrf_token"]')?.value) || '';
    const pingUrl = "{{ url_for('settings.ping_printer') }}";

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 21000); // leggermente > 20s backend

    fetch(pingUrl, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': token
      },
      body: JSON.stringify({ ip }),
      signal: controller.signal
    })
    .then(res => res.ok ? res.json() : { ok: false })
    .then(data => {
      clearTimeout(timeoutId);
      if (!data) {
        statusEl.style.color = '#dc3545';
        statusEl.textContent = 'Risposta non valida dal server.';
        return;
      }

      if (data.ok) {
        statusEl.style.color = '#28a745';
        let msg = 'Stampante raggiungibile';
        if (data.status_code) {
          msg += ' (HTTP ' + data.status_code + ')';
        }
        statusEl.textContent = msg + '.';
      } else {
        statusEl.style.color = '#dc3545';
        const msg = data.error || 'Stampante non raggiungibile.';
        statusEl.textContent = msg;
      }
    })
    .catch(() => {
      clearTimeout(timeoutId);
      statusEl.style.color = '#dc3545';
      statusEl.textContent = 'Errore durante il test di connessione.';
    });
  });
});
</script>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestione selezione file logo
    const fileInput = document.getElementById('logo_file');
    const uploadBtn = document.getElementById('uploadLogoBtn');
    const fileNameSpan = document.getElementById('selectedFileName');
    
    if (fileInput && uploadBtn && fileNameSpan) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                const fileName = this.files[0].name;
                fileNameSpan.textContent = fileName;
                uploadBtn.style.display = 'inline-block';
            } else {
                fileNameSpan.textContent = '';
                uploadBtn.style.display = 'none';
            }
        });
    }
    
    // Gestione checkbox visibilità logo in booking
    const visibleCheckbox = document.getElementById('logoVisibleInBooking');
    const visibleStatus = document.getElementById('logoVisibleStatus');
    
    if (visibleCheckbox && visibleStatus) {
        visibleCheckbox.addEventListener('change', function() {
            const isVisible = this.checked;
            visibleStatus.style.color = '#666';
            visibleStatus.textContent = 'Salvataggio...';
            
            const token = (document.querySelector('input[name="csrf_token"]')?.value) || '';
            
            fetch("{{ url_for('settings.set_logo_visibility') }}", {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': token
                },
                body: JSON.stringify({ visible: isVisible })
            })
            .then(res => res.json())
            .then(data => {
                if (data.ok) {
                    visibleStatus.style.color = '#28a745';
                    visibleStatus.textContent = 'Salvato!';
                    setTimeout(() => { visibleStatus.textContent = ''; }, 2000);
                } else {
                    visibleStatus.style.color = '#dc3545';
                    visibleStatus.textContent = data.error || 'Errore nel salvataggio';
                }
            })
            .catch(() => {
                visibleStatus.style.color = '#dc3545';
                visibleStatus.textContent = 'Errore di connessione';
            });
        });
    }
});
</script>
<style>
      /* Stili bottoni logo */
    .logo-btn {
        display: inline-block;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: normal;
        text-decoration: none;
        line-height: 1.4;
        vertical-align: middle;
    }
    .logo-btn-primary {
        background: #007bff;
        color: white;
    }
    .logo-btn-primary:hover {
        background: #0056b3;
    }
    .logo-btn-danger {
        background: #dc3545;
        color: white;
    }
    .logo-btn-danger:hover {
        background: #c82333;
    }
    .logo-btn-success {
        background: #28a745;
        color: white;
    }
    .logo-btn-success:hover {
        background: #218838;
    }
    
    table {
      border-collapse: separate;
      border-spacing: 8px 4px;
      width: 90%;
    }
    td:first-child {
      width: 20%;
      min-width: 120px;
    }
    td:nth-child(2) {
      width: 60%;
    }
    td:nth-child(2) input[type="text"],
    td:nth-child(2) input[type="email"] {
      width: 98%;
      max-width: 600px;
      box-sizing: border-box;
    }
    label {
      font-weight: bold;
    }
</style>
{% endblock %}
