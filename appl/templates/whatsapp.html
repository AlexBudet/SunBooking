{% extends "settings.html" %}

{% block settings_content %}
<div class="container mt-4" style="max-width:600px;">
    <h3>Messaggio WhatsApp manuale</h3>
    <form method="post" action="{{ url_for('settings.whatsapp') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="whatsapp_message" class="form-label">Da inviare manualmente tramite pulsante da calendario</label>
            <textarea class="form-control" id="whatsapp_message" name="whatsapp_message" rows="5" required>{{ whatsapp_message or "Buongiorno {{nome}}, ecco un memo per il tuo appuntamento del {{data}} alle ore {{ora}}. Ci vediamo presto! Sun Booking" }}</textarea>
            <div class="form-text">
                Puoi usare le variabili:<br>
                <code>{{"{{nome}}"}}</code> = nome cliente,
                <code>{{"{{data}}"}}</code> = data appuntamento,
                <code>{{"{{ora}}"}}</code> = orario appuntamento
                <code>{{"{{servizi}}"}}</code> = lista servizi prenotati
            </div>
        </div>
        <button type="submit" class="btn btn-success">Salva messaggio</button>
    </form>
</div>

<br>
<hr>
<div class="container mt-4" style="max-width:600px;">
    <h3>WhatsApp automatico alla conferma dell'appuntamento</h3>
<div class="container mt-3" style="max-width:600px;">
  <!-- Toggle senza pulsante Salva: la modifica viene salvata immediatamente via JS -->
  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" role="switch" id="whatsapp_modal_disable"
           {% if business_info and business_info.whatsapp_modal_disable %}checked{% endif %}>
    <label class="form-check-label" for="whatsapp_modal_disable">
      Non mostrare la richiesta di invio WhatsApp all'interno del modal di creazione appuntamento
    </label>
  </div>
</div>

<script>
(function() {
  const cb = document.getElementById('whatsapp_modal_disable');
  if (!cb) return;

  cb.addEventListener('change', function () {
    const disabled = !!cb.checked;
    const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

  const endpoint = "{{ url_for('settings.api_whatsapp_setting') }}";
  fetch(endpoint, {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': token
    },
    body: JSON.stringify({ whatsapp_modal_disable: disabled })
  })
  .then(resp => resp.ok ? resp.json() : Promise.reject(resp))
  .then(json => {
    console.log('whatsapp_modal_disable saved:', json);
  })
  .catch(err => {
    console.error('Errore salvataggio impostazione WhatsApp', err);
    cb.checked = !disabled;
  });
  });
})();
</script>
    <form method="post" action="{{ url_for('settings.whatsapp') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
            <label for="whatsapp_message_auto" class="form-label">Testo messaggio automatico</label>
            <textarea class="form-control" id="whatsapp_message_auto" name="whatsapp_message_auto" rows="5" required>{{ whatsapp_message_auto or "Ciao {{nome}}, la tua prenotazione per il {{data}} alle ore {{ora}} è stata registrata! Grazie da Sun Booking." }}</textarea>
            <div class="form-text">
                Questo messaggio verrà inviato automaticamente via WhatsApp ogni volta che viene creato un appuntamento in calendario.<br>
                Puoi usare le variabili:<br>
                <code>{{"{{nome}}"}}</code> = nome cliente,
                <code>{{"{{data}}"}}</code> = data appuntamento,
                <code>{{"{{ora}}"}}</code> = orario appuntamento,
                <code>{{"{{servizi}}"}}</code> = lista servizi prenotati
            </div>
        </div>
        <button type="submit" class="btn btn-success">Salva messaggio automatico</button>
    </form>
</div>

<br>
<hr>

<div class="container mt-4" style="max-width:600px;">
    <br>
    <h3>WhatsApp reminder giornaliero</h3>
    <form id="morningReminderForm" method="post" action="{{ url_for('settings.whatsapp') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <!--Aggiungi i nuovi controlli -->
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" role="switch" id="whatsapp_morning_reminder_enabled" name="whatsapp_morning_reminder_enabled" {% if business_info and business_info.whatsapp_morning_reminder_enabled %}checked{% endif %}>
            <label class="form-check-label" for="whatsapp_morning_reminder_enabled">Attiva invio automatico reminder</label>
        </div>
        <div class="mb-3">
            <label for="whatsapp_morning_reminder_time" class="form-label">Orario di invio giornaliero</label>
            <input type="time" class="form-control" id="whatsapp_morning_reminder_time" name="whatsapp_morning_reminder_time" value="{{ business_info.whatsapp_morning_reminder_time.strftime('%H:%M') if business_info and business_info.whatsapp_morning_reminder_time else '08:00' }}">
        </div>
        <div class="mb-3">
            <label for="whatsapp_message_morning" class="form-label">Testo messaggio reminder</label>
            <textarea class="form-control" id="whatsapp_message_morning" name="whatsapp_message_morning" rows="5" required>{{ whatsapp_message_morning or "Ciao {{nome}}, la tua prenotazione per il {{data}} alle ore {{ora}} è stata registrata! Grazie da Sun Booking." }}</textarea>
            <div class="form-text">
                Questo messaggio verrà inviato automaticamente via WhatsApp secondo le impostazioni.<br>
                Puoi usare le variabili:<br>
                <code>{{"{{nome}}"}}</code> = nome cliente,
                <code>{{"{{data}}"}}</code> = data appuntamento,
                <code>{{"{{ora}}"}}</code> = orario appuntamento,
                <code>{{"{{servizi}}"}}</code> = lista servizi prenotati
            </div>
        </div>
        <button type="submit" class="btn btn-success">Salva messaggio automatico</button>
    </form>
</div>
<script>
(function () {
  const cb = document.getElementById('whatsapp_morning_reminder_enabled');
  const timeInput = document.getElementById('whatsapp_morning_reminder_time');
  const msgTextarea = document.getElementById('whatsapp_message_morning');
  if (!cb) return;

  function saveReminder(enabled) {
    const tokenInput = document.querySelector('input[name="csrf_token"]');
    const csrf = tokenInput ? tokenInput.value : '';
    const params = new URLSearchParams();
    params.set('csrf_token', csrf);
    params.set('whatsapp_message_morning', msgTextarea ? (msgTextarea.value || '') : '');
    if (timeInput && timeInput.value) {
      params.set('whatsapp_morning_reminder_time', timeInput.value);
    }
    if (enabled) {
      params.set('whatsapp_morning_reminder_enabled', 'on');
    }
    return fetch("{{ url_for('settings.whatsapp') }}", {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    })
    .then(resp => {
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      // Rimosso alert di successo
    })
    .catch(err => {
      console.error('Errore salvataggio reminder', err);
      cb.checked = !enabled;
      alert('Errore durante il salvataggio');
    });
  }

  // Salva immediatamente toggle e orario
  cb.addEventListener('change', () => {
  if (!confirm('Confermi di voler ' + (cb.checked ? 'attivare' : 'disattivare') + ' l\'invio automatico reminder giornaliero?')) {
    cb.checked = !cb.checked;
    return;
  }
  saveReminder(cb.checked);
});
  if (timeInput) timeInput.addEventListener('change', () => saveReminder(cb.checked));

  // Intercetta "Salva messaggio automatico" per inviare SOLO il testo
  const form = document.getElementById('morningReminderForm');
  if (form) {
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const btn = form.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;

      const csrf = form.querySelector('input[name="csrf_token"]')?.value || '';
      const message = msgTextarea ? (msgTextarea.value || '') : '';
      const params = new URLSearchParams();
      params.set('csrf_token', csrf);
      params.set('whatsapp_message_morning', message);

      fetch("{{ url_for('settings.whatsapp') }}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      })
      .then(resp => {
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        alert('Messaggio automatico salvato');
      })
      .catch(err => {
        console.error('Errore salvataggio messaggio automatico', err);
        alert('Errore durante il salvataggio');
      })
      .finally(() => { if (btn) btn.disabled = false; });
    });
  }
})();
</script>
<br>
<hr>
<div class="container mt-4" style="max-width:600px;">
  <h3>Memo turni operatori (WhatsApp)</h3>

  <!-- Toggle e orario: salvataggio immediato via JS -->
  <div class="form-check form-switch mb-3">
    <input class="form-check-input" type="checkbox" role="switch"
           id="operator_whatsapp_notification_enabled"
           {% if business_info and business_info.operator_whatsapp_notification_enabled %}checked{% endif %}>
    <label class="form-check-label" for="operator_whatsapp_notification_enabled">
      Attiva invio automatico memo turni agli operatori
    </label>
  </div>

  <div class="mb-3">
    <label for="operator_whatsapp_notification_time" class="form-label">Orario invio (giorno seguente)</label>
    <input type="time" class="form-control" id="operator_whatsapp_notification_time"
           value="{{ business_info.operator_whatsapp_notification_time.strftime('%H:%M') if business_info and business_info.operator_whatsapp_notification_time else '20:00' }}">
    <div class="form-text">
      All’orario impostato, vengono inviati i memo per i turni del giorno successivo.
    </div>
  </div>

<script>
(function() {
    const enabledCb = document.getElementById('operator_whatsapp_notification_enabled');
    const timeInput = document.getElementById('operator_whatsapp_notification_time');
    if (!enabledCb || !timeInput) return;

    function saveOperatorReminder(enabled, timeHHMM) {
      const token = document.querySelector('input[name="csrf_token"]')?.value || '';
      const params = new URLSearchParams();
      params.set('csrf_token', token);
      if (enabled) params.set('operator_whatsapp_notification_enabled', 'on');
      if (timeHHMM) params.set('operator_whatsapp_notification_time', timeHHMM);
      return fetch("{{ url_for('settings.whatsapp_per_operatori') }}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      })
      .then(resp => { if (!resp.ok) throw new Error('HTTP ' + resp.status); })
      .catch(err => {
        console.error('Errore salvataggio impostazioni operatori', err);
        enabledCb.checked = !enabled;
        alert('Errore durante il salvataggio impostazioni operatori');
      });
    }

    enabledCb.addEventListener('change', () => {
      console.log('Operator checkbox changed, checked:', enabledCb.checked);
      if (!confirm('Confermi di voler ' + (enabledCb.checked ? 'attivare' : 'disattivare') + ' l\'invio automatico memo turni agli operatori?')) {
        console.log('Confirm canceled');
        enabledCb.checked = !enabledCb.checked;
        return;
      }
      console.log('Confirm accepted, saving...');
      saveOperatorReminder(enabledCb.checked, timeInput.value);
    });
    timeInput.addEventListener('change', () => saveOperatorReminder(enabledCb.checked, timeInput.value));
  })();
</script>

  <!-- Template messaggio operatori -->
<form id="operatorTemplateForm" method="post" action="{{ url_for('settings.whatsapp_per_operatori') }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="mb-3">
      <label for="operator_whatsapp_message_template" class="form-label">Template messaggio operatori</label>
    <textarea id="operator_whatsapp_message_template" name="operator_whatsapp_message_template" class="form-control" rows="6">{{ business_info.operator_whatsapp_message_template or tpl_default }}</textarea>
      <div class="form-text">
        Variabili disponibili:<br>
        <code>{{"{{operatore}}"}}</code>, <code>{{"{{data}}"}}</code>, <code>{{"{{ora_inizio}}"}}</code>, <code>{{"{{ora_fine}}"}}</code>,<code>{{"{{ora_primo_app}}"}}</code>, <code>{{"{{primo_app}}"}}</code>,<code>{{"{{sezione_pausa}}"}}</code>
      </div>
    </div>
    <button type="submit" class="btn btn-success">Salva template operatori</button>
  </form>

  <!-- Preview messaggi operatori (domani) -->
  <div class="mt-3">
    <button type="button" class="btn btn-outline-primary" id="previewOpsBtn">Preview (domani)</button>
  </div>

<!-- Modal preview -->
  <div class="modal fade" id="opsPreviewModal" tabindex="-1" aria-labelledby="opsPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" style="max-width: 80vw; height: 90vh;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="opsPreviewModalLabel">Anteprima messaggi operatori (domani)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body p-0" style="overflow: hidden;">
          <!-- Contenuto caricato via JS -->
          <div class="text-muted p-3">Caricamento…</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        </div>
      </div>
    </div>
  </div>

<br><br><br><br>
  <script>
  (function(){
    const previewBtn = document.getElementById('previewOpsBtn');
    const modalEl = document.getElementById('opsPreviewModal');
    
    if (previewBtn && modalEl) {
      const modalBody = modalEl.querySelector('.modal-body');

      previewBtn.addEventListener('click', () => {
        // Recupera bootstrap dall'oggetto window o globale
        const bs = window.bootstrap || bootstrap;
        if (!bs) {
            console.error('Bootstrap non trovato!');
            return;
        }
        
        const modalInstance = bs.Modal.getOrCreateInstance(modalEl);
        
        // Mostra subito il modal con loader
        modalBody.innerHTML = '<div class="text-muted">Caricamento…</div>';
        modalInstance.show();

        // Chiede anteprima completa al backend
        const url = "{{ url_for('settings.preview_operator_notifications') }}?full=1";
        fetch(url, { credentials: 'same-origin' })
          .then(r => r.ok ? r.json() : Promise.reject(r))
          .then(j => {
            const items = Array.isArray(j.items) ? j.items : [];
            if (!items.length) {
              modalBody.textContent = 'Nessun operatore da notificare per domani.';
            } else {
              // 1. Pulisce tutto il contenuto precedente
              while (modalBody.firstChild) {
                modalBody.removeChild(modalBody.firstChild);
              }
              
              // 2. Crea UNICO contenitore per la lista che gestisce lo scroll internamente
              const listContainer = document.createElement('div');
              listContainer.className = 'd-flex flex-column gap-3';
              // FORZA lo scroll su questo contenitore
              listContainer.style.maxHeight = '67vh'; // Altezza massima esplicita
              listContainer.style.overflowY = 'auto'; // Scroll verticale
              listContainer.style.padding = '30px';   // Padding interno
              
              // 3. Popola il contenitore
              items.forEach((it, index) => {
                // Singolo blocco operatore
                const itemDiv = document.createElement('div');
                itemDiv.className = 'operator-item p-2 border rounded bg-light'; // Stile visivo per separare i blocchi
                
                // Nome
                const nameEl = document.createElement('div');
                nameEl.className = 'fw-bold text-primary';
                nameEl.textContent = (it.operatore || 'Operatore').trim();
                itemDiv.appendChild(nameEl);
                
                // Telefono
                const phoneEl = document.createElement('div');
                phoneEl.className = 'small text-muted mb-2';
                phoneEl.textContent = (it.phone || '').trim();
                itemDiv.appendChild(phoneEl);
                
                // Messaggio
                const msgEl = document.createElement('div');
                msgEl.className = 'text-break'; // Bootstrap class per spezzare parole lunghe
                msgEl.style.whiteSpace = 'pre-wrap'; // Mantiene a capo
                msgEl.textContent = (it.msg_full || it.msg || it.msg_preview || '').trim();
                itemDiv.appendChild(msgEl);

                // Aggiungi al contenitore principale
                listContainer.appendChild(itemDiv);
              });
              
              // 4. Inserisce il contenitore nel body
              modalBody.appendChild(listContainer);
            }
          })
          .catch(e => {
            console.error(e);
            modalBody.textContent = 'Errore durante la costruzione della preview.';
          });
      });
    }
  })();
  </script>
</div>
{% endblock %}