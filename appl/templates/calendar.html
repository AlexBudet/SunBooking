<!-- appl/templates/calendar.html -->
{% extends "base.html" %}
{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<script>
  window.lastClickPosition = null;
    const selectedDate = "{{ selected_date_str }}"; 
    const defaultOpeningTime = "{{ active_opening_time.strftime('%H:%M') }}"; 
    const defaultClosingTime = "{{ active_closing_time.strftime('%H:%M') }}";
    const closingDays = {{ closing_days|tojson }};
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>
<!-- Messaggi Flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="flash {{ category|e }}">
    {{ message }}
</div>
{% endfor %}
{% endif %}
{% endwith %}
<div id="clientHistoryPopup" style="display:none; z-index:99999; background:#fff; border-radius:6px; border: 2px solid #222; padding:8px 12px;"></div>
                     <div class="d-flex align-items-start mb-3" style="gap: 4px; width: 100%;">
  <!-- Quarter Navigator -->
<div id="quarterNavigator"
     style="position: fixed; top: 15px; right: 21vw; min-width: 120px; display: flex; flex-direction: row; align-items: center; justify-content: center; margin-top: 0; z-index: 13040;">
  <button type="button"
          style="background: transparent; border: none; color: #222; font-size: 1.1em; padding: 2px 6px; line-height: 1;"
          onclick="changeQuarterHeight(-5)">‚àí</button>
  <span style="font-size: 1em; color: #222; display: flex; align-items: center;">
      <i class="bi bi-search"
         id="quarterResetIcon"
         style="cursor:pointer; transition: box-shadow 0.2s;"></i>
  </span>
  <button type="button"
          style="background: transparent; border: none; color: #222; font-size: 1.1em; padding: 2px 6px; line-height: 1;"
          onclick="changeQuarterHeight(5)">+</button>
</div>
  <!-- Appointment Navigator -->
  <div id="appointmentNavigator" class="appointmentNavigator">
    <!-- Campo cerca cliente -->
    <div style="margin-bottom: 10px; position: relative;">
      <input 
        type="text" 
        id="clientSearchInputNav" 
        placeholder="Cerca Cliente..." 
        onkeyup="handleClientSearchNav(this.value)"
        style="width: 100%; padding: 6px; padding-right: 35px;" 
        autocomplete="off"
      />
      <button 
        type="button" 
        class="btn btn-outline-success btn-add-client-square btn-add-client-nav"
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Aggiungi cliente"
        onclick="openAddClientModal('navigator')"
      >
        +
      </button>
      <div 
        id="clientResultsNav" 
        class="results-dropdown" 
        style="display: none; position: relative; top: auto; left: auto; width: 100%;"
      ></div>
    </div>

    <!-- Campo servizio -->
    <div style="margin-bottom: 10px; position: relative;">
      <input
        type="text"
        id="serviceInputNav"
        placeholder="Cerca servizio..."
        onfocus="loadFrequentServices()"
        onkeyup="handleServiceSearchNav(this.value)"
        style="width: 100%; padding: 6px;"
        autocomplete="off"
      />
      <div
        id="serviceResultsNav"
        class="results-dropdown"
        style="display: none; position: relative; top: auto; left: auto; width: 100%;"
      ></div>
    </div>

    <!-- Lista servizi selezionati -->
    <div id="selectedServicesList"
         style="border: 1px dashed #ccc; padding: 5px; min-height: 40px;">
    </div>
    <button id="clearNavigatorBtn" class="clear-navigator-btn" onclick="clearNavigator()">Svuota</button>
  </div>
</div>
<!-- NAVIGAZIONE CALENDARIO -->
<div class="calendar-navigation sticky-nav">
    <!-- Freccia sinistra (giorno precedente) -->
    <a href="{{ url_for('calendar.calendar_home', date=day_before_str) }}" class="arrow-nav arrow-left">&lt;</a>
    <!-- Campo data visibile con giorno della settimana -->
    <div class="calendar-date-container">
        <!-- DESKTOP VERSION -->
        <div id="dateNavDesktop">
            <input type="text" id="date" name="date" value="{{ selected_date_str }}" class="calendar-date-input">
            <span id="dayOfWeek"></span>
        </div>
        <!-- MOBILE VERSION -->
        <div id="dateNavMobile" style="display:none;">
            <div style="display:flex; flex-direction:column; align-items:flex-start;">
                <input type="text" id="dateMobile" name="date" value="{{ selected_date_str }}" class="calendar-date-input" style="width:94vw; font-size:18px;">
                <span id="dayOfWeekMobile" style="font-size:16px; margin-top:2px;"></span>
            </div>
        </div>
    </div>
    <!-- Freccia destra (giorno successivo) -->
    <a href="{{ url_for('calendar.calendar_home', date=day_after_str) }}" class="arrow-nav arrow-right">&gt;</a>
    <!-- Pulsante per tornare a oggi: visualizza solo se la data corrente non √® quella odierna -->
    {% if selected_date_str != today_str %}
    &nbsp;<a href="{{ url_for('calendar.calendar_home', date=today_str) }}" class="btn-today">Vai a OGGI</a>
    {% endif %}
  <!-- Pulsante Web: AGGIUNGI QUI -->
<button id="btnWebInformatica"
        class="btn btn-outline-secondary"
        title="Web"
        style="margin-left: 12px; font-size: 1.4em; background: #fff; border-radius: 6px; padding: 2px 16px; cursor: pointer;">
  üåê
</button>
</div>
</div>

<!-- NUOVA TABELLA MOBILE DATE-NAV (<1200px): visibile solo su mobile -->
<div class="mobile-date-nav" id="mobileDateNavCalendar" style="display:none; width:100%;">
  <table aria-label="Navigazione data (mobile)">
    <tr>
      <!-- 1: IERI -->
      <td class="cell-arrow">
        <a class="arrow-nav" href="{{ url_for('calendar.calendar_home', date=day_before_str) }}" aria-label="Giorno precedente">&lt;</a>
      </td>

      <!-- 2: DATA FORMATTATA -->
<td class="cell-date" style="padding-right:4px;">
  <span id="mobileDateFormattedCalendar" style="display:inline-block; margin-right:2px;">-- --- ----</span>
</td>

      <!-- 3: ICONA CALENDARIO -->
<td class="cell-cal">
  <a href="#"
     id="mobileCalIconCalendar"
     aria-label="Apri calendario"
     title="Apri calendario"
     style="display:none;">üìÖ</a>
  <input type="date"
         id="mobileCalDate"
         data-mobile-cal="1"
         value="{{ selected_date_str }}"
         aria-label="Seleziona data"
         title="Seleziona data"
         style="width:34px;"/>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const inp = document.getElementById('mobileCalDate');
    if (!inp) return;
    inp.addEventListener('change', function() {
      const v = (this.value || '').trim();
      if (!v) return;
      const base = (typeof calendarHomeUrl === 'string') ? calendarHomeUrl : '/calendar';
      window.location.href = base + '?date=' + encodeURIComponent(v);
    });
  });
  </script>
</td>

      <!-- 4: DOMANI -->
      <td class="cell-arrow">
        <a class="arrow-nav" href="{{ url_for('calendar.calendar_home', date=day_after_str) }}" aria-label="Giorno successivo">&gt;</a>
      </td>

      <!-- 5: DAY OF WEEK -->
      <td class="cell-dow">
        <span id="mobileDayOfWeekCalendar">---</span>
      </td>

      <!-- 6: VAI A OGGI -->
      <td class="cell-today">
      {% if selected_date_str != today_str %}
        <a class="btn-today" href="{{ url_for('calendar.calendar_home', date=today_str) }}" id="btnTodayCalendar">Vai a OGGI</a>
      {% endif %}
      </td>
    </tr>
  </table>
</div>

<!-- Tabella dell'agenda giornaliera -->
<div class="calendar-fullwidth" style="width:100% !important; left:0 !important; margin-left:0 !important;">
    <table class="calendar-table">
        <thead>
  <tr id="headerRow">
    <th>Ora</th>
    {% for operator in operators %}
    <th class="operator-header{% if operator.use_twenty_minutes %} twenty-minutes{% endif %}" data-operator-id="{{ operator.id }}">
      <a href="#" class="operator-shift-link {% if operator.user_tipo != 'estetista' %}solarium{% endif %}" 
         data-operator-id="{{ operator.id }}"
         data-operator-name="{{ operator.user_nome }}"
         data-date="{{ selected_date_str }}"
         data-url="{{ url_for('operators.operator_shifts', operator_id=operator.id, _external=True) }}">
         {{ operator.user_nome }}
      </a>
    </th>    
    {% endfor %}
    <th>Ora</th>
  </tr>
</thead>
        <tbody>
            {% for hour in range(opening_time.hour if opening_time else 8, (closing_time.hour if closing_time else 20) + 1) %}
            {% for quarter in range(4) %}
            <tr>
                <!-- Determina lo stile della cella oraria -->
                <td
  class="{% if quarter == 0 %}hour-cell{% else %}quarter-cell{% endif %}
    {% if hour < (active_opening_time.hour if active_opening_time else 24) or (hour == active_opening_time.hour and quarter * 15 < (active_opening_time.minute if active_opening_time else 60)) or hour > (active_closing_time.hour if active_closing_time else 0) or (hour == active_closing_time.hour and quarter * 15 >= (active_closing_time.minute if active_closing_time else 0)) %} calendar-closed{% endif %}
    {% if selected_date.strftime('%A') in closing_days %} calendar-closed{% endif %}"
    {% if quarter == 0 %}id="fascia-{{ "%02d" % hour }}"{% endif %}
  {% if quarter == 0 %}data-hour="{{ hour }}"{% endif %}
>
  {{ "%02d:%02d" % (hour, quarter * 15) }}
</td>

                {% for operator in operators %}
                <!-- Determina lo stile della cella operatore -->
                <td id="cell-{{ operator.id }}-{{ hour }}-{{ quarter }}" class="selectable-cell 
                              {% if hour < (active_opening_time.hour if active_opening_time else 24) or (hour == active_opening_time.hour and quarter * 15 < (active_opening_time.minute if active_opening_time else 60)) or hour > (active_closing_time.hour if active_closing_time else 0) or (hour == active_closing_time.hour and quarter * 15 >= (active_closing_time.minute if active_closing_time else 0)) %} calendar-closed{% endif %}
                              {% if selected_date.strftime('%A') in closing_days %} calendar-closed{% endif %}"
                    data-operator-id="{{ operator.id }}" data-hour="{{ hour }}" data-minute="{{ quarter * 15 }}"
                    data-operator-name="{{ operator.user_nome }} {{ operator.user_cognome }}"
                    data-date="{{ selected_date_str }}">
                    <!-- Aggiungi gli appuntamenti solo se la cella √® attiva -->
                    {% for appt in appointments if appt.operator_id == operator.id %}
                    {% if appt.start_time.hour == hour and (appt.start_time.minute // 15) == quarter %}
                    <div class="appointment-wrapper">
                      <div class="appointment-block{% if appt.stato == 2 %} status-2{% endif %}{% if not appt.client or (appt.client.cliente_nome|lower == 'dummy' and appt.client.cliente_cognome|lower == 'dummy') %} note-off{% elif appt.client and appt.client.is_deleted %} disable-popup{% endif %}{% if appt.colore_font|lower in ['#ffffff', '#fff', 'white'] %} dark-bg{% else %} light-bg{% endif %}"
                      draggable="{% if not appt.client.is_deleted %}true{% else %}false{% endif %}"
                      data-status="{{ appt.stato.value }}"
                      data-created-at="{{ appt.created_at.isoformat() if appt.created_at else '' }}"
                      data-booking_session_id="{{ appt.booking_session_id or '' }}"
                      data-last-edit="{{ appt.last_edit.isoformat() if appt.last_edit else '' }}"
                      data-colore="{{ appt.colore }}" 
                      data-colore_font="{{ appt.colore_font }}" 
                      data-appointment-id="{{ appt.id }}" 
                      data-duration="{{ appt.duration }}" 
                      data-service-id="{{ appt.service.id }}" 
                      data-client-id="{{ appt.client.id }}" 
                      data-client-nome="{{ appt.client.cliente_nome }}" 
                      data-client-cognome="{{ appt.client.cliente_cognome }}" 
                      data-client-cellulare="{{ appt.client.cliente_cellulare or '' }}"
                      data-operator-id="{{ operator.id }}" 
                      data-hour="{{ hour }}" 
                      data-minute="{{ quarter * 15 }}"
                      data-source="{{ appt.source.value }}" 
                      {% if appt.note %} data-note="{{ appt.note|e }}" {% endif %}
                 >
<div class="popup-buttons">
  {% if not appt.client.is_deleted %}
    <button type="button"
            class="btn-popup delete-appointment-block"
            title="Elimina appuntamento"
            data-appointment-id="{{ appt.id }}"
            onclick="if(window.deleteAppointment) window.deleteAppointment('{{ appt.id }}')">
      <i class="bi bi-trash"></i>
    </button>
    <button type="button" class="btn-popup sposta" title="Togli e sposta" data-bs-toggle="tooltip"
            data-appointment-id="{{ appt.id }}">
      <i class="bi bi-scissors"></i>
    </button>
    <button type="button" class="btn-popup copia" title="Copia blocco" data-bs-toggle="tooltip"
            data-appointment-id="{{ appt.id }}">
      <i class="bi bi-files"></i>
    </button>
    <button type="button" class="btn-popup colore" title="Imposta colore" data-bs-toggle="tooltip"
            data-appointment-id="{{ appt.id }}">
      <i class="bi bi-palette"></i>
    </button>
    <button type="button" class="btn-popup pagamento" title="Porta in cassa" data-bs-toggle="tooltip"
            data-appointment-id="{{ appt.id }}">
      <i class="bi bi-currency-euro"></i>
    </button>
    <button type="button" class="btn-popup aggiungi-servizi" title="Aggiungi Servizi" data-bs-toggle="tooltip"
            data-appointment-id="{{ appt.id }}">
      <i class="bi bi-plus"></i>
    </button>
    <button type="button" class="btn-popup nota" title="Nota appuntamento" data-bs-toggle="tooltip"
            data-appointment-id="{{ appt.id }}"
            onclick="event.stopPropagation();(function(btn){var b=btn.closest('.appointment-block');if(window.openNoteModal) window.openNoteModal(b)})(this)">
      <i class="bi bi-pencil-square"></i>
    </button>
  {% endif %}
</div>

<!-- BOTTOM BAR (6 pulsanti) -->
<div class="popup-buttons-bottom">
  {% if not appt.client.is_deleted %}
    <button type="button" class="btn-popup touch-resize-down" title="Allunga di 15 min"
            onclick="(function(btn){var b=btn.closest('.appointment-block');if(!b)return;var id=b.getAttribute('data-appointment-id');if(!id)return;var d=(parseInt(b.getAttribute('data-duration')||'15',10)||15)+15;fetch('/calendar/edit/'+encodeURIComponent(id),{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json','X-Requested-With':'XMLHttpRequest','X-CSRFToken':(document.querySelector('meta[name=&quot;csrf-token&quot;]')&&document.querySelector('meta[name=&quot;csrf-token&quot;]').getAttribute('content'))||''},credentials:'same-origin',body:JSON.stringify({duration:d})}).then(function(){b.setAttribute('data-duration',String(d));if(window.updateAppointmentBlockStyles)window.updateAppointmentBlockStyles(b)}).catch(function(){})})(this)">
      <i class="bi bi-arrow-down"></i>
    </button>
    <button type="button" class="btn-popup touch-spia-in" title="Segna cliente in istituto"
            onclick="(function(btn){var b=btn.closest('.appointment-block');var el=b&&b.querySelector('.my-spia');if(el) el.click()})(this)">
      <i class="bi bi-person-check"></i>
    </button>
    <button type="button" class="btn-popup touch-no-show" title="Segna NON ARRIVATO"
            onclick="(function(btn){var b=btn.closest('.appointment-block');var el=b&&b.querySelector('.btn-popup.no-show-button');if(el) el.click()})(this)">
      <i class="bi bi-x"></i>
    </button>
    {% if appt.client and appt.service and not (appt.client.cliente_nome|lower == 'dummy' and appt.client.cliente_cognome|lower == 'dummy') %}
    <button type="button" class="btn-popup whatsapp-bottom" title="Invia WhatsApp"
            onclick="(function(btn){var b=btn.closest('.appointment-block');var el=b&&b.querySelector('.btn-popup.whatsapp-btn');if(el) el.click()})(this)">
      <i class="bi bi-whatsapp"></i>
    </button>
    {% endif %}
    <button type="button" class="btn-popup nota" title="Aggiungi nota"
            onclick="(function(btn){var b=btn.closest('.appointment-block');if(window.openNoteModal) window.openNoteModal(b)})(this)">
      <i class="bi bi-pencil-square"></i>
    </button>
    <button type="button" class="btn-popup touch-resize-up" title="Accorcia di 15 min"
            onclick="(function(btn){var b=btn.closest('.appointment-block');if(!b)return;var id=b.getAttribute('data-appointment-id');if(!id)return;var cur=(parseInt(b.getAttribute('data-duration')||'15',10)||15);var d=Math.max(15,cur-15);fetch('/calendar/edit/'+encodeURIComponent(id),{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json','X-Requested-With':'XMLHttpRequest','X-CSRFToken':(document.querySelector('meta[name=&quot;csrf-token&quot;]')&&document.querySelector('meta[name=&quot;csrf-token&quot;]').getAttribute('content'))||''},credentials:'same-origin',body:JSON.stringify({duration:d})}).then(function(){b.setAttribute('data-duration',String(d));if(window.updateAppointmentBlockStyles)window.updateAppointmentBlockStyles(b)}).catch(function(){})})(this)">
      <i class="bi bi-arrow-up"></i>
    </button>
  {% endif %}
</div>

<div>
      <!-- pulsante Whatsapp -->
  {% if appt.client and appt.service and not (appt.client.cliente_nome|lower == 'dummy' and appt.client.cliente_cognome|lower == 'dummy') %}
<button type="button"
        class="btn-popup whatsapp-btn"
        data-appointment-id="{{ appt.id }}"
        title="Invia WhatsApp"
        data-bs-toggle="tooltip"
        data-client-nome="{{ (appt.client.cliente_nome or '')|e }}"
        data-client-cellulare="{{ (appt.client.cliente_cellulare or '')|e }}"
        data-date="{{ appt.start_time.strftime('%d/%m/%Y') if appt.start_time else '' }}"
        data-hour="{{ '%02d' % appt.start_time.hour if appt.start_time else '' }}"
        data-minute="{{ '%02d' % appt.start_time.minute if appt.start_time else '' }}">
  <i class="bi bi-whatsapp"></i>
</button>
{% endif %}
</div>
  <button type="button"
          class="delete-icon"
          title="Elimina appuntamento"
          data-appointment-id="{{ appt.id }}"
          onclick="event.stopPropagation(); if(window.deleteAppointment) window.deleteAppointment('{{ appt.id }}')">
    <i class="bi bi-trash"></i>
  </button>
<div class="drag-handle"></div>
<div class="note-indicator" onclick="openNoteModal(this.closest('.appointment-block'))"><i class="bi bi-pencil-square"></i></div>
<div class="appointment-content">
<!-- Un solo paragrafo per il nome/‚Äú+‚Äù -->
<p class="client-name">
{% if appt.client and appt.client.is_deleted %}
    <a href="javascript:void(0)" title="assegnare nuovo cliente o eliminare">?</a>
  {% elif appt.client and appt.client.cliente_nome|lower == 'dummy' and appt.client.cliente_cognome|lower == 'dummy' and appt.note %}
    <span class="off-title">{{ appt.note }}</span>
  {% else %}
    {% if appt.client.note %}
    <a href="javascript:void(0)" class="client-info-link"
    data-client-nome="{{ appt.client.cliente_nome|e }}"
    data-client-cognome="{{ appt.client.cliente_cognome|e }}"
    data-client-cellulare="{{ appt.client.cliente_cellulare|e }}"
    data-service-nome="{{ appt.service.servizio_tag|e }}"
    data-service-full_name="{{ appt.service.servizio_nome|e }}"
    data-client-note="{{ appt.client.note|e }}"
    data-created-at="{{ appt.created_at.isoformat() if appt.created_at else '' }}"
    data-last-edit="{{ appt.last_edit.isoformat() if appt.last_edit else '' }}"
    style="font-style: italic;">
    {{ appt.client.cliente_nome }} {{ appt.client.cliente_cognome }}
 </a>
    {% else %}
      <a href="javascript:void(0)" class="client-info-link"
   data-client-nome="{{ appt.client.cliente_nome|e }}"
   data-client-cognome="{{ appt.client.cliente_cognome|e }}"
   data-client-cellulare="{{ appt.client.cliente_cellulare|e }}"
   data-service-nome="{{ appt.service.servizio_tag|e }}"
   data-service-full_name="{{ appt.service.servizio_nome|e }}">
         {{ appt.client.cliente_nome }} {{ appt.client.cliente_cognome }}
      </a>
    {% endif %}
  {% endif %}
</p>
<p><strong>{{ appt.service.servizio_tag }}</strong></p>
</div>
<div class="my-spia"
     data-bs-toggle="tooltip"
     title="Segna cliente in istituto"></div>
<button class="btn-popup no-show-button"
        data-bs-toggle="tooltip"
        data-appointment-id="{{ appt.id }}"
        title="Segna NON ARRIVATO">
    <i class="bi bi-x"></i>
</button>
<div class="resize-handle"></div>
<button class="btn-chain-blocks"
        style="position:absolute; bottom:4px; right:4px; display:none;"
        onclick="chainBlocks()"
        title="Collega blocchi appuntamento consecutivi">
    <!-- ...icona... -->
</button>
</div>
</div>
{% endif %}
                    {% endfor %}
                </td>
                {% endfor %}
                <td class="{% if quarter == 0 %}hour-cell hour-cell-right{% else %}quarter-cell hour-cell-right{% endif %}
                {% if hour < (active_opening_time.hour if active_opening_time else 24) or (hour == active_opening_time.hour and quarter * 15 < (active_opening_time.minute if active_opening_time else 60)) or hour > (active_closing_time.hour if active_closing_time else 0) or (hour == active_closing_time.hour and quarter * 15 >= (active_closing_time.minute if active_closing_time else 0)) %} calendar-closed{% endif %}
                {% if selected_date.strftime('%A') in closing_days %} calendar-closed{% endif %}"
                style="text-align: left;">
                {{ "%02d:%02d" % (hour, quarter * 15) }}
            </td>
            </tr>
            {% endfor %}
            {% endfor %} </tbody>
    </table>
    <div id="clientInfoPopup" style="display:none; position:absolute; margin-top:-25px; z-index:9999; background:#000000; border:1px solid #ccc; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.15); padding:6px 10px; font-size:0.95em; width:auto; text-align:center;"></div>
    <div id="currentTimeIndicator" style="position: absolute; left: 0; right: 0; height: 1px; background: rgb(255, 0, 136); z-index: 10;"></div>
</div>

<!-- Modal per i turni operatore (calendar.html) -->
<div class="modal" id="OperatorShiftsModalCalendar" tabindex="-1" aria-labelledby="ShiftsModalCalendarLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ShiftsModalCalendarLabel">Turno di <strong><span
                        id="modalOperatorNameCalendar"></span></strong> per il <span id="modalSelectedDateCalendar"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Impostazioni turno giornaliero -->
                <div class="mb-3">
                    <h4>Imposta Turno Giornaliero</h4>
                    <div class="row">
                        <div class="col">
                            <label for="shiftStartTimeCalendar">Ora Inizio:</label>
                            <input type="time" id="shiftStartTimeCalendar" name="shiftStartTimeCalendar" class="form-control custom-time-input" step="300">
                        </div>
                        <div class="col">
                            <label for="shiftEndTimeCalendar">Ora Fine:</label>
                            <input type="time" id="shiftEndTimeCalendar">
                        </div>
                    </div>
                    <button class="btn btn-primary mt-2" onclick="saveDailyShiftCalendar()">Salva Turno</button>
                </div>

                <!-- Imposta come non di turno -->
                <div class="mb-3">
                    <h4>Imposta come Non di Turno</h4>
                    <button class="btn btn-secondary" onclick="setDayOffCalendar()">Imposta come Giorno di
                        Riposo</button>
                </div>
            </div>
        </div>
    </div>
</div>
  
  <div class="modal fade" id="EditAppointmentModal" tabindex="-1" aria-labelledby="EditAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="EditAppointmentModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Il contenuto per la modifica verr√† caricato qui via fetch -->
        </div>
      </div>
    </div>
  </div>

<!-- Modal per la modifica delle note -->
<div class="modal fade" tabindex="-1" id="EditApptNoteModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Note Appuntamento</h3>
        </div>
        <div class="modal-body">
          <form id="EditApptNoteForm">
            <div class="mb-3">
              <label for="apptNote" class="form-label">Scrivi una nota (max 1000 caratteri)</label>
              <textarea class="form-control" id="apptNote" name="note" maxlength="1000" rows="5"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="saveNoteBtn">OK</button>
        </div>
      </div>
    </div>
</div>

<!-- Modal per la selezione del colore -->
<div class="modal fade" id="ColorPickerModal" tabindex="-1" aria-labelledby="ColorPickerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ColorPickerModalLabel">Seleziona Colore Appuntamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Unico selettore per il colore di sfondo -->
        <div class="mb-3">
          <label for="colorPickerInput" class="form-label">Colore Appuntamento</label>
          <input type="color" id="colorPickerInput" value="#ffffff" style="width: 100%; height: 50px;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveColorBtn">OK</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="AddClientModal" tabindex="-1" aria-labelledby="AddClientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="AddClientModalLabel">Aggiungi Nuovo Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="AddClientForm">
          <div class="mb-3">
            <input type="text" class="form-control" id="cliente_nome" name="cliente_nome" required required placeholder="Nome">
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" id="cliente_cognome" name="cliente_cognome" required required placeholder="Cognome">
          </div>
          <div class="mb-3">
            <input type="text" class="form-control" id="cliente_cellulare" name="cliente_cellulare" required required placeholder="Cellulare">
          </div>
          <button type="submit" class="btn btn-primary">Salva Cliente</button>
        </form>        
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="CreateAppointmentModal"
     tabindex="-1"
     aria-labelledby="CreateAppointmentModalLabel"
     aria-hidden="true"
     data-bs-backdrop="static"
     data-bs-keyboard="false">
  <div class="modal-dialog modal-lg"> <!-- Usa modal-lg per una larghezza ampia, puoi togliere se vuoi pi√π stretto -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="CreateAppointmentModalLabel">Nuovo Appuntamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body" id="CreateAppointmentModalBody">
        <!-- Qui verr√† inserito il form dinamico -->
      </div>
    </div>
  </div>
</div>

<!-- MODAL MOBILE POPUP BUTTONS <1200 px -->
<div class="modal fade" id="MobilePopupButtonsModal" tabindex="-1" aria-labelledby="MobilePopupButtonsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="MobilePopupButtonsModalLabel">Azioni appuntamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <br>
          <div id="mobile-appt-info" style="color: #333; font-size: 1em;"></div>
          <br>
        <table style="width:100%; border:none;">
          <tr>
            <td><button class="btn mobile-popup-btn" data-action="elimina" style="width:100%;">ELIMINA</button></td>
            <td><button class="btn mobile-popup-btn" data-action="sposta" style="width:100%;">SPOSTA</button></td>
          </tr>
          <tr>
            <td><button class="btn mobile-popup-btn" data-action="cliente" style="width:100%;">CLIENTE</button></td>
            <td><button class="btn mobile-popup-btn" data-action="note" style="width:100%;">NOTE</button></td>
          </tr>
          <tr>
            <td><button class="btn mobile-popup-btn" data-action="allunga" style="width:100%;">ALLUNGA ‚Üì</button></td>
            <td><button class="btn mobile-popup-btn" data-action="accorcia" style="width:100%;">ACCORCIA ‚Üë</button></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Info Cliente (solo mobile) -->
<div class="modal fade" id="ClientInfoMobileModal" tabindex="-1" aria-labelledby="ClientInfoMobileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ClientInfoMobileModalLabel">Info Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="ci-section">
          <div class="ci-title">NOME</div>
          <input type="text" class="form-control" id="ciNome" autocomplete="off">
          <button type="button" class="btn btn-primary ci-save" data-field="nome">Salva</button>
        </div>

        <div class="ci-section">
          <div class="ci-title">COGNOME</div>
          <input type="text" class="form-control" id="ciCognome" autocomplete="off">
          <button type="button" class="btn btn-primary ci-save" data-field="cognome">Salva</button>
        </div>

        <div class="ci-section">
          <div class="ci-title">CELL</div>
          <input type="text" class="form-control" id="ciCell" autocomplete="off" inputmode="tel">
          <button type="button" class="btn btn-primary ci-save" data-field="cellulare">Salva</button>
        </div>

        <div class="ci-section">
          <div class="ci-title">E-MAIL</div>
          <input type="email" class="form-control" id="ciEmail" autocomplete="off" inputmode="email">
          <button type="button" class="btn btn-primary ci-save" data-field="email">Salva</button>
        </div>

        <hr class="ci-sep">
        <div class="ci-heading">PROX APPUNTAMENTI</div>
        <div id="ciNextAppts" class="ci-list"></div>

        <hr class="ci-sep">
        <div class="ci-heading">STORICO APPUNTAMENTI</div>
        <div id="ciHistoryAppts" class="ci-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal per gli appuntamenti via booking online-->
<div class="modal fade" id="WebAppointmentsModal" tabindex="-1" aria-labelledby="WebAppointmentsModalLabel" aria-hidden="true" style="z-index: 14000;">
  <div class="modal-dialog" style="max-width:80vw; height:85vh;">
    <div class="modal-content" style="height:83vh;">
      <div class="modal-header">
        <h5 class="modal-title" id="WebAppointmentsModalLabel">Appuntamenti Online</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body" style="overflow:auto;">
<div class="d-flex align-items-center mb-3" id="webApptDateNav" style="gap: 12px;">
  <!-- Date navigator -->
  <button class="btn btn-outline-secondary" id="webApptPrev">&lt;</button>
  <input type="date" id="webApptDate" class="form-control mx-2" style="width:180px;">
  <button class="btn btn-outline-secondary" id="webApptNext">&gt;</button>
  <!-- Campo ricerca -->
  <input type="text" id="webApptSearch" class="form-control ms-3" style="max-width: 260px;" placeholder="Cerca per nome cliente...">
</div>
        <!-- Tabella risultati -->
       <div class="web-appt-table-container">
        <table id="webApptTable">
          <thead>
            <tr>
              <th style="text-align:center">DATA RICHIESTA</th>
              <th>CLIENTE PRENOTATO</th>
              <th>MATCH CLIENTE</th>
              <th style="text-align:center">ASSOCIA</th>
              <th style="text-align:center">DATA APPUNTAMENTO</th>
            </tr>
          </thead>
          <tbody>
            <!-- Popolato via JS -->
          </tbody>
        </table>
        </div>
      </div>
    </div><div class="form-group position-relative"></div>
  </div>
</div>

<script id="create-appt-template" type="text/template">
  <form id="CreateAppointmentForm">
    <button type="button" id="btnCreateBlockOff" class="btn btn-warning" style="right: 3px; z-index: 999;">
      Crea blocco OFF
    </button>
    <input type="hidden" id="client_id" name="client_id">
    <input type="hidden" id="service_id" name="service_id">
    <input type="hidden" name="operator_id" value="{{operator_id}}">
    <input type="hidden" name="appointment_date" id="appointmentDate" value="{{date}}">
    <input type="hidden" name="date" value="{{date}}">
    <input type="hidden" id="start_time" name="start_time" value="{{start_time}}">

    <div>
      <label>Ora di inizio:</label>
      <span id="hour-display"><strong>{{start_time}}</strong></span>
      <span id="operator-display" style="margin-left: 20px;">{{operator_name}}</span>
    </div>
    <br>
    <div id="regularFields">
      <!-- Sezione Cliente (layout coerente: input + pulsante quadrato esterno) -->
      <div class="form-group client-search-row" style="display:flex; align-items:center; gap:8px;">
        <label for="clientSearchInput" style="min-width:110px; margin:0;">Cerca Cliente:</label>
        <div id="clientSearchInputContainer" style="position:relative; flex:1;">
          <input type="text" id="clientSearchInput"
                 class="form-control"
                 placeholder="Nome, cognome o cellulare..."
                 autocomplete="off"
                 onkeyup="handleClientSearch(this.value)"
                 style="width:100%; padding-right: 10px;">
          <div id="clientResults" class="results-dropdown"></div>
        </div>
        <button type="button" class="btn btn-outline-success btn-add-client-square"
                title="Aggiungi cliente"
                onclick="openAddClientModal('CreateAppointmentModal')">+</button>
      </div>
      <!-- Sezione Servizi -->
      <div class="form-group">
        <label for="serviceSearchInput">Cerca Servizio:</label>
        <input type="text" id="serviceSearchInput"
               class="form-control"
               placeholder="Nome servizio..."
               autocomplete="off"
               onfocus="loadServicesForModal()"
               onkeyup="handleServiceSearchModal(this.value)">
        <div id="serviceResults" class="results-dropdown"></div>
      </div>
    </div>
    <div class="mb-3" id="divDurata" style="display: none;">
      <label for="duration" class="form-label">Durata (minuti)</label>
      <input type="number" class="form-control" id="duration" name="duration" min="15" step="15">
    </div>
    <div class="form-group" id="divTitolo" style="display: none;">
      <label for="titolo">Titolo</label>
      <input type="text" id="titolo" name="titolo" class="form-control">
    </div>

    <div id="pseudoBlockContainer" class="pseudo-block-container" style="margin-top: 10px;">
      <!-- Qui verranno inseriti i pseudo-blocchi -->
    </div>

    <button type="submit" class="btn btn-primary mt-2">Crea Appuntamento</button>
  </form>

</script>


<script type="text/template" id="edit-appt-client-template">
  <form id="EditAppointmentClientForm" method="POST" action="/calendar/edit/__APPOINTMENT_ID__">
    <input type="hidden" id="appointmentId" name="appointmentId" value="__APPOINTMENT_ID__">
    <input type="hidden" name="csrf_token" value="__CSRF_TOKEN__">
    <input type="hidden" id="client_id" name="client_id" value="">

    <div class="form-group">
      <label for="currentClient">Cliente Attuale:</label>
      <input type="text" id="currentClient" class="form-control" value="__CURRENT_CLIENT__" disabled>
    </div>

    <div class="form-group">
      <label for="clientSearchInput">Nuovo cliente:</label>
<input type="text" id="clientSearchInput"
       class="form-control"
       placeholder="Nome, cognome o cellulare..."
       autocomplete="off">
<div id="clientResults" class="results-dropdown"></div>
    </div>
    
    <button type="submit" class="btn btn-primary">Assegna a Nuovo Cliente</button>
  </form>
</script>

<script>
  window.whatsappMessageTemplate = {{ whatsapp_message|tojson }};
</script>
<script>
  // Imposta l'endpoint dal url_for del blueprint (assicurati che questa riga sia prima dell'inclusione di calendar.js)
  window.apiWhatsappSettingUrl = "{{ url_for('settings.api_whatsapp_setting') }}";
</script>
<script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
<script>
    var calendarHomeUrl = "{{ url_for('calendar.calendar_home') }}";
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  flatpickr("#date", {
    dateFormat: "Y-m-d",  // Valore input resta yyyy-mm-dd (backend)
    altFormat: "d M Y",   // Display: gg MMM yyyy (mesi italiani grazie a locale)
    altInput: true,       // Mostra altFormat nell'input
    defaultDate: "{{ selected_date_str }}",
    locale: "it",         // Mesi italiani (GEN, FEB, ecc.)
    onChange: function(selectedDates, dateStr, instance) {
      // Reindirizza alla pagina con la nuova data
      window.location.href = calendarHomeUrl + "?date=" + dateStr;
    }
  });
});
</script>
<script>
  //blocco OFF
  document.addEventListener('DOMContentLoaded', function() {
  const btnToggleNote = document.getElementById('btnToggleNote');
  const noteBlockRow = document.getElementById('noteBlockRow');
  if (btnToggleNote && noteBlockRow) {
    btnToggleNote.addEventListener('click', function() {
      // Se il blocco √® nascosto (o non impostato), lo mostra; altrimenti lo nasconde
      if (!noteBlockRow.style.display || noteBlockRow.style.display === 'none') {
        noteBlockRow.style.display = 'flex';
      } else {
        noteBlockRow.style.display = 'none';
      }
    });
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  if ("{{ selected_date_str }}" !== "{{ today_str }}") {
    const indicator = document.getElementById("currentTimeIndicator");
    if (indicator) indicator.style.display = 'none';
    return;
  }

  function updateCurrentTimeIndicator() {
    // Usa l'orario di apertura definito in business_info
    const agendaStart = "{{ business_info.active_opening_time.strftime('%H:%M') if business_info and business_info.active_opening_time else '08:00' }}";
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();

    // Converte l'orario di apertura in minuti
    let [startHour, startMinute] = agendaStart.split(':').map(Number);
    const startAgendaMinutes = startHour * 60 + startMinute;

    // Calcola i minuti trascorsi dall'inizio dell'agenda
    let minutesSinceStart = currentMinutes - startAgendaMinutes;
    if (minutesSinceStart < 0) minutesSinceStart = 0;

    // Ottieni dinamicamente l'altezza di una cella quarter dal CSS
    const quarterCell = document.querySelector('.selectable-cell');
    if (!quarterCell) return;
    const computedStyle = getComputedStyle(quarterCell);
    const quarterHeight = parseFloat(computedStyle.height);

    // Determina se box-sizing √® border-box
    const boxSizing = computedStyle.boxSizing || 'border-box';
    let totalQuarterHeight = quarterHeight;
    if (boxSizing === 'content-box') {
      const borderTop = parseFloat(computedStyle.borderTopWidth) || 1;
      const borderBottom = parseFloat(computedStyle.borderBottomWidth) || 1;
      totalQuarterHeight = quarterHeight + borderTop + borderBottom;
    }

    // Calcola i pixel per minuto (un quarto d'ora = 15 minuti)
    const pixelsPerMinute = totalQuarterHeight / 15;

    // Ottieni l'offset del contenitore calendar-fullwidth rispetto al documento
    const calendarContainer = document.querySelector('.calendar-fullwidth');
    if (!calendarContainer) return;
    const containerOffset = calendarContainer.getBoundingClientRect().top + window.scrollY;

    // Ottieni l'offset della prima cella hour rispetto al contenitore
    const firstHourCell = document.querySelector('.hour-cell');
    let cellOffset = 0;
    if (firstHourCell) {
      const cellTop = firstHourCell.getBoundingClientRect().top + window.scrollY;
      cellOffset = cellTop - containerOffset; // Offset relativo al contenitore
    } else {
      cellOffset = 0; // Fallback
    }

    // Calcola la posizione in pixel dell'indicatore
    const topPx = cellOffset + (minutesSinceStart * pixelsPerMinute);

    // Aggiorna la posizione dell'indicatore
    const indicator = document.getElementById("currentTimeIndicator");
    if (indicator) {
      indicator.style.top = `${topPx}px`;
    }
  }

  // Esegui immediatamente e poi ogni minuto
  updateCurrentTimeIndicator();
  setInterval(updateCurrentTimeIndicator, 60000);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.appointment-block').forEach(function(block) {
        const noteIndicator = block.querySelector('.note-indicator');
        const note = block.getAttribute('data-note') || '';
        if (note.trim().length > 0) {
            noteIndicator.style.display = 'block';
        } else {
            noteIndicator.style.display = 'none';
        }
    });
});
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
      var hiddenOperators = [];
      // Cicla sugli header che hanno l'attributo data-operator-id
      document.querySelectorAll('th[data-operator-id]').forEach(function(th) {
          var operatorId = th.getAttribute('data-operator-id');
          if (localStorage.getItem('operator_' + operatorId + '_is_visible') === 'hidden') {
              hiddenOperators.push(operatorId);
          }
      });
      // Per ogni operatore nascosto, nascondi l'header, le celle e i blocchi appuntamento
      hiddenOperators.forEach(function(operatorId) {
          // Nascondi l'header
          document.querySelectorAll('th[data-operator-id="' + operatorId + '"]').forEach(function(th) {
              th.style.display = 'none';
          });
          // Nascondi le celle corrispondenti
          document.querySelectorAll('td[data-operator-id="' + operatorId + '"]').forEach(function(td) {
              td.style.display = 'none';
          });
          // Nascondi i blocchi appuntamento
          document.querySelectorAll('.appointment-block[data-operator-id="' + operatorId + '"]').forEach(function(block) {
              block.style.display = 'none';
          });
      });
  });
  </script>
<script>
function toggleOperatorVisibility(operatorId, isVisible) {
    localStorage.setItem('operator_' + operatorId + '_is_visible', isVisible ? 'visible' : 'hidden');
    console.log('Operatore ' + operatorId + ' impostato come ' + (isVisible ? 'visible' : 'hidden'));
}

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('input[type=checkbox][id^="operatorVisibility_"]').forEach(function(checkbox) {
        var operatorId = checkbox.id.split('_')[1];
        var storedValue = localStorage.getItem('operator_' + operatorId + '_is_visible');
        checkbox.checked = (storedValue !== 'hidden');
    });
});
</script>
<script>
  const DEFAULT_QUARTER_HEIGHT = 60; // Imposta il default a 60
  const MIN_QUARTER_HEIGHT = 30;
  const MAX_QUARTER_HEIGHT = 90;

  function applyQuarterHeight(height) {
  document.documentElement.style.setProperty('--quarter-px', height + 'px');
  // Celle: height fissa, ma NO maxHeight/minHeight
  document.querySelectorAll('.selectable-cell, .hour-cell, .quarter-cell').forEach(cell => {
    cell.style.height = height + 'px';
    cell.style.minHeight = '';
    cell.style.maxHeight = '';
  });

  // Blocchi: height fissa SOLO SE NON IN RESIZE
  document.querySelectorAll('.appointment-block').forEach(block => {
    // Se il blocco NON √® in resize, aggiorna l'altezza
    if (!block.classList.contains('resizing')) {
      const duration = parseInt(block.getAttribute('data-duration'), 10) || 15;
      const quarters = duration / 15;
      block.style.height = (quarters * height) + 'px';
    }
    // MAI impostare minHeight/maxHeight qui!
    block.style.minHeight = '';
    block.style.maxHeight = '';
  });

  if (height <= 55) {
  document.body.classList.add('quarter-55');
} else {
  document.body.classList.remove('quarter-55');
}
  // Allinea il contenuto verticalmente e NASCONDI la scritta servizio se height < 40
  document.querySelectorAll('.appointment-content').forEach(content => {
    content.style.lineHeight = height + 'px';
    // Cerca il <p><strong>...</strong></p> del servizio
    const serviceTag = content.querySelector('p > strong');
    if (serviceTag && serviceTag.parentElement.tagName === 'P') {
      serviceTag.parentElement.style.display = (height < 40) ? 'none' : '';
    }
  });

  if (typeof updateCurrentTimeIndicator === 'function') updateCurrentTimeIndicator();

// Scala SOLO la dimensione delle icone, NON il bottone intero (cos√¨ il tooltip resta grande)
const baseIconSize = 20; // px, dimensione icona a quarter 60
const minIconSize = 6;
const minMySpia = 12;     // grandezza minima my-spia
const minNoShow = 10;     // grandezza minima no-show

const maxIconSize = 20; // grandezza massima icone

const iconSizeMySpia = Math.max(
  minMySpia,
  Math.min(maxIconSize, Math.round(baseIconSize + (height - DEFAULT_QUARTER_HEIGHT) / 2) - 3)
);
const iconSizeNoShow = Math.max(
  minNoShow,
  Math.min(maxIconSize, Math.round(baseIconSize + (height - DEFAULT_QUARTER_HEIGHT) / 2) - 3)
);

const dragHandleHeight = Math.max(10, Math.round(height * 0.2)); // 20% dell'altezza del quarter, minimo 10px
// Calcola la posizione top per my-spia: drag-handle + 1px (default), meno 1px ogni 10px sopra il default
let spiaTop = dragHandleHeight + 1;
if (height > DEFAULT_QUARTER_HEIGHT) {
  spiaTop = Math.max(2, dragHandleHeight + 1 - Math.floor((height - DEFAULT_QUARTER_HEIGHT) / 10));
}

// Calcola la distanza verticale tra my-spia e no-show (uguale a dragHandleHeight)
const noShowTop = iconSizeMySpia + dragHandleHeight + 2;

document.querySelectorAll('.appointment-block .my-spia').forEach(el => {
  const block = el.closest('.appointment-block');
  let spiaTopValue;
  if (
    height === 30 &&
    block &&
    Math.abs(block.offsetHeight - height) < 2
  ) {
    spiaTopValue = 2;
  } else if (
    height === 35 &&
    block &&
    Math.abs(block.offsetHeight - height) < 2
  ) {
    spiaTopValue = 5;
  } else {
    spiaTopValue = spiaTop;
  }
  el.style.top = spiaTopValue + 'px';
  el.style.right = '9px';
  el.style.left = 'auto';
  el.style.width = iconSizeMySpia + 'px';
  el.style.height = iconSizeMySpia + 'px';
  el.style.transform = '';
  el.style.transformOrigin = 'center center';

  // Calcola la posizione di no-show: 1px sotto my-spia nei due casi speciali
  const noShowBtn = el.closest('.appointment-block').querySelector('.btn-popup.no-show-button');
  if (noShowBtn) {
    if (
      (height === 30 || height === 35) &&
      block &&
      Math.abs(block.offsetHeight - height) < 2
    ) {
      noShowBtn.style.top = (spiaTopValue + iconSizeMySpia + 1) + 'px';
    } else {
      noShowBtn.style.top = (iconSizeMySpia + dragHandleHeight + 2) + 'px';
    }
    noShowBtn.style.right = '9px';
    noShowBtn.style.left = 'auto';
    noShowBtn.style.bottom = '';
    noShowBtn.style.width = iconSizeNoShow + 'px';
    noShowBtn.style.height = iconSizeNoShow + 'px';
    noShowBtn.style.transform = '';
    noShowBtn.style.transformOrigin = 'center center';
    const icon = noShowBtn.querySelector('i');
    if (icon) icon.style.fontSize = iconSizeNoShow + 'px';
  }
});

document.querySelectorAll('.appointment-block .btn-popup.delete-appointment-block').forEach(el => {
  el.style.width = iconSizeMySpia + 'px';
  el.style.height = iconSizeMySpia + 'px';
  const icon = el.querySelector('i');
  if (icon) icon.style.fontSize = iconSizeMySpia + 'px';
});

    // MOSTRA/NASCONDI la linea oraria solo se quarter == default
    const indicator = document.getElementById("currentTimeIndicator");
  if (indicator) {
    if (height !== DEFAULT_QUARTER_HEIGHT) {
      indicator.style.display = 'none';
    } else {
      indicator.style.display = 'block';
      if (typeof updateCurrentTimeIndicator === 'function') {
        updateCurrentTimeIndicator();
      }
    }
  }
}

function changeQuarterHeight(delta) {
    let height = parseInt(localStorage.getItem('quarterHeight') || DEFAULT_QUARTER_HEIGHT, 10);
    height = Math.max(MIN_QUARTER_HEIGHT, Math.min(MAX_QUARTER_HEIGHT, height + delta));
    localStorage.setItem('quarterHeight', height);
    applyQuarterHeight(height);
}
window.changeQuarterHeight = changeQuarterHeight;

  document.addEventListener('DOMContentLoaded', function() {
    // Applica SEMPRE il valore di default all'avvio
    localStorage.setItem('quarterHeight', DEFAULT_QUARTER_HEIGHT);
    applyQuarterHeight(DEFAULT_QUARTER_HEIGHT);
  });

  document.addEventListener('DOMContentLoaded', function() {
  // Nascondi i popup-buttons quando il mouse √® sopra my-spia
  document.querySelectorAll('.appointment-block .my-spia').forEach(spia => {
    spia.addEventListener('mouseenter', function() {
      const popupBtns = this.closest('.appointment-block').querySelector('.popup-buttons');
      if (popupBtns) popupBtns.style.display = 'none';
    });
    spia.addEventListener('mouseleave', function() {
      const popupBtns = this.closest('.appointment-block').querySelector('.popup-buttons');
      if (popupBtns) popupBtns.style.display = '';
    });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const popup = document.getElementById('clientInfoPopup');
  if (!popup) return;

  // Helper: costruisce e mostra il tooltip piccolo a partire da un .appointment-block
  function showClientInfoForBlock(block) {
    if (!block) return;
    // Estrai valori dal blocco o dal link interno (fallback)
    const link = block.querySelector('.client-info-link');
    const nome = (link && link.getAttribute('data-client-nome')) || block.getAttribute('data-client-nome') || '';
    const cognome = (link && link.getAttribute('data-client-cognome')) || block.getAttribute('data-client-cognome') || '';
    const cellulare = (link && link.getAttribute('data-client-cellulare')) || block.getAttribute('data-client-cellulare') || '';
    const servizio = (link && link.getAttribute('data-service-full_name')) || block.getAttribute('data-service-name') || '';

    // Mostra ENTRAMBE le note separatamente:
    // - NOTA CLIENTE (dal link o dal block): subito sotto il nome
    // - NOTA APPUNTAMENTO (data-note del block): pi√π in fondo
    const notaCliente = (link && link.getAttribute('data-client-note')) || block.getAttribute('data-client-note') || '';
    const notaApp = block.getAttribute('data-note') || '';

    // Decodifica HTML entities (es. &#39; -> ')
    const decodeHtml = (s) => { const t = document.createElement('textarea'); t.innerHTML = String(s || ''); return t.value; };
    const nomeD = decodeHtml(nome);
    const cognomeD = decodeHtml(cognome);
    const servizioD = decodeHtml(servizio);
    const notaClienteD = decodeHtml(notaCliente);
    const notaAppD = decodeHtml(notaApp);

    const createdAt = block.getAttribute('data-created-at') || '';
    const lastEdit = block.getAttribute('data-last-edit') || '';
    let createdAtStr = '', lastEditStr = '';

    function parseToLocal(iso) {
      if (!iso) return null;
      // Se manca il fuso (+ / Z) aggiungi 'Z' per interpretarlo come UTC
      const needsZ = !/[zZ]|[+\-]\d{2}:?\d{2}$/.test(iso);
      try {
        return new Date(needsZ ? (iso + 'Z') : iso);
      } catch(_) {
        return null;
      }
    }

    let dCreated = parseToLocal(createdAt);
    let dLast = parseToLocal(lastEdit);

    // Safety: se last_edit risulta prima di created_at, spostalo a created_at + 1 minuto (solo visualizzazione)
    if (dCreated && dLast && dLast < dCreated) {
      dLast = new Date(dCreated.getTime() + 60000);
    }

    if (dCreated) {
      createdAtStr = dCreated.toLocaleString('it-IT', {
        hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit', year:'numeric'
      });
    }

    if (dLast) {
      lastEditStr = dLast.toLocaleString('it-IT', {
        hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit', year:'numeric'
      });
    }

    // Ricostruisci contenuto DOM in modo sicuro
    popup.innerHTML = '';

    // Meta
    const meta = document.createElement('div');
    meta.style.cssText = "font-size:10px; color:#fff; margin-bottom:3px; text-transform:uppercase;";
    meta.textContent = 'creato: ' + (createdAtStr || '');
    if (lastEditStr) {
      const br = document.createElement('br'); meta.appendChild(br);
      meta.appendChild(document.createTextNode('last edit: ' + lastEditStr));
    }
    popup.appendChild(meta);

    // Nome
    const strong = document.createElement('strong');
    strong.className = 'all-uppercase';
    strong.style.color = '#fff';
    strong.textContent = `${nomeD} ${cognomeD}`.trim();
    popup.appendChild(strong);

    // NOTA CLIENTE (subito sotto il nome)
    if (notaClienteD) {
      const ncLabel = document.createElement('div');
      ncLabel.style.cssText = "margin-top:4px; color:#ccc; font-size:11px; text-transform:uppercase;";
      ncLabel.textContent = 'NOTA CLIENTE';
      popup.appendChild(ncLabel);

      const nc = document.createElement('div');
      // Aggiunto margin auto per centrare il blocco che ha max-width
      nc.style.cssText = "margin-top:1px; color:#ffff99; max-width:260px; word-break:break-word; margin-left:auto; margin-right:auto;";
      nc.textContent = notaClienteD;
      popup.appendChild(nc);
    }

    // Servizio
    const serv = document.createElement('div');
    serv.className = 'all-uppercase';
    serv.style.color = '#ffa5c6';
    serv.style.marginTop = '6px';
    serv.textContent = servizioD || '';
    popup.appendChild(serv);

    // Cellulare
    const cellSpan = document.createElement('div');
    cellSpan.style.color = '#fff';
    const h5 = document.createElement('h5');
    h5.style.margin = '6px 0 0 0';
    h5.textContent = cellulare || '';
    cellSpan.appendChild(h5);
    popup.appendChild(cellSpan);

    // NOTA APPUNTAMENTO (pi√π in fondo)
    if (notaAppD) {
      const naLabel = document.createElement('div');
      naLabel.style.cssText = "margin-top:8px; color:#ccc; font-size:11px; text-transform:uppercase;";
      naLabel.textContent = 'NOTA APPUNTAMENTO';
      popup.appendChild(naLabel);

      const na = document.createElement('div');
      na.style.cssText = "margin-top:1px; color:#ffff99; max-width:260px; word-break:break-word; margin-left:auto; margin-right:auto;";
      na.textContent = notaAppD;
      popup.appendChild(na);
    }

    // Posizionamento
    const rect = block.getBoundingClientRect();
    const scrollY = window.scrollY || window.pageYOffset;
    const scrollX = window.scrollX || window.pageXOffset;

    if (popup.parentNode !== document.body) {
      document.body.appendChild(popup);
    }

    popup.style.position = 'absolute';
    popup.style.zIndex = '11500';
    popup.style.width = 'auto';
    popup.style.maxWidth = '320px';
    popup.style.minWidth = '180px';
    popup.style.display = 'block';

    const pw = popup.offsetWidth || 220;
    const ph = popup.offsetHeight || 140;

    let left = rect.right + scrollX + 2;
    if (left + pw > document.documentElement.clientWidth + scrollX) {
      left = rect.left + scrollX - pw - 2;
      if (left < 1) left = 1;
    }

    let top = rect.top + scrollY - 10;
    if (top + ph > document.documentElement.clientHeight + scrollY) {
      top = Math.max(1, document.documentElement.clientHeight + scrollY - ph - 1);
    }
    if (top < 1) top = 1;

    popup.style.left = Math.round(left) + 'px';
    popup.style.top = Math.round(top) + 'px';
    popup.style.display = 'block';
  }

  // BIND desktop: mouseenter/mouseleave solo se NON siamo in touch-ui
  const IS_TOUCH_UI = (() => { try { return localStorage.getItem('sun_touch_ui') === '1'; } catch(_) { return false; } })();
  if (!IS_TOUCH_UI) {
    document.querySelectorAll('.client-info-link').forEach(link => {
      link.addEventListener('mouseenter', function() {
        const apptBlock = this.closest('.appointment-block');
        if (!apptBlock) return;
        showClientInfoForBlock(apptBlock);
      });
      link.addEventListener('mouseleave', function() {
        popup.style.display = 'none';
      });
    });
  } else {
    popup.style.display = 'none';
  }

  window.showClientInfoForBlock = showClientInfoForBlock;

  window.onAppointmentNoteSaved = function (appointmentId, noteText) {
    try {
      const id = String(appointmentId || '').trim();
      const block = document.querySelector(`.appointment-block[data-appointment-id="${id}"]`);
      if (!block) return;

      // Aggiorna attributo nota appuntamento
      block.dataset.note = noteText || '';
      block.setAttribute('data-note', noteText || '');

      const noteInd = block.querySelector('.note-indicator');
      if (noteInd) noteInd.style.display = (noteText && noteText.trim().length) ? 'block' : 'none';

      const small = document.getElementById('clientInfoPopup');
      const isVisible = small && small.style.display && small.style.display !== 'none';
      if (isVisible || block.classList.contains('active-popup')) {
        try { showClientInfoForBlock(block); } catch (_) {}
      }
    } catch (_) {}
  };

  document.addEventListener('click', function (e) {
    const trg = e.target.closest('.btn-popup.nota, .note-indicator');
    if (!trg) return;
    const blk = trg.closest('.appointment-block');
    if (blk) window._lastNoteApptId = blk.getAttribute('data-appointment-id');
  }, true);

  const saveBtn = document.getElementById('saveNoteBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', function () {
      const id = window._lastNoteApptId;
      if (!id) return;
      const blk = document.querySelector(`.appointment-block[data-appointment-id="${id}"]`);
      if (!blk) return;
      const isStatus2 = String(blk.getAttribute('data-status')) === '2';
      if (!isStatus2) return;

      const noteText = document.getElementById('apptNote')?.value || '';
      setTimeout(() => {
        try { window.onAppointmentNoteSaved(id, noteText); } catch (_) {}
      }, 150);
    });
  }

  const noteModal = document.getElementById('EditApptNoteModal');
  if (noteModal) {
    noteModal.addEventListener('hidden.bs.modal', function () {
      try {
        const id = window._lastNoteApptId;
        if (!id) return;
        const blk = document.querySelector(`.appointment-block[data-appointment-id="${id}"]`);
        if (blk && String(blk.getAttribute('data-status')) === '2') {
          location.reload();
        }
      } catch (_) {}
    });
  }
});
</script>
   <script>
                          function getDefaultQuarterHeight() {
                            return 60;
                          }
                          function updateQuarterResetTooltip() {
                            var icon = document.getElementById('quarterResetIcon');
                            var current = parseInt(localStorage.getItem('quarterHeight') || getDefaultQuarterHeight(), 10);
                            var def = getDefaultQuarterHeight();
                            if (icon._tooltip) {
                              icon._tooltip.dispose();
                              icon._tooltip = null;
                            }
                            icon.style.opacity = '1';
                            icon.style.pointerEvents = 'auto';
                            icon.onclick = function() {
                              localStorage.setItem('quarterHeight', getDefaultQuarterHeight());
                              location.reload();
                            };
                            setTimeout(function() {
                              icon._tooltip = new bootstrap.Tooltip(icon, {
                                offset: [0, -15]
                              });
                            }, 0);
                          }
                          document.addEventListener('DOMContentLoaded', function () {
                            updateQuarterResetTooltip();
                          });
                      </script>
<script>
  function groupAppointmentsByDate(appointments) {
    const now = new Date();
    const weekAgo = new Date(now);
    weekAgo.setDate(now.getDate() - 7);
    const monthAgo = new Date(now);
    monthAgo.setMonth(now.getMonth() - 1);
    const sixMonthsAgo = new Date(now);
    sixMonthsAgo.setMonth(now.getMonth() - 6);

    const groups = {
        'ULTIMA SETTIMANA': [],
        'ULTIMO MESE': [],
        'ULTIMI 6 MESI': [],
        'MENO RECENTI': []
    };

    appointments.forEach(app => {
        const appDate = new Date(app.date); // Assicurati che app.date sia in formato ISO
        if (appDate >= weekAgo) {
            groups['ULTIMA SETTIMANA'].push(app);
        } else if (appDate >= monthAgo) {
            groups['ULTIMO MESE'].push(app);
        } else if (appDate >= sixMonthsAgo) {
            groups['ULTIMI 6 MESI'].push(app);
        } else {
            groups['MENO RECENTI'].push(app);
        }
    });

    return groups;
}

function showClientHistoryPopup(item, popup, position = {}) {
  if (!item || !popup) return;
  const clientId = item.dataset.clientId;
  if (!clientId) return;

// Posizionamento preciso rispetto all'item (viewport coords, no vw)
const placePopup = () => {
  // mostra per misurare
  popup.style.display = 'block';
  popup.style.position = 'fixed';
  popup.style.zIndex = '999999';
  popup.style.right = ''; // reset per evitare conflitti
  const rect = item.getBoundingClientRect();
  const gap = 1;

  // calcola width/height reali
  const pw = popup.offsetWidth || 320;
  const ph = popup.offsetHeight || 200;

  let top = Math.max(1, rect.top);

  // POSIZIONA SEMPRE A SINISTRA DELL'ITEM
  let left = Math.max(1, rect.left - pw - gap);

  // clamp verticale se esce in basso
  if (top + ph > window.innerHeight - 1) {
    top = Math.max(1, window.innerHeight - ph - 1);
  }

  popup.style.top = top + 'px';
  popup.style.left = left + 'px';
};

  popup.textContent = 'Caricamento dati...';
  popup.style.maxWidth = '360px';
  popup.style.minWidth = '220px';
  placePopup(); // posiziona subito (stato "Caricamento...")

  function escapeHtml(str) {
    return String(str || '').replace(/[&<>"'`]/g, ch =>
      ch === '&' ? '&amp;' :
      ch === '<' ? '&lt;' :
      ch === '>' ? '&gt;' :
      ch === '"' ? '&quot;' :
      ch === "'" ? '&#39;' : '&#96;'
    );
  }

  // Fetch anagrafica cliente
  fetch(`/settings/api/client_info/${clientId}`)
    .then(r => r.ok ? r.json() : Promise.reject('client_info failed'))
    .then(cliente => {
      // costruiamo DOM in modo sicuro
      const container = document.createElement('div');
      container.classList.add('client-info-container');

      const closeBtn = document.createElement('button');
      closeBtn.type = 'button';
      closeBtn.className = 'btn-close';
      closeBtn.id = 'closeClientHistoryPopupBtn';
      closeBtn.setAttribute('aria-label', 'Chiudi');
      closeBtn.style.position = 'absolute';
      closeBtn.style.top = '10px';
      closeBtn.style.right = '10px';
      closeBtn.style.zIndex = '10001';
      container.appendChild(closeBtn);

      const h2 = document.createElement('h2');
      h2.style.fontSize = '1.5em';
      h2.style.marginBottom = '6px';
      h2.textContent = `${escapeHtml(cliente.cliente_nome || '')} ${escapeHtml(cliente.cliente_cognome || '')}`;
      container.appendChild(h2);

      // Telefono
      const phoneDiv = document.createElement('div');
      phoneDiv.style.display = 'flex';
      phoneDiv.style.gap = '6px';
     // LABEL CELL:
      const cellLabel = document.createElement('span');
      cellLabel.className = 'ci-label';
      cellLabel.textContent = 'CELL:';
      cellLabel.style.fontWeight = '600';
      cellLabel.style.alignSelf = 'center';
      cellLabel.style.marginRight = '4px';
      phoneDiv.appendChild(cellLabel);
      const phoneInput = document.createElement('input');
      phoneInput.type = 'text';
      phoneInput.id = 'clientPhoneInput';
      phoneInput.value = cliente.cliente_cellulare || '';
      phoneInput.style.width = '180px';
      phoneInput.style.padding = '3px 8px';
      phoneInput.autocomplete = 'off';
      phoneInput.addEventListener('click', () => { popupHover = true; });
      const savePhoneBtn = document.createElement('button');
      savePhoneBtn.id = 'savePhoneBtn';
      savePhoneBtn.textContent = 'Salva';
      phoneDiv.appendChild(phoneInput);
      phoneDiv.appendChild(savePhoneBtn);
      container.appendChild(phoneDiv);

      // Email
      const emailDiv = document.createElement('div');
      emailDiv.style.display = 'flex';
      emailDiv.style.gap = '6px';
      // LABEL E-MAIL:
      const emailLabel = document.createElement('span');
      cellLabel.className = 'ci-label';
      emailLabel.className = 'ci-label';
      emailLabel.textContent = 'E-MAIL:';
      emailLabel.style.fontWeight = '600';
      emailLabel.style.alignSelf = 'center';
      emailLabel.style.marginRight = '4px';
      emailDiv.appendChild(emailLabel);
      const emailInput = document.createElement('input');
      emailInput.type = 'email';
      emailInput.id = 'clientEmailInput';
      emailInput.value = cliente.cliente_email || '';
      emailInput.style.width = '220px';
      emailInput.style.padding = '3px 8px';
      emailInput.autocomplete = 'off';
      emailInput.addEventListener('click', () => { popupHover = true; });
      const saveEmailBtn = document.createElement('button');
      saveEmailBtn.id = 'saveEmailBtn';
      saveEmailBtn.textContent = 'Salva';
      emailDiv.appendChild(emailInput);
      emailDiv.appendChild(saveEmailBtn);
      container.appendChild(emailDiv);

      closeBtn.addEventListener('click', () => {
        popup.style.display = 'none';
        popup.style.marginLeft = '0';
      });

      savePhoneBtn.addEventListener('click', () => {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        fetch(`/settings/api/update_client_phone`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
          body: JSON.stringify({ client_id: clientId, phone: phoneInput.value })
        })
        .then(r => r.json())
        .then(data => {
          savePhoneBtn.textContent = data.success ? 'Salvato!' : 'Errore!';
          setTimeout(() => savePhoneBtn.textContent = 'Salva', 1200);
        }).catch(() => {
          savePhoneBtn.textContent = 'Errore!';
          setTimeout(() => savePhoneBtn.textContent = 'Salva', 1200);
        });
      });

      saveEmailBtn.addEventListener('click', () => {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        fetch(`/settings/api/update_client_email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken || ''
          },
          body: JSON.stringify({ client_id: clientId, email: emailInput.value })
        })
        .then(resp => {
          if (!resp.ok) return resp.text().then(t => Promise.reject({status: resp.status, body: t}));
          return resp.json();
        })
        .then(data => {
          saveEmailBtn.textContent = data.success ? 'Salvato!' : 'Errore!';
          setTimeout(() => saveEmailBtn.textContent = 'Salva', 1200);
        })
        .catch(err => {
          console.error('update_client_email error', err);
          saveEmailBtn.textContent = 'Errore!';
          setTimeout(() => saveEmailBtn.textContent = 'Salva', 1200);
        });
      });

      // Fetch storico e prossimi appuntamenti, costruzione tabella in DOM
      fetch(`/settings/api/client_history?q=${encodeURIComponent(clientId)}`)
        .then(r => r.ok ? r.json() : Promise.reject('history failed'))
        .then(storico => {
          if (Array.isArray(storico) && storico.length) {
            const title = document.createElement('b');
            title.textContent = 'Storico Appuntamenti';
            container.appendChild(document.createElement('hr'));
            container.appendChild(title);

            const groups = groupAppointmentsByDate(storico.map(row => {
              let dateStr = row.ora_inizio;
              if (dateStr && dateStr.length > 10) dateStr = dateStr.substring(0, 10);
              return { ...row, date: dateStr };
            }));

            const order = ['ULTIMA SETTIMANA', 'ULTIMO MESE', 'ULTIMI 6 MESI', 'MENO RECENTI'];
            order.forEach(label => {
              const group = groups[label];
              if (group && group.length) {
                const block = document.createElement('div');
                block.style.marginTop = '10px';
                const toggle = document.createElement('span');
                toggle.className = 'storico-toggle';
                toggle.style.cursor = 'pointer';
                toggle.style.fontWeight = 'bold';
                toggle.style.color = '#333';
                toggle.style.userSelect = 'none';
                const iconSpan = document.createElement('span');
                iconSpan.className = 'storico-toggle-icon';
                iconSpan.textContent = (label === 'ULTIMA SETTIMANA') ? '‚àí' : '+';

                // svuota e aggiungi i nodi sicuri
                toggle.textContent = '';
                toggle.appendChild(iconSpan);
                toggle.appendChild(document.createTextNode(' ' + String(label) + ' (' + String(group.length) + ' PASSAGGI)'));
                block.appendChild(toggle);

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'storico-section-content';
                tableWrapper.style.display = label === 'ULTIMA SETTIMANA' ? '' : 'none';

                const table = document.createElement('table');
                table.className = 'table table-sm table-bordered mb-0';
                table.style.fontSize = '0.93em';
                const thead = document.createElement('thead');
                // costruisci l'header in modo sicuro
                const tr = document.createElement('tr');
                ['Data','Ora','Servizio','Durata','Operatore','Prezzo'].forEach(text => {
                  const th = document.createElement('th');
                  th.textContent = text;
                  tr.appendChild(th);
                });
                thead.appendChild(tr);
                table.appendChild(thead);
                const tbody = document.createElement('tbody');

                group.forEach(row => {
                  let dataStr = '';
                  let oraStr = '';
                  if (row.ora_inizio) {
                    const match = String(row.ora_inizio).match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})/);
                    if (match) { dataStr = match[1]; oraStr = match[2]; } else { oraStr = String(row.ora_inizio); }
                  }
                  const parts = oraStr ? oraStr.split(':') : ['', ''];
                  const tr = document.createElement('tr');
                  tr.className = 'clickable-row';
                  tr.style.cursor = 'pointer';
                  tr.setAttribute('data-date', dataStr);
                  tr.setAttribute('data-hour', parts[0] || '');
                  tr.setAttribute('data-minute', parts[1] || '');
                  const tdData = document.createElement('td'); tdData.textContent = dataStr;
                  const tdOra = document.createElement('td'); tdOra.textContent = oraStr;
                  const tdServ = document.createElement('td'); tdServ.textContent = row.servizio_tag || '';
                  const tdDur = document.createElement('td'); tdDur.textContent = row.durata ? (row.durata + ' min') : '';
                  const tdOp  = document.createElement('td'); tdOp.textContent = row.operatore || '';
                  const tdCost= document.createElement('td'); tdCost.textContent = row.costo ? ('‚Ç¨' + row.costo) : '';
                  tr.append(tdData, tdOra, tdServ, tdDur, tdOp, tdCost);
                  tr.addEventListener('click', function() {
                    const d = this.getAttribute('data-date');
                    const h = this.getAttribute('data-hour');
                    const m = this.getAttribute('data-minute');
                    if (!d || !h) return;
                    try {
                      sessionStorage.setItem('scrollToHour', h);
                      sessionStorage.setItem('scrollToMinute', m || '00');
                    } catch(_) {}
                    window.location.href = `/calendar?date=${d}&ora=${h}:${m || '00'}`;
                  });
                  tbody.appendChild(tr);
                });

                table.appendChild(tbody);
                tableWrapper.appendChild(table);
                block.appendChild(tableWrapper);

                toggle.addEventListener('click', function() {
                  if (tableWrapper.style.display === 'none') {
                    tableWrapper.style.display = '';
                    toggle.querySelector('.storico-toggle-icon').textContent = '‚àí';
                  } else {
                    tableWrapper.style.display = 'none';
                    toggle.querySelector('.storico-toggle-icon').textContent = '+';
                  }
                });

                container.appendChild(block);
              }
            });
          } else {
            const noHist = document.createElement('em');
            noHist.textContent = 'Nessuna seduta nello storico';
            container.appendChild(noHist);
          }

          return fetch(`/calendar/api/next-appointments-for-client/${clientId}`);
        })
        .then(r => r.ok ? r.json() : Promise.reject('next appointments failed'))
        .then(prossimi => {
          if (Array.isArray(prossimi) && prossimi.length) {
            const title = document.createElement('b'); title.textContent = 'Prossimi appuntamenti';
            container.appendChild(document.createElement('hr'));
            container.appendChild(title);

            const table = document.createElement('table');
            table.className = 'table table-sm table-bordered mb-0';
            table.style.fontSize = '0.93em';
            const thead = document.createElement('thead');
            const tr = document.createElement('tr');
            ['Data', 'Ora', 'Servizio', 'Durata', 'Operatore', 'Prezzo'].forEach(text => {
              const th = document.createElement('th');
              th.textContent = text;
              tr.appendChild(th);
            });
            thead.appendChild(tr);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');

            prossimi.forEach(row => {
              let dataStr = ''; let oraStr = '';
              if (row.ora_inizio) {
                const match = String(row.ora_inizio).match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})/);
                if (match) { dataStr = match[1]; oraStr = match[2]; } else { oraStr = String(row.ora_inizio); }
              }
              const parts = oraStr ? oraStr.split(':') : ['', ''];
              const tr = document.createElement('tr');
              tr.className = 'clickable-row'; tr.style.cursor = 'pointer';
              tr.setAttribute('data-date', dataStr); tr.setAttribute('data-hour', parts[0] || ''); tr.setAttribute('data-minute', parts[1] || '');
              tr.append(
                (() => { const td = document.createElement('td'); td.textContent = dataStr; return td; })(),
                (() => { const td = document.createElement('td'); td.textContent = oraStr; return td; })(),
                (() => { const td = document.createElement('td'); td.textContent = row.servizio_tag || ''; return td; })(),
                (() => { const td = document.createElement('td'); td.textContent = row.durata ? (row.durata + ' min') : ''; return td; })(),
                (() => { const td = document.createElement('td'); td.textContent = row.operatore || ''; return td; })(),
                (() => { const td = document.createElement('td'); td.textContent = row.costo ? ('‚Ç¨' + row.costo) : ''; return td; })()
              );
                tr.addEventListener('click', function() {
                  const d = this.getAttribute('data-date');
                  const h = parts[0] || '';
                  const m = parts[1] || '00';
                  if (!d || !h) return;
                  try {
                    sessionStorage.setItem('scrollToHour', h);
                    sessionStorage.setItem('scrollToMinute', m);
                  } catch(_) {}
                  window.location.href = `/calendar?date=${d}&ora=${h}:${m}`;
                });
              tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            container.appendChild(table);
          } else {
            const none = document.createElement('em'); none.textContent = 'Nessuna seduta prenotata'; container.appendChild(none);
          }

          popup.innerHTML = '';
          popup.appendChild(container);

  const createModal = document.getElementById('CreateAppointmentModal');
  const editModal = document.getElementById('EditAppointmentModal');
  if (createModal && createModal.classList.contains('show')) {
    const modalContent = createModal.querySelector('.modal-content');
    if (modalContent && !modalContent.contains(popup)) {
      modalContent.appendChild(popup);
    }
  } else if (editModal && editModal.classList.contains('show')) {
    const modalContent = editModal.querySelector('.modal-content');
    if (modalContent && !modalContent.contains(popup)) {
      modalContent.appendChild(popup);
    }
  } else {
    // Se non siamo in un modal, rimetti il popup nel body
    if (popup.parentNode !== document.body) {
      document.body.appendChild(popup);
    }
  }
          placePopup(); // riposiziona ora che abbiamo la dimensione finale
        })
        .catch(err => {
          popup.textContent = '';
          const em = document.createElement('em');
          em.textContent = 'Errore caricamento dati cliente';
          popup.appendChild(em);
          console.error('showClientHistoryPopup error:', err);
        });
    })
    .catch(err => {
      popup.textContent = '';
      const em2 = document.createElement('em');
      em2.textContent = 'Errore caricamento dati cliente';
      popup.appendChild(em2);
      console.error('client_info fetch error:', err);
    });
}

document.addEventListener('DOMContentLoaded', function() {
  const popup = document.getElementById('clientHistoryPopup');
  if (!popup) return;

  popup.style.pointerEvents = 'auto';

  // Mantieni solo l'event listener per nascondere il popup alla chiusura del modal
  document.getElementById('EditAppointmentModal').addEventListener('hidden.bs.modal', function() {
    if (popup) {
      popup.style.display = 'none';
      popup.style.marginLeft = '0';
    }
  });
});
</script>
<script>
  // Applica classe al body se la modalit√† touch √® abilitata (per CSS)
  (function(){
    try {
      if (localStorage.getItem('sun_touch_ui') === '1') {
        document.addEventListener('DOMContentLoaded', function(){
          document.body.classList.add('touch-ui');
        });
      }
    } catch(e) {}
  })();
</script>
<script src="{{ url_for('static', filename='js/touch-ui.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  try {
    if (localStorage.getItem('sun_touch_ui') !== '1') return;
  } catch(_) { return; }

  const smallPopup = document.getElementById('clientInfoPopup');

  // 1) Rendi cliccabile tutto il blocco: listener delegato in cattura
document.addEventListener('click', function(e){
  const block = e.target.closest('.appointment-block');
  if (!block) return;

  // lascia lavorare i bottoni popup senza toggle del blocco
  if (e.target.closest('.btn-popup')) return;

  const clientLink = e.target.closest('.client-info-link');
  if (clientLink) {
    // SE il blocco NON √® attivo: primo click -> mostra popup + tooltip, BLOCCA il click del link (non aprire modal)
    if (!block.classList.contains('active-popup')) {
      e.preventDefault();
      e.stopImmediatePropagation();

      // chiudi altri attivi e apri questo
      document.querySelectorAll('.appointment-block.active-popup').forEach(b => b.classList.remove('active-popup'));
      if (typeof window.setActivePopupAndTooltip === 'function') {
        window.setActivePopupAndTooltip(block);
      } else {
        block.classList.add('active-popup');
      }

      // mostra tooltip piccolo anche per status 2? (adatta se necessario)
      if (!block.classList.contains('note-off') && typeof window.showClientInfoForBlock === 'function') {
        try { window.showClientInfoForBlock(block); } catch(_) {}
      }

      // flag: permetti apertura modal al prossimo click sullo stesso link (timeout per pulire)
      clientLink.dataset.allowEditOnNextClick = '1';
      setTimeout(() => { delete clientLink.dataset.allowEditOnNextClick; }, 2500);

      return;
    }

    // SE il blocco √® attivo e la flag √® presente -> √® il secondo click: permetti il comportamento originale (NON bloccare)
    if (clientLink.dataset.allowEditOnNextClick === '1') {
      // rimuovi la flag e lascia proseguire (non fare preventDefault/stopImmediatePropagation)
      delete clientLink.dataset.allowEditOnNextClick;
      return;
    }

    // Altri casi (toggle normale se necessario)
    if (block.classList.contains('active-popup')) {
      block.classList.remove('active-popup');
      const big = document.getElementById('clientHistoryPopup');
      if (big) big.style.display = 'none';
      if (smallPopup) smallPopup.style.display = 'none';
    } else {
      document.querySelectorAll('.appointment-block.active-popup').forEach(b => b.classList.remove('active-popup'));
      if (typeof window.setActivePopupAndTooltip === 'function') {
        window.setActivePopupAndTooltip(block);
      } else {
        block.classList.add('active-popup');
      }
      if (!block.classList.contains('note-off') && typeof window.showClientInfoForBlock === 'function') {
        try { window.showClientInfoForBlock(block); } catch(_) {}
      }
    }

    return;
  }

  // Click in QUALSIASI altra zona del blocco ‚Üí comportamento touch standard
  e.preventDefault();
  e.stopImmediatePropagation();
  if (block.classList.contains('active-popup')) {
    block.classList.remove('active-popup');
    const big = document.getElementById('clientHistoryPopup');
    if (big) big.style.display = 'none';
    if (smallPopup) smallPopup.style.display = 'none';
  } else {
    document.querySelectorAll('.appointment-block.active-popup').forEach(b => b.classList.remove('active-popup'));
    if (typeof window.setActivePopupAndTooltip === 'function') {
      window.setActivePopupAndTooltip(block);
    } else {
      block.classList.add('active-popup');
    }
    if (!block.classList.contains('note-off') && typeof window.showClientInfoForBlock === 'function') {
      try { window.showClientInfoForBlock(block); } catch(_) {}
    }
  }
}, true);

  // 2) Rimuovi eventuali onclick inline dal link cliente SOLO in touch-ui
  document.querySelectorAll('.client-info-link[onclick]').forEach(a => a.removeAttribute('onclick'));
});
</script>
<script>
let lastScrollTop = 0;
let lastScrollLeft = 0;

document.addEventListener('DOMContentLoaded', function() {
  // 1) Flag mobile basato su media query (vivo anche su resize) ‚Äî vale SEMPRE (default e touch)
  function setMobileFlag() {
    const isMobile = window.matchMedia('(max-width: 1199.98px)').matches;
    window.__MOBILE_MODAL_ENABLED = !!isMobile;
    try {
      if (isMobile) localStorage.setItem('sun_mobile_modal', '1');
      else localStorage.removeItem('sun_mobile_modal');
    } catch (_) {}
  }
  setMobileFlag();
  window.addEventListener('resize', setMobileFlag, { passive: true });

  // 2) Utilit√† per box info in alto al modal
  function ensureMobileInfoContainer(modal) {
    let info = modal.querySelector('#mobile-appt-info');
    if (!info) {
      const body = modal.querySelector('.modal-body') || modal;
      info = document.createElement('div');
      info.id = 'mobile-appt-info';
      info.className = 'mobile-appt-info';
      info.setAttribute('aria-live', 'polite');
      body.insertBefore(info, body.firstChild);
    }
    return info;
  }
  function val(v) { const s = (v || '').toString().trim(); return s ? s : '-'; }
  function makeInfoRow(labelText, valueText) {
    const row = document.createElement('div');
    row.className = 'info-row';
    const label = document.createElement('span'); label.className = 'info-label'; label.textContent = labelText;
    const value = document.createElement('span'); value.className = 'info-value'; value.textContent = valueText;
    row.append(label, value); return row;
  }
  function fillMobileApptInfo(modal, block) {
    if (!modal || !block) return;
    const link = block.querySelector('.client-info-link');

    const nome = (link && link.getAttribute('data-client-nome')) || block.getAttribute('data-client-nome') || '';
    const cognome = (link && link.getAttribute('data-client-cognome')) || block.getAttribute('data-client-cognome') || '';
    const fullName = [nome, cognome].filter(Boolean).join(' ').trim();

    const cell = (link && link.getAttribute('data-client-cellulare')) || block.getAttribute('data-client-cellulare') || '';
    const notaCliente = (link && link.getAttribute('data-client-note')) || block.getAttribute('data-client-note') || '';

    const servizio =
      (link && link.getAttribute('data-service-full_name')) ||
      block.getAttribute('data-service_full_name') ||
      block.getAttribute('data-service_full_name') ||
      block.getAttribute('data-service-name') ||
      block.getAttribute('data-service-tag') ||
      '';

    const notaApp = block.getAttribute('data-note') || '';

    const infoBox = ensureMobileInfoContainer(modal);
    while (infoBox.firstChild) infoBox.removeChild(infoBox.firstChild);

    infoBox.appendChild(makeInfoRow('NOME CLIENTE:', val(fullName)));
    infoBox.appendChild(makeInfoRow('CELLULARE:', val(cell)));
    infoBox.appendChild(makeInfoRow('NOTA CLIENTE:', val(notaCliente)));
    infoBox.appendChild(makeInfoRow('SERVIZIO:', val(servizio)));
    infoBox.appendChild(makeInfoRow('NOTA APP:', val(notaApp)));
  }

  // 3) FILTRO PULSANTI MODAL <1200px
function configureMobileModalButtons(modal, block) {
  if (!modal || !block) return;

  const isMobile = window.matchMedia('(max-width: 1199.98px)').matches;
  if (!isMobile || modal.id !== 'MobilePopupButtonsModal') return;

  const table = modal.querySelector('table');
  if (!table) return;

  if (!table.dataset.originalHtml) {
    table.dataset.originalHtml = table.innerHTML;
  }

  function getProtoFromOriginal(act) {
    const tpl = document.createElement('template');
    tpl.innerHTML = table.dataset.originalHtml;
    const root = tpl.content || tpl;
    return root.querySelector(`.mobile-popup-btn[data-action="${act}"]`);
  }

  const status = block.getAttribute('data-status');
  const isPaid = status === '2';
  const isOff = block.classList.contains('note-off') || block.classList.contains('off');

  if (isPaid) {
    const protoNote = getProtoFromOriginal('note');
    const protoCopia = getProtoFromOriginal('copia');

    let btnNote = protoNote ? protoNote.cloneNode(true) : document.createElement('button');
    btnNote.classList.add('btn','mobile-popup-btn');
    btnNote.setAttribute('data-action','note');
    btnNote.style.display = '';
    btnNote.textContent = 'NOTE';

    let btnCopia = protoCopia ? protoCopia.cloneNode(true) : document.createElement('button');
    btnCopia.classList.add('btn','mobile-popup-btn');
    btnCopia.setAttribute('data-action','copia');
    btnCopia.style.display = '';
    btnCopia.textContent = 'COPIA';

    table.innerHTML = '';
    const tr = document.createElement('tr');
    const td1 = document.createElement('td');
    td1.style.width = '50%'; td1.style.padding = '4px';
    td1.appendChild(btnNote);
    const td2 = document.createElement('td');
    td2.style.width = '50%'; td2.style.padding = '4px';
    td2.appendChild(btnCopia);
    tr.appendChild(td1);
    tr.appendChild(td2);
    table.appendChild(tr);
    return;
  }

  if (!isOff) {
    if (table.dataset.originalHtml) {
      table.innerHTML = table.dataset.originalHtml;
    }
    return;
  }

  const proto = {
    elimina:  getProtoFromOriginal('elimina'),
    sposta:   getProtoFromOriginal('sposta'),
    cliente:  getProtoFromOriginal('cliente'),
    note:     getProtoFromOriginal('note'),
    allunga:  getProtoFromOriginal('allunga'),
    accorcia: getProtoFromOriginal('accorcia')
  };

  const acts = ['elimina', 'note', 'allunga', 'accorcia'];

  const clones = acts.map(act => {
    const src = proto[act];
    const c = src ? src.cloneNode(true) : document.createElement('button');
    c.classList.add('btn','mobile-popup-btn');
    c.style.display = '';
    if (act === 'note') {
      c.textContent = 'TITOLO';
      c.setAttribute('data-action','note');
    } else {
      c.setAttribute('data-action', act);
      if (!src) c.textContent = act.toUpperCase();
    }
    return c;
  });

  table.innerHTML = '';
  for (let i = 0; i < clones.length; i += 2) {
    const tr = document.createElement('tr');

    const td1 = document.createElement('td');
    td1.style.width = '50%';
    td1.style.padding = '4px';
    td1.appendChild(clones[i]);
    tr.appendChild(td1);

    if (i + 1 < clones.length) {
      const td2 = document.createElement('td');
      td2.style.width = '50%';
      td2.style.padding = '4px';
      td2.appendChild(clones[i + 1]);
      tr.appendChild(td2);
    } else {
      td1.colSpan = 2;
    }
    table.appendChild(tr);
  }
}

  // 4) Evita doppio binding
  if (document._mobileModalHandlersBound) return;
  document._mobileModalHandlersBound = true;

  // 5) Disabilita link cliente su mobile
  function disableClientLinksOnMobile() {
    if (!window.__MOBILE_MODAL_ENABLED) return;
    document.querySelectorAll('.appointment-block .client-info-link[onclick]').forEach(a => a.removeAttribute('onclick'));
    document.querySelectorAll('.appointment-block .client-info-link').forEach(a => {
      if (a._mobileBlocked) return;
      a.addEventListener('click', function(e) { e.preventDefault(); e.stopPropagation(); }, true);
      a._mobileBlocked = true;
    });
  }
  disableClientLinksOnMobile();

  // 6) Salva scroll prima di aprire il modal (solo mobile)
  document.addEventListener('click', function(e) {
    if (!window.__MOBILE_MODAL_ENABLED) return;
    if (e.target.closest('#MobilePopupButtonsModal')) return;
    const block = e.target.closest('.appointment-block');
    if (!block) return;
    lastScrollTop = window.scrollY || document.documentElement.scrollTop;
    lastScrollLeft = window.scrollX || document.documentElement.scrollLeft;
  }, true);

  let suppressNextClickTs = 0;

  function restoreScrollAfterModal(modal) {
    const baseY = parseInt(modal.dataset.scrollTopBefore || String(lastScrollTop || 0), 10) || 0;
    const baseX = parseInt(modal.dataset.scrollLeftBefore || String(lastScrollLeft || 0), 10) || 0;
    const apptId = modal.dataset.appointmentId || '';
    const ratio = parseFloat(modal.dataset.blockOffsetRatio || '0');
    const absTopStored = parseFloat(modal.dataset.blockAbsTop || '0');
    window.scrollTo(baseX, baseY);
    requestAnimationFrame(() => {
      const block = apptId ? document.querySelector(`.appointment-block[data-appointment-id="${apptId}"]`) : null;
      if (!block) return;
      const vh = window.innerHeight || 1;
      let rect = block.getBoundingClientRect();
      const targetViewportTop = ratio * vh;
      let delta = rect.top - targetViewportTop;
      window.scrollTo(window.scrollX, window.scrollY + delta);
      requestAnimationFrame(() => {
        rect = block.getBoundingClientRect();
        delta = rect.top - targetViewportTop;
        if (Math.abs(delta) > 2) {
          window.scrollTo(window.scrollX, window.scrollY + delta);
        } else {
          const diffAbs = Math.abs((rect.top + window.scrollY) - absTopStored);
          if (diffAbs > 60) {
            window.scrollTo(window.scrollX, Math.max(0, absTopStored - 60));
          }
        }
        requestAnimationFrame(() => {
          rect = block.getBoundingClientRect();
          delta = rect.top - targetViewportTop;
          if (Math.abs(delta) > 2) {
            window.scrollTo(window.scrollX, window.scrollY + delta);
          }
        });
      });
    });
  }

  // 7) Apertura modal su pointerdown (mobile)
  document.addEventListener('pointerdown', function(e) {
    if (!window.__MOBILE_MODAL_ENABLED) return;
    if (e.target.closest('#MobilePopupButtonsModal')) return;
    const block = e.target.closest('.appointment-block');
    if (!block) return;
    if (e.target.closest('.btn-popup')) return;

    e.preventDefault();
    e.stopImmediatePropagation();

    const modal = document.getElementById('MobilePopupButtonsModal');
    if (!modal) return;
    const rect = block.getBoundingClientRect();
    modal.dataset.appointmentId = block.getAttribute('data-appointment-id') || '';
    modal.dataset.scrollTopBefore = String(window.scrollY || document.documentElement.scrollTop || 0);
    modal.dataset.scrollLeftBefore = String(window.scrollX || document.documentElement.scrollLeft || 0);
    modal.dataset.blockOffsetRatio = (rect.top / (window.innerHeight || rect.height || 1)).toFixed(6);
    modal.dataset.blockAbsTop = String(rect.top + window.scrollY);
    fillMobileApptInfo(modal, block);
    configureMobileModalButtons(modal, block);
    const bsModal = new bootstrap.Modal(modal, { focus: false });
    bsModal.show();
    suppressNextClickTs = Date.now();
    function onHidden() {
      restoreScrollAfterModal(modal);
      modal.removeEventListener('hidden.bs.modal', onHidden);
    }
    modal.addEventListener('hidden.bs.modal', onHidden);
  }, true);

  // 8) Fallback su click (mobile)
  document.addEventListener('click', function(e) {
    if (!window.__MOBILE_MODAL_ENABLED) return;
    if (e.target.closest('#MobilePopupButtonsModal')) return;

    if (Date.now() - suppressNextClickTs < 400) {
      e.preventDefault();
      e.stopImmediatePropagation();
      return;
    }

    const block = e.target.closest('.appointment-block');
    if (!block) return;
    if (e.target.closest('.btn-popup')) return;

    e.preventDefault();
    e.stopImmediatePropagation();

    const modal = document.getElementById('MobilePopupButtonsModal');
    if (!modal) return;
    const rect = block.getBoundingClientRect();
    modal.dataset.appointmentId = block.getAttribute('data-appointment-id') || '';
    modal.dataset.blockOffsetRatio = (rect.top / (window.innerHeight || rect.height || 1)).toFixed(6);
    modal.dataset.blockAbsTop = String(rect.top + window.scrollY);

    // Popola info + FILTRO pulsanti
    fillMobileApptInfo(modal, block);
    configureMobileModalButtons(modal, block);
    const bsModal = new bootstrap.Modal(modal, { focus: false });
    bsModal.show();
    function onHiddenOnce() {
      restoreScrollAfterModal(modal);
      modal.removeEventListener('hidden.bs.modal', onHiddenOnce);
    }
    modal.addEventListener('hidden.bs.modal', onHiddenOnce);
  }, true);

  // 9) Garantisce info + filtro anche su evento show Bootstrap
  document.addEventListener('show.bs.modal', function(e) {
    if (!window.__MOBILE_MODAL_ENABLED) return;
    const modal = e.target;
    if (modal && modal.id === 'MobilePopupButtonsModal') {
      const apptId = modal.dataset.appointmentId || '';
      const block = apptId ? document.querySelector('.appointment-block[data-appointment-id="' + apptId + '"]') : null;
      if (block) {
        fillMobileApptInfo(modal, block);
        configureMobileModalButtons(modal, block);
      }
    }
  });

  // 10) Click dei pulsanti nel modal (aggiunta azione COPIA)
  (function bindModalButtons() {
    const modal = document.getElementById('MobilePopupButtonsModal');
    if (!modal || modal._buttonsBound) return;
    modal._buttonsBound = true;

    modal.addEventListener('click', function(e) {
      const btn = e.target.closest('.mobile-popup-btn');
      if (!btn) return;

      e.stopPropagation();

      const action = btn.getAttribute('data-action');
      const apptId = modal.dataset.appointmentId || '';
      const block = apptId ? document.querySelector('.appointment-block[data-appointment-id="' + apptId + '"]') : null;
      if (!block) return;

      const inst = bootstrap.Modal.getInstance(modal);
      if (inst) inst.hide();

      switch (action) {
        case 'elimina':
          if (window.deleteAppointment) window.deleteAppointment(apptId);
          break;
        case 'sposta':
          (block.querySelector('.btn-popup.sposta') || { click(){} }).click();
          break;
        case 'note':
          if (window.openNoteModal) window.openNoteModal(block);
          break;
        case 'cliente':
          if (window.openModifyPopup) window.openModifyPopup(apptId);
          break;
        case 'copia': // NUOVO
          (block.querySelector('.btn-popup.copia') || { click(){} }).click();
          break;
        case 'allunga':
          setAppointmentDurationMobile(block, +((parseInt(block.getAttribute('data-duration'), 10) || 15) + 15));
          break;
        case 'accorcia':
          setAppointmentDurationMobile(block, Math.max(15, (parseInt(block.getAttribute('data-duration'), 10) || 15) - 15));
          break;
      }
    });
  })();

  // 11) Aggiorna durata appuntamento via API
  const CSRF = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  async function setAppointmentDurationMobile(block, newDuration) {
    try {
      newDuration = Math.max(15, Math.round(newDuration / 15) * 15);
      const id = block.getAttribute('data-appointment-id');
      if (!id) return;

      const res = await fetch('/calendar/edit/' + encodeURIComponent(id), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          ...(CSRF ? { 'X-CSRFToken': CSRF } : {})
        },
        credentials: 'same-origin',
        body: JSON.stringify({ duration: newDuration })
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        console.error('setAppointmentDurationMobile error', res.status, txt);
        return;
      }

      block.setAttribute('data-duration', String(newDuration));
      if (typeof window.updateAppointmentBlockStyles === 'function') {
        window.updateAppointmentBlockStyles(block);
      } else if (typeof window.getQuarterPx === 'function') {
        const q = window.getQuarterPx();
        block.style.height = (newDuration / 15) * q + 'px';
      }
    } catch (err) {
      console.error('setAppointmentDurationMobile exception', err);
    }
  }
});
</script>
<script>
(function () {
  const isSmall = () => window.matchMedia('(max-width: 1199.98px)').matches;

  // Trigger robusti, inclusa .client-info-link (nome cliente)
  const INFO_TRIGGERS = [
    '.client-info-link',
    '.btn-popup.info-client',
    '.btn-popup.client-info',
    '.btn-info-client',
    '.open-client-info',
    '[data-action="client-info"]',
    '[data-open="client-info"]',
    'button[title*="Info"]',
    'a[title*="Info"]'
  ].join(',');

  function findInfoTrigger(target) {
    const btn = target.closest(INFO_TRIGGERS);
    if (btn) return btn;
    const any = target.closest('.btn-popup, button, a');
    if (any && any.querySelector('.bi-info, .bi-info-circle')) return any;
    return null;
  }

  function showModal(el) {
    const m = new bootstrap.Modal(el, { focus: true });
    m.show();
    return m;
  }

  async function fetchJson(url) {
    const r = await fetch(url, { credentials: 'same-origin' });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  }

  // Apre e popola il modal mobile a partire da un blocco agenda
  async function openClientInfoMobileModalByBlock(block) {
    const modal = document.getElementById('ClientInfoMobileModal');
    if (!modal || !block) return;

    const clientId = block.getAttribute('data-client-id') || '';
    if (!clientId) return;
    modal.dataset.clientId = clientId;

    // Salva visuale corrente (solo mobile)
    if (isSmall()) {
      modal.dataset.scrollY = String(window.scrollY || document.documentElement.scrollTop || 0);
      modal.dataset.scrollX = String(window.scrollX || document.documentElement.scrollLeft || 0);
      // Bind cleanup/restore una sola volta
      if (!modal._ciBound) {
        modal.addEventListener('hidden.bs.modal', function () {
          // Ripulisci eventuali backdrop residui e stato body
          try {
            document.querySelectorAll('.modal-backdrop, .offcanvas-backdrop').forEach(el => el.remove());
            if (!document.querySelector('.modal.show')) {
              document.body.classList.remove('modal-open');
              document.body.style.removeProperty('overflow');
              document.body.style.removeProperty('paddingRight');
            }
          } catch (_) {}
          // Ripristina esattamente la visuale precedente
          const sy = parseInt(modal.dataset.scrollY || '0', 10) || 0;
          const sx = parseInt(modal.dataset.scrollX || '0', 10) || 0;
          requestAnimationFrame(() => window.scrollTo({ top: sy, left: sx }));
        }, true);
        modal._ciBound = true;
      }
    }

    const $ = (sel) => modal.querySelector(sel);
    const inNome  = $('#ciNome');
    const inCogn  = $('#ciCognome');
    const inCell  = $('#ciCell');
    const inEmail = $('#ciEmail');
    const nextBox = $('#ciNextAppts');
    const histBox = $('#ciHistoryAppts');

    // Prefill da data-* del blocco
    inNome.value  = block.getAttribute('data-client-nome')      || '';
    inCogn.value  = block.getAttribute('data-client-cognome')   || '';
    inCell.value  = block.getAttribute('data-client-cellulare') || '';
    inEmail.value = block.getAttribute('data-client-email')     || '';

    nextBox.textContent = 'Caricamento...';
    histBox.textContent = 'Caricamento...';

    // Dettagli cliente
    try {
      const info = await fetchJson(`/settings/api/client_info/${clientId}`);
      inNome.value  = info?.cliente_nome      ?? inNome.value;
      inCogn.value  = info?.cliente_cognome   ?? inCogn.value;
      inCell.value  = info?.cliente_cellulare ?? inCell.value;
      inEmail.value = info?.cliente_email     ?? inEmail.value;
    } catch (_) {}

    // Prossimi appuntamenti
    try {
      const next = await fetchJson(`/calendar/api/next-appointments-for-client/${clientId}`);
      nextBox.innerHTML = '';
      if (Array.isArray(next) && next.length) {
        const ul = document.createElement('ul');
        ul.className = 'ci-ul';
        next.forEach(r => {
          const li = document.createElement('li');
          const m = String(r.ora_inizio || '').match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})/);
          const d = m ? m[1] : ''; const t = m ? m[2] : '';
          li.textContent = `${d} ${t} ‚Äî ${r.servizio_tag || ''} (${r.operatore || ''})`;
          ul.appendChild(li);
        });
        nextBox.appendChild(ul);
      } else {
        nextBox.textContent = 'Nessun appuntamento futuro';
      }
    } catch (_) { nextBox.textContent = 'Errore caricamento'; }

    // Storico appuntamenti
    try {
      const hist = await fetchJson(`/settings/api/client_history?q=${encodeURIComponent(clientId)}`);
      histBox.innerHTML = '';
      if (Array.isArray(hist) && hist.length) {
        const ul = document.createElement('ul');
        ul.className = 'ci-ul';
        hist.forEach(r => {
          const li = document.createElement('li');
          const m = String(r.ora_inizio || '').match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})/);
          const d = m ? m[1] : ''; const t = m ? m[2] : '';
          li.textContent = `${d} ${t} ‚Äî ${r.servizio_tag || ''} (${r.operatore || ''})`;
          ul.appendChild(li);
        });
        histBox.appendChild(ul);
      } else {
        histBox.textContent = 'Nessuna seduta nello storico';
      }
    } catch (_) { histBox.textContent = 'Errore caricamento'; }

    // Bind dei pulsanti "Salva" (una sola volta)
    if (!modal._saveBound) {
      modal.addEventListener('click', async (e) => {
        const btn = e.target.closest('.ci-save');
        if (!btn) return;
        const field = btn.getAttribute('data-field');
        const cid = modal.dataset.clientId || '';
        if (!cid) return;

        const map = {
          nome: inNome.value,
          cognome: inCogn.value,
          cellulare: inCell.value,
          email: inEmail.value
        };
        let url = '', body = {};
        if (field === 'nome')      { url = '/settings/api/update_client_name';    body = { client_id: cid, nome: map.nome }; }
        if (field === 'cognome')   { url = '/settings/api/update_client_surname'; body = { client_id: cid, cognome: map.cognome }; }
        if (field === 'cellulare') { url = '/settings/api/update_client_phone';   body = { client_id: cid, phone: map.cellulare }; }
        if (field === 'email')     { url = '/settings/api/update_client_email';   body = { client_id: cid, email: map.email }; }
        if (!url) return;

        try {
          const CSRF = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
          const r = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...(CSRF ? { 'X-CSRFToken': CSRF } : {}) },
            credentials: 'same-origin',
            body: JSON.stringify(body)
          });
          const old = btn.textContent;
          btn.disabled = true;
          btn.textContent = r.ok ? 'Salvato!' : 'Errore!';
          setTimeout(() => { btn.textContent = old; btn.disabled = false; }, 1000);
        } catch (_) {}
      });
      modal._saveBound = true;
    }

    showModal(modal);
  }

  // Esporta globalmente (utile per override)
  window.openClientInfoMobileModal = openClientInfoMobileModalByBlock;

  // Override soft: se qualche codice chiama il modal desktop, reindirizza al mobile su schermi piccoli
  (function overrideDesktopOpener() {
    const orig = window.showClientInfoModal;
    window.showClientInfoModal = function (clientId) {
      if (isSmall()) {
        const blk = document.querySelector(`.appointment-block[data-client-id="${clientId}"]`);
        if (blk) return openClientInfoMobileModalByBlock(blk);
      }
      if (typeof orig === 'function') return orig.apply(this, arguments);
    };
  })();

  // Intercettazione dei click sulla ‚Äúi‚Äù e sul nome cliente SOLO in mobile
  function interceptClientInfo(e) {
    if (!isSmall()) return;
    const trg = findInfoTrigger(e.target);
    if (!trg) return;

    // Evita navigate su <a href="#"> e blocca il modal desktop
    e.preventDefault();
    e.stopImmediatePropagation();

    const block = trg.closest('.appointment-block');
    if (block) {
      openClientInfoMobileModalByBlock(block);
      return;
    }

    // Fallback: se siamo nel modal di modifica e abbiamo il clientId
    const cid =
      trg.getAttribute('data-client-id') ||
      document.querySelector('#EditAppointmentModal input#currentClient')?.getAttribute('data-client-id') ||
      '';
    if (cid) {
      const blk = document.querySelector(`.appointment-block[data-client-id="${cid}"]`);
      if (blk) openClientInfoMobileModalByBlock(blk);
    }
  }

  document.addEventListener('pointerdown', interceptClientInfo, true);
  document.addEventListener('click', interceptClientInfo, true);
})();
</script>
{% if hide_cassa %}
<style>
  /* Nascondi popup button ‚Ç¨ solo in wsgi */
  .appointment-block .btn-popup.pagamento,
  .appointment-block .btn-popup.cassa,
  .appointment-block [data-action="cassa"],
  .appointment-block [data-action="to-cash"],
  .appointment-block .to-cash,
  .appointment-block .go-cash,
  .popup-buttons-bottom .btn-popup.pagamento,
  .popup-buttons-bottom .btn-popup.cassa {
    display: none !important;
  }
</style>
<script>
// Inizializza contenuti della tabella mobile (calendar)
document.addEventListener('DOMContentLoaded', function() {
  try {
    const fmtSpan = document.getElementById('mobileDateFormattedCalendar');
    const dowSpan = document.getElementById('mobileDayOfWeekCalendar');
    const calBtn  = document.getElementById('mobileCalIconCalendar');
    const inDate  = document.getElementById('date'); // input gi√† presente nella nav desktop

    // formatter "06 Nov 2025"
    const mesiShort = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
    function formatDateYMD(yyyy_mm_dd) {
      const [y,m,d] = (yyyy_mm_dd || '').split('-').map(x => parseInt(x,10));
      if (!y || !m || !d) return '-- --- ----';
      const dd = String(d).padStart(2,'0');
      const M = mesiShort[m-1] || '---';
      return `${dd} ${M} ${y}`;
    }
    function formatDOW(yyyy_mm_dd) {
      const giorni = ['DOM','LUN','MAR','MER','GIO','VEN','SAB'];
      const dt = new Date(yyyy_mm_dd);
      return isNaN(dt) ? '---' : giorni[dt.getDay()];
    }

    function refreshMobileFields() {
      const v = inDate ? inDate.value : '{{ selected_date_str }}';
      if (fmtSpan) fmtSpan.textContent = formatDateYMD(v);
      if (dowSpan) dowSpan.textContent = formatDOW(v);
    }
    refreshMobileFields();

    // Se c'√® flatpickr, aggiorna live anche la tabella al cambio data
    if (inDate && inDate._flatpickr) {
      inDate._flatpickr.config.onChange.push(() => refreshMobileFields());
    } else if (inDate) {
      inDate.addEventListener('change', refreshMobileFields);
    }

    // Icona calendario: apri flatpickr dell'input desktop
    if (calBtn) {
      calBtn.addEventListener('click', function(e){
        e.preventDefault();
        if (inDate && inDate._flatpickr) inDate._flatpickr.open();
        else if (inDate) inDate.focus();
      });
    }
  } catch(_) {}
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.querySelector('.calendar-fullwidth');
  const table = container ? container.querySelector('table') : null;
  
  if (container && table) {
    let currentScale = 1;
    let startDist = 0;
    let initialScale = 1;

    container.addEventListener('touchstart', function(e) {
      if (e.touches.length === 2) {
        e.preventDefault(); // Previene zoom pagina nativo
        startDist = Math.hypot(
          e.touches[0].pageX - e.touches[1].pageX,
          e.touches[0].pageY - e.touches[1].pageY
        );
        initialScale = currentScale;
      }
    }, { passive: false });

    container.addEventListener('touchmove', function(e) {
      if (e.touches.length === 2) {
        e.preventDefault();
        const dist = Math.hypot(
          e.touches[0].pageX - e.touches[1].pageX,
          e.touches[0].pageY - e.touches[1].pageY
        );
        if (startDist > 0) {
          const newScale = initialScale * (dist / startDist);
          // Limita lo zoom (es. da 0.4x a 2.0x)
          currentScale = Math.min(Math.max(0.4, newScale), 2.0);
          table.style.transform = 'scale(' + currentScale + ')';
          // Opzionale: adatta larghezza container per evitare spazio vuoto eccessivo
          // table.style.width = (100 / currentScale) + '%'; 
        }
      }
    }, { passive: false });
  }
});
</script>
{% endif %}
{% endblock %}